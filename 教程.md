---

## 第十章：前端界面开发 - 让商城更美观

### 10.1 理解前端架构

CRMEB的前端就像商城的**装修设计**：
- 🏢 **管理后台**：基于Vue.js + ElementUI，像办公室装修
- 📱 **小程序端**：基于UniApp，像店面装修
- 🎨 **设计规范**：统一的视觉风格，像装修风格指南

### 10.2 小程序首页改造

#### 10.2.1 首页布局设计

```vue
<!-- 修改文件：template/uni-app/pages/index/index.vue -->
<template>
  <view class="home-page">
    <!-- 顶部搜索栏 -->
    <view class="search-header">
      <view class="search-box" @click="goSearch">
        <text class="iconfont icon-search"></text>
        <text class="placeholder">搜索农产品</text>
      </view>
      <view class="scan-btn" @click="scanCode">
        <text class="iconfont icon-scan"></text>
      </view>
    </view>
    
    <!-- 轮播图 -->
    <swiper class="banner-swiper" 
            :indicator-dots="true"
            :autoplay="true"
            :interval="3000">
      <swiper-item v-for="item in bannerList" :key="item.id">
        <image :src="item.pic" 
               mode="aspectFill"
               @click="navigateTo(item.url)"></image>
      </swiper-item>
    </swiper>
    
    <!-- 合伙人入口 -->
    <view class="partner-entry" v-if="!isPartner" @click="goPartner">
      <view class="entry-content">
        <view class="entry-info">
          <view class="title">成为合伙人</view>
          <view class="desc">享专属折扣，赚分享佣金</view>
        </view>
        <view class="entry-action">
          <text>立即加入</text>
          <text class="iconfont icon-arrow-right"></text>
        </view>
      </view>
      <image src="/static/images/partner-bg.png" class="entry-bg"></image>
    </view>
    
    <!-- 功能导航 -->
    <view class="nav-grid">
      <view class="nav-item" @click="goPage('/pages/category/category')">
        <image src="/static/images/nav-category.png" class="nav-icon"></image>
        <text class="nav-title">商品分类</text>
      </view>
      <view class="nav-item" @click="goPage('/pages/giftcard/index')">
        <image src="/static/images/nav-giftcard.png" class="nav-icon"></image>
        <text class="nav-title">礼品卡</text>
      </view>
      <view class="nav-item" @click="goPage('/pages/distribution/center')">
        <image src="/static/images/nav-share.png" class="nav-icon"></image>
        <text class="nav-title">分享赚钱</text>
      </view>
      <view class="nav-item" @click="goPage('/pages/credit/index')">
        <image src="/static/images/nav-credit.png" class="nav-icon"></image>
        <text class="nav-title">先用后付</text>
      </view>
    </view>
    
    <!-- 秒杀专区 -->
    <view class="seckill-section" v-if="seckillList.length > 0">
      <view class="section-header">
        <view class="header-left">
          <text class="title">限时秒杀</text>
          <view class="countdown">
            <text class="time-block">{{ hours }}</text>
            <text class="colon">:</text>
            <text class="time-block">{{ minutes }}</text>
            <text class="colon">:</text>
            <text class="time-block">{{ seconds }}</text>
          </view>
        </view>
        <view class="header-right" @click="goSeckill">
          <text>更多</text>
          <text class="iconfont icon-arrow-right"></text>
        </view>
      </view>
      
      <scroll-view scroll-x class="seckill-scroll">
        <view class="seckill-list">
          <view class="seckill-item" 
                v-for="item in seckillList" 
                :key="item.id"
                @click="goProduct(item.id)">
            <image :src="item.image" class="product-img"></image>
            <view class="product-name">{{ item.store_name }}</view>
            <view class="price-box">
              <text class="seckill-price">¥{{ item.price }}</text>
              <text class="origin-price">¥{{ item.ot_price }}</text>
            </view>
            <view class="progress-bar">
              <view class="progress-fill" :style="{width: item.progress + '%'}"></view>
            </view>
            <text class="progress-text">已抢{{ item.progress }}%</text>
          </view>
        </view>
      </scroll-view>
    </view>
    
    <!-- 推荐商品 -->
    <view class="recommend-section">
      <view class="section-header">
        <text class="title">为您推荐</text>
      </view>
      
      <view class="product-grid">
        <view class="product-item" 
              v-for="item in recommendList" 
              :key="item.id"
              @click="goProduct(item.id)">
          <view class="product-image">
            <image :src="item.image" mode="aspectFill"></image>
            <view class="product-tag" v-if="item.activity">
              {{ item.activity.title }}
            </view>
          </view>
          <view class="product-info">
            <view class="product-name">{{ item.store_name }}</view>
            <view class="product-desc">{{ item.store_info }}</view>
            <view class="product-bottom">
              <view class="price">
                <text class="currency">¥</text>
                <text class="amount">{{ item.price }}</text>
              </view>
              <view class="cart-btn" @click.stop="addCart(item)">
                <text class="iconfont icon-cart"></text>
              </view>
            </view>
          </view>
        </view>
      </view>
    </view>
    
    <!-- 底部导航 -->
    <custom-tabbar :current="0"></custom-tabbar>
  </view>
</template>

<script>
import { getIndexData, getSeckillList, getProductList } from '@/api/home.js'
import { addCart } from '@/api/cart.js'
import CustomTabbar from '@/components/custom-tabbar/custom-tabbar.vue'

export default {
  components: {
    CustomTabbar
  },
  
  data() {
    return {
      bannerList: [],
      seckillList: [],
      recommendList: [],
      isPartner: false,
      // 倒计时
      endTime: 0,
      hours: '00',
      minutes: '00',
      seconds: '00',
      timer: null
    }
  },
  
  onLoad() {
    this.loadIndexData()
    this.checkPartnerStatus()
  },
  
  onShow() {
    // 开始倒计时
    if (this.endTime) {
      this.startCountdown()
    }
  },
  
  onHide() {
    // 清除倒计时
    if (this.timer) {
      clearInterval(this.timer)
    }
  },
  
  methods: {
    // 加载首页数据
    async loadIndexData() {
      uni.showLoading({ title: '加载中...' })
      
      try {
        // 获取首页数据
        const indexRes = await getIndexData()
        this.bannerList = indexRes.data.banner
        
        // 获取秒杀商品
        const seckillRes = await getSeckillList({ limit: 6 })
        this.seckillList = seckillRes.data.list
        if (this.seckillList.length > 0) {
          this.endTime = this.seckillList[0].stop_time
          this.startCountdown()
        }
        
        // 获取推荐商品
        const recommendRes = await getProductList({ 
          is_hot: 1, 
          limit: 20 
        })
        this.recommendList = recommendRes.data.list
        
        uni.hideLoading()
      } catch (error) {
        uni.hideLoading()
        console.error(error)
      }
    },
    
    // 检查合伙人状态
    checkPartnerStatus() {
      const userInfo = uni.getStorageSync('userInfo')
      if (userInfo && userInfo.is_partner) {
        this.isPartner = true
      }
    },
    
    // 倒计时
    startCountdown() {
      this.updateCountdown()
      this.timer = setInterval(() => {
        this.updateCountdown()
      }, 1000)
    },
    
    updateCountdown() {
      const now = Math.floor(Date.now() / 1000)
      const diff = this.endTime - now
      
      if (diff <= 0) {
        this.hours = '00'
        this.minutes = '00'
        this.seconds = '00'
        clearInterval(this.timer)
        return
      }
      
      const h = Math.floor(diff / 3600)
      const m = Math.floor((diff % 3600) / 60)
      const s = diff % 60
      
      this.hours = h < 10 ? '0' + h : h
      this.minutes = m < 10 ? '0' + m : m
      this.seconds = s < 10 ? '0' + s : s
    },
    
    // 添加购物车
    async addCart(product) {
      try {
        await addCart({
          productId: product.id,
          cartNum: 1
        })
        
        uni.showToast({
          title: '添加成功',
          icon: 'success'
        })
      } catch (error) {
        uni.showToast({
          title: error.message || '添加失败',
          icon: 'none'
        })
      }
    },
    
    // 页面跳转
    goPage(url) {
      uni.navigateTo({ url })
    },
    
    goProduct(id) {
      uni.navigateTo({
        url: `/pages/goods/goods?id=${id}`
      })
    },
    
    goSearch() {
      uni.navigateTo({
        url: '/pages/search/search'
      })
    },
    
    goPartner() {
      uni.navigateTo({
        url: '/pages/partner/index'
      })
    },
    
    goSeckill() {
      uni.navigateTo({
        url: '/pages/activity/seckill'
      })
    },
    
    // 扫码
    scanCode() {
      uni.scanCode({
        success: (res) => {
          console.log('扫码结果：', res.result)
          // 处理扫码结果
        }
      })
    },
    
    // 处理轮播图跳转
    navigateTo(url) {
      if (!url) return
      
      if (url.startsWith('http')) {
        // 外部链接
        uni.navigateTo({
          url: `/pages/webview/webview?url=${encodeURIComponent(url)}`
        })
      } else {
        // 内部页面
        uni.navigateTo({ url })
      }
    }
  }
}
</script>

<style lang="scss">
.home-page {
  background: #f5f5f5;
  padding-bottom: 100rpx;
  
  .search-header {
    position: sticky;
    top: 0;
    z-index: 100;
    display: flex;
    align-items: center;
    padding: 20rpx 30rpx;
    background: #fff;
    
    .search-box {
      flex: 1;
      height: 70rpx;
      background: #f5f5f5;
      border-radius: 35rpx;
      display: flex;
      align-items: center;
      padding: 0 30rpx;
      
      .iconfont {
        font-size: 32rpx;
        color: #999;
        margin-right: 20rpx;
      }
      
      .placeholder {
        color: #999;
        font-size: 28rpx;
      }
    }
    
    .scan-btn {
      width: 70rpx;
      height: 70rpx;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-left: 20rpx;
      
      .iconfont {
        font-size: 40rpx;
        color: #333;
      }
    }
  }
  
  .banner-swiper {
    height: 400rpx;
    
    image {
      width: 100%;
      height: 100%;
    }
  }
  
  .partner-entry {
    position: relative;
    margin: 20rpx 30rpx;
    height: 160rpx;
    background: linear-gradient(135deg, #ff6b6b 0%, #ff8e53 100%);
    border-radius: 20rpx;
    overflow: hidden;
    
    .entry-content {
      position: relative;
      z-index: 2;
      display: flex;
      justify-content: space-between;
      align-items: center;
      height: 100%;
      padding: 0 40rpx;
      color: #fff;
      
      .title {
        font-size: 36rpx;
        font-weight: bold;
        margin-bottom: 10rpx;
      }
      
      .desc {
        font-size: 26rpx;
        opacity: 0.9;
      }
      
      .entry-action {
        display: flex;
        align-items: center;
        
        text {
          font-size: 28rpx;
        }
        
        .iconfont {
          margin-left: 10rpx;
        }
      }
    }
    
    .entry-bg {
      position: absolute;
      right: 0;
      top: 0;
      width: 300rpx;
      height: 160rpx;
      opacity: 0.3;
    }
  }
  
  .nav-grid {
    display: flex;
    background: #fff;
    padding: 30rpx 0;
    
    .nav-item {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      
      .nav-icon {
        width: 80rpx;
        height: 80rpx;
        margin-bottom: 20rpx;
      }
      
      .nav-title {
        font-size: 26rpx;
        color: #666;
      }
    }
  }
  
  .seckill-section {
    margin-top: 20rpx;
    background: #fff;
    
    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 30rpx;
      
      .header-left {
        display: flex;
        align-items: center;
        
        .title {
          font-size: 36rpx;
          font-weight: bold;
          margin-right: 20rpx;
        }
        
        .countdown {
          display: flex;
          align-items: center;
          
          .time-block {
            width: 40rpx;
            height: 40rpx;
            background: #333;
            color: #fff;
            border-radius: 8rpx;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24rpx;
          }
          
          .colon {
            margin: 0 8rpx;
            font-weight: bold;
          }
        }
      }
      
      .header-right {
        display: flex;
        align-items: center;
        color: #999;
        font-size: 28rpx;
        
        .iconfont {
          margin-left: 8rpx;
          font-size: 24rpx;
        }
      }
    }
    
    .seckill-scroll {
      height: 340rpx;
    }
    
    .seckill-list {
      display: flex;
      padding: 0 30rpx 30rpx;
      
      .seckill-item {
        width: 200rpx;
        margin-right: 20rpx;
        
        .product-img {
          width: 200rpx;
          height: 200rpx;
          border-radius: 10rpx;
          margin-bottom: 20rpx;
        }
        
        .product-name {
          font-size: 26rpx;
          overflow: hidden;
          text-overflow: ellipsis;
          white-space: nowrap;
          margin-bottom: 10rpx;
        }
        
        .price-box {
          display: flex;
          align-items: baseline;
          margin-bottom: 10rpx;
          
          .seckill-price {
            font-size: 32rpx;
            color: #ff6b6b;
            font-weight: bold;
            margin-right: 10rpx;
          }
          
          .origin-price {
            font-size: 24rpx;
            color: #999;
            text-decoration: line-through;
          }
        }
        
        .progress-bar {
          width: 100%;
          height: 8rpx;
          background: #f5f5f5;
          border-radius: 4rpx;
          margin-bottom: 8rpx;
          
          .progress-fill {
            height: 100%;
            background: #ff6b6b;
            border-radius: 4rpx;
          }
        }
        
        .progress-text {
          font-size: 22rpx;
          color: #999;
        }
      }
    }
  }
  
  .recommend-section {
    margin-top: 20rpx;
    
    .section-header {
      padding: 30rpx;
      background: #fff;
      
      .title {
        font-size: 36rpx;
        font-weight: bold;
      }
    }
    
    .product-grid {
      display: flex;
      flex-wrap: wrap;
      padding: 0 20rpx;
      
      .product-item {
        width: calc(50% - 20rpx);
        margin: 10rpx;
        background: #fff;
        border-radius: 20rpx;
        overflow: hidden;
        
        .product-image {
          position: relative;
          width: 100%;
          height: 350rpx;
          
          image {
            width: 100%;
            height: 100%;
          }
          
          .product-tag {
            position: absolute;
            top: 20rpx;
            left: 0;
            background: #ff6b6b;
            color: #fff;
            padding: 8rpx 20rpx;
            font-size: 22rpx;
            border-radius: 0 20rpx 20rpx 0;
          }
        }
        
        .product-info {
          padding: 20rpx;
          
          .product-name {
            font-size: 30rpx;
            font-weight: bold;
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            margin-bottom: 10rpx;
          }
          
          .product-desc {
            font-size: 24rpx;
            color: #999;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            margin-bottom: 20rpx;
          }
          
          .product-bottom {
            display: flex;
            justify-content: space-between;
            align-items: center;
            
            .price {
              color: #ff6b6b;
              
              .currency {
                font-size: 24rpx;
              }
              
              .amount {
                font-size: 36rpx;
                font-weight: bold;
              }
            }
            
            .cart-btn {
              width: 60rpx;
              height: 60rpx;
              background: #ff6b6b;
              border-radius: 50%;
              display: flex;
              align-items: center;
              justify-content: center;
              
              .iconfont {
                color: #fff;
                font-size: 32rpx;
              }
            }
          }
        }
      }
    }
  }
}
</style>
```

### 10.3 管理后台界面优化

#### 10.3.1 数据看板设计

```vue
<!-- 创建文件：template/admin/src/views/dashboard/index.vue -->
<template>
  <div class="dashboard-container">
    <!-- 顶部统计卡片 -->
    <el-row :gutter="20" class="stat-cards">
      <el-col :xs="24" :sm="12" :lg="6">
        <div class="stat-card">
          <div class="stat-icon" style="background: #ff6b6b;">
            <i class="el-icon-shopping-cart-2"></i>
          </div>
          <div class="stat-content">
            <div class="stat-title">今日订单</div>
            <div class="stat-value">{{ todayStats.orderCount }}</div>
            <div class="stat-trend">
              <span :class="todayStats.orderTrend > 0 ? 'up' : 'down'">
                {{ todayStats.orderTrend > 0 ? '+' : '' }}{{ todayStats.orderTrend }}%
              </span>
              <span class="trend-text">较昨日</span>
            </div>
          </div>
        </div>
      </el-col>
      
      <el-col :xs="24" :sm="12" :lg="6">
        <div class="stat-card">
          <div class="stat-icon" style="background: #67c23a;">
            <i class="el-icon-money"></i>
          </div>
          <div class="stat-content">
            <div class="stat-title">今日销售额</div>
            <div class="stat-value">¥{{ todayStats.salesAmount }}</div>
            <div class="stat-trend">
              <span :class="todayStats.salesTrend > 0 ? 'up' : 'down'">
                {{ todayStats.salesTrend > 0 ? '+' : '' }}{{ todayStats.salesTrend }}%
              </span>
              <span class="trend-text">较昨日</span>
            </div>
          </div>
        </div>
      </el-col>
      
      <el-col :xs="24" :sm="12" :lg="6">
        <div class="stat-card">
          <div class="stat-icon" style="background: #409eff;">
            <i class="el-icon-user"></i>
          </div>
          <div class="stat-content">
            <div class="stat-title">新增用户</div>
            <div class="stat-value">{{ todayStats.newUsers }}</div>
            <div class="stat-trend">
              <span :class="todayStats.userTrend > 0 ? 'up' : 'down'">
                {{ todayStats.userTrend > 0 ? '+' : '' }}{{ todayStats.userTrend }}%
              </span>
              <span class="trend-text">较昨日</span>
            </div>
          </div>
        </div>
      </el-col>
      
      <el-col :xs="24" :sm="12" :lg="6">
        <div class="stat-card">
          <div class="stat-icon" style="background: #e6a23c;">
            <i class="el-icon-star-on"></i>
          </div>
          <div class="stat-content">
            <div class="stat-title">新增合伙人</div>
            <div class="stat-value">{{ todayStats.newPartners }}</div>
            <div class="stat-trend">
              <span :class="todayStats.partnerTrend > 0 ? 'up' : 'down'">
                {{ todayStats.partnerTrend > 0 ? '+' : '' }}{{ todayStats.partnerTrend }}%
              </span>
              <span class="trend-text">较昨日</span>
            </div>
          </div>
        </div>
      </el-col>
    </el-row>
    
    <!-- 图表区域 -->
    <el-row :gutter="20" class="chart-area">
      <!-- 销售趋势图 -->
      <el-col :lg="16" :xs="24">
        <el-card class="chart-card">
          <div slot="header" class="chart-header">
            <span class="chart-title">销售趋势</span>
            <el-radio-group v-model="salesPeriod" size="small">
              <el-radio-button label="week">近7天</el-radio-button>
              <el-radio-button label="month">近30天</el-radio-button>
              <el-radio-button label="year">近一年</el-radio-button>
            </el-radio-group>
          </div>
          <div class="chart-container">
            <div ref="salesChart" style="height: 400px;"></div>
          </div>
        </el-card>
      </el-col>
      
      <!-- 商品销量排行 -->
      <el-col :lg="8" :xs="24">
        <el-card class="chart-card">
          <div slot="header" class="chart-header">
            <span class="chart-title">商品销量TOP10</span>
          </div>
          <div class="product-ranking">
            <div class="ranking-item" 
                 v-for="(item, index) in productRanking" 
                 :key="item.id">
              <div class="ranking-index" :class="{'top': index < 3}">
                {{ index + 1 }}
              </div>
              <div class="product-info">
                <img :src="item.image" alt="">
                <div class="product-detail">
                  <div class="product-name">{{ item.name }}</div>
                  <div class="product-sales">销量：{{ item.sales }}</div>
                </div>
              </div>
              <div class="sales-amount">¥{{ item.amount }}</div>
            </div>
          </div>
        </el-card>
      </el-col>
    </el-row>
    
    <!-- 业务概览 -->
    <el-row :gutter="20" class="business-overview">
      <!-- 分销数据 -->
      <el-col :lg="8" :xs="24">
        <el-card>
          <div slot="header">
            <span class="card-title">分销数据</span>
          </div>
          <div class="overview-content">
            <div class="overview-item">
              <span class="label">今日分享次数</span>
              <span class="value">{{ distributionStats.shareCount }}</span>
            </div>
            <div class="overview-item">
              <span class="label">成功分销订单</span>
              <span class="value">{{ distributionStats.successOrders }}</span>
            </div>
            <div class="overview-item">
              <span class="label">发放现金奖励</span>
              <span class="value">¥{{ distributionStats.cashReward }}</span>
            </div>
            <div class="overview-item">
              <span class="label">发放礼品券</span>
              <span class="value">{{ distributionStats.giftCards }}张</span>
            </div>
          </div>
        </el-card>
      </el-col>
      
      <!-- 信用支付数据 -->
      <el-col :lg="8" :xs="24">
        <el-card>
          <div slot="header">
            <span class="card-title">信用支付</span>
          </div>
          <div class="overview-content">
            <div class="overview-item">
              <span class="label">今日信用订单</span>
              <span class="value">{{ creditStats.todayOrders }}</span>
            </div>
            <div class="overview-item">
              <span class="label">信用使用金额</span>
              <span class="value">¥{{ creditStats.usedAmount }}</span>
            </div>
            <div class="overview-item">
              <span class="label">待还款金额</span>
              <span class="value">¥{{ creditStats.pendingAmount }}</span>
            </div>
            <div class="overview-item">
              <span class="label">逾期订单</span>
              <span class="value text-danger">{{ creditStats.overdueCount }}</span>
            </div>
          </div>
        </el-card>
      </el-col>
      
      <!-- 供应商数据 -->
      <el-col :lg="8" :xs="24">
        <el-card>
          <div slot="header">
            <span class="card-title">供应商概况</span>
          </div>
          <div class="overview-content">
            <div class="overview-item">
              <span class="label">活跃供应商</span>
              <span class="value">{{ supplierStats.activeCount }}</span>
            </div>
            <div class="overview-item">
              <span class="label">今日发货订单</span>
              <span class="value">{{ supplierStats.shippedOrders }}</span>
            </div>
            <div class="overview-item">
              <span class="label">待结算金额</span>
              <span class="value">¥{{ supplierStats.pendingSettlement }}</span>
            </div>
            <div class="overview-item">
              <span class="label">本月结算金额</span>
              <span class="value">¥{{ supplierStats.monthlySettlement }}</span>
            </div>
          </div>
        </el-card>
      </el-col>
    </el-row>
  </div>
</template>

<script>
import * as echarts from 'echarts'
import { getDashboardStats } from '@/api/dashboard'

export default {
  name: 'Dashboard',
  
  data() {
    return {
      // 今日统计
      todayStats: {
        orderCount: 0,
        orderTrend: 0,
        salesAmount: 0,
        salesTrend: 0,
        newUsers: 0,
        userTrend: 0,
        newPartners: 0,
        partnerTrend: 0
      },
      
      // 销售趋势
      salesPeriod: 'week',
      salesChart: null,
      
      // 商品排行
      productRanking: [],
      
      // 业务数据
      distributionStats: {
        shareCount: 0,
        successOrders: 0,
        cashReward: 0,
        giftCards: 0
      },
      creditStats: {
        todayOrders: 0,
        usedAmount: 0,
        pendingAmount: 0,
        overdueCount: 0
      },
      supplierStats: {
        activeCount: 0,
        shippedOrders: 0,
        pendingSettlement: 0,
        monthlySettlement: 0
      }
    }
  },
  
  mounted() {
    this.initCharts()
    this.loadData()
    
    // 定时刷新
    this.timer = setInterval(() => {
      this.loadData()
    }, 60000) // 每分钟刷新
  },
  
  beforeDestroy() {
    if (this.timer) {
      clearInterval(this.timer)
    }
    if (this.salesChart) {
      this.salesChart.dispose()
    }
  },
  
  watch: {
    salesPeriod() {
      this.updateSalesChart()
    }
  },
  
  methods: {
    // 初始化图表
    initCharts() {
      this.salesChart = echarts.init(this.$refs.salesChart)
      
      // 响应式
      window.addEventListener('resize', () => {
        this.salesChart && this.salesChart.resize()
      })
    },
    
    // 加载数据
    async loadData() {
      try {
        const res = await getDashboardStats()
        const data = res.data
        
        // 更新各项数据
        this.todayStats = data.todayStats
        this.productRanking = data.productRanking
        this.distributionStats = data.distributionStats
        this.creditStats = data.creditStats
        this.supplierStats = data.supplierStats
        
        // 更新图表
        this.updateSalesChart(data.salesTrend)
      } catch (error) {
        console.error('加载数据失败', error)
      }
    },
    
    // 更新销售趋势图
    updateSalesChart(data) {
      if (!data) return
      
      const option = {
        tooltip: {
          trigger: 'axis',
          axisPointer: {
            type: 'cross'
          }
        },
        legend: {
          data: ['销售额', '订单量']
        },
        grid: {
          left: '3%',
          right: '4%',
          bottom: '3%',
          containLabel: true
        },
        xAxis: {
          type: 'category',
          boundaryGap: false,
          data: data.dates
        },
        yAxis: [
          {
            type: 'value',
            name: '销售额',
            axisLabel: {
              formatter: '¥{value}'
            }
          },
          {
            type: 'value',
            name: '订单量',
            axisLabel: {
              formatter: '{value}单'
            }
          }
        ],
        series: [
          {
            name: '销售额',
            type: 'line',
            smooth: true,
            data: data.amounts,
            itemStyle: {
              color: '#ff6b6b'
            },
            areaStyle: {
              color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                { offset: 0, color: 'rgba(255, 107, 107, 0.3)' },
                { offset: 1, color: 'rgba(255, 107, 107, 0.1)' }
              ])
            }
          },
          {
            name: '订单量',
            type: 'line',
            smooth: true,
            yAxisIndex: 1,
            data: data.orders,
            itemStyle: {
              color: '#409eff'
            }
          }
        ]
      }
      
      this.salesChart.setOption(option)
    }
  }
}
</script>

<style lang="scss" scoped>
.dashboard-container {
  padding: 20px;
  
  .stat-cards {
    margin-bottom: 20px;
    
    .stat-card {
      background: #fff;
      border-radius: 8px;
      padding: 20px;
      display: flex;
      align-items: center;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      transition: all 0.3s;
      
      &:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
      }
      
      .stat-icon {
        width: 60px;
        height: 60px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-right: 20px;
        
        i {
          font-size: 28px;
          color: #fff;
        }
      }
      
      .stat-content {
        flex: 1;
        
        .stat-title {
          font-size: 14px;
          color: #999;
          margin-bottom: 8px;
        }
        
        .stat-value {
          font-size: 28px;
          font-weight: bold;
          color: #333;
          margin-bottom: 8px;
        }
        
        .stat-trend {
          font-size: 14px;
          
          .up {
            color: #67c23a;
          }
          
          .down {
            color: #f56c6c;
          }
          
          .trend-text {
            color: #999;
            margin-left: 5px;
          }
        }
      }
    }
  }
  
  .chart-area {
    margin-bottom: 20px;
    
    .chart-card {
      margin-bottom: 20px;
      
      .chart-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        
        .chart-title {
          font-size: 16px;
          font-weight: bold;
        }
      }
      
      .chart-container {
        padding: 20px 0;
      }
    }
    
    .product-ranking {
      .ranking-item {
        display: flex;
        align-items: center;
        padding: 15px 0;
        border-bottom: 1px solid #f0f0f0;
        
        &:last-child {
          border-bottom: none;
        }
        
        .ranking-index {
          width: 30px;
          height: 30px;
          background: #f0f0f0;
          border-radius: 50%;
          display: flex;
          align-items: center;
          justify-content: center;
          font-weight: bold;
          margin-right: 15px;
          
          &.top {
            background: #ff6b6b;
            color: #fff;
          }
        }
        
        .product-info {
          flex: 1;
          display: flex;
          align-items: center;
          
          img {
            width: 50px;
            height: 50px;
            border-radius: 4px;
            margin-right: 10px;
          }
          
          .product-detail {
            flex: 1;
            
            .product-name {
              font-size: 14px;
              margin-bottom: 5px;
              overflow: hidden;
              text-overflow: ellipsis;
              white-space: nowrap;
            }
            
            .product-sales {
              font-size: 12px;
              color: #999;
            }
          }
        }
        
        .sales-amount {
          font-size: 16px;
          font-weight: bold;
          color: #ff6b6b;
        }
      }
    }
  }
  
  .business-overview {
    .card-title {
      font-size: 16px;
      font-weight: bold;
    }
    
    .overview-content {
      .overview-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 15px 0;
        border-bottom: 1px solid #f0f0f0;
        
        &:last-child {
          border-bottom: none;
        }
        
        .label {
          font-size: 14px;
          color: #666;
        }
        
        .value {
          font-size: 16px;
          font-weight: bold;
          color: #333;
          
          &.text-danger {
            color: #f56c6c;
          }
        }
      }
    }
  }
}
</style>
```

### 10.4 组件库开发

#### 10.4.1 创建商品卡片组件

```vue
<!-- 创建文件：template/uni-app/components/product-card/product-card.vue -->
<template>
  <view class="product-card" @click="handleClick">
    <!-- 商品图片 -->
    <view class="product-image">
      <image :src="product.image" 
             mode="aspectFill"
             lazy-load
             @error="handleImageError"></image>
      
      <!-- 标签 -->
      <view class="product-tags" v-if="showTags">
        <view class="tag partner-tag" v-if="product.is_partner_product">
          合伙人专享
        </view>
        <view class="tag hot-tag" v-if="product.is_hot">
          热销
        </view>
        <view class="tag new-tag" v-if="product.is_new">
          新品
        </view>
      </view>
      
      <!-- 活动标签 -->
      <view class="activity-tag" v-if="product.activity_type">
        <text class="iconfont" :class="activityIcon"></text>
        <text>{{ activityText }}</text>
      </view>
    </view>
    
    <!-- 商品信息 -->
    <view class="product-info">
      <!-- 商品名称 -->
      <view class="product-name">
        <text class="name-text">{{ product.store_name }}</text>
      </view>
      
      <!-- 商品描述 -->
      <view class="product-desc" v-if="showDesc">
        {{ product.store_info }}
      </view>
      
      <!-- 价格和操作 -->
      <view class="product-footer">
        <view class="price-box">
          <!-- 现价 -->
          <view class="current-price">
            <text class="currency">¥</text>
            <text class="price">{{ product.price }}</text>
          </view>
          
          <!-- 原价 -->
          <view class="origin-price" v-if="product.ot_price > product.price">
            ¥{{ product.ot_price }}
          </view>
          
          <!-- 合伙人价 -->
          <view class="partner-price" v-if="isPartner && product.partner_price">
            <text class="label">合伙人价</text>
            <text class="price">¥{{ product.partner_price }}</text>
          </view>
        </view>
        
        <!-- 操作按钮 -->
        <view class="action-box" v-if="showAction">
          <button class="cart-btn" 
                  @click.stop="handleCart"
                  v-if="actionType === 'cart'">
            <text class="iconfont icon-cart"></text>
          </button>
          
          <button class="buy-btn"
                  @click.stop="handleBuy"
                  v-if="actionType === 'buy'">
            立即购买
          </button>
        </view>
      </view>
      
      <!-- 销量和评价 -->
      <view class="product-extra" v-if="showExtra">
        <text class="sales">已售{{ product.sales }}件</text>
        <text class="divider">|</text>
        <text class="comment">{{ product.reply_count }}条评价</text>
      </view>
    </view>
  </view>
</template>

<script>
export default {
  name: 'ProductCard',
  
  props: {
    // 商品数据
    product: {
      type: Object,
      required: true
    },
    
    // 显示配置
    showTags: {
      type: Boolean,
      default: true
    },
    showDesc: {
      type: Boolean,
      default: true
    },
    showAction: {
      type: Boolean,
      default: true
    },
    showExtra: {
      type: Boolean,
      default: false
    },
    
    // 操作类型
    actionType: {
      type: String,
      default: 'cart' // cart | buy
    }
  },
  
  computed: {
    // 是否为合伙人
    isPartner() {
      const userInfo = uni.getStorageSync('userInfo')
      return userInfo && userInfo.is_partner
    },
    
    // 活动图标
    activityIcon() {
      const icons = {
        1: 'icon-seckill',
        2: 'icon-bargain',
        3: 'icon-combination',
        4: 'icon-discount'
      }
      return icons[this.product.activity_type] || ''
    },
    
    // 活动文字
    activityText() {
      const texts = {
        1: '限时秒杀',
        2: '砍价',
        3: '拼团',
        4: '限时折扣'
      }
      return texts[this.product.activity_type] || ''
    }
  },
  
  methods: {
    // 点击商品
    handleClick() {
      this.$emit('click', this.product)
      
      // 默认跳转商品详情
      uni.navigateTo({
        url: `/pages/goods/goods?id=${this.product.id}`
      })
    },
    
    // 加入购物车
    handleCart() {
      this.$emit('cart', this.product)
    },
    
    // 立即购买
    handleBuy() {
      this.$emit('buy', this.product)
    },
    
    // 图片加载失败
    handleImageError() {
      // 设置默认图片
      this.product.image = '/static/images/product-default.png'
    }
  }
}
</script>

<style lang="scss" scoped>
.product-card {
  background: #fff;
  border-radius: 20rpx;
  overflow: hidden;
  transition: all 0.3s;
  
  &:active {
    transform: scale(0.98);
  }
  
  .product-image {
    position: relative;
    width: 100%;
    height: 350rpx;
    overflow: hidden;
    
    image {
      width: 100%;
      height: 100%;
    }
    
    .product-tags {
      position: absolute;
      top: 20rpx;
      left: 20rpx;
      display: flex;
      flex-direction: column;
      gap: 10rpx;
      
      .tag {
        padding: 8rpx 16rpx;
        font-size: 22rpx;
        border-radius: 20rpx;
        color: #fff;
        
        &.partner-tag {
          background: linear-gradient(45deg, #ff6b6b, #ff8e53);
        }
        
        &.hot-tag {
          background: #ff6b6b;
        }
        
        &.new-tag {
          background: #67c23a;
        }
      }
    }
    
    .activity-tag {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      background: rgba(0, 0, 0, 0.6);
      color: #fff;
      padding: 10rpx 20rpx;
      font-size: 24rpx;
      display: flex;
      align-items: center;
      
      .iconfont {
        margin-right: 10rpx;
      }
    }
  }
  
  .product-info {
    padding: 20rpx;
    
    .product-name {
      margin-bottom: 10rpx;
      
      .name-text {
        font-size: 30rpx;
        font-weight: bold;
        overflow: hidden;
        text-overflow: ellipsis;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        line-height: 1.5;
      }
    }
    
    .product-desc {
      font-size: 24rpx;
      color: #999;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      margin-bottom: 20rpx;
    }
    
    .product-footer {
      display: flex;
      justify-content: space-between;
      align-items: flex-end;
      
      .price-box {
        flex: 1;
        
        .current-price {
          display: inline-flex;
          align-items: baseline;
          color: #ff6b6b;
          margin-right: 20rpx;
          
          .currency {
            font-size: 24rpx;
          }
          
          .price {
            font-size: 36rpx;
            font-weight: bold;
          }
        }
        
        .origin-price {
          display: inline-block;
          font-size: 24rpx;
          color: #999;
          text-decoration: line-through;
        }
        
        .partner-price {
          display: block;
          margin-top: 8rpx;
          font-size: 24rpx;
          color: #ff8e53;
          
          .label {
            margin-right: 10rpx;
          }
        }
      }
      
      .action-box {
        .cart-btn {
          width: 60rpx;
          height: 60rpx;
          background: #ff6b6b;
          border-radius: 50%;
          display: flex;
          align-items: center;
          justify-content: center;
          border: none;
          
          .iconfont {
            color: #fff;
            font-size: 32rpx;
          }
        }
        
        .buy-btn {
          height: 60rpx;
          padding: 0 30rpx;
          background: linear-gradient(45deg, #ff6b6b, #ff8e53);
          color: #fff;
          font-size: 26rpx;
          border-radius: 30rpx;
          border: none;
        }
      }
    }
    
    .product-extra {
      margin-top: 20rpx;
      font-size: 22rpx;
      color: #999;
      
      .divider {
        margin: 0 10rpx;
      }
    }
  }
}
</style>
```

### 10.5 主题定制

#### 10.5.1 创建主题配置文件

```scss
// 创建文件：template/uni-app/styles/theme.scss
// 主题颜色配置

// 主色调
$primary-color: #ff6b6b;
$primary-gradient-start: #ff6b6b;
$primary-gradient-end: #ff8e53;

// 功能色
$success-color: #67c23a;
$warning-color: #e6a23c;
$danger-color: #f56c6c;
$info-color: #409eff;

// 中性色
$text-color: #333333;
$text-color-secondary: #666666;
$text-color-placeholder: #999999;
$border-color: #e5e5e5;
$background-color: #f5f5f5;

// 阴影
$box-shadow-base: 0 2rpx 8rpx rgba(0, 0, 0, 0.1);
$box-shadow-light: 0 2rpx 4rpx rgba(0, 0, 0, 0.05);
$box-shadow-dark: 0 4rpx 16rpx rgba(0, 0, 0, 0.15);

// 圆角
$border-radius-small: 8rpx;
$border-radius-base: 12rpx;
$border-radius-large: 20rpx;
$border-radius-circle: 50%;

// 间距
$spacing-xs: 10rpx;
$spacing-sm: 20rpx;
$spacing-md: 30rpx;
$spacing-lg: 40rpx;
$spacing-xl: 60rpx;

// 字体大小
$font-size-xs: 22rpx;
$font-size-sm: 24rpx;
$font-size-base: 28rpx;
$font-size-md: 30rpx;
$font-size-lg: 32rpx;
$font-size-xl: 36rpx;
$font-size-xxl: 40rpx;

// 混入（Mixins）
@mixin flex-center {
  display: flex;
  align-items: center;
  justify-content: center;
}

@mixin flex-between {
  display: flex;
  align-items: center;
  justify-content: space-between;
}

@mixin ellipsis($lines: 1) {
  overflow: hidden;
  text-overflow: ellipsis;
  @if $lines == 1 {
    white-space: nowrap;
  } @else {
    display: -webkit-box;
    -webkit-line-clamp: $lines;
    -webkit-box-orient: vertical;
  }
}

@mixin card-style {
  background: #fff;
  border-radius: $border-radius-large;
  box-shadow: $box-shadow-base;
}

@mixin button-style($bg-color: $primary-color) {
  background: $bg-color;
  color: #fff;
  border: none;
  border-radius: $border-radius-circle;
  @include flex-center;
  
  &:active {
    opacity: 0.8;
  }
  
  &[disabled] {
    opacity: 0.5;
  }
}

// 渐变背景
@mixin gradient-bg($start: $primary-gradient-start, $end: $primary-gradient-end, $deg: 45deg) {
  background: linear-gradient($deg, $start, $end);
}

// 主题切换（预留）
@mixin theme-dark {
  // 深色主题配置
  $text-color: #ffffff;
  $background-color: #1a1a1a;
  // ...
}
```

### 10.6 本章练习

1. **界面开发**：
   - 设计并实现个人中心页面
   - 创建订单列表页面
   - 优化商品详情页

2. **组件开发**：
   - 开发订单卡片组件
   - 创建倒计时组件
   - 实现图片预览组件

3. **主题定制**：
   - 实现深色模式切换
   - 创建节日主题样式
   - 开发主题配置面板

---

## 第十一章：系统部署与上线 - 让商城活起来

### 11.1 部署前准备

部署就像**搬家入住**：
- 🏠 **服务器**：新家的房子
- 📦 **代码打包**：打包行李
- 🔧 **环境配置**：装修布置
- 🚀 **上线发布**：正式入住

### 11.2 代码打包优化

#### 11.2.1 后端代码优化

```bash
# 1. 进入项目目录
cd /www/wwwroot/qingrenfu

# 2. 清理缓存
php think clear

# 3. 关闭调试模式
# 修改 .env 文件
APP_DEBUG = false

# 4. 优化配置
php think optimize:config
php think optimize:route

# 5. 安装生产环境依赖
composer install --no-dev --optimize-autoloader

# 6. 设置目录权限
chmod -R 755 .
chmod -R 777 runtime
chmod -R 777 public/uploads
```

#### 11.2.2 前端代码打包

**管理后台打包：**

```bash
# 进入管理后台目录
cd template/admin

# 安装依赖
npm install

# 修改生产环境配置
# 编辑 .env.production
VUE_APP_BASE_API = 'https://shop.qingrenfu.com'

# 打包
npm run build

# 打包后的文件在 dist 目录
```

**小程序打包：**

```bash
# 进入小程序目录
cd template/uni-app

# 安装依赖
npm install

# 修改配置
# 编辑 common/config.js
export default {
  baseUrl: 'https://shop.qingrenfu.com',
  // ... 其他配置
}

# 编译小程序
npm run build:mp-weixin

# 编译后的文件在 dist/build/mp-weixin 目录
```

### 11.3 服务器配置优化

#### 11.3.1 Nginx配置优化

```nginx
# 编辑网站配置文件
# /www/server/panel/vhost/nginx/shop.qingrenfu.com.conf

server {
    listen 443 ssl http2;
    server_name shop.qingrenfu.com;
    
    # SSL配置
    ssl_certificate /www/server/panel/vhost/cert/shop.qingrenfu.com/fullchain.pem;
    ssl_certificate_key /www/server/panel/vhost/cert/shop.qingrenfu.com/privkey.pem;
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers ECDHE-RSA-AES128-GCM-SHA256:HIGH:!aNULL:!MD5:!RC4:!DHE;
    ssl_prefer_server_ciphers on;
    ssl_session_cache shared:SSL:10m;
    ssl_session_timeout 10m;
    
    # 安全头部
    add_header X-Frame-Options "SAMEORIGIN";
    add_header X-Content-Type-Options "nosniff";
    add_header X-XSS-Protection "1; mode=block";
    
    # Gzip压缩
    gzip on;
    gzip_vary on;
    gzip_comp_level 6;
    gzip_types text/plain text/css text/xml text/javascript application/json application/javascript application/xml+rss application/rss+xml application/atom+xml image/svg+xml;
    
    # 根目录
    root /www/wwwroot/qingrenfu/crmeb/public;
    index index.php;
    
    # 静态资源缓存
    location ~* \.(jpg|jpeg|png|gif|ico|css|js|pdf|txt|woff|woff2|ttf)$ {
        expires 30d;
        add_header Cache-Control "public, immutable";
    }
    
    # 上传文件大小限制
    client_max_body_size 50M;
    
    # PHP配置
    location ~ \.php$ {
        fastcgi_pass unix:/tmp/php-cgi-74.sock;
        fastcgi_index index.php;
        include fastcgi_params;
        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
        
        # PHP超时设置
        fastcgi_connect_timeout 300;
        fastcgi_send_timeout 300;
        fastcgi_read_timeout 300;
    }
    
    # 伪静态规则
    location / {
        if (!-e $request_filename) {
            rewrite ^(.*)$ /index.php?s=/$1 last;
        }
    }
    
    # 禁止访问的文件
    location ~ ^/(\.user.ini|\.htaccess|\.git|\.svn|\.project|LICENSE|README.md) {
        return 404;
    }
    
    # 管理后台
    location /admin {
        alias /www/wwwroot/qingrenfu/template/admin/dist;
        try_files $uri $uri/ /admin/index.html;
    }
}

# HTTP跳转HTTPS
server {
    listen 80;
    server_name shop.qingrenfu.com;
    return 301 https://$server_name$request_uri;
}
```

#### 11.3.2 PHP配置优化

在宝塔面板中，找到PHP设置：

1. **配置修改**：
```ini
# 内存限制
memory_limit = 256M

# 上传限制
upload_max_filesize = 50M
post_max_size = 50M

# 执行时间
max_execution_time = 300
max_input_time = 300

# OPcache优化
opcache.enable=1
opcache.memory_consumption=128
opcache.interned_strings_buffer=8
opcache.max_accelerated_files=10000
opcache.revalidate_freq=60
```

2. **安装扩展**：
- opcache（性能优化）
- redis（缓存）
- fileinfo（文件处理）

### 11.4 数据库优化

#### 11.4.1 MySQL配置优化

```ini
# 编辑 /etc/my.cnf
[mysqld]
# 基础设置
max_connections = 500
max_connect_errors = 100

# 缓存设置
key_buffer_size = 128M
query_cache_size = 64M
query_cache_type = 1
tmp_table_size = 64M
max_heap_table_size = 64M

# InnoDB设置
innodb_buffer_pool_size = 512M
innodb_log_file_size = 128M
innodb_flush_log_at_trx_commit = 2
innodb_flush_method = O_DIRECT

# 慢查询日志
slow_query_log = 1
slow_query_log_file = /www/server/data/mysql-slow.log
long_query_time = 2
```

#### 11.4.2 数据库备份策略

```bash
# 创建备份脚本
vim /root/backup_mysql.sh

#!/bin/bash
# 数据库备份脚本

# 配置
DB_NAME="qingrenfu"
DB_USER="root"
DB_PASS="your_password"
BACKUP_DIR="/www/backup/database"
DATE=$(date +%Y%m%d_%H%M%S)

# 创建备份目录
mkdir -p $BACKUP_DIR

# 备份数据库
mysqldump -u$DB_USER -p$DB_PASS $DB_NAME > $BACKUP_DIR/${DB_NAME}_${DATE}.sql

# 压缩备份文件
gzip $BACKUP_DIR/${DB_NAME}_${DATE}.sql

# 删除7天前的备份
find $BACKUP_DIR -name "*.sql.gz" -mtime +7 -delete

# 同步到远程服务器（可选）
# rsync -av $BACKUP_DIR/ user@backup-server:/path/to/backup/

echo "备份完成: ${DB_NAME}_${DATE}.sql.gz"
```

设置定时任务：
```bash
# 添加定时任务
crontab -e

# 每天凌晨3点备份
0 3 * * * /root/backup_mysql.sh > /www/logs/backup.log 2>&1
```

### 11.5 CDN配置

#### 11.5.1 静态资源CDN

1. **开通CDN服务**（以阿里云为例）：
   - 登录阿里云控制台
   - 开通CDN服务
   - 添加加速域名：cdn.qingrenfu.com

2. **配置源站**：
   - 源站类型：源站域名
   - 源站地址：shop.qingrenfu.com
   - 回源端口：443

3. **缓存配置**：
```
# 缓存规则
/static/*     缓存30天
/uploads/*    缓存7天
*.js          缓存30天
*.css         缓存30天
*.jpg,*.png   缓存30天
```

4. **修改代码中的静态资源地址**：
```php
// config/filesystem.php
'cdn_domain' => 'https://cdn.qingrenfu.com',
```

### 11.6 小程序发布

#### 11.6.1 小程序配置

1. **修改小程序配置**：
```javascript
// manifest.json
{
  "mp-weixin": {
    "appid": "你的小程序AppID",
    "setting": {
      "urlCheck": true,
      "es6": true,
      "postcss": true,
      "minified": true
    },
    "permission": {
      "scope.userLocation": {
        "desc": "获取位置信息"
      }
    }
  }
}
```

2. **配置服务器域名**：
   - 登录微信公众平台
   - 开发 → 开发设置 → 服务器域名
   - 添加域名：
     - request合法域名：https://shop.qingrenfu.com
     - uploadFile合法域名：https://shop.qingrenfu.com
     - downloadFile合法域名：https://shop.qingrenfu.com

#### 11.6.2 上传代码

1. **使用微信开发者工具**：
   - 导入项目：选择 dist/build/mp-weixin 目录
   - 点击"上传"按钮
   - 填写版本号和项目备注

2. **提交审核**：
   - 登录小程序后台
   - 版本管理 → 提交审核
   - 填写审核信息

### 11.7 监控与日志

#### 11.7.1 配置日志系统

```php
// config/log.php
return [
    'default' => 'file',
    'channels' => [
        'file' => [
            'type' => 'daily',
            'path' => runtime_path() . 'log/',
            'level' => 'error',
            'max_files' => 30,
        ],
        // 错误日志单独记录
        'error' => [
            'type' => 'daily',
            'path' => runtime_path() . 'error/',
            'level' => 'error',
            'max_files' => 30,
        ],
        // 支付日志
        'payment' => [
            'type' => 'daily',
            'path' => runtime_path() . 'payment/',
            'level' => 'info',
            'max_files' => 90,
        ],
    ],
];
```

#### 11.7.2 性能监控脚本

```php
// 创建文件：app/command/Monitor.php
<?php
namespace app\command;

use think\console\Command;
use think\console\Input;
use think\console\Output;

class Monitor extends Command
{
    protected function configure()
    {
        $this->setName('monitor:check')
             ->setDescription('系统监控检查');
    }
    
    protected function execute(Input $input, Output $output)
    {
        // CPU使用率
        $cpu = sys_getloadavg()[0];
        
        // 内存使用
        $memory = memory_get_usage(true) / 1024 / 1024;
        
        // 磁盘空间
        $disk = disk_free_space('/') / 1024 / 1024 / 1024;
        
        // 数据库连接
        try {
            $db = \think\facade\Db::query("SELECT 1");
            $dbStatus = 'OK';
        } catch (\Exception $e) {
            $dbStatus = 'ERROR: ' . $e->getMessage();
        }
        
        // Redis连接
        try {
            $redis = \think\facade\Cache::store('redis')->handler();
            $redis->ping();
            $redisStatus = 'OK';
        } catch (\Exception $e) {
            $redisStatus = 'ERROR: ' . $e->getMessage();
        }
        
        $output->writeln("=== 系统监控报告 ===");
        $output->writeln("CPU负载: {$cpu}");
        $output->writeln("内存使用: {$memory}MB");
        $output->writeln("剩余磁盘: {$disk}GB");
        $output->writeln("数据库: {$dbStatus}");
        $output->writeln("Redis: {$redisStatus}");
        
        // 告警
        if ($cpu > 2) {
            $this->sendAlert("CPU负载过高: {$cpu}");
        }
        
        if ($disk < 10) {
            $this->sendAlert("磁盘空间不足: {$disk}GB");
        }
    }
    
    protected function sendAlert($message)
    {
        // 发送告警（短信、邮件等）
        // ...
    }
}
```

### 11.8 安全加固

#### 11.8.1 安全配置清单

1. **关闭不必要的服务**：
```bash
# 检查开放端口
netstat -tlnp

# 关闭不需要的服务
systemctl stop service_name
systemctl disable service_name
```

2. **配置防火墙**：
```bash
# 开启防火墙
systemctl start firewalld
systemctl enable firewalld

# 只开放必要端口
firewall-cmd --permanent --add-port=80/tcp
firewall-cmd --permanent --add-port=443/tcp
firewall-cmd --permanent --add-port=22/tcp
firewall-cmd --reload
```

3. **定期更新**：
```bash
# 系统更新
yum update -y

# PHP更新（通过宝塔面板）
```

#### 11.8.2 代码安全检查

```php
// 创建安全中间件
// app/middleware/Security.php
<?php
namespace app\middleware;

class Security
{
    public function handle($request, \Closure $next)
    {
        // XSS防护
        $params = $request->param();
        array_walk_recursive($params, function(&$value) {
            $value = htmlspecialchars($value, ENT_QUOTES, 'UTF-8');
        });
        $request->withParam($params);
        
        // SQL注入防护（框架已处理）
        
        // CSRF防护
        if ($request->isPost()) {
            $token = $request->header('X-CSRF-TOKEN');
            if (!$this->validateCsrfToken($token)) {
                return json(['code' => 403, 'msg' => 'CSRF验证失败']);
            }
        }
        
        return $next($request);
    }
    
    protected function validateCsrfToken($token)
    {
        // 验证逻辑
        return true;
    }
}
```

### 11.9 本章练习

1. **部署实践**：
   - 完成生产环境部署
   - 配置SSL证书
   - 设置自动备份

2. **性能优化**：
   - 实施CDN加速
   - 优化数据库查询
   - 配置Redis缓存

3. **安全加固**：
   - 实施安全策略
   - 配置监控告警
   - 制定应急预案

---

## 第十二章：运维与优化 - 让商城稳定运行

### 12.1 日常运维工作

运维就像**物业管理**：
- 🔧 **日常巡检**：检查系统状态
- 🚨 **故障处理**：及时解决问题
- 📊 **性能优化**：提升用户体验
- 📈 **数据分析**：指导业务决策

### 12.2 监控体系建设

#### 12.2.1 搭建监控系统

```bash
# 安装Prometheus + Grafana

# 1. 安装Prometheus
cd /opt
wget https://github.com/prometheus/prometheus/releases/download/v2.37.0/prometheus-2.37.0.linux-amd64.tar.gz
tar -xvf prometheus-2.37.0.linux-amd64.tar.gz
mv prometheus-2.37.0.linux-amd64 prometheus

# 2. 配置Prometheus
cat > /opt/prometheus/prometheus.yml << EOF
global:
  scrape_interval: 15s

scrape_configs:
  - job_name: 'node'
    static_configs:
    - targets: ['localhost:9100']
    
  - job_name: 'mysql'
    static_configs:
    - targets: ['localhost:9104']
    
  - job_name: 'redis'
    static_configs:
    - targets: ['localhost:9121']
    
  - job_name: 'php-fpm'
    static_configs:
    - targets: ['localhost:9253']
EOF

# 3. 创建systemd服务
cat > /etc/systemd/system/prometheus.service << EOF
[Unit]
Description=Prometheus
After=network.target

[Service]
Type=simple
ExecStart=/opt/prometheus/prometheus --config.file=/opt/prometheus/prometheus.yml
Restart=always

[Install]
WantedBy=multi-user.target
EOF

systemctl start prometheus
systemctl enable prometheus
```

#### 12.2.2 业务监控指标

```php
// 创建文件：app/middleware/Metrics.php
<?php
namespace app\middleware;

use think\facade\Cache;

class Metrics
{
    public function handle($request, \Closure $next)
    {
        $startTime = microtime(true);
        
        // 请求计数
        Cache::inc('metrics:request:total');
        
        // 执行请求
        $response = $next($request);
        
        // 响应时间
        $duration = microtime(true) - $startTime;
        $this->recordResponseTime($request->pathinfo(), $duration);
        
        // 状态码统计
        $statusCode = $response->getCode();
        Cache::inc("metrics:response:status:{$statusCode}");
        
        return $response;
    }
    
    protected function recordResponseTime($path, $duration)
    {
        // 按路径分组统计
        $key = "metrics:response:time:" . date('YmdH');
        $data = Cache::get($key, []);
        
        if (!isset($data[$path])) {
            $data[$path] = [
                'count' => 0,
                'total' => 0,
                'max' => 0,
                'min' => PHP_FLOAT_MAX
            ];
        }
        
        $data[$path]['count']++;
        $data[$path]['total'] += $duration;
        $data[$path]['max'] = max($data[$path]['max'], $duration);
        $data[$path]['min'] = min($data[$path]['min'], $duration);
        
        Cache::set($key, $data, 3600);
    }
}
```

### 12.3 性能优化实战

#### 12.3.1 数据库查询优化

```php
// 优化前：N+1查询问题
$orders = Order::select();
foreach ($orders as $order) {
    $user = User::find($order->uid);  // 每次循环都查询数据库
    $order->user_name = $user->nickname;
}

// 优化后：使用关联预加载
$orders = Order::with(['user'])->select();
foreach ($orders as $order) {
    $order->user_name = $order->user->nickname;  // 不再查询数据库
}

// 优化复杂统计查询
// 创建文件：app/services/statistics/DashboardCache.php
<?php
namespace app\services\statistics;

use think\facade\Cache;
use think\facade\Db;

class DashboardCache
{
    /**
     * 获取仪表盘数据（带缓存）
     */
    public function getDashboardData()
    {
        return Cache::remember('dashboard:stats', function() {
            return $this->calculateStats();
        }, 300);  // 缓存5分钟
    }
    
    /**
     * 计算统计数据
     */
    protected function calculateStats()
    {
        $today = date('Y-m-d');
        $yesterday = date('Y-m-d', strtotime('-1 day'));
        
        // 使用原生SQL优化复杂查询
        $sql = "
            SELECT 
                COUNT(CASE WHEN DATE(FROM_UNIXTIME(add_time)) = ? THEN 1 END) as today_orders,
                COUNT(CASE WHEN DATE(FROM_UNIXTIME(add_time)) = ? THEN 1 END) as yesterday_orders,
                SUM(CASE WHEN DATE(FROM_UNIXTIME(add_time)) = ? THEN pay_price ELSE 0 END) as today_sales,
                SUM(CASE WHEN DATE(FROM_UNIXTIME(add_time)) = ? THEN pay_price ELSE 0 END) as yesterday_sales
            FROM eb_store_order
            WHERE paid = 1 
            AND is_del = 0
            AND DATE(FROM_UNIXTIME(add_time)) >= ?
        ";
        
        $result = Db::query($sql, [
            $today, $yesterday, $today, $yesterday, $yesterday
        ]);
        
        return $result[0];
    }
    
    /**
     * 清除缓存
     */
    public function clearCache()
    {
        Cache::delete('dashboard:stats');
    }
}
```

#### 12.3.2 接口响应优化

```php
// 创建文件：app/services/optimize/ResponseOptimizer.php
<?php
namespace app\services\optimize;

class ResponseOptimizer
{
    /**
     * 优化商品列表数据
     */
    public function optimizeProductList($products)
    {
        // 只返回必要字段
        $fields = ['id', 'store_name', 'image', 'price', 'sales', 'stock'];
        
        return $products->map(function($product) use ($fields) {
            $data = [];
            foreach ($fields as $field) {
                $data[$field] = $product[$field];
            }
            
            // 图片使用CDN
            $data['image'] = $this->getCdnUrl($data['image']);
            
            return $data;
        });
    }
    
    /**
     * 分页数据优化
     */
    public function paginateOptimize($query, $page = 1, $limit = 10)
    {
        // 优化COUNT查询
        $total = Cache::remember("pagination:total:{$query->buildSql()}", function() use ($query) {
            return $query->count();
        }, 60);
        
        // 获取数据
        $list = $query->page($page, $limit)->select();
        
        return [
            'list' => $list,
            'total' => $total,
            'page' => $page,
            'limit' => $limit,
            'pages' => ceil($total / $limit)
        ];
    }
    
    /**
     * CDN地址转换
     */
    protected function getCdnUrl($path)
    {
        if (empty($path)) {
            return '';
        }
        
        if (strpos($path, 'http') === 0) {
            return $path;
        }
        
        return config('filesystem.cdn_domain') . $path;
    }
}
```

### 12.4 故障处理流程

#### 12.4.1 建立故障处理机制

```php
// 创建文件：app/services/alert/AlertService.php
<?php
namespace app\services\alert;

use think\facade\Log;

class AlertService
{
    protected $channels = [];
    
    public function __construct()
    {
        // 初始化告警渠道
        $this->channels = [
            'sms' => new SmsAlertChannel(),
            'email' => new EmailAlertChannel(),
            'wechat' => new WechatAlertChannel(),
        ];
    }
    
    /**
     * 发送告警
     */
    public function send($level, $message, $data = [])
    {
        // 记录日志
        Log::error("[ALERT] {$level}: {$message}", $data);
        
        // 根据级别选择通知渠道
        $channels = $this->getChannelsByLevel($level);
        
        foreach ($channels as $channel) {
            try {
                $this->channels[$channel]->send($level, $message, $data);
            } catch (\Exception $e) {
                Log::error("告警发送失败: " . $e->getMessage());
            }
        }
    }
    
    /**
     * 根据级别获取通知渠道
     */
    protected function getChannelsByLevel($level)
    {
        $config = [
            'critical' => ['sms', 'email', 'wechat'],  // 严重：全渠道通知
            'error' => ['email', 'wechat'],            // 错误：邮件和微信
            'warning' => ['wechat'],                    // 警告：仅微信
            'info' => []                                // 信息：不通知
        ];
        
        return $config[$level] ?? [];
    }
}

// 告警使用示例
class OrderService
{
    public function createOrder($data)
    {
        try {
            // 创建订单逻辑
            
        } catch (\Exception $e) {
            // 发送告警
            app()->make(AlertService::class)->send('error', '订单创建失败', [
                'error' => $e->getMessage(),
                'user_id' => $data['user_id'] ?? 0,
                'data' => $data
            ]);
            
            throw $e;
        }
    }
}
```

#### 12.4.2 故障自动恢复

```php
// 创建文件：app/command/HealthCheck.php
<?php
namespace app\command;

use think\console\Command;
use think\console\Input;
use think\console\Output;

class HealthCheck extends Command
{
    protected function configure()
    {
        $this->setName('health:check')
             ->setDescription('健康检查和自动恢复');
    }
    
    protected function execute(Input $input, Output $output)
    {
        $checks = [
            'database' => $this->checkDatabase(),
            'redis' => $this->checkRedis(),
            'queue' => $this->checkQueue(),
            'storage' => $this->checkStorage(),
        ];
        
        $hasError = false;
        foreach ($checks as $name => $result) {
            if (!$result['status']) {
                $hasError = true;
                $output->error("{$name}: {$result['message']}");
                
                // 尝试自动恢复
                $this->tryRecover($name);
            } else {
                $output->info("{$name}: OK");
            }
        }
        
        return $hasError ? 1 : 0;
    }
    
    /**
     * 检查数据库
     */
    protected function checkDatabase()
    {
        try {
            \think\facade\Db::query("SELECT 1");
            return ['status' => true, 'message' => 'OK'];
        } catch (\Exception $e) {
            return ['status' => false, 'message' => $e->getMessage()];
        }
    }
    
    /**
     * 检查Redis
     */
    protected function checkRedis()
    {
        try {
            $redis = \think\facade\Cache::store('redis')->handler();
            $redis->ping();
            return ['status' => true, 'message' => 'OK'];
        } catch (\Exception $e) {
            return ['status' => false, 'message' => $e->getMessage()];
        }
    }
    
    /**
     * 尝试恢复服务
     */
    protected function tryRecover($service)
    {
        switch ($service) {
            case 'redis':
                // 重启Redis
                exec('systemctl restart redis', $output, $code);
                if ($code === 0) {
                    Log::info("Redis服务已自动重启");
                }
                break;
                
            case 'queue':
                // 重启队列
                exec('php think queue:restart', $output, $code);
                if ($code === 0) {
                    Log::info("队列服务已自动重启");
                }
                break;
        }
    }
}
```

### 12.5 数据分析与报表

#### 12.5.1 业务数据分析

```php
// 创建文件：app/services/analysis/BusinessAnalysis.php
<?php
namespace app\services\analysis;

use think\facade\Db;

class BusinessAnalysis
{
    /**
     * 用户行为分析
     */
    public function userBehaviorAnalysis($startDate, $endDate)
    {
        // 访问路径分析
        $pathAnalysis = Db::query("
            SELECT 
                path,
                COUNT(*) as pv,
                COUNT(DISTINCT user_id) as uv,
                AVG(duration) as avg_duration
            FROM eb_user_visit_log
            WHERE DATE(create_time) BETWEEN ? AND ?
            GROUP BY path
            ORDER BY pv DESC
            LIMIT 20
        ", [$startDate, $endDate]);
        
        // 用户留存分析
        $retentionAnalysis = $this->calculateRetention($startDate, $endDate);
        
        // 购买转化漏斗
        $conversionFunnel = $this->calculateConversionFunnel($startDate, $endDate);
        
        return compact('pathAnalysis', 'retentionAnalysis', 'conversionFunnel');
    }
    
    /**
     * 计算用户留存
     */
    protected function calculateRetention($startDate, $endDate)
    {
        $sql = "
            SELECT 
                DATE(a.create_time) as cohort_date,
                COUNT(DISTINCT a.uid) as new_users,
                COUNT(DISTINCT b1.uid) as day_1,
                COUNT(DISTINCT b7.uid) as day_7,
                COUNT(DISTINCT b30.uid) as day_30
            FROM eb_user a
            LEFT JOIN eb_user_visit_log b1 ON a.uid = b1.user_id 
                AND DATE(b1.create_time) = DATE_ADD(DATE(a.create_time), INTERVAL 1 DAY)
            LEFT JOIN eb_user_visit_log b7 ON a.uid = b7.user_id 
                AND DATE(b7.create_time) = DATE_ADD(DATE(a.create_time), INTERVAL 7 DAY)
            LEFT JOIN eb_user_visit_log b30 ON a.uid = b30.user_id 
                AND DATE(b30.create_time) = DATE_ADD(DATE(a.create_time), INTERVAL 30 DAY)
            WHERE DATE(a.create_time) BETWEEN ? AND ?
            GROUP BY cohort_date
        ";
        
        $data = Db::query($sql, [$startDate, $endDate]);
        
        // 计算留存率
        foreach ($data as &$row) {
            $row['retention_1d'] = $row['new_users'] > 0 
                ? round($row['day_1'] / $row['new_users'] * 100, 2) : 0;
            $row['retention_7d'] = $row['new_users'] > 0 
                ? round($row['day_7'] / $row['new_users'] * 100, 2) : 0;
            $row['retention_30d'] = $row['new_users'] > 0 
                ? round($row['day_30'] / $row['new_users'] * 100, 2) : 0;
        }
        
        return $data;
    }
    
    /**
     * 计算转化漏斗
     */
    protected function calculateConversionFunnel($startDate, $endDate)
    {
        $timeRange = [
            strtotime($startDate),
            strtotime($endDate . ' 23:59:59')
        ];
        
        // 各阶段用户数
        $stages = [
            'visit' => Db::name('user_visit_log')
                ->whereTime('create_time', 'between', $timeRange)
                ->group('user_id')
                ->count(),
                
            'view_product' => Db::name('user_visit_log')
                ->whereTime('create_time', 'between', $timeRange)
                ->where('path', 'like', '%/goods/%')
                ->group('user_id')
                ->count(),
                
            'add_cart' => Db::name('store_cart')
                ->whereTime('add_time', 'between', $timeRange)
                ->group('uid')
                ->count(),
                
            'create_order' => Db::name('store_order')
                ->whereTime('add_time', 'between', $timeRange)
                ->group('uid')
                ->count(),
                
            'pay_order' => Db::name('store_order')
                ->whereTime('add_time', 'between', $timeRange)
                ->where('paid', 1)
                ->group('uid')
                ->count(),
        ];
        
        // 计算转化率
        $funnel = [];
        $prevCount = 0;
        foreach ($stages as $stage => $count) {
            $funnel[] = [
                'stage' => $stage,
                'count' => $count,
                'rate' => $prevCount > 0 ? round($count / $prevCount * 100, 2) : 100
            ];
            $prevCount = $count;
        }
        # CRMEB 5.6.1 庆人府商城二次开发完全教程

## 目录

- [前言：写给零基础的你](#前言写给零基础的你)
- [第一章：认识CRMEB - 你的商城开发利器](#第一章认识crmeb---

## 第九章：供应商管理系统开发 - 构建供应链网络

### 9.1 理解供应商系统

供应商系统就像一个**商场招商部**：
- 🏪 **入驻管理**：审核供应商资质，像审核商铺入驻
- 📦 **商品管理**：供应商自主上架商品，像商铺进货
- 💰 **结算管理**：自动分账结算，像商场收租金

### 9.2 供应商入驻系统

#### 9.2.1 创建供应商服务

```php
// 创建文件：app/services/supplier/SupplierServices.php
<?php
namespace app\services\supplier;

use app\services\BaseServices;
use app\dao\supplier\SupplierDao;
use think\facade\Db;

class SupplierServices extends BaseServices
{
    public function __construct(SupplierDao $dao)
    {
        $this->dao = $dao;
    }
    
    /**
     * 供应商申请入驻
     * 就像商户申请入驻商场
     */
    public function applySupplier($userId, $data)
    {
        // 检查是否已经是供应商
        $exists = $this->dao->count(['user_id' => $userId]);
        if ($exists) {
            throw new \Exception('您已经是供应商了');
        }
        
        // 验证必要信息
        if (empty($data['supplier_name']) || empty($data['contact_name']) || empty($data['contact_phone'])) {
            throw new \Exception('请填写完整信息');
        }
        
        // 创建供应商申请
        $supplierData = [
            'user_id' => $userId,
            'supplier_name' => $data['supplier_name'],
            'contact_name' => $data['contact_name'],
            'contact_phone' => $data['contact_phone'],
            'business_license' => $data['business_license'] ?? '',
            'qualification_img' => $data['qualification_img'] ?? '',
            'bank_name' => $data['bank_name'] ?? '',
            'bank_account' => $data['bank_account'] ?? '',
            'bank_account_name' => $data['bank_account_name'] ?? '',
            'status' => 1,  // 待审核
            'create_time' => time()
        ];
        
        $supplier = $this->dao->save($supplierData);
        
        // 发送通知给管理员
        $this->sendApplyNotice($supplier);
        
        return $supplier;
    }
    
    /**
     * 审核供应商
     * 管理员审核供应商入驻申请
     */
    public function auditSupplier($supplierId, $status, $reason = '')
    {
        $supplier = $this->dao->get($supplierId);
        if (!$supplier) {
            throw new \Exception('供应商不存在');
        }
        
        if ($supplier['status'] != 1) {
            throw new \Exception('该申请已处理');
        }
        
        Db::startTrans();
        try {
            // 更新状态
            $updateData = [
                'status' => $status,  // 2:通过 3:拒绝
                'audit_time' => time(),
                'audit_reason' => $reason
            ];
            
            if ($status == 2) {
                // 通过审核
                // 1. 设置默认佣金比例
                $updateData['commission_rate'] = 10;  // 默认10%
                $updateData['settlement_cycle'] = 1;  // 默认周结
                
                // 2. 创建供应商专属角色
                $this->createSupplierRole($supplier['user_id']);
                
                // 3. 初始化供应商钱包
                $this->initSupplierWallet($supplierId);
            }
            
            $this->dao->update($supplierId, $updateData);
            
            // 发送审核结果通知
            $this->sendAuditNotice($supplier['user_id'], $status, $reason);
            
            Db::commit();
            
            return true;
        } catch (\Exception $e) {
            Db::rollback();
            throw $e;
        }
    }
    
    /**
     * 创建供应商角色
     * 赋予供应商后台权限
     */
    protected function createSupplierRole($userId)
    {
        // 更新用户类型
        app()->make(\app\services\user\UserServices::class)
            ->update(['uid' => $userId], ['user_type' => 'supplier']);
        
        // 这里可以配置供应商的菜单权限
        // 如：商品管理、订单管理、财务管理等
    }
    
    /**
     * 初始化供应商钱包
     */
    protected function initSupplierWallet($supplierId)
    {
        app()->make(SupplierWalletServices::class)->initWallet($supplierId);
    }
    
    /**
     * 获取供应商信息
     */
    public function getSupplierInfo($userId)
    {
        return $this->dao->getOne(['user_id' => $userId]);
    }
    
    /**
     * 获取供应商列表
     */
    public function getSupplierList($where)
    {
        [$page, $limit] = $this->getPageValue();
        
        $query = $this->dao->getModel();
        
        // 搜索条件
        if (!empty($where['keyword'])) {
            $query = $query->where('supplier_name|contact_name|contact_phone', 'like', "%{$where['keyword']}%");
        }
        
        if ($where['status'] !== '') {
            $query = $query->where('status', $where['status']);
        }
        
        $list = $query->page($page, $limit)->select();
        $count = $query->count();
        
        // 统计每个供应商的数据
        foreach ($list as &$item) {
            $item['product_count'] = app()->make(SupplierProductServices::class)
                ->dao->count(['supplier_id' => $item['id']]);
            
            $item['order_count'] = app()->make(\app\services\order\StoreOrderServices::class)
                ->dao->count(['supplier_id' => $item['id']]);
            
            // 格式化时间
            $item['create_time_text'] = date('Y-m-d H:i', $item['create_time']);
        }
        
        return compact('list', 'count');
    }
}
```

#### 9.2.2 供应商商品管理服务

```php
// 创建文件：app/services/supplier/SupplierProductServices.php
<?php
namespace app\services\supplier;

use app\services\BaseServices;
use app\dao\supplier\SupplierProductDao;

class SupplierProductServices extends BaseServices
{
    public function __construct(SupplierProductDao $dao)
    {
        $this->dao = $dao;
    }
    
    /**
     * 供应商添加商品
     * 就像商户在自己店铺上架商品
     */
    public function addProduct($supplierId, $data)
    {
        // 检查商品是否已存在
        $exists = $this->dao->count([
            'supplier_id' => $supplierId,
            'product_id' => $data['product_id']
        ]);
        
        if ($exists) {
            throw new \Exception('该商品已添加');
        }
        
        // 获取平台商品信息
        $productService = app()->make(\app\services\product\product\StoreProductServices::class);
        $product = $productService->get($data['product_id']);
        
        if (!$product || !$product['is_show']) {
            throw new \Exception('商品不存在或已下架');
        }
        
        // 验证供货价格
        if ($data['supplier_price'] >= $product['price']) {
            throw new \Exception('供货价格不能高于销售价格');
        }
        
        // 创建供应商商品
        $supplierProduct = [
            'supplier_id' => $supplierId,
            'product_id' => $data['product_id'],
            'supplier_price' => $data['supplier_price'],
            'stock' => $data['stock'],
            'min_order' => $data['min_order'] ?? 1,
            'delivery_time' => $data['delivery_time'] ?? 3,  // 默认3天发货
            'status' => 1,  // 待审核
            'create_time' => time()
        ];
        
        return $this->dao->save($supplierProduct);
    }
    
    /**
     * 更新商品库存
     * 供应商补货或调整库存
     */
    public function updateStock($supplierId, $productId, $stock, $type = 'set')
    {
        $supplierProduct = $this->dao->getOne([
            'supplier_id' => $supplierId,
            'product_id' => $productId
        ]);
        
        if (!$supplierProduct) {
            throw new \Exception('商品不存在');
        }
        
        if ($type == 'set') {
            // 设置库存
            $newStock = $stock;
        } elseif ($type == 'inc') {
            // 增加库存
            $newStock = $supplierProduct['stock'] + $stock;
        } else {
            // 减少库存
            $newStock = max(0, $supplierProduct['stock'] - $stock);
        }
        
        $this->dao->update($supplierProduct['id'], [
            'stock' => $newStock,
            'update_time' => time()
        ]);
        
        // 同步更新平台商品库存
        $this->syncPlatformStock($productId);
        
        return true;
    }
    
    /**
     * 同步平台商品库存
     * 所有供应商的库存总和
     */
    protected function syncPlatformStock($productId)
    {
        // 获取所有供应商的该商品库存
        $totalStock = $this->dao->getModel()
            ->where('product_id', $productId)
            ->where('status', 2)  // 已审核
            ->sum('stock');
        
        // 更新平台商品库存
        app()->make(\app\services\product\product\StoreProductServices::class)
            ->update($productId, ['stock' => $totalStock]);
    }
    
    /**
     * 订单商品分配
     * 当用户下单时，分配给合适的供应商
     */
    public function allocateOrderProduct($productId, $quantity)
    {
        // 获取有库存的供应商，按价格排序
        $suppliers = $this->dao->getModel()
            ->where('product_id', $productId)
            ->where('status', 2)
            ->where('stock', '>=', $quantity)
            ->order('supplier_price asc')
            ->select();
        
        if ($suppliers->isEmpty()) {
            throw new \Exception('商品库存不足');
        }
        
        // 选择价格最低的供应商
        $supplier = $suppliers[0];
        
        // 扣减库存
        $this->updateStock($supplier['supplier_id'], $productId, $quantity, 'dec');
        
        return [
            'supplier_id' => $supplier['supplier_id'],
            'supplier_price' => $supplier['supplier_price'],
            'supplier_product_id' => $supplier['id']
        ];
    }
}
```

### 9.3 供应商后台开发

#### 9.3.1 供应商控制器

```php
// 创建文件：app/supplierapi/controller/v1/product/Product.php
<?php
namespace app\supplierapi\controller\v1\product;

use app\supplierapi\controller\AuthController;
use app\services\supplier\SupplierProductServices;

class Product extends AuthController
{
    /**
     * 商品列表
     */
    public function index()
    {
        $where = $this->request->getMore([
            ['keyword', ''],
            ['status', ''],
            ['page', 1],
            ['limit', 10]
        ]);
        
        $supplierInfo = $this->getSupplierInfo();
        $where['supplier_id'] = $supplierInfo['id'];
        
        $productService = app()->make(SupplierProductServices::class);
        $list = $productService->getList($where);
        
        return app('json')->success($list);
    }
    
    /**
     * 添加商品
     */
    public function save()
    {
        $data = $this->request->postMore([
            ['product_id', 0],
            ['supplier_price', 0],
            ['stock', 0],
            ['min_order', 1],
            ['delivery_time', 3]
        ]);
        
        $supplierInfo = $this->getSupplierInfo();
        
        $productService = app()->make(SupplierProductServices::class);
        $result = $productService->addProduct($supplierInfo['id'], $data);
        
        return app('json')->success('添加成功');
    }
    
    /**
     * 更新库存
     */
    public function updateStock($id)
    {
        $stock = $this->request->post('stock', 0);
        $type = $this->request->post('type', 'set');
        
        $supplierInfo = $this->getSupplierInfo();
        
        $productService = app()->make(SupplierProductServices::class);
        
        // 验证商品归属
        $product = $productService->dao->get($id);
        if (!$product || $product['supplier_id'] != $supplierInfo['id']) {
            return app('json')->fail('商品不存在');
        }
        
        $productService->updateStock($supplierInfo['id'], $product['product_id'], $stock, $type);
        
        return app('json')->success('更新成功');
    }
    
    /**
     * 获取可添加的商品列表
     * 平台商品库，供应商选择
     */
    public function platformProducts()
    {
        $keyword = $this->request->get('keyword', '');
        $supplierInfo = $this->getSupplierInfo();
        
        // 获取平台商品
        $productService = app()->make(\app\services\product\product\StoreProductServices::class);
        
        // 获取已添加的商品ID
        $addedProductIds = app()->make(SupplierProductServices::class)
            ->dao->getModel()
            ->where('supplier_id', $supplierInfo['id'])
            ->column('product_id');
        
        $where = [
            ['is_show', '=', 1],
            ['is_del', '=', 0]
        ];
        
        if ($keyword) {
            $where[] = ['store_name', 'like', "%{$keyword}%"];
        }
        
        if ($addedProductIds) {
            $where[] = ['id', 'not in', $addedProductIds];
        }
        
        $list = $productService->getList($where, ['id', 'store_name', 'image', 'price']);
        
        return app('json')->success($list);
    }
}
```

#### 9.3.2 供应商订单管理

```php
// 创建文件：app/supplierapi/controller/v1/order/Order.php
<?php
namespace app\supplierapi\controller\v1\order;

use app\supplierapi\controller\AuthController;
use app\services\supplier\SupplierOrderServices;

class Order extends AuthController
{
    /**
     * 订单列表
     */
    public function index()
    {
        $where = $this->request->getMore([
            ['order_id', ''],
            ['status', ''],
            ['date_range', []],
            ['page', 1],
            ['limit', 10]
        ]);
        
        $supplierInfo = $this->getSupplierInfo();
        $where['supplier_id'] = $supplierInfo['id'];
        
        $orderService = app()->make(SupplierOrderServices::class);
        $list = $orderService->getList($where);
        
        return app('json')->success($list);
    }
    
    /**
     * 订单详情
     */
    public function detail($id)
    {
        $supplierInfo = $this->getSupplierInfo();
        
        $orderService = app()->make(SupplierOrderServices::class);
        $order = $orderService->getDetail($id, $supplierInfo['id']);
        
        if (!$order) {
            return app('json')->fail('订单不存在');
        }
        
        return app('json')->success($order);
    }
    
    /**
     * 发货
     */
    public function ship($id)
    {
        $data = $this->request->postMore([
            ['express_company', ''],
            ['express_number', ''],
            ['remark', '']
        ]);
        
        if (empty($data['express_company']) || empty($data['express_number'])) {
            return app('json')->fail('请填写物流信息');
        }
        
        $supplierInfo = $this->getSupplierInfo();
        
        $orderService = app()->make(SupplierOrderServices::class);
        $result = $orderService->shipOrder($id, $supplierInfo['id'], $data);
        
        return app('json')->success('发货成功');
    }
    
    /**
     * 打印订单
     */
    public function printOrder($id)
    {
        $supplierInfo = $this->getSupplierInfo();
        
        $orderService = app()->make(SupplierOrderServices::class);
        $order = $orderService->getDetail($id, $supplierInfo['id']);
        
        if (!$order) {
            return app('json')->fail('订单不存在');
        }
        
        // 生成打印数据
        $printData = [
            'order_id' => $order['order_id'],
            'create_time' => date('Y-m-d H:i:s', $order['create_time']),
            'user_name' => $order['real_name'],
            'user_phone' => $order['user_phone'],
            'user_address' => $order['user_address'],
            'products' => $order['cart_info'],
            'total_num' => $order['total_num'],
            'pay_price' => $order['pay_price'],
            'mark' => $order['mark']
        ];
        
        return app('json')->success($printData);
    }
}
```

### 9.4 供应商财务管理

#### 9.4.1 供应商钱包服务

```php
// 创建文件：app/services/supplier/SupplierWalletServices.php
<?php
namespace app\services\supplier;

use app\services\BaseServices;
use app\dao\supplier\SupplierWalletDao;
use think\facade\Db;

class SupplierWalletServices extends BaseServices
{
    public function __construct(SupplierWalletDao $dao)
    {
        $this->dao = $dao;
    }
    
    /**
     * 初始化钱包
     */
    public function initWallet($supplierId)
    {
        return $this->dao->save([
            'supplier_id' => $supplierId,
            'balance' => 0,
            'frozen_balance' => 0,
            'total_income' => 0,
            'total_withdraw' => 0,
            'create_time' => time()
        ]);
    }
    
    /**
     * 订单结算
     * 当订单完成时，给供应商结算货款
     */
    public function orderSettlement($order, $supplierOrder)
    {
        Db::startTrans();
        try {
            // 计算结算金额
            $settlementAmount = $this->calculateSettlement($order, $supplierOrder);
            
            // 获取钱包
            $wallet = $this->dao->getOne(['supplier_id' => $supplierOrder['supplier_id']]);
            
            // 根据结算周期处理
            $supplier = app()->make(SupplierServices::class)->dao->get($supplierOrder['supplier_id']);
            
            if ($supplier['settlement_cycle'] == 1) {
                // 周结：先到冻结余额
                $this->dao->inc($wallet['id'], 'frozen_balance', $settlementAmount);
            } else {
                // 月结：直接到可用余额
                $this->dao->inc($wallet['id'], 'balance', $settlementAmount);
                $this->dao->inc($wallet['id'], 'total_income', $settlementAmount);
            }
            
            // 记录结算明细
            $this->recordSettlement([
                'supplier_id' => $supplierOrder['supplier_id'],
                'order_id' => $order['id'],
                'order_sn' => $order['order_id'],
                'product_amount' => $supplierOrder['supplier_price'] * $supplierOrder['quantity'],
                'commission_rate' => $supplier['commission_rate'],
                'commission_amount' => $settlementAmount * $supplier['commission_rate'] / 100,
                'settlement_amount' => $settlementAmount,
                'status' => $supplier['settlement_cycle'] == 1 ? 0 : 1,  // 0:待结算 1:已结算
                'create_time' => time()
            ]);
            
            Db::commit();
            
            return true;
        } catch (\Exception $e) {
            Db::rollback();
            throw $e;
        }
    }
    
    /**
     * 计算结算金额
     * 供货价 - 平台佣金
     */
    protected function calculateSettlement($order, $supplierOrder)
    {
        $supplier = app()->make(SupplierServices::class)->dao->get($supplierOrder['supplier_id']);
        
        // 供货总额
        $supplierAmount = $supplierOrder['supplier_price'] * $supplierOrder['quantity'];
        
        // 扣除平台佣金
        $commissionAmount = $supplierAmount * $supplier['commission_rate'] / 100;
        
        return $supplierAmount - $commissionAmount;
    }
    
    /**
     * 周结算
     * 定时任务，每周一结算上周的冻结金额
     */
    public function weeklySettlement()
    {
        // 获取所有周结的供应商
        $suppliers = app()->make(SupplierServices::class)->dao->getModel()
            ->where('settlement_cycle', 1)
            ->where('status', 2)
            ->select();
        
        foreach ($suppliers as $supplier) {
            $wallet = $this->dao->getOne(['supplier_id' => $supplier['id']]);
            
            if ($wallet['frozen_balance'] > 0) {
                // 转移冻结余额到可用余额
                $this->dao->update($wallet['id'], [
                    'balance' => $wallet['balance'] + $wallet['frozen_balance'],
                    'total_income' => $wallet['total_income'] + $wallet['frozen_balance'],
                    'frozen_balance' => 0,
                    'update_time' => time()
                ]);
                
                // 更新结算记录状态
                app()->make(SupplierSettlementDao::class)->update(
                    [
                        'supplier_id' => $supplier['id'],
                        'status' => 0
                    ],
                    ['status' => 1, 'settlement_time' => time()]
                );
                
                // 发送结算通知
                $this->sendSettlementNotice($supplier['id'], $wallet['frozen_balance']);
            }
        }
    }
    
    /**
     * 提现申请
     */
    public function withdraw($supplierId, $amount, $accountInfo)
    {
        $wallet = $this->dao->getOne(['supplier_id' => $supplierId]);
        
        if ($wallet['balance'] < $amount) {
            throw new \Exception('余额不足');
        }
        
        if ($amount < 100) {
            throw new \Exception('最低提现金额为100元');
        }
        
        Db::startTrans();
        try {
            // 扣减余额
            $this->dao->dec($wallet['id'], 'balance', $amount);
            $this->dao->inc($wallet['id'], 'total_withdraw', $amount);
            
            // 创建提现记录
            app()->make(SupplierWithdrawServices::class)->create([
                'supplier_id' => $supplierId,
                'amount' => $amount,
                'bank_name' => $accountInfo['bank_name'],
                'bank_account' => $accountInfo['bank_account'],
                'bank_account_name' => $accountInfo['bank_account_name'],
                'status' => 0,  // 待审核
                'create_time' => time()
            ]);
            
            Db::commit();
            
            return true;
        } catch (\Exception $e) {
            Db::rollback();
            throw $e;
        }
    }
}
```

### 9.5 供应商端界面开发

#### 9.5.1 供应商入驻申请页面

```vue
<!-- 创建文件：template/uni-app/pages/supplier/apply.vue -->
<template>
  <view class="supplier-apply">
    <view class="apply-header">
      <image src="/static/images/supplier-banner.jpg" class="banner"></image>
      <view class="header-content">
        <view class="title">成为供应商</view>
        <view class="desc">加入庆人府商城，开启农产品销售新渠道</view>
      </view>
    </view>
    
    <!-- 申请表单 -->
    <view class="apply-form">
      <view class="form-section">
        <view class="section-title">基本信息</view>
        
        <view class="form-item">
          <view class="label required">供应商名称</view>
          <input v-model="form.supplier_name" 
                 placeholder="请输入供应商名称"
                 maxlength="50" />
        </view>
        
        <view class="form-item">
          <view class="label required">联系人</view>
          <input v-model="form.contact_name" 
                 placeholder="请输入联系人姓名"
                 maxlength="20" />
        </view>
        
        <view class="form-item">
          <view class="label required">联系电话</view>
          <input v-model="form.contact_phone" 
                 placeholder="请输入联系电话"
                 type="number"
                 maxlength="11" />
        </view>
      </view>
      
      <view class="form-section">
        <view class="section-title">资质信息</view>
        
        <view class="form-item">
          <view class="label required">营业执照</view>
          <view class="upload-area">
            <view class="upload-box" @click="uploadImage('business_license')">
              <image v-if="form.business_license" 
                     :src="form.business_license" 
                     mode="aspectFill"></image>
              <view v-else class="upload-placeholder">
                <text class="iconfont icon-camera"></text>
                <text>上传营业执照</text>
              </view>
            </view>
          </view>
        </view>
        
        <view class="form-item">
          <view class="label">其他资质</view>
          <view class="upload-area">
            <view class="upload-list">
              <view class="upload-item" 
                    v-for="(img, index) in form.qualification_img" 
                    :key="index">
                <image :src="img" mode="aspectFill"></image>
                <view class="delete-btn" @click="deleteImage(index)">
                  <text class="iconfont icon-close"></text>
                </view>
              </view>
              <view class="upload-box" 
                    @click="uploadImage('qualification')"
                    v-if="form.qualification_img.length < 5">
                <view class="upload-placeholder">
                  <text class="iconfont icon-add"></text>
                  <text>添加资质</text>
                </view>
              </view>
            </view>
            <view class="upload-tips">最多上传5张，支持食品经营许可证等</view>
          </view>
        </view>
      </view>
      
      <view class="form-section">
        <view class="section-title">结算信息</view>
        
        <view class="form-item">
          <view class="label required">开户银行</view>
          <input v-model="form.bank_name" 
                 placeholder="请输入开户银行"
                 maxlength="50" />
        </view>
        
        <view class="form-item">
          <view class="label required">银行账号</view>
          <input v-model="form.bank_account" 
                 placeholder="请输入银行账号"
                 type="number"
                 maxlength="30" />
        </view>
        
        <view class="form-item">
          <view class="label required">开户名</view>
          <input v-model="form.bank_account_name" 
                 placeholder="请输入开户名（需与营业执照一致）"
                 maxlength="50" />
        </view>
      </view>
      
      <!-- 协议 -->
      <view class="agreement">
        <checkbox v-model="agreed" />
        <text>我已阅读并同意</text>
        <text class="link" @click="showAgreement">《供应商入驻协议》</text>
      </view>
    </view>
    
    <!-- 提交按钮 -->
    <view class="submit-section">
      <button class="submit-btn" @click="submitApply" :disabled="!canSubmit">
        提交申请
      </button>
    </view>
  </view>
</template>

<script>
import { applySupplier } from '@/api/supplier.js'
import { uploadImage } from '@/api/common.js'

export default {
  data() {
    return {
      form: {
        supplier_name: '',
        contact_name: '',
        contact_phone: '',
        business_license: '',
        qualification_img: [],
        bank_name: '',
        bank_account: '',
        bank_account_name: ''
      },
      agreed: false
    }
  },
  
  computed: {
    canSubmit() {
      return this.form.supplier_name && 
             this.form.contact_name && 
             this.form.contact_phone &&
             this.form.business_license &&
             this.form.bank_name &&
             this.form.bank_account &&
             this.form.bank_account_name &&
             this.agreed
    }
  },
  
  methods: {
    // 上传图片
    uploadImage(type) {
      uni.chooseImage({
        count: type === 'business_license' ? 1 : 5 - this.form.qualification_img.length,
        success: async (res) => {
          uni.showLoading({ title: '上传中...' })
          
          try {
            for (let filePath of res.tempFilePaths) {
              const uploadRes = await uploadImage(filePath)
              
              if (type === 'business_license') {
                this.form.business_license = uploadRes.data.url
              } else {
                this.form.qualification_img.push(uploadRes.data.url)
              }
            }
            
            uni.hideLoading()
          } catch (error) {
            uni.hideLoading()
            uni.showToast({
              title: '上传失败',
              icon: 'none'
            })
          }
        }
      })
    },
    
    // 删除图片
    deleteImage(index) {
      this.form.qualification_img.splice(index, 1)
    },
    
    // 提交申请
    async submitApply() {
      if (!this.canSubmit) return
      
      // 手机号验证
      if (!/^1[3-9]\d{9}$/.test(this.form.contact_phone)) {
        uni.showToast({
          title: '请输入正确的手机号',
          icon: 'none'
        })
        return
      }
      
      uni.showLoading({ title: '提交中...' })
      
      try {
        await applySupplier(this.form)
        
        uni.hideLoading()
        uni.showModal({
          title: '申请成功',
          content: '您的申请已提交，我们会在1-3个工作日内审核',
          showCancel: false,
          success: () => {
            uni.navigateBack()
          }
        })
      } catch (error) {
        uni.hideLoading()
        uni.showToast({
          title: error.message || '提交失败',
          icon: 'none'
        })
      }
    },
    
    // 显示协议
    showAgreement() {
      uni.navigateTo({
        url: '/pages/supplier/agreement'
      })
    }
  }
}
</script>

<style lang="scss">
.supplier-apply {
  background: #f5f5f5;
  min-height: 100vh;
  padding-bottom: 150rpx;
  
  .apply-header {
    position: relative;
    height: 400rpx;
    
    .banner {
      width: 100%;
      height: 100%;
    }
    
    .header-content {
      position: absolute;
      bottom: 40rpx;
      left: 40rpx;
      color: #fff;
      
      .title {
        font-size: 48rpx;
        font-weight: bold;
        margin-bottom: 10rpx;
      }
      
      .desc {
        font-size: 28rpx;
        opacity: 0.9;
      }
    }
  }
  
  .apply-form {
    padding: 0 30rpx;
    
    .form-section {
      background: #fff;
      border-radius: 20rpx;
      padding: 30rpx;
      margin-top: 20rpx;
      
      .section-title {
        font-size: 32rpx;
        font-weight: bold;
        margin-bottom: 30rpx;
        padding-left: 20rpx;
        border-left: 6rpx solid #ff6b6b;
      }
    }
    
    .form-item {
      margin-bottom: 30rpx;
      
      .label {
        font-size: 30rpx;
        margin-bottom: 20rpx;
        
        &.required::before {
          content: '*';
          color: #ff6b6b;
          margin-right: 8rpx;
        }
      }
      
      input {
        width: 100%;
        height: 88rpx;
        padding: 0 30rpx;
        border: 2rpx solid #e5e5e5;
        border-radius: 10rpx;
        font-size: 30rpx;
      }
    }
    
    .upload-area {
      .upload-box {
        width: 200rpx;
        height: 200rpx;
        border: 2rpx dashed #ddd;
        border-radius: 10rpx;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        
        image {
          width: 100%;
          height: 100%;
          border-radius: 10rpx;
        }
        
        .upload-placeholder {
          text-align: center;
          color: #999;
          
          .iconfont {
            font-size: 48rpx;
            display: block;
            margin-bottom: 10rpx;
          }
          
          text {
            font-size: 26rpx;
          }
        }
      }
      
      .upload-list {
        display: flex;
        flex-wrap: wrap;
        gap: 20rpx;
        
        .upload-item {
          position: relative;
          width: 200rpx;
          height: 200rpx;
          
          image {
            width: 100%;
            height: 100%;
            border-radius: 10rpx;
          }
          
          .delete-btn {
            position: absolute;
            top: -10rpx;
            right: -10rpx;
            width: 40rpx;
            height: 40rpx;
            background: #ff6b6b;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            
            .iconfont {
              color: #fff;
              font-size: 24rpx;
            }
          }
        }
      }
      
      .upload-tips {
        font-size: 24rpx;
        color: #999;
        margin-top: 20rpx;
      }
    }
    
    .agreement {
      display: flex;
      align-items: center;
      justify-content: center;
      margin-top: 40rpx;
      font-size: 28rpx;
      
      checkbox {
        margin-right: 10rpx;
      }
      
      .link {
        color: #576b95;
        text-decoration: underline;
      }
    }
  }
  
  .submit-section {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    padding: 30rpx;
    background: #fff;
    box-shadow: 0 -2rpx 10rpx rgba(0,0,0,0.05);
    
    .submit-btn {
      width: 100%;
      height: 88rpx;
      background: linear-gradient(45deg, #ff6b6b, #ff8e53);
      color: #fff;
      font-size: 32rpx;
      border-radius: 44rpx;
      
      &[disabled] {
        opacity: 0.5;
      }
    }
  }
}
</style>
```

### 9.6 本章练习

1. **功能实现**：
   - 实现供应商评分系统
   - 添加供应商商品推荐功能
   - 实现多供应商比价功能

2. **思考题**：
   - 如何平衡供应商之间的订单分配？
   - 如何处理供应商发货延迟的问题？

3. **扩展任务**：
   - 开发供应商数据分析报表
   - 实现智能订单分配算法
   - 添加供应商培训管理系统

---你的商城开发利器)
- [第二章：搭建开发环境 - 打造你的工作台](#第二章搭建开发环境---打造你的工作台)
- [第三章：CRMEB项目结构详解 - 认识你的新家](#第三章crmeb项目结构详解---认识你的新家)
- [第四章：数据库设计与扩展 - 商城的记忆中心](#第四章数据库设计与扩展---商城的记忆中心)
- [第五章：合伙人管理系统开发 - 打造你的商业帝国](#第五章合伙人管理系统开发---打造你的商业帝国)
- [第六章：礼品卡系统开发 - 创造虚拟价值](#第六章礼品卡系统开发---创造虚拟价值)
- [第七章：先用后付系统开发 - 建立信任经济](#第七章先用后付系统开发---建立信任经济)
- [第八章：创新分销系统开发 - 让用户帮你卖货](#第八章创新分销系统开发---让用户帮你卖货)
- [第九章：供应商管理系统开发 - 构建供应链网络](#第九章供应商管理系统开发---构建供应链网络)
- [第十章：前端界面开发 - 让商城更美观](#第十章前端界面开发---让商城更美观)
- [第十一章：系统部署与上线 - 让商城活起来](#第十一章系统部署与上线---让商城活起来)
- [第十二章：运维与优化 - 让商城稳定运行](#第十二章运维与优化---让商城稳定运行)

---

## 前言：写给零基础的你

### 为什么选择这本教程？

想象一下，你想开一家网上商城，就像在网上开了一家24小时营业的超市。但是从零开始建设这样一个商城，就像要你从零开始盖一座大楼一样困难。

CRMEB就像是一座已经建好主体结构的大楼，有房间（功能模块）、有电梯（数据流转）、有管道（接口通道），你只需要按照自己的需求进行装修（二次开发）就可以了。

### 你将学到什么？

通过这本教程，你将学会：
- 🏗️ **理解商城的"建筑结构"**：知道每个文件夹、每个文件的作用
- 🔧 **掌握"装修技能"**：学会修改和添加新功能
- 💡 **实现创新功能**：合伙人制度、礼品卡、信用支付等
- 🚀 **部署上线技能**：让你的商城在互联网上运行

### 学习建议

1. **按顺序学习**：每章都建立在前一章的基础上
2. **动手实践**：看到代码就去试试，错了也没关系
3. **做好笔记**：记录你的理解和遇到的问题
4. **保持耐心**：罗马不是一天建成的，商城也是

---

## 第一章：认识CRMEB - 你的商城开发利器

### 1.1 什么是CRMEB？

把CRMEB想象成一个**商城模板工具包**，就像：
- **宜家的家具**：基础框架已经有了，你来组装和定制
- **乐高积木**：各种功能模块可以自由组合
- **毛坯房**：主体结构完整，等你来装修

CRMEB = **C**ommerce（商业） + **RM**（客户关系管理） + **EB**（电子商务）

### 1.2 CRMEB的技术栈（工具箱）

想象你要修理一辆汽车，需要不同的工具：

| 工具类比 | 技术名称 | 作用说明 |
|---------|---------|---------|
| 🔨 锤子 | PHP | 后端主要编程语言，处理业务逻辑 |
| 🔧 扳手 | ThinkPHP 6.0 | PHP框架，提供快速开发能力 |
| 🎨 画笔 | Vue.js | 前端框架，让界面动起来 |
| 📱 手机壳模具 | UniApp | 开发小程序的框架 |
| 💾 仓库 | MySQL | 存储所有数据的数据库 |
| ⚡ 加速器 | Redis | 缓存系统，让网站更快 |

### 1.3 庆人府商城的特色功能

我们要在CRMEB的基础上添加以下"特色装修"：

1. **🤝 合伙人系统**
   - 像会员卡一样，但更高级
   - 分为梦想、战略、城市三个等级
   - 每个等级都有不同的优惠和权益

2. **🎁 礼品卡系统**
   - 像商场的购物卡
   - 可以送人，也可以自己用

3. **💳 先用后付**
   - 像信用卡一样，先拿货后付款
   - 只有合伙人才能享受

4. **🔄 创新分销**
   - 新用户分享成功，返还全部金额
   - 老用户分享成功，送同样商品的礼品卡

5. **🏭 供应商管理**
   - 让其他商家也能在你的平台卖货

### 1.4 本章练习

1. **思考题**：如果CRMEB是一座房子，那么：
   - PHP是什么？（提示：建筑材料）
   - MySQL是什么？（提示：储物间）
   - Vue.js是什么？（提示：装饰）

2. **实践题**：
   - 在纸上画出你理解的商城结构图
   - 列出你最想实现的3个功能

---

## 第二章：搭建开发环境 - 打造你的工作台

### 2.1 理解开发环境

开发环境就像厨房，你需要准备好所有的"厨具"才能开始"烹饪"（编程）。

**需要准备的"厨具"清单**：
- 🖥️ **代码编辑器**（菜刀）：用来写代码
- 🌐 **Web服务器**（炉灶）：让网站运行起来
- 💾 **数据库**（冰箱）：存储数据
- 🔧 **PHP环境**（调料）：运行PHP代码

### 2.2 在阿里云服务器上搭建环境

既然你已经有了阿里云CentOS 8服务器，我们就像在一个空房间里布置厨房。

#### 步骤1：连接到服务器

```bash
# 在你的电脑上打开终端（Windows用户使用PowerShell）
# 用你的服务器IP替换下面的 your-server-ip
ssh root@your-server-ip

# 输入密码后，你就"走进"了服务器这个房间
```

💡 **小贴士**：SSH就像一把钥匙，让你能远程进入服务器。

#### 步骤2：安装宝塔面板（一键安装所有工具）

宝塔面板就像是一个**智能厨房管理系统**，帮你一键安装和管理所有工具。

```bash
# 安装宝塔面板
yum install -y wget && wget -O install.sh http://download.bt.cn/install/install_6.0.sh && sh install.sh
```

安装完成后，会显示：
- 面板地址：http://你的IP:8888
- 用户名：admin
- 密码：随机生成的

**记住这些信息！** 就像记住你家的钥匙和密码。

#### 步骤3：在宝塔面板中安装环境

1. 在浏览器打开宝塔面板地址
2. 登录后，会弹出"推荐安装"窗口
3. 选择**LNMP**环境：
   - **Nginx 1.20**（网站服务器）
   - **MySQL 5.7**（数据库）
   - **PHP 7.4**（PHP环境）
   - **phpMyAdmin**（数据库管理工具）

4. 点击"一键安装"，等待约10-20分钟

### 2.3 配置PHP环境

安装完成后，需要给PHP安装一些"插件"（扩展）：

1. 在宝塔面板中，点击"软件商店"
2. 找到PHP 7.4，点击"设置"
3. 点击"安装扩展"，安装以下扩展：
   - **fileinfo**（文件处理）
   - **redis**（缓存支持）
   - **swoole**（性能提升）

### 2.4 上传CRMEB代码

#### 方法1：使用宝塔面板上传（推荐新手）

1. 在宝塔面板点击"文件"
2. 进入 `/www/wwwroot/` 目录
3. 点击"上传"，选择你的CRMEB-5.6.1.zip文件
4. 上传完成后，右键解压

#### 方法2：使用Git（推荐学习）

```bash
# 进入网站目录
cd /www/wwwroot/

# 如果是从GitHub克隆（假设你已上传到GitHub）
git clone https://github.com/你的用户名/CRMEB-5.6.1.git qingrenfu

# 或者直接上传后解压
unzip CRMEB-5.6.1.zip
mv CRMEB-5.6.1 qingrenfu
```

### 2.5 创建网站和数据库

#### 创建网站

1. 在宝塔面板点击"网站" → "添加站点"
2. 填写信息：
   - 域名：你的域名（如：shop.qingrenfu.com）
   - 根目录：/www/wwwroot/qingrenfu/crmeb/public
   - PHP版本：PHP-74
   - 创建数据库：勾选

#### 配置伪静态

1. 点击网站的"设置"
2. 选择"伪静态"
3. 选择"thinkphp"规则
4. 保存

### 2.6 安装CRMEB

1. 在浏览器访问：http://你的域名/install
2. 按照安装向导操作：
   - 检查环境（全部通过才能继续）
   - 填写数据库信息（宝塔创建时的信息）
   - 设置管理员账号密码
   - 完成安装

### 2.7 配置SSL证书（让网站更安全）

1. 在宝塔面板，点击网站"设置"
2. 选择"SSL" → "Let's Encrypt"
3. 勾选域名，点击"申请"
4. 申请成功后，开启"强制HTTPS"

### 2.8 本章练习

1. **动手实践**：
   - 成功安装宝塔面板
   - 创建一个测试网站
   - 访问CRMEB后台（http://你的域名/admin）

2. **思考题**：
   - 为什么需要SSL证书？（提示：想想银行网站）
   - PHP扩展像什么？（提示：手机APP）

---

## 第三章：CRMEB项目结构详解 - 认识你的新家

### 3.1 整体结构 - 商城的"建筑图纸"

想象CRMEB项目就像一座大楼，每个文件夹都是不同的楼层或房间：

```
CRMEB-5.6.1/                    🏢 整座大楼
├── crmeb/                      🏗️ 主建筑（核心代码）
│   ├── app/                    🏢 业务办公区
│   │   ├── adminapi/          👔 总经理办公室（后台管理API）
│   │   ├── api/               🛍️ 客户服务大厅（前端API）
│   │   ├── dao/               🗄️ 档案室（数据访问）
│   │   ├── jobs/              ⏰ 任务调度室（定时任务）
│   │   ├── listener/          👂 监控室（事件监听）
│   │   ├── model/             📊 数据模型室（数据结构）
│   │   └── services/          🔧 服务部门（业务逻辑）
│   ├── config/                📋 配置中心（各种设置）
│   ├── public/                🚪 大门（入口文件）
│   └── route/                 🗺️ 路线图（路由配置）
├── template/                  🎨 设计部
│   ├── admin/                 🖥️ 后台界面设计
│   └── uni-app/               📱 手机端设计
└── docker-compose/            🐳 快速部署工具
```

### 3.2 深入了解每个部门

#### 3.2.1 app目录 - 业务核心区

这是整个商城的"大脑"，所有业务逻辑都在这里。

**📁 adminapi/ - 管理后台接口**
```php
adminapi/
├── controller/         # 控制器（接待员）
│   ├── v1/            # 版本1的接口
│   │   ├── user/      # 用户管理相关
│   │   ├── product/   # 商品管理相关
│   │   ├── order/     # 订单管理相关
│   │   └── ...        # 其他功能
├── route/             # 路由（地图）
└── validate/          # 验证器（保安）
```

**理解控制器**：控制器就像接待员，当有人（请求）来访时，决定该做什么。

```php
// 例子：adminapi/controller/v1/user/User.php
class User {
    // 获取用户列表 - 就像查看客户名单
    public function index() {
        // 1. 接收参数（听客户需求）
        $where = $this->request->getMore([
            ['keyword', ''],
            ['status', ''],
        ]);
        
        // 2. 调用服务（找相关部门处理）
        $list = $this->services->getUserList($where);
        
        // 3. 返回结果（给客户答复）
        return app('json')->success($list);
    }
}
```

**📁 api/ - 用户端接口**
```php
api/
├── controller/
│   ├── v1/
│   │   ├── LoginController.php    # 登录相关
│   │   ├── UserController.php     # 用户中心
│   │   ├── ProductController.php  # 商品展示
│   │   └── OrderController.php    # 订单处理
```

**📁 services/ - 业务服务层**

服务层就像公司的各个部门，专门处理具体业务：

```php
// 例子：app/services/user/UserServices.php
class UserServices {
    // 获取用户列表 - 具体的业务处理
    public function getUserList($where) {
        // 就像从档案柜（数据库）查找资料
        return $this->dao->getList($where);
    }
    
    // 创建新用户 - 就像办理新客户入档
    public function createUser($data) {
        // 1. 验证数据
        // 2. 处理密码
        // 3. 保存到数据库
        return $this->dao->save($data);
    }
}
```

**📁 dao/ - 数据访问层**

DAO（Data Access Object）就像档案管理员，专门负责存取数据：

```php
// 例子：app/dao/user/UserDao.php
class UserDao {
    // 获取用户数据 - 从档案柜取出资料
    public function getList($where) {
        return $this->search($where)
            ->order('id desc')
            ->paginate(10);
    }
}
```

### 3.3 模型层 - 数据的形状

模型定义了数据的"形状"，就像表格的表头：

```php
// app/model/user/User.php
class User extends BaseModel {
    // 定义这个"档案柜"里存什么
    protected $name = 'user';  // 表名
    
    // 用户有哪些属性
    protected $schema = [
        'uid' => 'int',           // 用户ID
        'nickname' => 'string',   // 昵称
        'phone' => 'string',      // 手机号
        'add_time' => 'int',      // 注册时间
    ];
}
```

### 3.4 配置文件 - 商城的设置中心

```php
config/
├── app.php          # 应用配置（商城基本信息）
├── database.php     # 数据库配置（连接信息）
├── cache.php        # 缓存配置（Redis设置）
├── filesystem.php   # 文件系统配置（图片上传）
└── ...
```

**重要配置示例**：

```php
// config/database.php
return [
    'default' => 'mysql',
    'connections' => [
        'mysql' => [
            'hostname' => '127.0.0.1',  // 数据库地址
            'database' => 'crmeb',      // 数据库名
            'username' => 'root',       // 用户名
            'password' => '123456',     // 密码
            'hostport' => '3306',       // 端口
        ]
    ]
];
```

### 3.5 路由配置 - 请求的地图

路由告诉系统：当用户访问某个网址时，该调用哪个控制器的哪个方法。

```php
// route/api.php
Route::group('user', function () {
    // 当访问 /api/user/info 时，调用 UserController 的 info 方法
    Route::get('info', 'v1.user.UserController/info');
    
    // 当访问 /api/user/edit 时，调用 UserController 的 edit 方法
    Route::post('edit', 'v1.user.UserController/edit');
});
```

### 3.6 前端模板 - 商城的脸面

```
template/
├── admin/              # 管理后台界面
│   ├── src/
│   │   ├── views/     # 页面文件
│   │   ├── api/       # 接口调用
│   │   └── router/    # 路由配置
└── uni-app/           # 小程序/H5界面
    ├── pages/         # 页面文件
    ├── api/           # 接口调用
    └── store/         # 状态管理
```

### 3.7 文件之间的协作关系

想象一个用户下单的过程：

1. **用户在小程序点击"立即购买"**
   - `template/uni-app/pages/goods/goods.vue` 处理点击事件

2. **发送请求到后端**
   - 请求到达 `public/index.php`（入口）
   - 路由 `route/api.php` 识别这是创建订单请求
   - 转发给 `api/controller/v1/order/StoreOrderController.php`

3. **控制器处理请求**
   ```php
   public function create() {
       // 接收数据
       $data = $this->request->postMore(['addressId', 'cartIds']);
       
       // 调用服务层
       $order = $this->services->createOrder($uid, $data);
       
       // 返回结果
       return app('json')->success('订单创建成功', $order);
   }
   ```

4. **服务层处理业务**
   ```php
   // services/order/StoreOrderServices.php
   public function createOrder($uid, $data) {
       // 1. 检查库存
       // 2. 计算价格
       // 3. 生成订单号
       // 4. 保存订单
       return $this->dao->save($orderData);
   }
   ```

5. **DAO层保存数据**
   ```php
   // dao/order/StoreOrderDao.php
   public function save($data) {
       return $this->getModel()->save($data);
   }
   ```

### 3.8 本章练习

1. **探索任务**：
   - 找到用户登录的控制器文件
   - 找到商品列表的服务层文件
   - 找到订单的模型文件

2. **思考题**：
   - 为什么要分成控制器、服务层、DAO层？
   - 如果把所有代码都写在控制器里会怎样？

3. **实践任务**：
   - 在 `api/controller/v1/` 下创建一个 `TestController.php`
   - 添加一个 `hello` 方法，返回 "Hello, 庆人府商城!"
   - 在路由中配置这个接口

---

## 第四章：数据库设计与扩展 - 商城的记忆中心

### 4.1 理解数据库

数据库就像商城的**档案室**，所有的信息都存储在这里：
- 📁 **表（Table）**：不同类型的档案柜
- 📄 **记录（Record）**：每一份档案
- 📋 **字段（Field）**：档案上的每一项信息

### 4.2 CRMEB原有的数据表

先来认识一下CRMEB已经准备好的"档案柜"：

```sql
-- 用户相关
eb_user                 -- 用户基本信息表（客户档案）
eb_user_address         -- 用户地址表（收货地址）
eb_user_bill            -- 用户账单表（消费记录）

-- 商品相关
eb_store_product        -- 商品表（商品档案）
eb_store_product_attr   -- 商品属性表（规格信息）
eb_store_category       -- 商品分类表（商品目录）

-- 订单相关
eb_store_order          -- 订单表（订单档案）
eb_store_order_cart     -- 订单商品表（订单明细）

-- 营销相关
eb_store_coupon         -- 优惠券表
eb_store_seckill        -- 秒杀活动表
eb_store_bargain        -- 砍价活动表
```

### 4.3 为庆人府商城新增数据表

现在我们要新增一些"档案柜"来存储新功能的数据。

#### 4.3.1 创建合伙人信息表

```sql
-- 这就像为VIP客户建立特别档案
CREATE TABLE `eb_partner_info` (
  `id` int(11) NOT NULL AUTO_INCREMENT COMMENT '编号',
  `user_id` int(11) NOT NULL COMMENT '对应的用户编号',
  `partner_level` tinyint(2) NOT NULL DEFAULT '1' COMMENT '合伙人等级：1梦想 2战略 3城市',
  `start_time` int(11) NOT NULL COMMENT '成为合伙人的时间',
  `expire_time` int(11) NOT NULL COMMENT '权益到期时间',
  `credit_limit` decimal(10,2) DEFAULT '0.00' COMMENT '信用额度（能欠多少钱）',
  `total_commission` decimal(10,2) DEFAULT '0.00' COMMENT '累计获得的佣金',
  `status` tinyint(2) DEFAULT '1' COMMENT '状态：1正常 2冻结',
  `create_time` int(11) NOT NULL COMMENT '创建时间',
  PRIMARY KEY (`id`),
  UNIQUE KEY `user_id` (`user_id`) COMMENT '一个用户只能有一条合伙人记录'
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='合伙人信息表';
```

💡 **理解要点**：
- `AUTO_INCREMENT`：自动编号，就像档案自动贴上编号
- `UNIQUE KEY`：唯一索引，确保不重复
- `DECIMAL(10,2)`：最多10位数，其中2位小数，用于存钱
- `COMMENT`：注释，方便理解每个字段的用途

#### 4.3.2 创建礼品卡表

```sql
-- 礼品卡就像商场的购物卡
CREATE TABLE `eb_gift_card` (
  `id` int(11) NOT NULL AUTO_INCREMENT,
  `card_code` varchar(32) NOT NULL COMMENT '卡号（像银行卡号）',
  `card_password` varchar(64) NOT NULL COMMENT '密码（刮开涂层才能看到）',
  `card_type` tinyint(2) NOT NULL DEFAULT '1' COMMENT '类型：1商品卡 2分销奖励卡',
  `product_id` int(11) NOT NULL COMMENT '可兑换的商品ID',
  `product_name` varchar(255) NOT NULL COMMENT '商品名称',
  `user_id` int(11) DEFAULT NULL COMMENT '持有人ID（谁的卡）',
  `status` tinyint(2) DEFAULT '1' COMMENT '状态：1未使用 2已使用 3已过期',
  `expire_time` int(11) DEFAULT NULL COMMENT '过期时间',
  `create_time` int(11) NOT NULL,
  PRIMARY KEY (`id`),
  UNIQUE KEY `card_code` (`card_code`) COMMENT '卡号不能重复',
  KEY `user_id` (`user_id`) COMMENT '方便查询某人的卡',
  KEY `status` (`status`) COMMENT '方便查询可用的卡'
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='礼品卡表';
```

### 4.4 使用宝塔面板操作数据库

#### 步骤1：进入数据库管理

1. 登录宝塔面板
2. 点击"数据库"
3. 找到你的商城数据库，点击"管理"
4. 这会打开phpMyAdmin（数据库管理工具）

#### 步骤2：执行SQL语句

1. 在phpMyAdmin中，点击"SQL"标签
2. 复制上面的建表语句，粘贴进去
3. 点击"执行"
4. 成功后会看到新表出现在左侧列表

### 4.5 在代码中使用新数据表

#### 4.5.1 创建模型文件

模型文件告诉系统这个表的结构：

```php
// 创建文件：app/model/partner/PartnerInfo.php
<?php
namespace app\model\partner;

use crmeb\basic\BaseModel;

class PartnerInfo extends BaseModel
{
    /**
     * 数据表名
     */
    protected $name = 'partner_info';
    
    /**
     * 数据表主键
     */
    protected $pk = 'id';
    
    /**
     * 模型对应数据表字段及类型
     * 这就像告诉系统：这个档案柜里有哪些格子
     */
    protected $schema = [
        'id'                => 'int',
        'user_id'           => 'int',
        'partner_level'     => 'int',
        'start_time'        => 'int',
        'expire_time'       => 'int',
        'credit_limit'      => 'float',
        'total_commission'  => 'float',
        'status'            => 'int',
        'create_time'       => 'int',
    ];
    
    /**
     * 获取合伙人等级名称
     * 就像把数字1、2、3翻译成"梦想"、"战略"、"城市"
     */
    public function getPartnerLevelAttr($value)
    {
        $levels = [
            1 => '梦想合伙人',
            2 => '战略合伙人',
            3 => '城市合伙人'
        ];
        return $levels[$value] ?? '未知';
    }
}
```

#### 4.5.2 创建DAO文件

DAO负责具体的数据操作：

```php
// 创建文件：app/dao/partner/PartnerInfoDao.php
<?php
namespace app\dao\partner;

use app\dao\BaseDao;
use app\model\partner\PartnerInfo;

class PartnerInfoDao extends BaseDao
{
    /**
     * 设置模型
     */
    protected function setModel(): string
    {
        return PartnerInfo::class;
    }
    
    /**
     * 根据用户ID获取合伙人信息
     * 就像通过身份证号查找VIP档案
     */
    public function getByUserId($userId)
    {
        return $this->getModel()->where('user_id', $userId)->find();
    }
    
    /**
     * 创建合伙人
     * 就像为新VIP建立档案
     */
    public function createPartner($userId, $level)
    {
        $data = [
            'user_id' => $userId,
            'partner_level' => $level,
            'start_time' => time(),
            'expire_time' => time() + 365 * 86400, // 一年后过期
            'credit_limit' => $this->getCreditLimit($level),
            'status' => 1,
            'create_time' => time()
        ];
        
        return $this->save($data);
    }
    
    /**
     * 根据等级获取信用额度
     */
    private function getCreditLimit($level)
    {
        $limits = [
            1 => 1000.00,  // 梦想合伙人
            2 => 5000.00,  // 战略合伙人
            3 => 10000.00  // 城市合伙人
        ];
        return $limits[$level] ?? 0;
    }
}
```

#### 4.5.3 创建服务层文件

服务层处理业务逻辑：

```php
// 创建文件：app/services/partner/PartnerServices.php
<?php
namespace app\services\partner;

use app\services\BaseServices;
use app\dao\partner\PartnerInfoDao;
use app\services\user\UserServices;

class PartnerServices extends BaseServices
{
    /**
     * 构造方法
     */
    public function __construct(PartnerInfoDao $dao)
    {
        $this->dao = $dao;
    }
    
    /**
     * 升级为合伙人
     * 就像办理VIP会员卡
     */
    public function upgradeToPartner($userId, $level, $orderId)
    {
        // 1. 检查是否已经是合伙人
        $partnerInfo = $this->dao->getByUserId($userId);
        if ($partnerInfo) {
            throw new \Exception('您已经是合伙人了');
        }
        
        // 2. 创建合伙人记录
        $result = $this->dao->createPartner($userId, $level);
        
        // 3. 记录升级日志
        $this->recordUpgradeLog($userId, $level, $orderId);
        
        // 4. 发送通知
        $this->sendUpgradeNotice($userId, $level);
        
        return $result;
    }
    
    /**
     * 获取合伙人信息
     */
    public function getPartnerInfo($userId)
    {
        $info = $this->dao->getByUserId($userId);
        if (!$info) {
            return null;
        }
        
        // 检查是否过期
        if ($info['expire_time'] < time()) {
            $info['is_expired'] = true;
        } else {
            $info['is_expired'] = false;
            $info['days_left'] = ceil(($info['expire_time'] - time()) / 86400);
        }
        
        return $info;
    }
}
```

### 4.6 数据库设计原则

设计数据库就像整理档案室，要遵循一些原则：

1. **每个表都要有主键**
   - 就像每个档案都要有唯一编号

2. **字段类型要合适**
   - 存钱用 `DECIMAL`
   - 存时间用 `INT`（时间戳）或 `DATETIME`
   - 存短文本用 `VARCHAR`
   - 存长文本用 `TEXT`

3. **建立合适的索引**
   - 经常查询的字段要加索引
   - 就像给常用档案贴上标签，方便查找

4. **注意数据关联**
   - 用外键关联不同的表
   - 就像用订书机把相关档案订在一起

### 4.7 本章练习

1. **动手实践**：
   - 创建所有新功能需要的数据表
   - 为每个新表创建对应的模型文件
   - 测试数据的增删改查

2. **思考题**：
   - 为什么合伙人表要和用户表关联？
   - 如果要记录合伙人的升级历史，该如何设计表？

3. **扩展任务**：
   - 设计一个合伙人升级记录表
   - 设计一个礼品卡使用记录表

---

## 第五章：合伙人管理系统开发 - 打造你的商业帝国

### 5.1 理解合伙人系统

合伙人系统就像是商城的**VIP会员体系**，但更高级：

- 🥉 **梦想合伙人**：像铜卡会员
- 🥈 **战略合伙人**：像银卡会员  
- 🥇 **城市合伙人**：像金卡会员

每个等级都有不同的权益，就像不同等级的会员卡享受不同的优惠。

### 5.2 后台管理功能开发

#### 5.2.1 创建合伙人管理控制器

```php
// 创建文件：app/adminapi/controller/v1/partner/Partner.php
<?php
namespace app\adminapi\controller\v1\partner;

use app\adminapi\controller\AuthController;
use app\services\partner\PartnerServices;
use think\facade\App;

/**
 * 合伙人管理控制器
 * 就像公司的人事部门，管理所有合伙人
 */
class Partner extends AuthController
{
    protected $services;
    
    public function __construct(App $app, PartnerServices $services)
    {
        parent::__construct($app);
        $this->services = $services;
    }
    
    /**
     * 合伙人列表
     * 就像查看所有VIP会员名单
     */
    public function index()
    {
        // 接收查询参数
        $where = $this->request->getMore([
            ['keyword', ''],        // 搜索关键词
            ['level', ''],          // 合伙人等级
            ['status', ''],         // 状态
            ['page', 1],            // 页码
            ['limit', 10],          // 每页显示数量
        ]);
        
        // 获取列表数据
        $list = $this->services->getPartnerList($where);
        
        return app('json')->success($list);
    }
    
    /**
     * 添加合伙人
     * 就像给某人办理VIP卡
     */
    public function save()
    {
        $data = $this->request->postMore([
            ['user_id', 0],                    // 用户ID
            ['partner_level', 1],              // 合伙人等级
            ['credit_limit', 0],               // 信用额度
            ['expire_time', ''],               // 到期时间
        ]);
        
        // 验证数据
        if (!$data['user_id']) {
            return app('json')->fail('请选择用户');
        }
        
        // 创建合伙人
        $result = $this->services->createPartner($data);
        
        return app('json')->success('添加成功');
    }
    
    /**
     * 编辑合伙人信息
     * 就像修改VIP卡信息
     */
    public function update($id)
    {
        $data = $this->request->postMore([
            ['credit_limit', 0],               // 信用额度
            ['expire_time', ''],               // 到期时间
            ['status', 1],                     // 状态
        ]);
        
        $result = $this->services->updatePartner($id, $data);
        
        return app('json')->success('修改成功');
    }
    
    /**
     * 合伙人配置
     * 设置不同等级的权益
     */
    public function config()
    {
        if ($this->request->isPost()) {
            // 保存配置
            $data = $this->request->postMore([
                ['level_1_discount', 95],       // 梦想合伙人折扣
                ['level_1_commission', 5],      // 梦想合伙人分红比例
                ['level_2_discount', 90],       // 战略合伙人折扣
                ['level_2_commission', 10],     // 战略合伙人分红比例
                ['level_3_discount', 85],       // 城市合伙人折扣
                ['level_3_commission', 15],     // 城市合伙人分红比例
            ]);
            
            $this->services->saveConfig($data);
            return app('json')->success('保存成功');
        } else {
            // 获取配置
            $config = $this->services->getConfig();
            return app('json')->success($config);
        }
    }
}
```

#### 5.2.2 完善服务层

```php
// 修改文件：app/services/partner/PartnerServices.php
// 添加以下方法

/**
 * 获取合伙人列表
 * 支持搜索、筛选、分页
 */
public function getPartnerList($where)
{
    // 构建查询条件
    $query = $this->dao->getModel();
    
    // 关联用户表，获取用户信息
    $query = $query->with(['user' => function($query) {
        $query->field('uid,nickname,phone,avatar');
    }]);
    
    // 搜索条件
    if (!empty($where['keyword'])) {
        $query = $query->where(function($q) use ($where) {
            $q->whereHas('user', function($q) use ($where) {
                $q->where('nickname', 'like', "%{$where['keyword']}%")
                  ->whereOr('phone', 'like', "%{$where['keyword']}%");
            });
        });
    }
    
    // 等级筛选
    if ($where['level'] !== '') {
        $query = $query->where('partner_level', $where['level']);
    }
    
    // 状态筛选
    if ($where['status'] !== '') {
        $query = $query->where('status', $where['status']);
    }
    
    // 分页获取数据
    $list = $query->order('id desc')
                  ->page($where['page'], $where['limit'])
                  ->select();
    
    // 统计总数
    $count = $query->count();
    
    // 处理数据
    foreach ($list as &$item) {
        // 计算剩余天数
        $item['days_left'] = max(0, ceil(($item['expire_time'] - time()) / 86400));
        // 格式化时间
        $item['start_time_text'] = date('Y-m-d', $item['start_time']);
        $item['expire_time_text'] = date('Y-m-d', $item['expire_time']);
    }
    
    return compact('list', 'count');
}

/**
 * 保存合伙人配置
 */
public function saveConfig($data)
{
    // 保存到系统配置表
    foreach ($data as $key => $value) {
        // 使用系统配置服务保存
        app()->make(\app\services\system\config\SystemConfigServices::class)
              ->saveConfig($key, $value);
    }
    
    // 清除缓存
    $this->clearCache();
    
    return true;
}

/**
 * 获取合伙人配置
 */
public function getConfig()
{
    $configService = app()->make(\app\services\system\config\SystemConfigServices::class);
    
    return [
        'level_1_discount' => $configService->getConfig('level_1_discount') ?: 95,
        'level_1_commission' => $configService->getConfig('level_1_commission') ?: 5,
        'level_2_discount' => $configService->getConfig('level_2_discount') ?: 90,
        'level_2_commission' => $configService->getConfig('level_2_commission') ?: 10,
        'level_3_discount' => $configService->getConfig('level_3_discount') ?: 85,
        'level_3_commission' => $configService->getConfig('level_3_commission') ?: 15,
    ];
}
```

### 5.3 前端管理界面开发

#### 5.3.1 创建合伙人列表页面

```vue
<!-- 创建文件：template/admin/src/views/partner/index.vue -->
<template>
  <div class="partner-list">
    <!-- 搜索栏 -->
    <el-card class="search-card">
      <el-form :inline="true" :model="searchForm">
        <el-form-item label="关键词">
          <el-input v-model="searchForm.keyword" 
                    placeholder="用户昵称/手机号" 
                    clearable />
        </el-form-item>
        
        <el-form-item label="合伙人等级">
          <el-select v-model="searchForm.level" placeholder="全部" clearable>
            <el-option label="梦想合伙人" :value="1" />
            <el-option label="战略合伙人" :value="2" />
            <el-option label="城市合伙人" :value="3" />
          </el-select>
        </el-form-item>
        
        <el-form-item label="状态">
          <el-select v-model="searchForm.status" placeholder="全部" clearable>
            <el-option label="正常" :value="1" />
            <el-option label="冻结" :value="2" />
          </el-select>
        </el-form-item>
        
        <el-form-item>
          <el-button type="primary" @click="getList">查询</el-button>
          <el-button @click="resetSearch">重置</el-button>
          <el-button type="success" @click="openAddDialog">添加合伙人</el-button>
        </el-form-item>
      </el-form>
    </el-card>
    
    <!-- 数据表格 -->
    <el-card class="table-card">
      <el-table :data="tableData" border>
        <el-table-column prop="id" label="ID" width="80" />
        
        <el-table-column label="用户信息" width="200">
          <template slot-scope="scope">
            <div class="user-info">
              <el-avatar :src="scope.row.user.avatar" />
              <div>
                <div>{{ scope.row.user.nickname }}</div>
                <div class="text-muted">{{ scope.row.user.phone }}</div>
              </div>
            </div>
          </template>
        </el-table-column>
        
        <el-table-column label="合伙人等级">
          <template slot-scope="scope">
            <el-tag :type="getLevelType(scope.row.partner_level)">
              {{ getLevelName(scope.row.partner_level) }}
            </el-tag>
          </template>
        </el-table-column>
        
        <el-table-column prop="credit_limit" label="信用额度" />
        
        <el-table-column label="有效期">
          <template slot-scope="scope">
            <div>{{ scope.row.start_time_text }} 至</div>
            <div>{{ scope.row.expire_time_text }}</div>
            <div class="text-warning">剩余{{ scope.row.days_left }}天</div>
          </template>
        </el-table-column>
        
        <el-table-column label="状态">
          <template slot-scope="scope">
            <el-switch v-model="scope.row.status" 
                       :active-value="1" 
                       :inactive-value="2"
                       @change="changeStatus(scope.row)" />
          </template>
        </el-table-column>
        
        <el-table-column label="操作" width="150">
          <template slot-scope="scope">
            <el-button size="mini" @click="editPartner(scope.row)">编辑</el-button>
            <el-button size="mini" type="danger" @click="deletePartner(scope.row)">删除</el-button>
          </template>
        </el-table-column>
      </el-table>
      
      <!-- 分页 -->
      <el-pagination
        @current-change="handlePageChange"
        :current-page="searchForm.page"
        :page-size="searchForm.limit"
        :total="total"
        layout="total, prev, pager, next" />
    </el-card>
  </div>
</template>

<script>
// 导入接口
import { getPartnerList, updatePartnerStatus } from '@/api/partner'

export default {
  name: 'PartnerList',
  data() {
    return {
      // 搜索表单
      searchForm: {
        keyword: '',
        level: '',
        status: '',
        page: 1,
        limit: 10
      },
      // 表格数据
      tableData: [],
      total: 0
    }
  },
  
  created() {
    this.getList()
  },
  
  methods: {
    // 获取列表
    async getList() {
      const res = await getPartnerList(this.searchForm)
      this.tableData = res.data.list
      this.total = res.data.count
    },
    
    // 获取等级名称
    getLevelName(level) {
      const names = {
        1: '梦想合伙人',
        2: '战略合伙人',
        3: '城市合伙人'
      }
      return names[level] || '未知'
    },
    
    // 获取等级标签类型
    getLevelType(level) {
      const types = {
        1: 'info',
        2: 'warning',
        3: 'success'
      }
      return types[level] || 'info'
    },
    
    // 改变状态
    async changeStatus(row) {
      await updatePartnerStatus(row.id, { status: row.status })
      this.$message.success('状态更新成功')
    },
    
    // 其他方法...
  }
}
</script>

<style lang="scss" scoped>
.partner-list {
  .search-card {
    margin-bottom: 20px;
  }
  
  .user-info {
    display: flex;
    align-items: center;
    
    .el-avatar {
      margin-right: 10px;
    }
  }
  
  .text-muted {
    color: #999;
    font-size: 12px;
  }
  
  .text-warning {
    color: #e6a23c;
    font-size: 12px;
  }
}
</style>
```

### 5.4 小程序端合伙人功能

#### 5.4.1 创建合伙人中心页面

```vue
<!-- 创建文件：template/uni-app/pages/partner/index.vue -->
<template>
  <view class="partner-center">
    <!-- 合伙人信息卡片 -->
    <view class="partner-card" v-if="partnerInfo">
      <view class="card-bg"></view>
      <view class="card-content">
        <view class="user-info">
          <image :src="userInfo.avatar" class="avatar"></image>
          <view class="info">
            <view class="nickname">{{ userInfo.nickname }}</view>
            <view class="level">{{ partnerInfo.partner_level_text }}</view>
          </view>
        </view>
        
        <view class="rights-info">
          <view class="item">
            <view class="label">购物折扣</view>
            <view class="value">{{ partnerInfo.discount }}折</view>
          </view>
          <view class="item">
            <view class="label">分红比例</view>
            <view class="value">{{ partnerInfo.commission }}%</view>
          </view>
          <view class="item">
            <view class="label">信用额度</view>
            <view class="value">¥{{ partnerInfo.credit_limit }}</view>
          </view>
        </view>
        
        <view class="expire-info">
          <text>有效期至：{{ partnerInfo.expire_time_text }}</text>
          <text class="days">（剩余{{ partnerInfo.days_left }}天）</text>
        </view>
      </view>
    </view>
    
    <!-- 未成为合伙人 -->
    <view class="not-partner" v-else>
      <image src="/static/images/partner-banner.png" class="banner"></image>
      <view class="title">成为合伙人，享受专属权益</view>
      <view class="desc">购物享折扣，分享得分红，还能先用后付！</view>
      <button class="upgrade-btn" @click="goUpgrade">立即升级</button>
    </view>
    
    <!-- 功能菜单 -->
    <view class="menu-list" v-if="partnerInfo">
      <view class="menu-item" @click="goPage('/pages/partner/team')">
        <view class="icon">
          <text class="iconfont icon-team"></text>
        </view>
        <view class="title">我的团队</view>
        <view class="arrow">
          <text class="iconfont icon-arrow-right"></text>
        </view>
      </view>
      
      <view class="menu-item" @click="goPage('/pages/partner/commission')">
        <view class="icon">
          <text class="iconfont icon-money"></text>
        </view>
        <view class="title">佣金明细</view>
        <view class="value">¥{{ partnerInfo.current_commission }}</view>
        <view class="arrow">
          <text class="iconfont icon-arrow-right"></text>
        </view>
      </view>
      
      <view class="menu-item" @click="goPage('/pages/partner/credit')">
        <view class="icon">
          <text class="iconfont icon-credit"></text>
        </view>
        <view class="title">信用管理</view>
        <view class="arrow">
          <text class="iconfont icon-arrow-right"></text>
        </view>
      </view>
    </view>
  </view>
</template>

<script>
import { getPartnerInfo } from '@/api/partner.js'

export default {
  data() {
    return {
      userInfo: {},
      partnerInfo: null
    }
  },
  
  onShow() {
    this.getUserInfo()
    this.getPartnerInfo()
  },
  
  methods: {
    // 获取用户信息
    getUserInfo() {
      this.userInfo = uni.getStorageSync('userInfo')
    },
    
    // 获取合伙人信息
    async getPartnerInfo() {
      const res = await getPartnerInfo()
      this.partnerInfo = res.data
    },
    
    // 跳转页面
    goPage(url) {
      uni.navigateTo({ url })
    },
    
    // 去升级
    goUpgrade() {
      uni.navigateTo({
        url: '/pages/partner/upgrade'
      })
    }
  }
}
</script>

<style lang="scss">
.partner-center {
  padding: 20rpx;
  
  .partner-card {
    position: relative;
    border-radius: 20rpx;
    overflow: hidden;
    box-shadow: 0 4rpx 20rpx rgba(0,0,0,0.1);
    
    .card-bg {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 200rpx;
      background: linear-gradient(45deg, #ff6b6b, #ff8e53);
    }
    
    .card-content {
      position: relative;
      padding: 30rpx;
      
      .user-info {
        display: flex;
        align-items: center;
        margin-bottom: 40rpx;
        
        .avatar {
          width: 120rpx;
          height: 120rpx;
          border-radius: 50%;
          border: 4rpx solid #fff;
        }
        
        .info {
          margin-left: 30rpx;
          color: #fff;
          
          .nickname {
            font-size: 36rpx;
            font-weight: bold;
          }
          
          .level {
            font-size: 28rpx;
            margin-top: 10rpx;
          }
        }
      }
      
      .rights-info {
        display: flex;
        justify-content: space-around;
        padding: 40rpx 0;
        background: #fff;
        border-radius: 20rpx;
        
        .item {
          text-align: center;
          
          .label {
            font-size: 26rpx;
            color: #999;
          }
          
          .value {
            font-size: 36rpx;
            font-weight: bold;
            color: #ff6b6b;
            margin-top: 10rpx;
          }
        }
      }
      
      .expire-info {
        text-align: center;
        margin-top: 30rpx;
        font-size: 26rpx;
        color: #666;
        
        .days {
          color: #ff6b6b;
        }
      }
    }
  }
  
  .not-partner {
    text-align: center;
    padding: 60rpx 0;
    
    .banner {
      width: 600rpx;
      height: 300rpx;
    }
    
    .title {
      font-size: 36rpx;
      font-weight: bold;
      margin-top: 40rpx;
    }
    
    .desc {
      font-size: 28rpx;
      color: #666;
      margin-top: 20rpx;
    }
    
    .upgrade-btn {
      width: 400rpx;
      height: 88rpx;
      background: linear-gradient(45deg, #ff6b6b, #ff8e53);
      color: #fff;
      font-size: 32rpx;
      border-radius: 44rpx;
      margin-top: 60rpx;
    }
  }
  
  .menu-list {
    margin-top: 30rpx;
    background: #fff;
    border-radius: 20rpx;
    
    .menu-item {
      display: flex;
      align-items: center;
      padding: 30rpx;
      border-bottom: 1rpx solid #f5f5f5;
      
      &:last-child {
        border-bottom: none;
      }
      
      .icon {
        width: 60rpx;
        height: 60rpx;
        background: #fff5f5;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        
        .iconfont {
          font-size: 32rpx;
          color: #ff6b6b;
        }
      }
      
      .title {
        flex: 1;
        margin-left: 30rpx;
        font-size: 30rpx;
      }
      
      .value {
        font-size: 30rpx;
        color: #ff6b6b;
        font-weight: bold;
      }
      
      .arrow {
        margin-left: 20rpx;
        
        .iconfont {
          font-size: 28rpx;
          color: #999;
        }
      }
    }
  }
}
</style>
```

### 5.5 合伙人权益实现

#### 5.5.1 购物折扣实现

在订单服务中添加折扣计算：

```php
// 修改文件：app/services/order/StoreOrderServices.php
// 在计算订单价格的方法中添加

/**
 * 计算合伙人折扣
 */
protected function calculatePartnerDiscount($uid, $totalPrice)
{
    // 获取合伙人信息
    $partnerService = app()->make(PartnerServices::class);
    $partnerInfo = $partnerService->getPartnerInfo($uid);
    
    if (!$partnerInfo || $partnerInfo['is_expired']) {
        return [
            'discount' => 100,  // 无折扣
            'discount_price' => 0
        ];
    }
    
    // 获取折扣配置
    $config = $partnerService->getConfig();
    $discountKey = 'level_' . $partnerInfo['partner_level'] . '_discount';
    $discount = $config[$discountKey] ?? 100;
    
    // 计算折扣金额
    $discountPrice = $totalPrice * (100 - $discount) / 100;
    
    return [
        'discount' => $discount,
        'discount_price' => round($discountPrice, 2)
    ];
}
```

#### 5.5.2 分红计算实现

创建分红服务：

```php
// 创建文件：app/services/partner/PartnerCommissionServices.php
<?php
namespace app\services\partner;

use app\services\BaseServices;

class PartnerCommissionServices extends BaseServices
{
    /**
     * 计算分红
     * 当订单完成时调用
     */
    public function calculateCommission($order)
    {
        // 获取购买用户的推荐人
        $userService = app()->make(\app\services\user\UserServices::class);
        $spreadUid = $userService->value(['uid' => $order['uid']], 'spread_uid');
        
        if (!$spreadUid) {
            return;
        }
        
        // 检查推荐人是否是合伙人
        $partnerService = app()->make(PartnerServices::class);
        $partnerInfo = $partnerService->getPartnerInfo($spreadUid);
        
        if (!$partnerInfo || $partnerInfo['is_expired']) {
            return;
        }
        
        // 获取分红比例
        $config = $partnerService->getConfig();
        $commissionKey = 'level_' . $partnerInfo['partner_level'] . '_commission';
        $commissionRate = $config[$commissionKey] ?? 0;
        
        // 计算分红金额
        $commissionAmount = $order['pay_price'] * $commissionRate / 100;
        
        // 记录分红
        $this->recordCommission([
            'partner_id' => $partnerInfo['id'],
            'user_id' => $spreadUid,
            'order_id' => $order['id'],
            'order_sn' => $order['order_id'],
            'commission_rate' => $commissionRate,
            'order_amount' => $order['pay_price'],
            'commission_amount' => round($commissionAmount, 2),
            'status' => 0,  // 待结算
            'create_time' => time()
        ]);
        
        // 更新合伙人累计佣金
        $partnerService->dao->inc($partnerInfo['id'], 'total_commission', $commissionAmount);
    }
    
    /**
     * 记录分红明细
     */
    protected function recordCommission($data)
    {
        // 这里需要创建一个分红记录表
        // eb_partner_commission
        return app()->make(\app\dao\partner\PartnerCommissionDao::class)->save($data);
    }
}
```

### 5.6 定时任务处理

创建定时任务处理合伙人权益到期：

```php
// 创建文件：app/jobs/partner/PartnerExpireJob.php
<?php
namespace app\jobs\partner;

use crmeb\basic\BaseJobs;
use app\services\partner\PartnerServices;

/**
 * 合伙人到期处理任务
 * 就像每天检查会员卡是否过期
 */
class PartnerExpireJob extends BaseJobs
{
    /**
     * 执行任务
     */
    public function doJob()
    {
        $partnerService = app()->make(PartnerServices::class);
        
        // 查找即将到期的合伙人（3天内）
        $expiringSoon = $partnerService->dao->getModel()
            ->where('status', 1)
            ->where('expire_time', '<=', time() + 3 * 86400)
            ->where('expire_time', '>', time())
            ->select();
        
        // 发送到期提醒
        foreach ($expiringSoon as $partner) {
            $this->sendExpireReminder($partner);
        }
        
        // 处理已到期的合伙人
        $expired = $partnerService->dao->getModel()
            ->where('status', 1)
            ->where('expire_time', '<=', time())
            ->select();
        
        foreach ($expired as $partner) {
            // 更新状态为过期
            $partnerService->dao->update($partner['id'], ['status' => 3]);
            
            // 发送过期通知
            $this->sendExpiredNotice($partner);
        }
        
        return true;
    }
    
    /**
     * 发送即将到期提醒
     */
    protected function sendExpireReminder($partner)
    {
        // 调用消息服务发送提醒
        // 可以是短信、微信模板消息等
    }
    
    /**
     * 发送过期通知
     */
    protected function sendExpiredNotice($partner)
    {
        // 发送过期通知
    }
}
```

### 5.7 本章练习

1. **功能实现**：
   - 完成合伙人升级商品的配置功能
   - 实现合伙人到期自动续费功能
   - 添加合伙人等级变更记录

2. **思考题**：
   - 如何防止用户重复升级合伙人？
   - 如何处理合伙人降级的情况？

3. **扩展任务**：
   - 实现合伙人专属商品功能
   - 添加合伙人业绩排行榜
   - 实现团队管理功能

---

## 第六章：礼品卡系统开发 - 创造虚拟价值

### 6.1 理解礼品卡系统

礼品卡就像商场的**购物卡**，但我们的更特别：
- 🎁 **商品礼品卡**：只能兑换特定商品，像专柜购物券
- 🎯 **分销礼品卡**：分销奖励发放，奖励的是商品而不是现金

### 6.2 礼品卡生成系统

#### 6.2.1 创建礼品卡生成服务

```php
// 创建文件：app/services/giftcard/GiftCardServices.php
<?php
namespace app\services\giftcard;

use app\services\BaseServices;
use app\dao\giftcard\GiftCardDao;

class GiftCardServices extends BaseServices
{
    public function __construct(GiftCardDao $dao)
    {
        $this->dao = $dao;
    }
    
    /**
     * 批量生成礼品卡
     * 就像印刷一批购物券
     */
    public function batchGenerate($data)
    {
        // 提取参数
        $productId = $data['product_id'];      // 商品ID
        $quantity = $data['quantity'];         // 生成数量
        $expireDays = $data['expire_days'];   // 有效天数
        $batchId = $this->generateBatchId();   // 批次号
        
        // 获取商品信息
        $productService = app()->make(\app\services\product\product\StoreProductServices::class);
        $product = $productService->get($productId);
        
        if (!$product) {
            throw new \Exception('商品不存在');
        }
        
        $cards = [];
        $successCount = 0;
        
        // 循环生成卡片
        for ($i = 0; $i < $quantity; $i++) {
            // 生成唯一的卡号和密码
            $cardCode = $this->generateCardCode();
            $cardPassword = $this->generateCardPassword();
            
            // 确保卡号唯一
            while ($this->dao->count(['card_code' => $cardCode]) > 0) {
                $cardCode = $this->generateCardCode();
            }
            
            $cardData = [
                'card_code' => $cardCode,
                'card_password' => $cardPassword,
                'card_type' => 1,  // 商品卡
                'product_id' => $productId,
                'product_name' => $product['store_name'],
                'product_image' => $product['image'],
                'batch_id' => $batchId,
                'source_type' => 1,  // 管理员发放
                'status' => 1,  // 未使用
                'expire_time' => time() + $expireDays * 86400,
                'create_time' => time()
            ];
            
            if ($this->dao->save($cardData)) {
                $successCount++;
                $cards[] = [
                    'card_code' => $cardCode,
                    'card_password' => $cardPassword
                ];
            }
        }
        
        return [
            'batch_id' => $batchId,
            'total' => $quantity,
            'success' => $successCount,
            'cards' => $cards
        ];
    }
    
    /**
     * 生成批次号
     * 格式：GC + 年月日 + 4位随机数
     */
    protected function generateBatchId()
    {
        return 'GC' . date('Ymd') . rand(1000, 9999);
    }
    
    /**
     * 生成卡号
     * 16位数字，像银行卡号
     */
    protected function generateCardCode()
    {
        // 前缀（4位） + 时间戳后8位 + 随机4位
        $prefix = '8888';  // 吉利数字
        $timestamp = substr(time(), -8);
        $random = rand(1000, 9999);
        
        return $prefix . $timestamp . $random;
    }
    
    /**
     * 生成卡密
     * 12位字母数字组合
     */
    protected function generateCardPassword()
    {
        $chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
        $password = '';
        
        for ($i = 0; i < 12; $i++) {
            if ($i > 0 && $i % 4 == 0) {
                $password .= '-';  // 每4位加个横线，方便输入
            }
            $password .= $chars[rand(0, strlen($chars) - 1)];
        }
        
        return $password;
    }
    
    /**
     * 使用礼品卡
     * 就像刷购物卡结账
     */
    public function useCard($userId, $cardCode, $cardPassword)
    {
        // 查找礼品卡
        $card = $this->dao->getOne([
            'card_code' => $cardCode,
            'card_password' => $cardPassword
        ]);
        
        if (!$card) {
            throw new \Exception('礼品卡号或密码错误');
        }
        
        // 检查状态
        if ($card['status'] != 1) {
            $statusText = ['', '未使用', '已使用', '已过期'];
            throw new \Exception('该礼品卡' . $statusText[$card['status']]);
        }
        
        // 检查是否过期
        if ($card['expire_time'] < time()) {
            $this->dao->update($card['id'], ['status' => 3]);
            throw new \Exception('礼品卡已过期');
        }
        
        // 绑定用户
        if (!$card['user_id']) {
            $this->dao->update($card['id'], ['user_id' => $userId]);
        } elseif ($card['user_id'] != $userId) {
            throw new \Exception('该礼品卡已被其他用户绑定');
        }
        
        return $card;
    }
    
    /**
     * 创建分销奖励礼品卡
     * 老用户分销成功后调用
     */
    public function createDistributionCard($userId, $productId)
    {
        // 获取商品信息
        $productService = app()->make(\app\services\product\product\StoreProductServices::class);
        $product = $productService->get($productId);
        
        // 生成礼品卡
        $cardData = [
            'card_code' => $this->generateCardCode(),
            'card_password' => $this->generateCardPassword(),
            'card_type' => 2,  // 分销卡
            'product_id' => $productId,
            'product_name' => $product['store_name'],
            'product_image' => $product['image'],
            'user_id' => $userId,  // 直接绑定用户
            'source_type' => 2,  // 分销奖励
            'status' => 1,
            'expire_time' => time() + 365 * 86400,  // 一年有效期
            'create_time' => time()
        ];
        
        $this->dao->save($cardData);
        
        // 发送通知
        $this->sendGiftCardNotice($userId, $cardData);
        
        return $cardData;
    }
}
```

#### 6.2.2 创建礼品卡管理控制器

```php
// 创建文件：app/adminapi/controller/v1/giftcard/GiftCard.php
<?php
namespace app\adminapi\controller\v1\giftcard;

use app\adminapi\controller\AuthController;
use app\services\giftcard\GiftCardServices;

class GiftCard extends AuthController
{
    protected $services;
    
    public function __construct(App $app, GiftCardServices $services)
    {
        parent::__construct($app);
        $this->services = $services;
    }
    
    /**
     * 礼品卡列表
     */
    public function index()
    {
        $where = $this->request->getMore([
            ['card_code', ''],
            ['batch_id', ''],
            ['status', ''],
            ['card_type', ''],
            ['page', 1],
            ['limit', 10]
        ]);
        
        $list = $this->services->getList($where);
        
        return app('json')->success($list);
    }
    
    /**
     * 批量生成礼品卡
     */
    public function batchGenerate()
    {
        $data = $this->request->postMore([
            ['product_id', 0],
            ['quantity', 10],
            ['expire_days', 365]
        ]);
        
        // 验证
        if (!$data['product_id']) {
            return app('json')->fail('请选择商品');
        }
        
        if ($data['quantity'] < 1 || $data['quantity'] > 1000) {
            return app('json')->fail('生成数量必须在1-1000之间');
        }
        
        $result = $this->services->batchGenerate($data);
        
        return app('json')->success('生成成功', $result);
    }
    
    /**
     * 导出礼品卡
     * 导出为Excel，方便打印或分发
     */
    public function export()
    {
        $batchId = $this->request->get('batch_id');
        
        if (!$batchId) {
            return app('json')->fail('请选择批次');
        }
        
        // 获取该批次的礼品卡
        $cards = $this->services->dao->getList(['batch_id' => $batchId]);
        
        // 生成Excel
        $excel = new \PhpOffice\PhpSpreadsheet\Spreadsheet();
        $sheet = $excel->getActiveSheet();
        
        // 设置表头
        $sheet->setCellValue('A1', '卡号');
        $sheet->setCellValue('B1', '密码');
        $sheet->setCellValue('C1', '商品名称');
        $sheet->setCellValue('D1', '有效期');
        $sheet->setCellValue('E1', '状态');
        
        // 填充数据
        $row = 2;
        foreach ($cards as $card) {
            $sheet->setCellValue('A' . $row, $card['card_code']);
            $sheet->setCellValue('B' . $row, $card['card_password']);
            $sheet->setCellValue('C' . $row, $card['product_name']);
            $sheet->setCellValue('D' . $row, date('Y-m-d', $card['expire_time']));
            $sheet->setCellValue('E' . $row, $card['status'] == 1 ? '未使用' : '已使用');
            $row++;
        }
        
        // 输出下载
        $filename = '礼品卡_' . $batchId . '.xlsx';
        header('Content-Type: application/vnd.openxmlformats-officedocument.spreadsheetml.sheet');
        header('Content-Disposition: attachment;filename="' . $filename . '"');
        
        $writer = new \PhpOffice\PhpSpreadsheet\Writer\Xlsx($excel);
        $writer->save('php://output');
    }
}
```

### 6.3 礼品卡使用流程

#### 6.3.1 小程序端礼品卡中心

```vue
<!-- 创建文件：template/uni-app/pages/giftcard/index.vue -->
<template>
  <view class="giftcard-page">
    <!-- 顶部标签 -->
    <view class="tabs">
      <view class="tab" 
            :class="{active: currentTab === 'unused'}"
            @click="switchTab('unused')">
        未使用({{ unusedCount }})
      </view>
      <view class="tab" 
            :class="{active: currentTab === 'used'}"
            @click="switchTab('used')">
        已使用({{ usedCount }})
      </view>
      <view class="tab" 
            :class="{active: currentTab === 'expired'}"
            @click="switchTab('expired')">
        已过期({{ expiredCount }})
      </view>
    </view>
    
    <!-- 添加礼品卡按钮 -->
    <view class="add-card" @click="showAddDialog = true">
      <text class="iconfont icon-add"></text>
      <text>添加礼品卡</text>
    </view>
    
    <!-- 礼品卡列表 -->
    <view class="card-list">
      <view class="card-item" 
            v-for="card in cardList" 
            :key="card.id"
            :class="{disabled: card.status !== 1}">
        
        <!-- 卡片主体 -->
        <view class="card-body">
          <image :src="card.product_image" class="product-img"></image>
          <view class="card-info">
            <view class="product-name">{{ card.product_name }}</view>
            <view class="card-code">卡号：{{ formatCardCode(card.card_code) }}</view>
            <view class="expire-time">
              有效期至：{{ card.expire_time_text }}
            </view>
          </view>
          <view class="card-status">
            <text v-if="card.status === 1" class="status-unused">未使用</text>
            <text v-if="card.status === 2" class="status-used">已使用</text>
            <text v-if="card.status === 3" class="status-expired">已过期</text>
          </view>
        </view>
        
        <!-- 使用按钮 -->
        <view class="card-action" v-if="card.status === 1">
          <button class="use-btn" @click="useCard(card)">立即使用</button>
        </view>
      </view>
    </view>
    
    <!-- 添加礼品卡弹窗 -->
    <uni-popup ref="addDialog" type="bottom">
      <view class="add-dialog">
        <view class="dialog-title">添加礼品卡</view>
        <view class="input-group">
          <input v-model="cardForm.card_code" 
                 placeholder="请输入16位卡号"
                 maxlength="16"
                 type="number" />
        </view>
        <view class="input-group">
          <input v-model="cardForm.card_password" 
                 placeholder="请输入卡密（含横线）"
                 maxlength="15" />
        </view>
        <view class="dialog-tips">
          提示：卡密格式为 XXXX-XXXX-XXXX
        </view>
        <view class="dialog-btns">
          <button class="btn-cancel" @click="$refs.addDialog.close()">取消</button>
          <button class="btn-confirm" @click="addCard">确定</button>
        </view>
      </view>
    </uni-popup>
  </view>
</template>

<script>
import { getMyGiftCards, bindGiftCard } from '@/api/giftcard.js'

export default {
  data() {
    return {
      currentTab: 'unused',
      cardList: [],
      unusedCount: 0,
      usedCount: 0,
      expiredCount: 0,
      showAddDialog: false,
      cardForm: {
        card_code: '',
        card_password: ''
      }
    }
  },
  
  onLoad() {
    this.loadCards()
  },
  
  methods: {
    // 加载礼品卡列表
    async loadCards() {
      const res = await getMyGiftCards({
        status: this.getStatusByTab()
      })
      
      this.cardList = res.data.list
      this.unusedCount = res.data.unused_count
      this.usedCount = res.data.used_count
      this.expiredCount = res.data.expired_count
    },
    
    // 格式化卡号显示
    formatCardCode(code) {
      // 1234 5678 9012 3456
      return code.replace(/(\d{4})(?=\d)/g, '$1 ')
    },
    
    // 使用礼品卡
    useCard(card) {
      uni.navigateTo({
        url: `/pages/goods/goods?id=${card.product_id}&gift_card_id=${card.id}`
      })
    },
    
    // 添加礼品卡
    async addCard() {
      if (!this.cardForm.card_code || !this.cardForm.card_password) {
        uni.showToast({
          title: '请输入完整信息',
          icon: 'none'
        })
        return
      }
      
      try {
        await bindGiftCard(this.cardForm)
        uni.showToast({
          title: '添加成功',
          icon: 'success'
        })
        this.$refs.addDialog.close()
        this.cardForm = {
          card_code: '',
          card_password: ''
        }
        this.loadCards()
      } catch (error) {
        uni.showToast({
          title: error.message || '添加失败',
          icon: 'none'
        })
      }
    }
  }
}
</script>

<style lang="scss">
.giftcard-page {
  background: #f5f5f5;
  min-height: 100vh;
  
  .tabs {
    display: flex;
    background: #fff;
    
    .tab {
      flex: 1;
      text-align: center;
      padding: 30rpx 0;
      font-size: 30rpx;
      color: #666;
      position: relative;
      
      &.active {
        color: #ff6b6b;
        
        &::after {
          content: '';
          position: absolute;
          bottom: 0;
          left: 50%;
          transform: translateX(-50%);
          width: 60rpx;
          height: 4rpx;
          background: #ff6b6b;
        }
      }
    }
  }
  
  .add-card {
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 20rpx;
    padding: 20rpx;
    background: #fff;
    border-radius: 10rpx;
    color: #ff6b6b;
    font-size: 30rpx;
    
    .iconfont {
      margin-right: 10rpx;
    }
  }
  
  .card-list {
    padding: 0 20rpx;
    
    .card-item {
      background: #fff;
      border-radius: 20rpx;
      margin-bottom: 20rpx;
      overflow: hidden;
      
      &.disabled {
        opacity: 0.6;
      }
      
      .card-body {
        display: flex;
        padding: 30rpx;
        
        .product-img {
          width: 160rpx;
          height: 160rpx;
          border-radius: 10rpx;
        }
        
        .card-info {
          flex: 1;
          margin-left: 30rpx;
          
          .product-name {
            font-size: 32rpx;
            font-weight: bold;
            margin-bottom: 20rpx;
          }
          
          .card-code {
            font-size: 26rpx;
            color: #666;
            margin-bottom: 10rpx;
          }
          
          .expire-time {
            font-size: 24rpx;
            color: #999;
          }
        }
        
        .card-status {
          .status-unused {
            color: #07c160;
          }
          
          .status-used {
            color: #999;
          }
          
          .status-expired {
            color: #ff6b6b;
          }
        }
      }
      
      .card-action {
        padding: 20rpx 30rpx;
        border-top: 1rpx solid #f5f5f5;
        
        .use-btn {
          width: 100%;
          height: 70rpx;
          background: linear-gradient(45deg, #ff6b6b, #ff8e53);
          color: #fff;
          font-size: 30rpx;
          border-radius: 35rpx;
        }
      }
    }
  }
  
  .add-dialog {
    background: #fff;
    padding: 40rpx;
    border-radius: 20rpx 20rpx 0 0;
    
    .dialog-title {
      font-size: 36rpx;
      font-weight: bold;
      text-align: center;
      margin-bottom: 40rpx;
    }
    
    .input-group {
      margin-bottom: 30rpx;
      
      input {
        width: 100%;
        height: 88rpx;
        padding: 0 30rpx;
        border: 2rpx solid #e5e5e5;
        border-radius: 10rpx;
        font-size: 30rpx;
      }
    }
    
    .dialog-tips {
      font-size: 24rpx;
      color: #999;
      margin-bottom: 40rpx;
    }
    
    .dialog-btns {
      display: flex;
      
      button {
        flex: 1;
        height: 88rpx;
        font-size: 32rpx;
        border-radius: 44rpx;
        
        &.btn-cancel {
          background: #f5f5f5;
          color: #666;
          margin-right: 20rpx;
        }
        
        &.btn-confirm {
          background: linear-gradient(45deg, #ff6b6b, #ff8e53);
          color: #fff;
        }
      }
    }
  }
}
</style>
```

### 6.4 礼品卡兑换流程

#### 6.4.1 创建礼品卡兑换服务

```php
// 修改文件：app/services/order/StoreOrderServices.php
// 添加礼品卡兑换订单方法

/**
 * 使用礼品卡创建订单
 * 就像用购物券直接换商品
 */
public function createGiftCardOrder($uid, $giftCardId, $addressId)
{
    // 获取礼品卡信息
    $giftCardService = app()->make(\app\services\giftcard\GiftCardServices::class);
    $giftCard = $giftCardService->dao->get($giftCardId);
    
    if (!$giftCard) {
        throw new \Exception('礼品卡不存在');
    }
    
    if ($giftCard['user_id'] != $uid) {
        throw new \Exception('这不是您的礼品卡');
    }
    
    if ($giftCard['status'] != 1) {
        throw new \Exception('礼品卡已使用或已过期');
    }
    
    // 获取商品信息
    $productService = app()->make(\app\services\product\product\StoreProductServices::class);
    $product = $productService->get($giftCard['product_id']);
    
    if (!$product || !$product['is_show'] || !$product['is_del']) {
        throw new \Exception('商品已下架');
    }
    
    // 创建订单数据
    $orderInfo = [
        'uid' => $uid,
        'order_id' => $this->getNewOrderId(),  // 生成订单号
        'real_name' => '',  // 从地址获取
        'user_phone' => '',
        'user_address' => '',
        'cart_id' => [],
        'total_num' => 1,
        'total_price' => $product['price'],
        'pay_price' => 0,  // 礼品卡兑换，支付金额为0
        'paid' => 1,  // 已支付
        'pay_type' => 'giftcard',  // 支付方式：礼品卡
        'pay_time' => time(),
        'deduction_price' => $product['price'],  // 抵扣金额
        'coupon_price' => 0,
        'is_gift_card' => 1,  // 标记为礼品卡订单
        'gift_card_id' => $giftCardId,
        'mark' => '礼品卡兑换订单',
        'add_time' => time()
    ];
    
    // 开启事务
    $this->transaction(function () use ($orderInfo, $giftCard, $product) {
        // 1. 创建订单
        $order = $this->dao->save($orderInfo);
        
        // 2. 创建订单商品
        $this->dao->saveOrderCart($order['id'], [
            [
                'product_id' => $product['id'],
                'cart_info' => $product->toArray(),
                'cart_num' => 1,
                'unique' => $product['unique'] ?? ''
            ]
        ]);
        
        // 3. 更新礼品卡状态
        $giftCardService->dao->update($giftCard['id'], [
            'status' => 2,  // 已使用
            'use_time' => time(),
            'use_order_id' => $orderInfo['order_id']
        ]);
        
        // 4. 减少商品库存
        $productService->decStock([$product['id'] => 1]);
        
        // 5. 记录使用日志
        $this->recordGiftCardUseLog($uid, $giftCard, $order);
    });
    
    return $orderInfo;
}
```

### 6.5 礼品卡统计与报表

#### 6.5.1 创建统计服务

```php
// 创建文件：app/services/giftcard/GiftCardStatisticsServices.php
<?php
namespace app\services\giftcard;

use app\services\BaseServices;

class GiftCardStatisticsServices extends BaseServices
{
    /**
     * 获取礼品卡统计数据
     * 就像查看购物券的使用报表
     */
    public function getStatistics($where = [])
    {
        $giftCardDao = app()->make(\app\dao\giftcard\GiftCardDao::class);
        
        // 总体统计
        $total = [
            'total_count' => $giftCardDao->count(),  // 总数量
            'unused_count' => $giftCardDao->count(['status' => 1]),  // 未使用
            'used_count' => $giftCardDao->count(['status' => 2]),  // 已使用
            'expired_count' => $giftCardDao->count(['status' => 3]),  // 已过期
        ];
        
        // 计算使用率
        $total['use_rate'] = $total['total_count'] > 0 
            ? round($total['used_count'] / $total['total_count'] * 100, 2) 
            : 0;
        
        // 按商品统计
        $productStats = $giftCardDao->getModel()
            ->field('product_id, product_name, COUNT(*) as total, 
                    SUM(status = 1) as unused, 
                    SUM(status = 2) as used')
            ->group('product_id')
            ->select();
        
        // 按批次统计
        $batchStats = $giftCardDao->getModel()
            ->field('batch_id, COUNT(*) as total, 
                    SUM(status = 1) as unused, 
                    SUM(status = 2) as used,
                    MIN(create_time) as create_time')
            ->where('batch_id', '<>', '')
            ->group('batch_id')
            ->order('create_time desc')
            ->select();
        
        // 使用趋势（最近30天）
        $trends = [];
        for ($i = 29; $i >= 0; $i--) {
            $date = date('Y-m-d', strtotime("-{$i} days"));
            $startTime = strtotime($date);
            $endTime = $startTime + 86400;
            
            $dayCount = $giftCardDao->count([
                ['use_time', '>=', $startTime],
                ['use_time', '<', $endTime],
                ['status', '=', 2]
            ]);
            
            $trends[] = [
                'date' => $date,
                'count' => $dayCount
            ];
        }
        
        return compact('total', 'productStats', 'batchStats', 'trends');
    }
    
    /**
     * 导出使用报表
     */
    public function exportUsageReport($where)
    {
        // 获取使用记录
        $list = app()->make(\app\dao\giftcard\GiftCardLogDao::class)
            ->getModel()
            ->with(['user', 'giftCard'])
            ->where($where)
            ->select();
        
        // 生成报表数据
        $reportData = [];
        foreach ($list as $item) {
            $reportData[] = [
                '使用时间' => date('Y-m-d H:i:s', $item['create_time']),
                '用户昵称' => $item['user']['nickname'],
                '用户手机' => $item['user']['phone'],
                '卡号' => $item['giftCard']['card_code'],
                '商品名称' => $item['giftCard']['product_name'],
                '订单号' => $item['order_id']
            ];
        }
        
        return $reportData;
    }
}
```

### 6.6 本章练习

1. **功能实现**：
   - 实现礼品卡批量发放功能
   - 添加礼品卡转赠功能
   - 实现礼品卡余额功能（一张卡多次使用）

2. **思考题**：
   - 如何防止礼品卡被盗用？
   - 如何处理礼品卡退款问题？

3. **扩展任务**：
   - 设计电子礼品卡样式
   - 实现礼品卡充值功能
   - 添加礼品卡使用限制（如指定时间、指定用户等）

---

## 第七章：先用后付系统开发 - 建立信任经济

### 7.1 理解先用后付

先用后付就像**信用卡购物**：
- 🏦 **信用额度**：每个合伙人都有一定的信用额度
- 📅 **账期管理**：固定的还款周期（如30天）
- ⚠️ **风险控制**：逾期管理和信用评估

### 7.2 信用系统架构设计

#### 7.2.1 创建信用管理服务

```php
// 创建文件：app/services/credit/UserCreditServices.php
<?php
namespace app\services\credit;

use app\services\BaseServices;
use app\dao\credit\UserCreditDao;

class UserCreditServices extends BaseServices
{
    public function __construct(UserCreditDao $dao)
    {
        $this->dao = $dao;
    }
    
    /**
     * 初始化用户信用
     * 当用户成为合伙人时调用
     */
    public function initUserCredit($userId, $partnerLevel)
    {
        // 检查是否已存在
        $credit = $this->dao->getOne(['user_id' => $userId]);
        if ($credit) {
            return $credit;
        }
        
        // 根据合伙人等级设置信用额度
        $creditLimits = [
            1 => 1000.00,   // 梦想合伙人
            2 => 5000.00,   // 战略合伙人
            3 => 10000.00   // 城市合伙人
        ];
        
        $creditLimit = $creditLimits[$partnerLevel] ?? 0;
        
        // 创建信用记录
        $data = [
            'user_id' => $userId,
            'credit_limit' => $creditLimit,
            'used_credit' => 0,
            'available_credit' => $creditLimit,
            'credit_score' => 100,  // 初始信用分
            'is_enabled' => 1,
            'status' => 1,
            'create_time' => time()
        ];
        
        return $this->dao->save($data);
    }
    
    /**
     * 检查信用额度
     * 下单时调用，检查是否可以使用信用支付
     */
    public function checkCreditLimit($userId, $amount)
    {
        $credit = $this->dao->getOne(['user_id' => $userId]);
        
        if (!$credit) {
            throw new \Exception('您还未开通信用支付');
        }
        
        if (!$credit['is_enabled']) {
            throw new \Exception('您的信用支付功能已被禁用');
        }
        
        if ($credit['status'] != 1) {
            throw new \Exception('您的信用账户状态异常');
        }
        
        if ($credit['available_credit'] < $amount) {
            throw new \Exception('信用额度不足，可用额度：¥' . $credit['available_credit']);
        }
        
        // 检查是否有逾期未还
        $overdueCount = app()->make(CreditOrderServices::class)
            ->dao->count([
                'user_id' => $userId,
                'status' => 3  // 逾期状态
            ]);
        
        if ($overdueCount > 0) {
            throw new \Exception('您有逾期未还款项，请先还款');
        }
        
        return true;
    }
    
    /**
     * 使用信用额度
     * 创建信用订单时调用
     */
    public function useCredit($userId, $amount, $orderId)
    {
        $credit = $this->dao->getOne(['user_id' => $userId]);
        
        // 再次检查额度
        if ($credit['available_credit'] < $amount) {
            throw new \Exception('信用额度不足');
        }
        
        // 更新信用额度
        $this->dao->update($credit['id'], [
            'used_credit' => $credit['used_credit'] + $amount,
            'available_credit' => $credit['available_credit'] - $amount,
            'update_time' => time()
        ]);
        
        // 记录信用使用日志
        $this->recordCreditLog($userId, 'use', $amount, $orderId);
        
        return true;
    }
    
    /**
     * 还款
     * 用户还款时调用
     */
    public function repayment($userId, $amount, $creditOrderId)
    {
        $credit = $this->dao->getOne(['user_id' => $userId]);
        
        // 更新信用额度
        $this->dao->update($credit['id'], [
            'used_credit' => max(0, $credit['used_credit'] - $amount),
            'available_credit' => min($credit['credit_limit'], $credit['available_credit'] + $amount),
            'update_time' => time()
        ]);
        
        // 更新信用分（按时还款加分）
        $this->updateCreditScore($userId, 5);
        
        // 记录还款日志
        $this->recordCreditLog($userId, 'repay', $amount, $creditOrderId);
        
        return true;
    }
    
    /**
     * 更新信用分
     * 正分表示加分，负分表示扣分
     */
    public function updateCreditScore($userId, $score)
    {
        $credit = $this->dao->getOne(['user_id' => $userId]);
        
        $newScore = max(0, min(150, $credit['credit_score'] + $score));
        
        $this->dao->update($credit['id'], [
            'credit_score' => $newScore,
            'update_time' => time()
        ]);
        
        // 根据信用分调整额度
        $this->adjustCreditLimit($userId, $newScore);
    }
    
    /**
     * 根据信用分调整额度
     * 信用分高的用户可以获得更高额度
     */
    protected function adjustCreditLimit($userId, $creditScore)
    {
        $credit = $this->dao->getOne(['user_id' => $userId]);
        
        // 获取基础额度
        $partnerInfo = app()->make(\app\services\partner\PartnerServices::class)
            ->getPartnerInfo($userId);
        
        $baseLimits = [
            1 => 1000.00,
            2 => 5000.00,
            3 => 10000.00
        ];
        
        $baseLimit = $baseLimits[$partnerInfo['partner_level']] ?? 1000;
        
        // 根据信用分计算额度倍数
        $multiplier = 1.0;
        if ($creditScore >= 120) {
            $multiplier = 1.5;  // 150%
        } elseif ($creditScore >= 100) {
            $multiplier = 1.2;  // 120%
        } elseif ($creditScore < 80) {
            $multiplier = 0.5;  // 50%
        }
        
        $newLimit = round($baseLimit * $multiplier, 2);
        
        // 更新额度
        if ($newLimit != $credit['credit_limit']) {
            $availableChange = $newLimit - $credit['credit_limit'];
            
            $this->dao->update($credit['id'], [
                'credit_limit' => $newLimit,
                'available_credit' => max(0, $credit['available_credit'] + $availableChange)
            ]);
        }
    }
}
```

#### 7.2.2 创建信用订单服务

```php
// 创建文件：app/services/credit/CreditOrderServices.php
<?php
namespace app\services\credit;

use app\services\BaseServices;
use app\dao\credit\CreditOrderDao;

class CreditOrderServices extends BaseServices
{
    public function __construct(CreditOrderDao $dao)
    {
        $this->dao = $dao;
    }
    
    /**
     * 创建信用订单
     * 当用户选择先用后付时调用
     */
    public function createCreditOrder($orderInfo)
    {
        // 计算还款时间（30天后）
        $repaymentTime = time() + 30 * 86400;
        
        $data = [
            'order_id' => $orderInfo['order_id'],
            'user_id' => $orderInfo['uid'],
            'credit_amount' => $orderInfo['pay_price'],
            'repayment_amount' => 0,
            'repayment_time' => $repaymentTime,
            'status' => 1,  // 未还款
            'create_time' => time()
        ];
        
        return $this->dao->save($data);
    }
    
    /**
     * 处理还款
     * 支持部分还款
     */
    public function processRepayment($creditOrderId, $amount)
    {
        $creditOrder = $this->dao->get($creditOrderId);
        
        if (!$creditOrder) {
            throw new \Exception('信用订单不存在');
        }
        
        if ($creditOrder['status'] == 2) {
            throw new \Exception('该订单已还清');
        }
        
        // 计算剩余应还金额
        $remainAmount = $creditOrder['credit_amount'] - $creditOrder['repayment_amount'];
        $actualRepayAmount = min($amount, $remainAmount);
        
        // 更新还款金额
        $newRepaymentAmount = $creditOrder['repayment_amount'] + $actualRepayAmount;
        
        $updateData = [
            'repayment_amount' => $newRepaymentAmount,
            'update_time' => time()
        ];
        
        // 如果还清了
        if ($newRepaymentAmount >= $creditOrder['credit_amount']) {
            $updateData['status'] = 2;  // 已还款
            $updateData['actual_repayment_time'] = time();
        }
        
        $this->dao->update($creditOrderId, $updateData);
        
        // 恢复信用额度
        $creditService = app()->make(UserCreditServices::class);
        $creditService->repayment($creditOrder['user_id'], $actualRepayAmount, $creditOrderId);
        
        return $actualRepayAmount;
    }
    
    /**
     * 检查逾期订单
     * 定时任务调用
     */
    public function checkOverdueOrders()
    {
        // 查找所有未还款且已过还款时间的订单
        $overdueOrders = $this->dao->getModel()
            ->where('status', 1)
            ->where('repayment_time', '<', time())
            ->select();
        
        foreach ($overdueOrders as $order) {
            // 计算逾期天数
            $overdueDays = ceil((time() - $order['repayment_time']) / 86400);
            
            // 更新订单状态
            $this->dao->update($order['id'], [
                'status' => 3,  // 逾期
                'overdue_days' => $overdueDays,
                'update_time' => time()
            ]);
            
            // 扣除信用分
            $creditService = app()->make(UserCreditServices::class);
            $creditService->updateCreditScore($order['user_id'], -10);
            
            // 发送逾期提醒
            $this->sendOverdueReminder($order);
        }
    }
    
    /**
     * 发送还款提醒
     * 提前3天提醒
     */
    public function sendRepaymentReminder()
    {
        // 查找3天后到期的订单
        $startTime = time() + 2 * 86400;  // 2天后
        $endTime = time() + 4 * 86400;    // 4天后
        
        $orders = $this->dao->getModel()
            ->where('status', 1)
            ->where('repayment_time', '>=', $startTime)
            ->where('repayment_time', '<', $endTime)
            ->where('remind_count', '<', 3)  // 最多提醒3次
            ->select();
        
        foreach ($orders as $order) {
            // 发送提醒
            $this->sendReminder($order, 'repayment');
            
            // 更新提醒次数
            $this->dao->inc($order['id'], 'remind_count');
            $this->dao->update($order['id'], [
                'last_remind_time' => time()
            ]);
        }
    }
    
    /**
     * 发送提醒
     * 使用短信或微信模板消息
     */
    protected function sendReminder($order, $type)
    {
        $userService = app()->make(\app\services\user\UserServices::class);
        $user = $userService->get($order['user_id']);
        
        if ($type == 'repayment') {
            // 还款提醒
            $daysLeft = ceil(($order['repayment_time'] - time()) / 86400);
            $message = "【庆人府商城】您有一笔￥{$order['credit_amount']}的信用订单将在{$daysLeft}天后到期，请及时还款。";
        } else {
            // 逾期提醒
            $message = "【庆人府商城】您有一笔￥{$order['credit_amount']}的信用订单已逾期{$order['overdue_days']}天，请尽快还款以免影响信用。";
        }
        
        // 发送短信
        if ($user['phone']) {
            app()->make(\app\services\message\SmsServices::class)
                ->send($user['phone'], $message);
        }
        
        // 发送微信模板消息
        if ($user['openid']) {
            // 调用微信模板消息服务
        }
    }
}
```

### 7.3 前端信用支付界面

#### 7.3.1 订单确认页面添加信用支付

```vue
<!-- 修改文件：template/uni-app/pages/order/order-confirm.vue -->
<!-- 在支付方式选择部分添加 -->

<template>
  <view class="order-confirm">
    <!-- 其他内容... -->
    
    <!-- 支付方式选择 -->
    <view class="payment-section">
      <view class="section-title">支付方式</view>
      <view class="payment-list">
        <!-- 微信支付 -->
        <view class="payment-item" @click="selectPayment('weixin')">
          <image src="/static/images/wechat-pay.png" class="pay-icon"></image>
          <text class="pay-name">微信支付</text>
          <view class="radio" :class="{active: payType === 'weixin'}"></view>
        </view>
        
        <!-- 余额支付 -->
        <view class="payment-item" @click="selectPayment('balance')">
          <image src="/static/images/balance-pay.png" class="pay-icon"></image>
          <text class="pay-name">余额支付</text>
          <text class="balance">¥{{ userInfo.balance }}</text>
          <view class="radio" :class="{active: payType === 'balance'}"></view>
        </view>
        
        <!-- 信用支付（仅合伙人可见） -->
        <view class="payment-item" 
              v-if="creditInfo && creditInfo.is_enabled"
              @click="selectPayment('credit')">
          <image src="/static/images/credit-pay.png" class="pay-icon"></image>
          <view class="pay-info">
            <text class="pay-name">先用后付</text>
            <text class="pay-desc">30天免息，可用额度¥{{ creditInfo.available_credit }}</text>
          </view>
          <view class="radio" :class="{active: payType === 'credit'}"></view>
        </view>
      </view>
      
      <!-- 信用支付提示 -->
      <view class="credit-tips" v-if="payType === 'credit'">
        <view class="tips-title">
          <text class="iconfont icon-info"></text>
          <text>先用后付说明</text>
        </view>
        <view class="tips-content">
          <view>1. 订单确认收货后30天内还款，无需支付利息</view>
          <view>2. 到期前3天会发送还款提醒</view>
          <view>3. 逾期将影响您的信用额度</view>
        </view>
      </view>
    </view>
    
    <!-- 提交订单按钮 -->
    <view class="bottom-bar">
      <view class="total-info">
        <text class="label">需支付：</text>
        <text class="price">¥{{ totalPrice }}</text>
      </view>
      <button class="submit-btn" @click="submitOrder">
        {{ payType === 'credit' ? '确认使用信用支付' : '提交订单' }}
      </button>
    </view>
  </view>
</template>

<script>
import { getCreditInfo } from '@/api/credit.js'

export default {
  data() {
    return {
      payType: 'weixin',
      creditInfo: null,
      // ... 其他数据
    }
  },
  
  onLoad() {
    this.loadCreditInfo()
  },
  
  methods: {
    // 加载信用信息
    async loadCreditInfo() {
      try {
        const res = await getCreditInfo()
        this.creditInfo = res.data
      } catch (error) {
        // 非合伙人不显示信用支付
      }
    },
    
    // 选择支付方式
    selectPayment(type) {
      if (type === 'credit' && this.totalPrice > this.creditInfo.available_credit) {
        uni.showToast({
          title: '信用额度不足',
          icon: 'none'
        })
        return
      }
      this.payType = type
    },
    
    // 提交订单
    async submitOrder() {
      if (this.payType === 'credit') {
        // 信用支付确认
        uni.showModal({
          title: '确认使用信用支付',
          content: `本次消费¥${this.totalPrice}，将从您的信用额度中扣除，请在30天内还款。`,
          success: (res) => {
            if (res.confirm) {
              this.createOrder()
            }
          }
        })
      } else {
        this.createOrder()
      }
    }
  }
}
</script>

<style lang="scss">
.payment-section {
  background: #fff;
  margin: 20rpx 0;
  padding: 30rpx;
  
  .payment-item {
    display: flex;
    align-items: center;
    padding: 30rpx 0;
    border-bottom: 1rpx solid #f5f5f5;
    
    .pay-icon {
      width: 60rpx;
      height: 60rpx;
      margin-right: 20rpx;
    }
    
    .pay-info {
      flex: 1;
      
      .pay-name {
        font-size: 32rpx;
        display: block;
      }
      
      .pay-desc {
        font-size: 24rpx;
        color: #999;
        margin-top: 8rpx;
      }
    }
    
    .balance {
      color: #ff6b6b;
      margin-right: 20rpx;
    }
    
    .radio {
      width: 40rpx;
      height: 40rpx;
      border: 2rpx solid #ddd;
      border-radius: 50%;
      
      &.active {
        border-color: #ff6b6b;
        position: relative;
        
        &::after {
          content: '';
          position: absolute;
          top: 50%;
          left: 50%;
          transform: translate(-50%, -50%);
          width: 20rpx;
          height: 20rpx;
          background: #ff6b6b;
          border-radius: 50%;
        }
      }
    }
  }
  
  .credit-tips {
    margin-top: 30rpx;
    padding: 20rpx;
    background: #fff5f5;
    border-radius: 10rpx;
    
    .tips-title {
      display: flex;
      align-items: center;
      font-size: 28rpx;
      color: #ff6b6b;
      margin-bottom: 20rpx;
      
      .iconfont {
        margin-right: 10rpx;
      }
    }
    
    .tips-content {
      font-size: 24rpx;
      color: #666;
      
      view {
        margin-bottom: 10rpx;
      }
    }
  }
}
</style>
```

#### 7.3.2 信用管理中心

```vue
<!-- 创建文件：template/uni-app/pages/credit/index.vue -->
<template>
  <view class="credit-center">
    <!-- 信用额度卡片 -->
    <view class="credit-card">
      <view class="card-bg"></view>
      <view class="card-content">
        <view class="card-title">我的信用额度</view>
        <view class="credit-info">
          <view class="amount-item">
            <view class="label">总额度</view>
            <view class="amount">¥{{ creditInfo.credit_limit }}</view>
          </view>
          <view class="amount-item">
            <view class="label">已使用</view>
            <view class="amount used">¥{{ creditInfo.used_credit }}</view>
          </view>
          <view class="amount-item">
            <view class="label">可使用</view>
            <view class="amount available">¥{{ creditInfo.available_credit }}</view>
          </view>
        </view>
        <view class="credit-score">
          <text>信用分：</text>
          <text class="score">{{ creditInfo.credit_score }}</text>
          <text class="score-desc">{{ getCreditLevel(creditInfo.credit_score) }}</text>
        </view>
      </view>
    </view>
    
    <!-- 待还款订单 -->
    <view class="pending-section" v-if="pendingOrders.length > 0">
      <view class="section-header">
        <text class="title">待还款</text>
        <text class="count">{{ pendingOrders.length }}笔</text>
      </view>
      
      <view class="order-list">
        <view class="order-item" 
              v-for="order in pendingOrders" 
              :key="order.id">
          <view class="order-info">
            <view class="order-no">订单号：{{ order.order_id }}</view>
            <view class="order-time">{{ order.create_time_text }}</view>
          </view>
          <view class="order-amount">
            <view class="amount">¥{{ order.credit_amount }}</view>
            <view class="due-date" :class="{overdue: order.is_overdue}">
              {{ order.is_overdue ? '已逾期' + order.overdue_days + '天' : order.days_left + '天后到期' }}
            </view>
          </view>
          <button class="repay-btn" @click="goRepay(order)">立即还款</button>
        </view>
      </view>
    </view>
    
    <!-- 还款记录 -->
    <view class="record-section">
      <view class="section-header">
        <text class="title">还款记录</text>
        <text class="more" @click="goRecords">查看全部</text>
      </view>
      
      <view class="record-list">
        <view class="record-item" 
              v-for="record in recentRecords" 
              :key="record.id">
          <view class="record-info">
            <view class="record-title">还款成功</view>
            <view class="record-time">{{ record.create_time_text }}</view>
          </view>
          <view class="record-amount">-¥{{ record.amount }}</view>
        </view>
      </view>
    </view>
  </view>
</template>

<script>
import { getCreditInfo, getPendingOrders, getRepayRecords } from '@/api/credit.js'

export default {
  data() {
    return {
      creditInfo: {
        credit_limit: 0,
        used_credit: 0,
        available_credit: 0,
        credit_score: 100
      },
      pendingOrders: [],
      recentRecords: []
    }
  },
  
  onShow() {
    this.loadData()
  },
  
  methods: {
    async loadData() {
      // 加载信用信息
      const creditRes = await getCreditInfo()
      this.creditInfo = creditRes.data
      
      // 加载待还款订单
      const ordersRes = await getPendingOrders()
      this.pendingOrders = ordersRes.data.list
      
      // 加载还款记录
      const recordsRes = await getRepayRecords({ limit: 5 })
      this.recentRecords = recordsRes.data.list
    },
    
    // 获取信用等级描述
    getCreditLevel(score) {
      if (score >= 120) return '信用极好'
      if (score >= 100) return '信用良好'
      if (score >= 80) return '信用一般'
      return '信用较差'
    },
    
    // 去还款
    goRepay(order) {
      uni.navigateTo({
        url: `/pages/credit/repay?id=${order.id}`
      })
    },
    
    // 查看全部记录
    goRecords() {
      uni.navigateTo({
        url: '/pages/credit/records'
      })
    }
  }
}
</script>

<style lang="scss">
.credit-center {
  background: #f5f5f5;
  min-height: 100vh;
  padding-bottom: 20rpx;
  
  .credit-card {
    position: relative;
    margin: 20rpx;
    border-radius: 20rpx;
    overflow: hidden;
    box-shadow: 0 4rpx 20rpx rgba(0,0,0,0.1);
    
    .card-bg {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }
    
    .card-content {
      position: relative;
      padding: 40rpx;
      color: #fff;
      
      .card-title {
        font-size: 32rpx;
        margin-bottom: 40rpx;
      }
      
      .credit-info {
        display: flex;
        justify-content: space-between;
        margin-bottom: 40rpx;
        
        .amount-item {
          text-align: center;
          
          .label {
            font-size: 26rpx;
            opacity: 0.8;
            margin-bottom: 10rpx;
          }
          
          .amount {
            font-size: 36rpx;
            font-weight: bold;
            
            &.used {
              color: #ffd700;
            }
            
            &.available {
              color: #90ee90;
            }
          }
        }
      }
      
      .credit-score {
        text-align: center;
        font-size: 28rpx;
        
        .score {
          font-size: 48rpx;
          font-weight: bold;
          margin: 0 10rpx;
        }
        
        .score-desc {
          opacity: 0.8;
        }
      }
    }
  }
  
  .pending-section, .record-section {
    margin: 20rpx;
    background: #fff;
    border-radius: 20rpx;
    padding: 30rpx;
    
    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 30rpx;
      
      .title {
        font-size: 32rpx;
        font-weight: bold;
      }
      
      .count {
        color: #ff6b6b;
        font-size: 28rpx;
      }
      
      .more {
        color: #666;
        font-size: 28rpx;
      }
    }
    
    .order-item {
      display: flex;
      align-items: center;
      padding: 30rpx 0;
      border-bottom: 1rpx solid #f5f5f5;
      
      &:last-child {
        border-bottom: none;
      }
      
      .order-info {
        flex: 1;
        
        .order-no {
          font-size: 30rpx;
          margin-bottom: 10rpx;
        }
        
        .order-time {
          font-size: 26rpx;
          color: #999;
        }
      }
      
      .order-amount {
        text-align: right;
        margin-right: 30rpx;
        
        .amount {
          font-size: 36rpx;
          font-weight: bold;
          color: #333;
        }
        
        .due-date {
          font-size: 24rpx;
          color: #666;
          margin-top: 8rpx;
          
          &.overdue {
            color: #ff6b6b;
          }
        }
      }
      
      .repay-btn {
        width: 140rpx;
        height: 60rpx;
        background: linear-gradient(45deg, #667eea, #764ba2);
        color: #fff;
        font-size: 26rpx;
        border-radius: 30rpx;
      }
    }
    
    .record-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 20rpx 0;
      
      .record-info {
        .record-title {
          font-size: 30rpx;
          margin-bottom: 8rpx;
        }
        
        .record-time {
          font-size: 26rpx;
          color: #999;
        }
      }
      
      .record-amount {
        font-size: 32rpx;
        color: #ff6b6b;
        font-weight: bold;
      }
    }
  }
}
</style>
```

### 7.4 定时任务管理

#### 7.4.1 创建信用管理定时任务

```php
// 创建文件：app/jobs/credit/CreditManageJob.php
<?php
namespace app\jobs\credit;

use crmeb\basic\BaseJobs;
use think\facade\Log;

/**
 * 信用管理定时任务
 * 每天凌晨执行一次
 */
class CreditManageJob extends BaseJobs
{
    /**
     * 执行任务
     */
    public function doJob()
    {
        try {
            Log::info('开始执行信用管理定时任务');
            
            // 1. 检查逾期订单
            $this->checkOverdueOrders();
            
            // 2. 发送还款提醒
            $this->sendRepaymentReminders();
            
            // 3. 更新信用分
            $this->updateCreditScores();
            
            // 4. 清理过期数据
            $this->cleanExpiredData();
            
            Log::info('信用管理定时任务执行完成');
            
            return true;
        } catch (\Exception $e) {
            Log::error('信用管理定时任务执行失败：' . $e->getMessage());
            return false;
        }
    }
    
    /**
     * 检查逾期订单
     */
    protected function checkOverdueOrders()
    {
        $creditOrderService = app()->make(\app\services\credit\CreditOrderServices::class);
        $creditOrderService->checkOverdueOrders();
    }
    
    /**
     * 发送还款提醒
     */
    protected function sendRepaymentReminders()
    {
        $creditOrderService = app()->make(\app\services\credit\CreditOrderServices::class);
        $creditOrderService->sendRepaymentReminder();
    }
    
    /**
     * 更新信用分
     * 根据用户的还款行为更新信用分
     */
    protected function updateCreditScores()
    {
        $creditService = app()->make(\app\services\credit\UserCreditServices::class);
        
        // 获取所有有信用记录的用户
        $users = $creditService->dao->getModel()->select();
        
        foreach ($users as $user) {
            // 计算信用分变化
            $scoreChange = $this->calculateScoreChange($user['user_id']);
            
            if ($scoreChange != 0) {
                $creditService->updateCreditScore($user['user_id'], $scoreChange);
            }
        }
    }
    
    /**
     * 计算信用分变化
     */
    protected function calculateScoreChange($userId)
    {
        $creditOrderDao = app()->make(\app\dao\credit\CreditOrderDao::class);
        
        // 统计最近30天的还款情况
        $startTime = time() - 30 * 86400;
        
        // 按时还款次数
        $onTimeCount = $creditOrderDao->count([
            'user_id' => $userId,
            'status' => 2,
            ['actual_repayment_time', '<=', 'repayment_time'],
            ['create_time', '>=', $startTime]
        ]);
        
        // 逾期次数
        $overdueCount = $creditOrderDao->count([
            'user_id' => $userId,
            'status' => 3,
            ['create_time', '>=', $startTime]
        ]);
        
        // 计算分数变化
        $score = $onTimeCount * 2 - $overdueCount * 5;
        
        return $score;
    }
    
    /**
     * 清理过期数据
     */
    protected function cleanExpiredData()
    {
        // 清理超过1年的还款记录
        $expireTime = time() - 365 * 86400;
        
        app()->make(\app\dao\credit\CreditOrderDao::class)
            ->getModel()
            ->where('status', 2)
            ->where('create_time', '<', $expireTime)
            ->delete();
    }
}
```

#### 7.4.2 配置定时任务

```php
// 在 config/crontab.php 中添加
return [
    // ... 其他任务
    
    // 信用管理任务 - 每天凌晨2点执行
    [
        'title' => '信用管理任务',
        'task' => \app\jobs\credit\CreditManageJob::class,
        'cron' => '0 2 * * *'
    ],
];
```

### 7.5 本章练习

1. **功能实现**：
   - 实现自动还款功能（从余额扣除）
   - 添加还款计划功能
   - 实现信用额度申请提升功能

2. **思考题**：
   - 如何防止用户恶意透支？
   - 如何设计更合理的信用评分体系？

3. **扩展任务**：
   - 实现分期还款功能
   - 添加逾期费用计算
   - 开发信用报告功能

---

## 第八章：创新分销系统开发 - 让用户帮你卖货

### 8.1 理解创新分销系统

我们的分销系统与众不同：
- 🆕 **新用户分销**：首单分享成功，返还全部购买金额
- 👥 **老用户分销**：分享成功，获得相同商品的礼品券
- 📊 **分享条件**：至少2人购买，且价格不低于分享者的购买价格

### 8.2 分销核心逻辑实现

#### 8.2.1 创建分销服务

```php
// 创建文件：app/services/distribution/DistributionServices.php
<?php
namespace app\services\distribution;

use app\services\BaseServices;
use app\dao\distribution\DistributionRelationDao;
use think\facade\Log;

class DistributionServices extends BaseServices
{
    public function __construct(DistributionRelationDao $dao)
    {
        $this->dao = $dao;
    }
    
    /**
     * 记录分享关系
     * 当用户通过分享链接进入并下单时调用
     */
    public function recordShareRelation($shareUserId, $shareOrderId, $buyerUserId, $buyerOrderInfo)
    {
        // 检查是否已记录
        $exists = $this->dao->count([
            'share_user_id' => $shareUserId,
            'share_order_id' => $shareOrderId,
            'buyer_user_id' => $buyerUserId,
            'buyer_order_id' => $buyerOrderInfo['order_id']
        ]);
        
        if ($exists) {
            return true;
        }
        
        // 记录分享关系
        $data = [
            'share_user_id' => $shareUserId,
            'share_order_id' => $shareOrderId,
            'buyer_user_id' => $buyerUserId,
            'buyer_order_id' => $buyerOrderInfo['order_id'],
            'buyer_order_amount' => $buyerOrderInfo['pay_price'],
            'share_time' => time(),
            'buy_time' => time(),
            'create_time' => time()
        ];
        
        $this->dao->save($data);
        
        // 检查是否满足分销条件
        $this->checkDistributionCondition($shareUserId, $shareOrderId);
        
        return true;
    }
    
    /**
     * 检查分销条件
     * 规则：至少2人购买，且最低价格>=分享者购买价格
     */
    public function checkDistributionCondition($shareUserId, $shareOrderId)
    {
        // 获取分享者的订单信息
        $orderService = app()->make(\app\services\order\StoreOrderServices::class);
        $shareOrder = $orderService->dao->get($shareOrderId);
        
        if (!$shareOrder) {
            Log::error("分销检查失败：订单不存在 {$shareOrderId}");
            return false;
        }
        
        // 统计通过分享购买的情况
        $relations = $this->dao->getModel()
            ->where('share_user_id', $shareUserId)
            ->where('share_order_id', $shareOrderId)
            ->select();
        
        // 购买人数
        $buyerCount = count($relations);
        
        // 最低购买价格
        $minPrice = $relations->min('buyer_order_amount');
        
        Log::info("分销条件检查：分享者{$shareUserId}，订单{$shareOrderId}，购买人数{$buyerCount}，最低价格{$minPrice}，分享订单价格{$shareOrder['pay_price']}");
        
        // 检查是否满足条件：人数>=2 且 最低价格>=分享订单价格
        if ($buyerCount >= 2 && $minPrice >= $shareOrder['pay_price']) {
            // 检查是否已发放奖励
            $rewardService = app()->make(DistributionRewardServices::class);
            $hasReward = $rewardService->dao->count([
                'user_id' => $shareUserId,
                'share_order_id' => $shareOrderId,
                'status' => 2  // 已发放
            ]);
            
            if (!$hasReward) {
                // 触发分销奖励
                $this->triggerDistributionReward($shareUserId, $shareOrder);
            }
            
            return true;
        }
        
        return false;
    }
    
    /**
     * 触发分销奖励
     */
    protected function triggerDistributionReward($shareUserId, $shareOrder)
    {
        Log::info("触发分销奖励：用户{$shareUserId}，订单{$shareOrder['order_id']}");
        
        // 判断是否为新用户
        $isNewUser = $this->checkIsNewUser($shareUserId, $shareOrder['id']);
        
        // 获取分享统计
        $shareStats = $this->getShareStats($shareUserId, $shareOrder['order_id']);
        
        // 创建奖励记录
        $rewardService = app()->make(DistributionRewardServices::class);
        
        if ($isNewUser) {
            // 新用户：全额返还
            $rewardData = [
                'user_id' => $shareUserId,
                'share_order_id' => $shareOrder['order_id'],
                'reward_type' => 1,  // 现金返还
                'reward_amount' => $shareOrder['pay_price'],
                'buyer_count' => $shareStats['buyer_count'],
                'min_buy_amount' => $shareStats['min_price'],
                'status' => 1,  // 待发放
                'create_time' => time()
            ];
            
            $reward = $rewardService->dao->save($rewardData);
            
            // 发放现金奖励
            $this->processNewUserReward($shareUserId, $shareOrder, $reward);
            
        } else {
            // 老用户：发放商品礼品券
            $rewardData = [
                'user_id' => $shareUserId,
                'share_order_id' => $shareOrder['order_id'],
                'reward_type' => 2,  // 商品礼品券
                'reward_amount' => 0,
                'buyer_count' => $shareStats['buyer_count'],
                'min_buy_amount' => $shareStats['min_price'],
                'status' => 1,  // 待发放
                'create_time' => time()
            ];
            
            $reward = $rewardService->dao->save($rewardData);
            
            // 发放礼品券奖励
            $this->processOldUserReward($shareUserId, $shareOrder, $reward);
        }
    }
    
    /**
     * 检查是否为新用户
     * 新用户定义：分享的是首单
     */
    protected function checkIsNewUser($userId, $orderId)
    {
        // 查询用户首单记录
        $firstOrderDao = app()->make(\app\dao\user\UserFirstOrderDao::class);
        $firstOrder = $firstOrderDao->getOne(['user_id' => $userId]);
        
        if (!$firstOrder) {
            // 如果没有首单记录，查询用户第一个订单
            $orderService = app()->make(\app\services\order\StoreOrderServices::class);
            $firstRealOrder = $orderService->dao->getModel()
                ->where('uid', $userId)
                ->where('paid', 1)
                ->order('id asc')
                ->find();
            
            if ($firstRealOrder && $firstRealOrder['id'] == $orderId) {
                // 创建首单记录
                $firstOrderDao->save([
                    'user_id' => $userId,
                    'first_order_id' => $firstRealOrder['order_id'],
                    'first_order_amount' => $firstRealOrder['pay_price'],
                    'first_order_time' => $firstRealOrder['pay_time'],
                    'create_time' => time()
                ]);
                
                return true;
            }
        }
        
        // 检查分享的是否是首单
        return $firstOrder && $firstOrder['first_order_id'] == $orderId;
    }
    
    /**
     * 处理新用户奖励 - 全额返还
     */
    protected function processNewUserReward($userId, $shareOrder, $rewardRecord)
    {
        try {
            // 返还到用户余额
            $userService = app()->make(\app\services\user\UserServices::class);
            $userService->incMoney($userId, $shareOrder['pay_price']);
            
            // 记录余额变动
            $userBillService = app()->make(\app\services\user\UserBillServices::class);
            $userBillService->income('distribution_new', $userId, $shareOrder['pay_price'], 0, $shareOrder['id']);
            
            // 更新奖励状态
            $rewardService = app()->make(DistributionRewardServices::class);
            $rewardService->dao->update($rewardRecord['id'], [
                'status' => 2,  // 已发放
                'reward_time' => time()
            ]);
            
            // 更新首单分享状态
            $firstOrderDao = app()->make(\app\dao\user\UserFirstOrderDao::class);
            $firstOrderDao->update(['user_id' => $userId], [
                'is_shared' => 1,
                'share_reward_status' => 2
            ]);
            
            // 发送通知
            $this->sendRewardNotice($userId, 'new_user', $shareOrder['pay_price']);
            
            Log::info("新用户分销奖励发放成功：用户{$userId}，金额{$shareOrder['pay_price']}");
            
        } catch (\Exception $e) {
            Log::error("新用户分销奖励发放失败：" . $e->getMessage());
            throw $e;
        }
    }
    
    /**
     * 处理老用户奖励 - 发放商品礼品券
     */
    protected function processOldUserReward($userId, $shareOrder, $rewardRecord)
    {
        try {
            // 获取订单商品
            $orderCartInfo = app()->make(\app\dao\order\StoreOrderCartInfoDao::class)
                ->getModel()
                ->where('oid', $shareOrder['id'])
                ->select();
            
            $giftCardService = app()->make(\app\services\giftcard\GiftCardServices::class);
            $giftCardIds = [];
            
            // 为每个商品生成礼品券
            foreach ($orderCartInfo as $cartItem) {
                $productInfo = json_decode($cartItem['cart_info'], true);
                
                // 根据购买数量生成对应数量的礼品券
                for ($i = 0; $i < $cartItem['cart_num']; $i++) {
                    $giftCard = $giftCardService->createDistributionCard($userId, $productInfo['product_id']);
                    $giftCardIds[] = $giftCard['id'];
                }
            }
            
            // 更新奖励记录
            $rewardService = app()->make(DistributionRewardServices::class);
            $rewardService->dao->update($rewardRecord['id'], [
                'gift_card_ids' => implode(',', $giftCardIds),
                'status' => 2,  // 已发放
                'reward_time' => time()
            ]);
            
            // 发送通知
            $this->sendRewardNotice($userId, 'old_user', count($giftCardIds));
            
            Log::info("老用户分销奖励发放成功：用户{$userId}，礼品券数量" . count($giftCardIds));
            
        } catch (\Exception $e) {
            Log::error("老用户分销奖励发放失败：" . $e->getMessage());
            throw $e;
        }
    }
    
    /**
     * 获取分享统计
     */
    public function getShareStats($shareUserId, $shareOrderId)
    {
        $relations = $this->dao->getModel()
            ->where('share_user_id', $shareUserId)
            ->where('share_order_id', $shareOrderId)
            ->select();
        
        return [
            'buyer_count' => count($relations),
            'total_amount' => $relations->sum('buyer_order_amount'),
            'min_price' => $relations->min('buyer_order_amount'),
            'buyers' => $relations->toArray()
        ];
    }
    
    /**
     * 发送奖励通知
     */
    protected function sendRewardNotice($userId, $type, $value)
    {
        $userService = app()->make(\app\services\user\UserServices::class);
        $user = $userService->get($userId);
        
        if ($type == 'new_user') {
            $message = "恭喜您！您的首单分享已成功，￥{$value}已返还到您的账户余额。";
        } else {
            $message = "恭喜您！您的分享已成功，{$value}张商品礼品券已发放到您的账户。";
        }
        
        // 发送站内信
        app()->make(\app\services\message\SystemMessageServices::class)->save([
            'uid' => $userId,
            'type' => 'distribution_reward',
            'title' => '分销奖励到账',
            'content' => $message,
            'add_time' => time()
        ]);
        
        // 发送微信模板消息
        if ($user['openid']) {
            // 调用微信模板消息服务
        }
    }
}
```

#### 8.2.2 创建分销奖励服务

```php
// 创建文件：app/services/distribution/DistributionRewardServices.php
<?php
namespace app\services\distribution;

use app\services\BaseServices;
use app\dao\distribution\DistributionRewardDao;

class DistributionRewardServices extends BaseServices
{
    public function __construct(DistributionRewardDao $dao)
    {
        $this->dao = $dao;
    }
    
    /**
     * 获取用户分销奖励列表
     */
    public function getUserRewardList($userId, $where = [])
    {
        $where['user_id'] = $userId;
        
        $list = $this->dao->getList($where, ['*'], 0, 0, 'create_time desc');
        
        foreach ($list as &$item) {
            // 格式化时间
            $item['create_time_text'] = date('Y-m-d H:i', $item['create_time']);
            $item['reward_time_text'] = $item['reward_time'] ? date('Y-m-d H:i', $item['reward_time']) : '';
            
            // 奖励类型文字
            $item['reward_type_text'] = $item['reward_type'] == 1 ? '现金返还' : '商品礼品券';
            
            // 状态文字
            $statusText = ['', '待发放', '已发放', '已取消'];
            $item['status_text'] = $statusText[$item['status']] ?? '';
            
            // 如果是礼品券，获取礼品券信息
            if ($item['reward_type'] == 2 && $item['gift_card_ids']) {
                $giftCardIds = explode(',', $item['gift_card_ids']);
                $item['gift_card_count'] = count($giftCardIds);
            }
        }
        
        return $list;
    }
    
    /**
     * 获取分销统计
     */
    public function getDistributionStats($userId)
    {
        // 总奖励次数
        $totalCount = $this->dao->count(['user_id' => $userId, 'status' => 2]);
        
        // 现金奖励统计
        $cashReward = $this->dao->getModel()
            ->where('user_id', $userId)
            ->where('reward_type', 1)
            ->where('status', 2)
            ->sum('reward_amount');
        
        // 礼品券奖励统计
        $giftCardCount = 0;
        $giftCardRewards = $this->dao->getModel()
            ->where('user_id', $userId)
            ->where('reward_type', 2)
            ->where('status', 2)
            ->select();
        
        foreach ($giftCardRewards as $reward) {
            if ($reward['gift_card_ids']) {
                $giftCardCount += count(explode(',', $reward['gift_card_ids']));
            }
        }
        
        // 分享成功的订单数
        $shareOrderCount = $this->dao->getModel()
            ->where('user_id', $userId)
            ->where('status', 2)
            ->group('share_order_id')
            ->count();
        
        // 带来的用户数
        $distributionService = app()->make(DistributionServices::class);
        $buyerCount = $distributionService->dao->getModel()
            ->where('share_user_id', $userId)
            ->group('buyer_user_id')
            ->count();
        
        return [
            'total_count' => $totalCount,
            'cash_reward' => $cashReward,
            'gift_card_count' => $giftCardCount,
            'share_order_count' => $shareOrderCount,
            'buyer_count' => $buyerCount
        ];
    }
    
    /**
     * 检查订单是否可分享
     */
    public function checkOrderCanShare($userId, $orderId)
    {
        // 检查是否已经分享成功
        $hasReward = $this->dao->count([
            'user_id' => $userId,
            'share_order_id' => $orderId,
            'status' => 2
        ]);
        
        if ($hasReward) {
            return [
                'can_share' => false,
                'reason' => '该订单已获得分销奖励'
            ];
        }
        
        // 检查是否是新用户的首单
        $firstOrderDao = app()->make(\app\dao\user\UserFirstOrderDao::class);
        $firstOrder = $firstOrderDao->getOne(['user_id' => $userId]);
        
        if ($firstOrder && $firstOrder['first_order_id'] == $orderId && $firstOrder['share_reward_status'] == 2) {
            return [
                'can_share' => false,
                'reason' => '首单已获得分销奖励'
            ];
        }
        
        // 获取分享统计
        $distributionService = app()->make(DistributionServices::class);
        $shareStats = $distributionService->getShareStats($userId, $orderId);
        
        return [
            'can_share' => true,
            'is_new_user' => $firstOrder && $firstOrder['first_order_id'] == $orderId,
            'current_buyers' => $shareStats['buyer_count'],
            'need_buyers' => max(0, 2 - $shareStats['buyer_count']),
            'share_stats' => $shareStats
        ];
    }
}
```

### 8.3 前端分销功能实现

#### 8.3.1 订单分享页面

```vue
<!-- 创建文件：template/uni-app/pages/distribution/share.vue -->
<template>
  <view class="share-page">
    <!-- 分享海报 -->
    <view class="poster-section">
      <canvas canvas-id="posterCanvas" 
              :style="{width: canvasWidth + 'px', height: canvasHeight + 'px'}"
              class="poster-canvas"></canvas>
      <image :src="posterImage" 
             mode="aspectFit" 
             class="poster-image" 
             v-if="posterImage"></image>
    </view>
    
    <!-- 分享说明 -->
    <view class="share-info">
      <view class="info-card">
        <view class="card-title">
          <text class="iconfont icon-gift"></text>
          <text>{{ isNewUser ? '新用户专属福利' : '分享赢好礼' }}</text>
        </view>
        
        <view class="reward-desc" v-if="isNewUser">
          <view class="reward-amount">¥{{ orderInfo.pay_price }}</view>
          <view class="reward-text">分享成功可获得全额返现</view>
        </view>
        
        <view class="reward-desc" v-else>
          <view class="reward-products">
            <view class="product-item" 
                  v-for="(product, index) in orderProducts" 
                  :key="index">
              <image :src="product.image" class="product-img"></image>
              <text class="product-name">{{ product.name }}</text>
              <text class="product-num">×{{ product.num }}</text>
            </view>
          </view>
          <view class="reward-text">分享成功可获得相同商品礼品券</view>
        </view>
        
        <view class="share-rules">
          <view class="rule-title">分享规则：</view>
          <view class="rule-item">1. 需要至少2位好友通过您的分享购买</view>
          <view class="rule-item">2. 好友购买价格需≥¥{{ orderInfo.pay_price }}</view>
          <view class="rule-item">3. 满足条件后自动发放奖励</view>
        </view>
      </view>
      
      <!-- 分享进度 -->
      <view class="progress-card" v-if="shareStats">
        <view class="progress-title">当前进度</view>
        <view class="progress-bar">
          <view class="progress-fill" 
                :style="{width: progressPercent + '%'}"></view>
        </view>
        <view class="progress-text">
          已有{{ shareStats.buyer_count }}人购买，
          {{ shareStats.buyer_count >= 2 ? '已满足人数条件' : '还需' + (2 - shareStats.buyer_count) + '人' }}
        </view>
        
        <view class="buyer-list" v-if="shareStats.buyers.length > 0">
          <view class="buyer-item" 
                v-for="buyer in shareStats.buyers" 
                :key="buyer.id">
            <view class="buyer-info">
              <text class="buyer-name">{{ buyer.nickname }}</text>
              <text class="buy-time">{{ formatTime(buyer.buy_time) }}</text>
            </view>
            <view class="buy-amount">¥{{ buyer.buyer_order_amount }}</view>
          </view>
        </view>
      </view>
    </view>
    
    <!-- 分享按钮 -->
    <view class="share-actions">
      <button class="share-btn wechat" @click="shareToWechat">
        <text class="iconfont icon-wechat"></text>
        <text>分享给好友</text>
      </button>
      <button class="share-btn moments" @click="shareToMoments">
        <text class="iconfont icon-moments"></text>
        <text>分享到朋友圈</text>
      </button>
      <button class="share-btn save" @click="savePoster">
        <text class="iconfont icon-download"></text>
        <text>保存海报</text>
      </button>
    </view>
  </view>
</template>

<script>
import { getOrderDetail } from '@/api/order.js'
import { checkOrderShare, getShareStats } from '@/api/distribution.js'

export default {
  data() {
    return {
      orderId: '',
      orderInfo: {},
      orderProducts: [],
      isNewUser: false,
      shareStats: null,
      canvasWidth: 375,
      canvasHeight: 667,
      posterImage: '',
      shareUrl: ''
    }
  },
  
  computed: {
    progressPercent() {
      if (!this.shareStats) return 0
      const percent = (this.shareStats.buyer_count / 2) * 100
      return Math.min(percent, 100)
    }
  },
  
  onLoad(options) {
    this.orderId = options.id
    this.loadData()
  },
  
  methods: {
    async loadData() {
      // 获取订单信息
      const orderRes = await getOrderDetail(this.orderId)
      this.orderInfo = orderRes.data
      this.orderProducts = this.orderInfo.cart_info
      
      // 检查分享状态
      const shareRes = await checkOrderShare(this.orderId)
      this.isNewUser = shareRes.data.is_new_user
      this.shareStats = shareRes.data.share_stats
      
      // 生成分享链接
      const userInfo = uni.getStorageSync('userInfo')
      this.shareUrl = `${process.env.VUE_APP_BASE_URL}/pages/goods/goods?share_uid=${userInfo.uid}&share_order=${this.orderId}`
      
      // 生成海报
      this.generatePoster()
    },
    
    // 生成分享海报
    generatePoster() {
      const ctx = uni.createCanvasContext('posterCanvas', this)
      
      // 背景
      ctx.setFillStyle('#ffffff')
      ctx.fillRect(0, 0, this.canvasWidth, this.canvasHeight)
      
      // 标题
      ctx.setFillStyle('#333333')
      ctx.setFontSize(20)
      ctx.setTextAlign('center')
      ctx.fillText('庆人府商城', this.canvasWidth / 2, 40)
      
      // 商品图片
      const mainProduct = this.orderProducts[0]
      if (mainProduct) {
        ctx.drawImage(mainProduct.image, 50, 70, 275, 275)
      }
      
      // 商品名称
      ctx.setFillStyle('#333333')
      ctx.setFontSize(16)
      ctx.setTextAlign('left')
      this.drawText(ctx, mainProduct.name, 50, 370, 275, 20)
      
      // 价格
      ctx.setFillStyle('#ff6b6b')
      ctx.setFontSize(24)
      ctx.fillText('¥' + this.orderInfo.pay_price, 50, 420)
      
      // 分销说明
      ctx.setFillStyle('#666666')
      ctx.setFontSize(14)
      if (this.isNewUser) {
        ctx.fillText('分享成功返现 ¥' + this.orderInfo.pay_price, 50, 460)
      } else {
        ctx.fillText('分享成功送同款商品', 50, 460)
      }
      
      // 二维码（这里需要后端生成）
      ctx.drawImage('/static/images/qrcode-placeholder.png', 225, 480, 100, 100)
      
      // 提示文字
      ctx.setFillStyle('#999999')
      ctx.setFontSize(12)
      ctx.setTextAlign('center')
      ctx.fillText('长按识别二维码', this.canvasWidth / 2, 610)
      ctx.fillText('好友购买你就赚', this.canvasWidth / 2, 630)
      
      // 绘制到canvas
      ctx.draw(false, () => {
        setTimeout(() => {
          uni.canvasToTempFilePath({
            canvasId: 'posterCanvas',
            success: (res) => {
              this.posterImage = res.tempFilePath
            }
          }, this)
        }, 500)
      })
    },
    
    // 文字换行
    drawText(ctx, text, x, y, maxWidth, lineHeight) {
      const words = text.split('')
      let line = ''
      let lineNum = 0
      
      for (let n = 0; n < words.length; n++) {
        const testLine = line + words[n]
        const metrics = ctx.measureText(testLine)
        const testWidth = metrics.width
        
        if (testWidth > maxWidth && n > 0) {
          ctx.fillText(line, x, y + lineNum * lineHeight)
          line = words[n]
          lineNum++
          if (lineNum >= 2) {
            ctx.fillText(line + '...', x, y + lineNum * lineHeight)
            break
          }
        } else {
          line = testLine
        }
      }
      
      if (lineNum < 2) {
        ctx.fillText(line, x, y + lineNum * lineHeight)
      }
    },
    
    // 分享给好友
    shareToWechat() {
      // #ifdef MP-WEIXIN
      uni.share({
        provider: 'weixin',
        scene: 'WXSceneSession',
        type: 0,
        href: this.shareUrl,
        title: this.isNewUser ? `我在庆人府商城购物，分享成功返现¥${this.orderInfo.pay_price}` : '我在庆人府商城发现好物，快来看看',
        summary: '优质农产品，产地直供',
        imageUrl: this.posterImage,
        success: () => {
          uni.showToast({
            title: '分享成功',
            icon: 'success'
          })
        }
      })
      // #endif
      
      // #ifdef H5
      this.showShareGuide()
      // #endif
    },
    
    // 保存海报
    savePoster() {
      uni.saveImageToPhotosAlbum({
        filePath: this.posterImage,
        success: () => {
          uni.showToast({
            title: '保存成功',
            icon: 'success'
          })
        },
        fail: () => {
          uni.showToast({
            title: '保存失败',
            icon: 'none'
          })
        }
      })
    },
    
    // 格式化时间
    formatTime(timestamp) {
      const date = new Date(timestamp * 1000)
      return `${date.getMonth() + 1}月${date.getDate()}日 ${date.getHours()}:${date.getMinutes()}`
    }
  }
}
</script>

<style lang="scss">
.share-page {
  background: #f5f5f5;
  min-height: 100vh;
  padding-bottom: 200rpx;
  
  .poster-section {
    background: #fff;
    padding: 30rpx;
    text-align: center;
    
    .poster-canvas {
      position: absolute;
      left: -9999px;
    }
    
    .poster-image {
      width: 600rpx;
      height: 1067rpx;
      box-shadow: 0 4rpx 20rpx rgba(0,0,0,0.1);
    }
  }
  
  .share-info {
    padding: 0 30rpx;
    
    .info-card, .progress-card {
      background: #fff;
      border-radius: 20rpx;
      padding: 30rpx;
      margin-top: 20rpx;
    }
    
    .card-title {
      display: flex;
      align-items: center;
      font-size: 32rpx;
      font-weight: bold;
      margin-bottom: 30rpx;
      
      .iconfont {
        font-size: 36rpx;
        color: #ff6b6b;
        margin-right: 10rpx;
      }
    }
    
    .reward-desc {
      text-align: center;
      padding: 40rpx 0;
      
      .reward-amount {
        font-size: 60rpx;
        color: #ff6b6b;
        font-weight: bold;
        margin-bottom: 20rpx;
      }
      
      .reward-products {
        display: flex;
        flex-wrap: wrap;
        justify-content: center;
        margin-bottom: 20rpx;
        
        .product-item {
          display: flex;
          align-items: center;
          margin: 10rpx;
          padding: 10rpx;
          background: #f5f5f5;
          border-radius: 10rpx;
          
          .product-img {
            width: 60rpx;
            height: 60rpx;
            border-radius: 8rpx;
            margin-right: 10rpx;
          }
          
          .product-name {
            font-size: 26rpx;
            max-width: 200rpx;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
          }
          
          .product-num {
            font-size: 24rpx;
            color: #999;
            margin-left: 10rpx;
          }
        }
      }
      
      .reward-text {
        font-size: 30rpx;
        color: #666;
      }
    }
    
    .share-rules {
      background: #fff5f5;
      padding: 20rpx;
      border-radius: 10rpx;
      
      .rule-title {
        font-size: 28rpx;
        font-weight: bold;
        margin-bottom: 20rpx;
      }
      
      .rule-item {
        font-size: 26rpx;
        color: #666;
        margin-bottom: 10rpx;
        padding-left: 20rpx;
      }
    }
    
    .progress-title {
      font-size: 30rpx;
      font-weight: bold;
      margin-bottom: 20rpx;
    }
    
    .progress-bar {
      height: 20rpx;
      background: #f5f5f5;
      border-radius: 10rpx;
      overflow: hidden;
      margin-bottom: 20rpx;
      
      .progress-fill {
        height: 100%;
        background: linear-gradient(45deg, #ff6b6b, #ff8e53);
        transition: width 0.3s;
      }
    }
    
    .progress-text {
      font-size: 26rpx;
      color: #666;
      margin-bottom: 30rpx;
    }
    
    .buyer-list {
      border-top: 1rpx solid #f5f5f5;
      padding-top: 20rpx;
      
      .buyer-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 20rpx 0;
        
        .buyer-info {
          .buyer-name {
            font-size: 28rpx;
            margin-right: 20rpx;
          }
          
          .buy-time {
            font-size: 24rpx;
            color: #999;
          }
        }
        
        .buy-amount {
          font-size: 30rpx;
          color: #ff6b6b;
          font-weight: bold;
        }
      }
    }
  }
  
  .share-actions {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    background: #fff;
    padding: 30rpx;
    display: flex;
    justify-content: space-around;
    box-shadow: 0 -2rpx 10rpx rgba(0,0,0,0.05);
    
    .share-btn {
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 20rpx;
      border: none;
      background: none;
      
      .iconfont {
        font-size: 48rpx;
        margin-bottom: 10rpx;
      }
      
      text {
        font-size: 26rpx;
      }
      
      &.wechat {
        .iconfont {
          color: #07c160;
        }
      }
      
      &.moments {
        .iconfont {
          color: #ff6b6b;
        }
      }
      
      &.save {
        .iconfont {
          color: #576b95;
        }
      }
    }
  }
}
</style>
```

### 8.4 后台分销管理

#### 8.4.1 分销管理控制器

```php
// 创建文件：app/adminapi/controller/v1/distribution/Distribution.php
<?php
namespace app\adminapi\controller\v1\distribution;

use app\adminapi\controller\AuthController;
use app\services\distribution\DistributionServices;
use app\services\distribution\DistributionRewardServices;

class Distribution extends AuthController
{
    /**
     * 分销记录列表
     */
    public function relationList()
    {
        $where = $this->request->getMore([
            ['share_user', ''],      // 分享者
            ['buyer_user', ''],      // 购买者
            ['date_range', []],      // 时间范围
            ['page', 1],
            ['limit', 10]
        ]);
        
        $distributionService = app()->make(DistributionServices::class);
        $list = $distributionService->getRelationList($where);
        
        return app('json')->success($list);
    }
    
    /**
     * 分销奖励列表
     */
    public function rewardList()
    {
        $where = $this->request->getMore([
            ['user_id', 0],
            ['reward_type', ''],
            ['status', ''],
            ['date_range', []],
            ['page', 1],
            ['limit', 10]
        ]);
        
        $rewardService = app()->make(DistributionRewardServices::class);
        $list = $rewardService->getList($where);
        
        return app('json')->success($list);
    }
    
    /**
     * 分销统计
     */
    public function statistics()
    {
        $dateRange = $this->request->get('date_range', []);
        
        $distributionService = app()->make(DistributionServices::class);
        $rewardService = app()->make(DistributionRewardServices::class);
        
        // 统计数据
        $stats = [
            // 总体统计
            'total' => [
                'share_users' => $distributionService->dao->group('share_user_id')->count(),
                'buyer_users' => $distributionService->dao->group('buyer_user_id')->count(),
                'share_orders' => $distributionService->dao->group('share_order_id')->count(),
                'total_amount' => $distributionService->dao->sum('buyer_order_amount')
            ],
            
            // 奖励统计
            'reward' => [
                'total_count' => $rewardService->dao->where('status', 2)->count(),
                'cash_amount' => $rewardService->dao->where('reward_type', 1)->where('status', 2)->sum('reward_amount'),
                'gift_card_count' => $this->countGiftCards(),
                'pending_count' => $rewardService->dao->where('status', 1)->count()
            ],
            
            // 趋势数据
            'trends' => $this->getTrendData($dateRange)
        ];
        
        return app('json')->success($stats);
    }
    
    /**
     * 审核分销奖励
     */
    public function auditReward($id)
    {
        $status = $this->request->post('status', 2);  // 2:通过 3:拒绝
        $reason = $this->request->post('reason', '');
        
        $rewardService = app()->make(DistributionRewardServices::class);
        $reward = $rewardService->dao->get($id);
        
        if (!$reward) {
            return app('json')->fail('奖励记录不存在');
        }
        
        if ($reward['status'] != 1) {
            return app('json')->fail('该奖励已处理');
        }
        
        if ($status == 2) {
            // 通过审核，发放奖励
            $distributionService = app()->make(DistributionServices::class);
            
            if ($reward['reward_type'] == 1) {
                // 新用户现金奖励
                $distributionService->processNewUserReward(
                    $reward['user_id'], 
                    ['pay_price' => $reward['reward_amount']], 
                    $reward
                );
            } else {
                // 老用户礼品券奖励
                // 需要重新生成礼品券
            }
        } else {
            // 拒绝
            $rewardService->dao->update($id, [
                'status' => 3,
                'remark' => $reason,
                'update_time' => time()
            ]);
        }
        
        return app('json')->success('处理成功');
    }
    
    /**
     * 统计礼品券数量
     */
    protected function countGiftCards()
    {
        $rewards = app()->make(DistributionRewardServices::class)->dao->getModel()
            ->where('reward_type', 2)
            ->where('status', 2)
            ->select();
        
        $count = 0;
        foreach ($rewards as $reward) {
            if ($reward['gift_card_ids']) {
                $count += count(explode(',', $reward['gift_card_ids']));
            }
        }
        
        return $count;
    }
    
    /**
     * 获取趋势数据
     */
    protected function getTrendData($dateRange)
    {
        // 默认最近30天
        $endTime = time();
        $startTime = $endTime - 30 * 86400;
        
        if ($dateRange && count($dateRange) == 2) {
            $startTime = strtotime($dateRange[0]);
            $endTime = strtotime($dateRange[1]);
        }
        
        $trends = [];
        $currentTime = $startTime;
        
        while ($currentTime <= $endTime) {
            $dayStart = strtotime(date('Y-m-d', $currentTime));
            $dayEnd = $dayStart + 86400;
            
            $trends[] = [
                'date' => date('Y-m-d', $currentTime),
                'share_count' => app()->make(DistributionServices::class)->dao->whereTime('create_time', 'between', [$dayStart, $dayEnd])->count(),
                'reward_count' => app()->make(DistributionRewardServices::class)->dao->whereTime('create_time', 'between', [$dayStart, $dayEnd])->where('status', 2)->count(),
                'reward_amount' => app()->make(DistributionRewardServices::class)->dao->whereTime('create_time', 'between', [$dayStart, $dayEnd])->where('status', 2)->where('reward_type', 1)->sum('reward_amount')
            ];
            
            $currentTime += 86400;
        }
        
        return $trends;
    }
}
```

### 8.5 本章练习

1. **功能实现**：
   - 实现分享排行榜功能
   - 添加分销海报模板管理
   - 实现团队分销功能（多级分销）

2. **思考题**：
   - 如何防止用户刷单获取分销奖励？
   - 如何优化分销链路追踪？

3. **扩展任务**：
   - 实现分销等级系统
   - 添加分销任务系统
   - 开发分销数据大屏展示

---