---

## ç¬¬åç« ï¼šå‰ç«¯ç•Œé¢å¼€å‘ - è®©å•†åŸæ›´ç¾è§‚

### 10.1 ç†è§£å‰ç«¯æ¶æ„

CRMEBçš„å‰ç«¯å°±åƒå•†åŸçš„**è£…ä¿®è®¾è®¡**ï¼š
- ğŸ¢ **ç®¡ç†åå°**ï¼šåŸºäºVue.js + ElementUIï¼ŒåƒåŠå…¬å®¤è£…ä¿®
- ğŸ“± **å°ç¨‹åºç«¯**ï¼šåŸºäºUniAppï¼Œåƒåº—é¢è£…ä¿®
- ğŸ¨ **è®¾è®¡è§„èŒƒ**ï¼šç»Ÿä¸€çš„è§†è§‰é£æ ¼ï¼Œåƒè£…ä¿®é£æ ¼æŒ‡å—

### 10.2 å°ç¨‹åºé¦–é¡µæ”¹é€ 

#### 10.2.1 é¦–é¡µå¸ƒå±€è®¾è®¡

```vue
<!-- ä¿®æ”¹æ–‡ä»¶ï¼štemplate/uni-app/pages/index/index.vue -->
<template>
  <view class="home-page">
    <!-- é¡¶éƒ¨æœç´¢æ  -->
    <view class="search-header">
      <view class="search-box" @click="goSearch">
        <text class="iconfont icon-search"></text>
        <text class="placeholder">æœç´¢å†œäº§å“</text>
      </view>
      <view class="scan-btn" @click="scanCode">
        <text class="iconfont icon-scan"></text>
      </view>
    </view>
    
    <!-- è½®æ’­å›¾ -->
    <swiper class="banner-swiper" 
            :indicator-dots="true"
            :autoplay="true"
            :interval="3000">
      <swiper-item v-for="item in bannerList" :key="item.id">
        <image :src="item.pic" 
               mode="aspectFill"
               @click="navigateTo(item.url)"></image>
      </swiper-item>
    </swiper>
    
    <!-- åˆä¼™äººå…¥å£ -->
    <view class="partner-entry" v-if="!isPartner" @click="goPartner">
      <view class="entry-content">
        <view class="entry-info">
          <view class="title">æˆä¸ºåˆä¼™äºº</view>
          <view class="desc">äº«ä¸“å±æŠ˜æ‰£ï¼Œèµšåˆ†äº«ä½£é‡‘</view>
        </view>
        <view class="entry-action">
          <text>ç«‹å³åŠ å…¥</text>
          <text class="iconfont icon-arrow-right"></text>
        </view>
      </view>
      <image src="/static/images/partner-bg.png" class="entry-bg"></image>
    </view>
    
    <!-- åŠŸèƒ½å¯¼èˆª -->
    <view class="nav-grid">
      <view class="nav-item" @click="goPage('/pages/category/category')">
        <image src="/static/images/nav-category.png" class="nav-icon"></image>
        <text class="nav-title">å•†å“åˆ†ç±»</text>
      </view>
      <view class="nav-item" @click="goPage('/pages/giftcard/index')">
        <image src="/static/images/nav-giftcard.png" class="nav-icon"></image>
        <text class="nav-title">ç¤¼å“å¡</text>
      </view>
      <view class="nav-item" @click="goPage('/pages/distribution/center')">
        <image src="/static/images/nav-share.png" class="nav-icon"></image>
        <text class="nav-title">åˆ†äº«èµšé’±</text>
      </view>
      <view class="nav-item" @click="goPage('/pages/credit/index')">
        <image src="/static/images/nav-credit.png" class="nav-icon"></image>
        <text class="nav-title">å…ˆç”¨åä»˜</text>
      </view>
    </view>
    
    <!-- ç§’æ€ä¸“åŒº -->
    <view class="seckill-section" v-if="seckillList.length > 0">
      <view class="section-header">
        <view class="header-left">
          <text class="title">é™æ—¶ç§’æ€</text>
          <view class="countdown">
            <text class="time-block">{{ hours }}</text>
            <text class="colon">:</text>
            <text class="time-block">{{ minutes }}</text>
            <text class="colon">:</text>
            <text class="time-block">{{ seconds }}</text>
          </view>
        </view>
        <view class="header-right" @click="goSeckill">
          <text>æ›´å¤š</text>
          <text class="iconfont icon-arrow-right"></text>
        </view>
      </view>
      
      <scroll-view scroll-x class="seckill-scroll">
        <view class="seckill-list">
          <view class="seckill-item" 
                v-for="item in seckillList" 
                :key="item.id"
                @click="goProduct(item.id)">
            <image :src="item.image" class="product-img"></image>
            <view class="product-name">{{ item.store_name }}</view>
            <view class="price-box">
              <text class="seckill-price">Â¥{{ item.price }}</text>
              <text class="origin-price">Â¥{{ item.ot_price }}</text>
            </view>
            <view class="progress-bar">
              <view class="progress-fill" :style="{width: item.progress + '%'}"></view>
            </view>
            <text class="progress-text">å·²æŠ¢{{ item.progress }}%</text>
          </view>
        </view>
      </scroll-view>
    </view>
    
    <!-- æ¨èå•†å“ -->
    <view class="recommend-section">
      <view class="section-header">
        <text class="title">ä¸ºæ‚¨æ¨è</text>
      </view>
      
      <view class="product-grid">
        <view class="product-item" 
              v-for="item in recommendList" 
              :key="item.id"
              @click="goProduct(item.id)">
          <view class="product-image">
            <image :src="item.image" mode="aspectFill"></image>
            <view class="product-tag" v-if="item.activity">
              {{ item.activity.title }}
            </view>
          </view>
          <view class="product-info">
            <view class="product-name">{{ item.store_name }}</view>
            <view class="product-desc">{{ item.store_info }}</view>
            <view class="product-bottom">
              <view class="price">
                <text class="currency">Â¥</text>
                <text class="amount">{{ item.price }}</text>
              </view>
              <view class="cart-btn" @click.stop="addCart(item)">
                <text class="iconfont icon-cart"></text>
              </view>
            </view>
          </view>
        </view>
      </view>
    </view>
    
    <!-- åº•éƒ¨å¯¼èˆª -->
    <custom-tabbar :current="0"></custom-tabbar>
  </view>
</template>

<script>
import { getIndexData, getSeckillList, getProductList } from '@/api/home.js'
import { addCart } from '@/api/cart.js'
import CustomTabbar from '@/components/custom-tabbar/custom-tabbar.vue'

export default {
  components: {
    CustomTabbar
  },
  
  data() {
    return {
      bannerList: [],
      seckillList: [],
      recommendList: [],
      isPartner: false,
      // å€’è®¡æ—¶
      endTime: 0,
      hours: '00',
      minutes: '00',
      seconds: '00',
      timer: null
    }
  },
  
  onLoad() {
    this.loadIndexData()
    this.checkPartnerStatus()
  },
  
  onShow() {
    // å¼€å§‹å€’è®¡æ—¶
    if (this.endTime) {
      this.startCountdown()
    }
  },
  
  onHide() {
    // æ¸…é™¤å€’è®¡æ—¶
    if (this.timer) {
      clearInterval(this.timer)
    }
  },
  
  methods: {
    // åŠ è½½é¦–é¡µæ•°æ®
    async loadIndexData() {
      uni.showLoading({ title: 'åŠ è½½ä¸­...' })
      
      try {
        // è·å–é¦–é¡µæ•°æ®
        const indexRes = await getIndexData()
        this.bannerList = indexRes.data.banner
        
        // è·å–ç§’æ€å•†å“
        const seckillRes = await getSeckillList({ limit: 6 })
        this.seckillList = seckillRes.data.list
        if (this.seckillList.length > 0) {
          this.endTime = this.seckillList[0].stop_time
          this.startCountdown()
        }
        
        // è·å–æ¨èå•†å“
        const recommendRes = await getProductList({ 
          is_hot: 1, 
          limit: 20 
        })
        this.recommendList = recommendRes.data.list
        
        uni.hideLoading()
      } catch (error) {
        uni.hideLoading()
        console.error(error)
      }
    },
    
    // æ£€æŸ¥åˆä¼™äººçŠ¶æ€
    checkPartnerStatus() {
      const userInfo = uni.getStorageSync('userInfo')
      if (userInfo && userInfo.is_partner) {
        this.isPartner = true
      }
    },
    
    // å€’è®¡æ—¶
    startCountdown() {
      this.updateCountdown()
      this.timer = setInterval(() => {
        this.updateCountdown()
      }, 1000)
    },
    
    updateCountdown() {
      const now = Math.floor(Date.now() / 1000)
      const diff = this.endTime - now
      
      if (diff <= 0) {
        this.hours = '00'
        this.minutes = '00'
        this.seconds = '00'
        clearInterval(this.timer)
        return
      }
      
      const h = Math.floor(diff / 3600)
      const m = Math.floor((diff % 3600) / 60)
      const s = diff % 60
      
      this.hours = h < 10 ? '0' + h : h
      this.minutes = m < 10 ? '0' + m : m
      this.seconds = s < 10 ? '0' + s : s
    },
    
    // æ·»åŠ è´­ç‰©è½¦
    async addCart(product) {
      try {
        await addCart({
          productId: product.id,
          cartNum: 1
        })
        
        uni.showToast({
          title: 'æ·»åŠ æˆåŠŸ',
          icon: 'success'
        })
      } catch (error) {
        uni.showToast({
          title: error.message || 'æ·»åŠ å¤±è´¥',
          icon: 'none'
        })
      }
    },
    
    // é¡µé¢è·³è½¬
    goPage(url) {
      uni.navigateTo({ url })
    },
    
    goProduct(id) {
      uni.navigateTo({
        url: `/pages/goods/goods?id=${id}`
      })
    },
    
    goSearch() {
      uni.navigateTo({
        url: '/pages/search/search'
      })
    },
    
    goPartner() {
      uni.navigateTo({
        url: '/pages/partner/index'
      })
    },
    
    goSeckill() {
      uni.navigateTo({
        url: '/pages/activity/seckill'
      })
    },
    
    // æ‰«ç 
    scanCode() {
      uni.scanCode({
        success: (res) => {
          console.log('æ‰«ç ç»“æœï¼š', res.result)
          // å¤„ç†æ‰«ç ç»“æœ
        }
      })
    },
    
    // å¤„ç†è½®æ’­å›¾è·³è½¬
    navigateTo(url) {
      if (!url) return
      
      if (url.startsWith('http')) {
        // å¤–éƒ¨é“¾æ¥
        uni.navigateTo({
          url: `/pages/webview/webview?url=${encodeURIComponent(url)}`
        })
      } else {
        // å†…éƒ¨é¡µé¢
        uni.navigateTo({ url })
      }
    }
  }
}
</script>

<style lang="scss">
.home-page {
  background: #f5f5f5;
  padding-bottom: 100rpx;
  
  .search-header {
    position: sticky;
    top: 0;
    z-index: 100;
    display: flex;
    align-items: center;
    padding: 20rpx 30rpx;
    background: #fff;
    
    .search-box {
      flex: 1;
      height: 70rpx;
      background: #f5f5f5;
      border-radius: 35rpx;
      display: flex;
      align-items: center;
      padding: 0 30rpx;
      
      .iconfont {
        font-size: 32rpx;
        color: #999;
        margin-right: 20rpx;
      }
      
      .placeholder {
        color: #999;
        font-size: 28rpx;
      }
    }
    
    .scan-btn {
      width: 70rpx;
      height: 70rpx;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-left: 20rpx;
      
      .iconfont {
        font-size: 40rpx;
        color: #333;
      }
    }
  }
  
  .banner-swiper {
    height: 400rpx;
    
    image {
      width: 100%;
      height: 100%;
    }
  }
  
  .partner-entry {
    position: relative;
    margin: 20rpx 30rpx;
    height: 160rpx;
    background: linear-gradient(135deg, #ff6b6b 0%, #ff8e53 100%);
    border-radius: 20rpx;
    overflow: hidden;
    
    .entry-content {
      position: relative;
      z-index: 2;
      display: flex;
      justify-content: space-between;
      align-items: center;
      height: 100%;
      padding: 0 40rpx;
      color: #fff;
      
      .title {
        font-size: 36rpx;
        font-weight: bold;
        margin-bottom: 10rpx;
      }
      
      .desc {
        font-size: 26rpx;
        opacity: 0.9;
      }
      
      .entry-action {
        display: flex;
        align-items: center;
        
        text {
          font-size: 28rpx;
        }
        
        .iconfont {
          margin-left: 10rpx;
        }
      }
    }
    
    .entry-bg {
      position: absolute;
      right: 0;
      top: 0;
      width: 300rpx;
      height: 160rpx;
      opacity: 0.3;
    }
  }
  
  .nav-grid {
    display: flex;
    background: #fff;
    padding: 30rpx 0;
    
    .nav-item {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      
      .nav-icon {
        width: 80rpx;
        height: 80rpx;
        margin-bottom: 20rpx;
      }
      
      .nav-title {
        font-size: 26rpx;
        color: #666;
      }
    }
  }
  
  .seckill-section {
    margin-top: 20rpx;
    background: #fff;
    
    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 30rpx;
      
      .header-left {
        display: flex;
        align-items: center;
        
        .title {
          font-size: 36rpx;
          font-weight: bold;
          margin-right: 20rpx;
        }
        
        .countdown {
          display: flex;
          align-items: center;
          
          .time-block {
            width: 40rpx;
            height: 40rpx;
            background: #333;
            color: #fff;
            border-radius: 8rpx;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24rpx;
          }
          
          .colon {
            margin: 0 8rpx;
            font-weight: bold;
          }
        }
      }
      
      .header-right {
        display: flex;
        align-items: center;
        color: #999;
        font-size: 28rpx;
        
        .iconfont {
          margin-left: 8rpx;
          font-size: 24rpx;
        }
      }
    }
    
    .seckill-scroll {
      height: 340rpx;
    }
    
    .seckill-list {
      display: flex;
      padding: 0 30rpx 30rpx;
      
      .seckill-item {
        width: 200rpx;
        margin-right: 20rpx;
        
        .product-img {
          width: 200rpx;
          height: 200rpx;
          border-radius: 10rpx;
          margin-bottom: 20rpx;
        }
        
        .product-name {
          font-size: 26rpx;
          overflow: hidden;
          text-overflow: ellipsis;
          white-space: nowrap;
          margin-bottom: 10rpx;
        }
        
        .price-box {
          display: flex;
          align-items: baseline;
          margin-bottom: 10rpx;
          
          .seckill-price {
            font-size: 32rpx;
            color: #ff6b6b;
            font-weight: bold;
            margin-right: 10rpx;
          }
          
          .origin-price {
            font-size: 24rpx;
            color: #999;
            text-decoration: line-through;
          }
        }
        
        .progress-bar {
          width: 100%;
          height: 8rpx;
          background: #f5f5f5;
          border-radius: 4rpx;
          margin-bottom: 8rpx;
          
          .progress-fill {
            height: 100%;
            background: #ff6b6b;
            border-radius: 4rpx;
          }
        }
        
        .progress-text {
          font-size: 22rpx;
          color: #999;
        }
      }
    }
  }
  
  .recommend-section {
    margin-top: 20rpx;
    
    .section-header {
      padding: 30rpx;
      background: #fff;
      
      .title {
        font-size: 36rpx;
        font-weight: bold;
      }
    }
    
    .product-grid {
      display: flex;
      flex-wrap: wrap;
      padding: 0 20rpx;
      
      .product-item {
        width: calc(50% - 20rpx);
        margin: 10rpx;
        background: #fff;
        border-radius: 20rpx;
        overflow: hidden;
        
        .product-image {
          position: relative;
          width: 100%;
          height: 350rpx;
          
          image {
            width: 100%;
            height: 100%;
          }
          
          .product-tag {
            position: absolute;
            top: 20rpx;
            left: 0;
            background: #ff6b6b;
            color: #fff;
            padding: 8rpx 20rpx;
            font-size: 22rpx;
            border-radius: 0 20rpx 20rpx 0;
          }
        }
        
        .product-info {
          padding: 20rpx;
          
          .product-name {
            font-size: 30rpx;
            font-weight: bold;
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            margin-bottom: 10rpx;
          }
          
          .product-desc {
            font-size: 24rpx;
            color: #999;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            margin-bottom: 20rpx;
          }
          
          .product-bottom {
            display: flex;
            justify-content: space-between;
            align-items: center;
            
            .price {
              color: #ff6b6b;
              
              .currency {
                font-size: 24rpx;
              }
              
              .amount {
                font-size: 36rpx;
                font-weight: bold;
              }
            }
            
            .cart-btn {
              width: 60rpx;
              height: 60rpx;
              background: #ff6b6b;
              border-radius: 50%;
              display: flex;
              align-items: center;
              justify-content: center;
              
              .iconfont {
                color: #fff;
                font-size: 32rpx;
              }
            }
          }
        }
      }
    }
  }
}
</style>
```

### 10.3 ç®¡ç†åå°ç•Œé¢ä¼˜åŒ–

#### 10.3.1 æ•°æ®çœ‹æ¿è®¾è®¡

```vue
<!-- åˆ›å»ºæ–‡ä»¶ï¼štemplate/admin/src/views/dashboard/index.vue -->
<template>
  <div class="dashboard-container">
    <!-- é¡¶éƒ¨ç»Ÿè®¡å¡ç‰‡ -->
    <el-row :gutter="20" class="stat-cards">
      <el-col :xs="24" :sm="12" :lg="6">
        <div class="stat-card">
          <div class="stat-icon" style="background: #ff6b6b;">
            <i class="el-icon-shopping-cart-2"></i>
          </div>
          <div class="stat-content">
            <div class="stat-title">ä»Šæ—¥è®¢å•</div>
            <div class="stat-value">{{ todayStats.orderCount }}</div>
            <div class="stat-trend">
              <span :class="todayStats.orderTrend > 0 ? 'up' : 'down'">
                {{ todayStats.orderTrend > 0 ? '+' : '' }}{{ todayStats.orderTrend }}%
              </span>
              <span class="trend-text">è¾ƒæ˜¨æ—¥</span>
            </div>
          </div>
        </div>
      </el-col>
      
      <el-col :xs="24" :sm="12" :lg="6">
        <div class="stat-card">
          <div class="stat-icon" style="background: #67c23a;">
            <i class="el-icon-money"></i>
          </div>
          <div class="stat-content">
            <div class="stat-title">ä»Šæ—¥é”€å”®é¢</div>
            <div class="stat-value">Â¥{{ todayStats.salesAmount }}</div>
            <div class="stat-trend">
              <span :class="todayStats.salesTrend > 0 ? 'up' : 'down'">
                {{ todayStats.salesTrend > 0 ? '+' : '' }}{{ todayStats.salesTrend }}%
              </span>
              <span class="trend-text">è¾ƒæ˜¨æ—¥</span>
            </div>
          </div>
        </div>
      </el-col>
      
      <el-col :xs="24" :sm="12" :lg="6">
        <div class="stat-card">
          <div class="stat-icon" style="background: #409eff;">
            <i class="el-icon-user"></i>
          </div>
          <div class="stat-content">
            <div class="stat-title">æ–°å¢ç”¨æˆ·</div>
            <div class="stat-value">{{ todayStats.newUsers }}</div>
            <div class="stat-trend">
              <span :class="todayStats.userTrend > 0 ? 'up' : 'down'">
                {{ todayStats.userTrend > 0 ? '+' : '' }}{{ todayStats.userTrend }}%
              </span>
              <span class="trend-text">è¾ƒæ˜¨æ—¥</span>
            </div>
          </div>
        </div>
      </el-col>
      
      <el-col :xs="24" :sm="12" :lg="6">
        <div class="stat-card">
          <div class="stat-icon" style="background: #e6a23c;">
            <i class="el-icon-star-on"></i>
          </div>
          <div class="stat-content">
            <div class="stat-title">æ–°å¢åˆä¼™äºº</div>
            <div class="stat-value">{{ todayStats.newPartners }}</div>
            <div class="stat-trend">
              <span :class="todayStats.partnerTrend > 0 ? 'up' : 'down'">
                {{ todayStats.partnerTrend > 0 ? '+' : '' }}{{ todayStats.partnerTrend }}%
              </span>
              <span class="trend-text">è¾ƒæ˜¨æ—¥</span>
            </div>
          </div>
        </div>
      </el-col>
    </el-row>
    
    <!-- å›¾è¡¨åŒºåŸŸ -->
    <el-row :gutter="20" class="chart-area">
      <!-- é”€å”®è¶‹åŠ¿å›¾ -->
      <el-col :lg="16" :xs="24">
        <el-card class="chart-card">
          <div slot="header" class="chart-header">
            <span class="chart-title">é”€å”®è¶‹åŠ¿</span>
            <el-radio-group v-model="salesPeriod" size="small">
              <el-radio-button label="week">è¿‘7å¤©</el-radio-button>
              <el-radio-button label="month">è¿‘30å¤©</el-radio-button>
              <el-radio-button label="year">è¿‘ä¸€å¹´</el-radio-button>
            </el-radio-group>
          </div>
          <div class="chart-container">
            <div ref="salesChart" style="height: 400px;"></div>
          </div>
        </el-card>
      </el-col>
      
      <!-- å•†å“é”€é‡æ’è¡Œ -->
      <el-col :lg="8" :xs="24">
        <el-card class="chart-card">
          <div slot="header" class="chart-header">
            <span class="chart-title">å•†å“é”€é‡TOP10</span>
          </div>
          <div class="product-ranking">
            <div class="ranking-item" 
                 v-for="(item, index) in productRanking" 
                 :key="item.id">
              <div class="ranking-index" :class="{'top': index < 3}">
                {{ index + 1 }}
              </div>
              <div class="product-info">
                <img :src="item.image" alt="">
                <div class="product-detail">
                  <div class="product-name">{{ item.name }}</div>
                  <div class="product-sales">é”€é‡ï¼š{{ item.sales }}</div>
                </div>
              </div>
              <div class="sales-amount">Â¥{{ item.amount }}</div>
            </div>
          </div>
        </el-card>
      </el-col>
    </el-row>
    
    <!-- ä¸šåŠ¡æ¦‚è§ˆ -->
    <el-row :gutter="20" class="business-overview">
      <!-- åˆ†é”€æ•°æ® -->
      <el-col :lg="8" :xs="24">
        <el-card>
          <div slot="header">
            <span class="card-title">åˆ†é”€æ•°æ®</span>
          </div>
          <div class="overview-content">
            <div class="overview-item">
              <span class="label">ä»Šæ—¥åˆ†äº«æ¬¡æ•°</span>
              <span class="value">{{ distributionStats.shareCount }}</span>
            </div>
            <div class="overview-item">
              <span class="label">æˆåŠŸåˆ†é”€è®¢å•</span>
              <span class="value">{{ distributionStats.successOrders }}</span>
            </div>
            <div class="overview-item">
              <span class="label">å‘æ”¾ç°é‡‘å¥–åŠ±</span>
              <span class="value">Â¥{{ distributionStats.cashReward }}</span>
            </div>
            <div class="overview-item">
              <span class="label">å‘æ”¾ç¤¼å“åˆ¸</span>
              <span class="value">{{ distributionStats.giftCards }}å¼ </span>
            </div>
          </div>
        </el-card>
      </el-col>
      
      <!-- ä¿¡ç”¨æ”¯ä»˜æ•°æ® -->
      <el-col :lg="8" :xs="24">
        <el-card>
          <div slot="header">
            <span class="card-title">ä¿¡ç”¨æ”¯ä»˜</span>
          </div>
          <div class="overview-content">
            <div class="overview-item">
              <span class="label">ä»Šæ—¥ä¿¡ç”¨è®¢å•</span>
              <span class="value">{{ creditStats.todayOrders }}</span>
            </div>
            <div class="overview-item">
              <span class="label">ä¿¡ç”¨ä½¿ç”¨é‡‘é¢</span>
              <span class="value">Â¥{{ creditStats.usedAmount }}</span>
            </div>
            <div class="overview-item">
              <span class="label">å¾…è¿˜æ¬¾é‡‘é¢</span>
              <span class="value">Â¥{{ creditStats.pendingAmount }}</span>
            </div>
            <div class="overview-item">
              <span class="label">é€¾æœŸè®¢å•</span>
              <span class="value text-danger">{{ creditStats.overdueCount }}</span>
            </div>
          </div>
        </el-card>
      </el-col>
      
      <!-- ä¾›åº”å•†æ•°æ® -->
      <el-col :lg="8" :xs="24">
        <el-card>
          <div slot="header">
            <span class="card-title">ä¾›åº”å•†æ¦‚å†µ</span>
          </div>
          <div class="overview-content">
            <div class="overview-item">
              <span class="label">æ´»è·ƒä¾›åº”å•†</span>
              <span class="value">{{ supplierStats.activeCount }}</span>
            </div>
            <div class="overview-item">
              <span class="label">ä»Šæ—¥å‘è´§è®¢å•</span>
              <span class="value">{{ supplierStats.shippedOrders }}</span>
            </div>
            <div class="overview-item">
              <span class="label">å¾…ç»“ç®—é‡‘é¢</span>
              <span class="value">Â¥{{ supplierStats.pendingSettlement }}</span>
            </div>
            <div class="overview-item">
              <span class="label">æœ¬æœˆç»“ç®—é‡‘é¢</span>
              <span class="value">Â¥{{ supplierStats.monthlySettlement }}</span>
            </div>
          </div>
        </el-card>
      </el-col>
    </el-row>
  </div>
</template>

<script>
import * as echarts from 'echarts'
import { getDashboardStats } from '@/api/dashboard'

export default {
  name: 'Dashboard',
  
  data() {
    return {
      // ä»Šæ—¥ç»Ÿè®¡
      todayStats: {
        orderCount: 0,
        orderTrend: 0,
        salesAmount: 0,
        salesTrend: 0,
        newUsers: 0,
        userTrend: 0,
        newPartners: 0,
        partnerTrend: 0
      },
      
      // é”€å”®è¶‹åŠ¿
      salesPeriod: 'week',
      salesChart: null,
      
      // å•†å“æ’è¡Œ
      productRanking: [],
      
      // ä¸šåŠ¡æ•°æ®
      distributionStats: {
        shareCount: 0,
        successOrders: 0,
        cashReward: 0,
        giftCards: 0
      },
      creditStats: {
        todayOrders: 0,
        usedAmount: 0,
        pendingAmount: 0,
        overdueCount: 0
      },
      supplierStats: {
        activeCount: 0,
        shippedOrders: 0,
        pendingSettlement: 0,
        monthlySettlement: 0
      }
    }
  },
  
  mounted() {
    this.initCharts()
    this.loadData()
    
    // å®šæ—¶åˆ·æ–°
    this.timer = setInterval(() => {
      this.loadData()
    }, 60000) // æ¯åˆ†é’Ÿåˆ·æ–°
  },
  
  beforeDestroy() {
    if (this.timer) {
      clearInterval(this.timer)
    }
    if (this.salesChart) {
      this.salesChart.dispose()
    }
  },
  
  watch: {
    salesPeriod() {
      this.updateSalesChart()
    }
  },
  
  methods: {
    // åˆå§‹åŒ–å›¾è¡¨
    initCharts() {
      this.salesChart = echarts.init(this.$refs.salesChart)
      
      // å“åº”å¼
      window.addEventListener('resize', () => {
        this.salesChart && this.salesChart.resize()
      })
    },
    
    // åŠ è½½æ•°æ®
    async loadData() {
      try {
        const res = await getDashboardStats()
        const data = res.data
        
        // æ›´æ–°å„é¡¹æ•°æ®
        this.todayStats = data.todayStats
        this.productRanking = data.productRanking
        this.distributionStats = data.distributionStats
        this.creditStats = data.creditStats
        this.supplierStats = data.supplierStats
        
        // æ›´æ–°å›¾è¡¨
        this.updateSalesChart(data.salesTrend)
      } catch (error) {
        console.error('åŠ è½½æ•°æ®å¤±è´¥', error)
      }
    },
    
    // æ›´æ–°é”€å”®è¶‹åŠ¿å›¾
    updateSalesChart(data) {
      if (!data) return
      
      const option = {
        tooltip: {
          trigger: 'axis',
          axisPointer: {
            type: 'cross'
          }
        },
        legend: {
          data: ['é”€å”®é¢', 'è®¢å•é‡']
        },
        grid: {
          left: '3%',
          right: '4%',
          bottom: '3%',
          containLabel: true
        },
        xAxis: {
          type: 'category',
          boundaryGap: false,
          data: data.dates
        },
        yAxis: [
          {
            type: 'value',
            name: 'é”€å”®é¢',
            axisLabel: {
              formatter: 'Â¥{value}'
            }
          },
          {
            type: 'value',
            name: 'è®¢å•é‡',
            axisLabel: {
              formatter: '{value}å•'
            }
          }
        ],
        series: [
          {
            name: 'é”€å”®é¢',
            type: 'line',
            smooth: true,
            data: data.amounts,
            itemStyle: {
              color: '#ff6b6b'
            },
            areaStyle: {
              color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                { offset: 0, color: 'rgba(255, 107, 107, 0.3)' },
                { offset: 1, color: 'rgba(255, 107, 107, 0.1)' }
              ])
            }
          },
          {
            name: 'è®¢å•é‡',
            type: 'line',
            smooth: true,
            yAxisIndex: 1,
            data: data.orders,
            itemStyle: {
              color: '#409eff'
            }
          }
        ]
      }
      
      this.salesChart.setOption(option)
    }
  }
}
</script>

<style lang="scss" scoped>
.dashboard-container {
  padding: 20px;
  
  .stat-cards {
    margin-bottom: 20px;
    
    .stat-card {
      background: #fff;
      border-radius: 8px;
      padding: 20px;
      display: flex;
      align-items: center;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      transition: all 0.3s;
      
      &:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
      }
      
      .stat-icon {
        width: 60px;
        height: 60px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-right: 20px;
        
        i {
          font-size: 28px;
          color: #fff;
        }
      }
      
      .stat-content {
        flex: 1;
        
        .stat-title {
          font-size: 14px;
          color: #999;
          margin-bottom: 8px;
        }
        
        .stat-value {
          font-size: 28px;
          font-weight: bold;
          color: #333;
          margin-bottom: 8px;
        }
        
        .stat-trend {
          font-size: 14px;
          
          .up {
            color: #67c23a;
          }
          
          .down {
            color: #f56c6c;
          }
          
          .trend-text {
            color: #999;
            margin-left: 5px;
          }
        }
      }
    }
  }
  
  .chart-area {
    margin-bottom: 20px;
    
    .chart-card {
      margin-bottom: 20px;
      
      .chart-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        
        .chart-title {
          font-size: 16px;
          font-weight: bold;
        }
      }
      
      .chart-container {
        padding: 20px 0;
      }
    }
    
    .product-ranking {
      .ranking-item {
        display: flex;
        align-items: center;
        padding: 15px 0;
        border-bottom: 1px solid #f0f0f0;
        
        &:last-child {
          border-bottom: none;
        }
        
        .ranking-index {
          width: 30px;
          height: 30px;
          background: #f0f0f0;
          border-radius: 50%;
          display: flex;
          align-items: center;
          justify-content: center;
          font-weight: bold;
          margin-right: 15px;
          
          &.top {
            background: #ff6b6b;
            color: #fff;
          }
        }
        
        .product-info {
          flex: 1;
          display: flex;
          align-items: center;
          
          img {
            width: 50px;
            height: 50px;
            border-radius: 4px;
            margin-right: 10px;
          }
          
          .product-detail {
            flex: 1;
            
            .product-name {
              font-size: 14px;
              margin-bottom: 5px;
              overflow: hidden;
              text-overflow: ellipsis;
              white-space: nowrap;
            }
            
            .product-sales {
              font-size: 12px;
              color: #999;
            }
          }
        }
        
        .sales-amount {
          font-size: 16px;
          font-weight: bold;
          color: #ff6b6b;
        }
      }
    }
  }
  
  .business-overview {
    .card-title {
      font-size: 16px;
      font-weight: bold;
    }
    
    .overview-content {
      .overview-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 15px 0;
        border-bottom: 1px solid #f0f0f0;
        
        &:last-child {
          border-bottom: none;
        }
        
        .label {
          font-size: 14px;
          color: #666;
        }
        
        .value {
          font-size: 16px;
          font-weight: bold;
          color: #333;
          
          &.text-danger {
            color: #f56c6c;
          }
        }
      }
    }
  }
}
</style>
```

### 10.4 ç»„ä»¶åº“å¼€å‘

#### 10.4.1 åˆ›å»ºå•†å“å¡ç‰‡ç»„ä»¶

```vue
<!-- åˆ›å»ºæ–‡ä»¶ï¼štemplate/uni-app/components/product-card/product-card.vue -->
<template>
  <view class="product-card" @click="handleClick">
    <!-- å•†å“å›¾ç‰‡ -->
    <view class="product-image">
      <image :src="product.image" 
             mode="aspectFill"
             lazy-load
             @error="handleImageError"></image>
      
      <!-- æ ‡ç­¾ -->
      <view class="product-tags" v-if="showTags">
        <view class="tag partner-tag" v-if="product.is_partner_product">
          åˆä¼™äººä¸“äº«
        </view>
        <view class="tag hot-tag" v-if="product.is_hot">
          çƒ­é”€
        </view>
        <view class="tag new-tag" v-if="product.is_new">
          æ–°å“
        </view>
      </view>
      
      <!-- æ´»åŠ¨æ ‡ç­¾ -->
      <view class="activity-tag" v-if="product.activity_type">
        <text class="iconfont" :class="activityIcon"></text>
        <text>{{ activityText }}</text>
      </view>
    </view>
    
    <!-- å•†å“ä¿¡æ¯ -->
    <view class="product-info">
      <!-- å•†å“åç§° -->
      <view class="product-name">
        <text class="name-text">{{ product.store_name }}</text>
      </view>
      
      <!-- å•†å“æè¿° -->
      <view class="product-desc" v-if="showDesc">
        {{ product.store_info }}
      </view>
      
      <!-- ä»·æ ¼å’Œæ“ä½œ -->
      <view class="product-footer">
        <view class="price-box">
          <!-- ç°ä»· -->
          <view class="current-price">
            <text class="currency">Â¥</text>
            <text class="price">{{ product.price }}</text>
          </view>
          
          <!-- åŸä»· -->
          <view class="origin-price" v-if="product.ot_price > product.price">
            Â¥{{ product.ot_price }}
          </view>
          
          <!-- åˆä¼™äººä»· -->
          <view class="partner-price" v-if="isPartner && product.partner_price">
            <text class="label">åˆä¼™äººä»·</text>
            <text class="price">Â¥{{ product.partner_price }}</text>
          </view>
        </view>
        
        <!-- æ“ä½œæŒ‰é’® -->
        <view class="action-box" v-if="showAction">
          <button class="cart-btn" 
                  @click.stop="handleCart"
                  v-if="actionType === 'cart'">
            <text class="iconfont icon-cart"></text>
          </button>
          
          <button class="buy-btn"
                  @click.stop="handleBuy"
                  v-if="actionType === 'buy'">
            ç«‹å³è´­ä¹°
          </button>
        </view>
      </view>
      
      <!-- é”€é‡å’Œè¯„ä»· -->
      <view class="product-extra" v-if="showExtra">
        <text class="sales">å·²å”®{{ product.sales }}ä»¶</text>
        <text class="divider">|</text>
        <text class="comment">{{ product.reply_count }}æ¡è¯„ä»·</text>
      </view>
    </view>
  </view>
</template>

<script>
export default {
  name: 'ProductCard',
  
  props: {
    // å•†å“æ•°æ®
    product: {
      type: Object,
      required: true
    },
    
    // æ˜¾ç¤ºé…ç½®
    showTags: {
      type: Boolean,
      default: true
    },
    showDesc: {
      type: Boolean,
      default: true
    },
    showAction: {
      type: Boolean,
      default: true
    },
    showExtra: {
      type: Boolean,
      default: false
    },
    
    // æ“ä½œç±»å‹
    actionType: {
      type: String,
      default: 'cart' // cart | buy
    }
  },
  
  computed: {
    // æ˜¯å¦ä¸ºåˆä¼™äºº
    isPartner() {
      const userInfo = uni.getStorageSync('userInfo')
      return userInfo && userInfo.is_partner
    },
    
    // æ´»åŠ¨å›¾æ ‡
    activityIcon() {
      const icons = {
        1: 'icon-seckill',
        2: 'icon-bargain',
        3: 'icon-combination',
        4: 'icon-discount'
      }
      return icons[this.product.activity_type] || ''
    },
    
    // æ´»åŠ¨æ–‡å­—
    activityText() {
      const texts = {
        1: 'é™æ—¶ç§’æ€',
        2: 'ç ä»·',
        3: 'æ‹¼å›¢',
        4: 'é™æ—¶æŠ˜æ‰£'
      }
      return texts[this.product.activity_type] || ''
    }
  },
  
  methods: {
    // ç‚¹å‡»å•†å“
    handleClick() {
      this.$emit('click', this.product)
      
      // é»˜è®¤è·³è½¬å•†å“è¯¦æƒ…
      uni.navigateTo({
        url: `/pages/goods/goods?id=${this.product.id}`
      })
    },
    
    // åŠ å…¥è´­ç‰©è½¦
    handleCart() {
      this.$emit('cart', this.product)
    },
    
    // ç«‹å³è´­ä¹°
    handleBuy() {
      this.$emit('buy', this.product)
    },
    
    // å›¾ç‰‡åŠ è½½å¤±è´¥
    handleImageError() {
      // è®¾ç½®é»˜è®¤å›¾ç‰‡
      this.product.image = '/static/images/product-default.png'
    }
  }
}
</script>

<style lang="scss" scoped>
.product-card {
  background: #fff;
  border-radius: 20rpx;
  overflow: hidden;
  transition: all 0.3s;
  
  &:active {
    transform: scale(0.98);
  }
  
  .product-image {
    position: relative;
    width: 100%;
    height: 350rpx;
    overflow: hidden;
    
    image {
      width: 100%;
      height: 100%;
    }
    
    .product-tags {
      position: absolute;
      top: 20rpx;
      left: 20rpx;
      display: flex;
      flex-direction: column;
      gap: 10rpx;
      
      .tag {
        padding: 8rpx 16rpx;
        font-size: 22rpx;
        border-radius: 20rpx;
        color: #fff;
        
        &.partner-tag {
          background: linear-gradient(45deg, #ff6b6b, #ff8e53);
        }
        
        &.hot-tag {
          background: #ff6b6b;
        }
        
        &.new-tag {
          background: #67c23a;
        }
      }
    }
    
    .activity-tag {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      background: rgba(0, 0, 0, 0.6);
      color: #fff;
      padding: 10rpx 20rpx;
      font-size: 24rpx;
      display: flex;
      align-items: center;
      
      .iconfont {
        margin-right: 10rpx;
      }
    }
  }
  
  .product-info {
    padding: 20rpx;
    
    .product-name {
      margin-bottom: 10rpx;
      
      .name-text {
        font-size: 30rpx;
        font-weight: bold;
        overflow: hidden;
        text-overflow: ellipsis;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        line-height: 1.5;
      }
    }
    
    .product-desc {
      font-size: 24rpx;
      color: #999;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      margin-bottom: 20rpx;
    }
    
    .product-footer {
      display: flex;
      justify-content: space-between;
      align-items: flex-end;
      
      .price-box {
        flex: 1;
        
        .current-price {
          display: inline-flex;
          align-items: baseline;
          color: #ff6b6b;
          margin-right: 20rpx;
          
          .currency {
            font-size: 24rpx;
          }
          
          .price {
            font-size: 36rpx;
            font-weight: bold;
          }
        }
        
        .origin-price {
          display: inline-block;
          font-size: 24rpx;
          color: #999;
          text-decoration: line-through;
        }
        
        .partner-price {
          display: block;
          margin-top: 8rpx;
          font-size: 24rpx;
          color: #ff8e53;
          
          .label {
            margin-right: 10rpx;
          }
        }
      }
      
      .action-box {
        .cart-btn {
          width: 60rpx;
          height: 60rpx;
          background: #ff6b6b;
          border-radius: 50%;
          display: flex;
          align-items: center;
          justify-content: center;
          border: none;
          
          .iconfont {
            color: #fff;
            font-size: 32rpx;
          }
        }
        
        .buy-btn {
          height: 60rpx;
          padding: 0 30rpx;
          background: linear-gradient(45deg, #ff6b6b, #ff8e53);
          color: #fff;
          font-size: 26rpx;
          border-radius: 30rpx;
          border: none;
        }
      }
    }
    
    .product-extra {
      margin-top: 20rpx;
      font-size: 22rpx;
      color: #999;
      
      .divider {
        margin: 0 10rpx;
      }
    }
  }
}
</style>
```

### 10.5 ä¸»é¢˜å®šåˆ¶

#### 10.5.1 åˆ›å»ºä¸»é¢˜é…ç½®æ–‡ä»¶

```scss
// åˆ›å»ºæ–‡ä»¶ï¼štemplate/uni-app/styles/theme.scss
// ä¸»é¢˜é¢œè‰²é…ç½®

// ä¸»è‰²è°ƒ
$primary-color: #ff6b6b;
$primary-gradient-start: #ff6b6b;
$primary-gradient-end: #ff8e53;

// åŠŸèƒ½è‰²
$success-color: #67c23a;
$warning-color: #e6a23c;
$danger-color: #f56c6c;
$info-color: #409eff;

// ä¸­æ€§è‰²
$text-color: #333333;
$text-color-secondary: #666666;
$text-color-placeholder: #999999;
$border-color: #e5e5e5;
$background-color: #f5f5f5;

// é˜´å½±
$box-shadow-base: 0 2rpx 8rpx rgba(0, 0, 0, 0.1);
$box-shadow-light: 0 2rpx 4rpx rgba(0, 0, 0, 0.05);
$box-shadow-dark: 0 4rpx 16rpx rgba(0, 0, 0, 0.15);

// åœ†è§’
$border-radius-small: 8rpx;
$border-radius-base: 12rpx;
$border-radius-large: 20rpx;
$border-radius-circle: 50%;

// é—´è·
$spacing-xs: 10rpx;
$spacing-sm: 20rpx;
$spacing-md: 30rpx;
$spacing-lg: 40rpx;
$spacing-xl: 60rpx;

// å­—ä½“å¤§å°
$font-size-xs: 22rpx;
$font-size-sm: 24rpx;
$font-size-base: 28rpx;
$font-size-md: 30rpx;
$font-size-lg: 32rpx;
$font-size-xl: 36rpx;
$font-size-xxl: 40rpx;

// æ··å…¥ï¼ˆMixinsï¼‰
@mixin flex-center {
  display: flex;
  align-items: center;
  justify-content: center;
}

@mixin flex-between {
  display: flex;
  align-items: center;
  justify-content: space-between;
}

@mixin ellipsis($lines: 1) {
  overflow: hidden;
  text-overflow: ellipsis;
  @if $lines == 1 {
    white-space: nowrap;
  } @else {
    display: -webkit-box;
    -webkit-line-clamp: $lines;
    -webkit-box-orient: vertical;
  }
}

@mixin card-style {
  background: #fff;
  border-radius: $border-radius-large;
  box-shadow: $box-shadow-base;
}

@mixin button-style($bg-color: $primary-color) {
  background: $bg-color;
  color: #fff;
  border: none;
  border-radius: $border-radius-circle;
  @include flex-center;
  
  &:active {
    opacity: 0.8;
  }
  
  &[disabled] {
    opacity: 0.5;
  }
}

// æ¸å˜èƒŒæ™¯
@mixin gradient-bg($start: $primary-gradient-start, $end: $primary-gradient-end, $deg: 45deg) {
  background: linear-gradient($deg, $start, $end);
}

// ä¸»é¢˜åˆ‡æ¢ï¼ˆé¢„ç•™ï¼‰
@mixin theme-dark {
  // æ·±è‰²ä¸»é¢˜é…ç½®
  $text-color: #ffffff;
  $background-color: #1a1a1a;
  // ...
}
```

### 10.6 æœ¬ç« ç»ƒä¹ 

1. **ç•Œé¢å¼€å‘**ï¼š
   - è®¾è®¡å¹¶å®ç°ä¸ªäººä¸­å¿ƒé¡µé¢
   - åˆ›å»ºè®¢å•åˆ—è¡¨é¡µé¢
   - ä¼˜åŒ–å•†å“è¯¦æƒ…é¡µ

2. **ç»„ä»¶å¼€å‘**ï¼š
   - å¼€å‘è®¢å•å¡ç‰‡ç»„ä»¶
   - åˆ›å»ºå€’è®¡æ—¶ç»„ä»¶
   - å®ç°å›¾ç‰‡é¢„è§ˆç»„ä»¶

3. **ä¸»é¢˜å®šåˆ¶**ï¼š
   - å®ç°æ·±è‰²æ¨¡å¼åˆ‡æ¢
   - åˆ›å»ºèŠ‚æ—¥ä¸»é¢˜æ ·å¼
   - å¼€å‘ä¸»é¢˜é…ç½®é¢æ¿

---

## ç¬¬åä¸€ç« ï¼šç³»ç»Ÿéƒ¨ç½²ä¸ä¸Šçº¿ - è®©å•†åŸæ´»èµ·æ¥

### 11.1 éƒ¨ç½²å‰å‡†å¤‡

éƒ¨ç½²å°±åƒ**æ¬å®¶å…¥ä½**ï¼š
- ğŸ  **æœåŠ¡å™¨**ï¼šæ–°å®¶çš„æˆ¿å­
- ğŸ“¦ **ä»£ç æ‰“åŒ…**ï¼šæ‰“åŒ…è¡Œæ
- ğŸ”§ **ç¯å¢ƒé…ç½®**ï¼šè£…ä¿®å¸ƒç½®
- ğŸš€ **ä¸Šçº¿å‘å¸ƒ**ï¼šæ­£å¼å…¥ä½

### 11.2 ä»£ç æ‰“åŒ…ä¼˜åŒ–

#### 11.2.1 åç«¯ä»£ç ä¼˜åŒ–

```bash
# 1. è¿›å…¥é¡¹ç›®ç›®å½•
cd /www/wwwroot/qingrenfu

# 2. æ¸…ç†ç¼“å­˜
php think clear

# 3. å…³é—­è°ƒè¯•æ¨¡å¼
# ä¿®æ”¹ .env æ–‡ä»¶
APP_DEBUG = false

# 4. ä¼˜åŒ–é…ç½®
php think optimize:config
php think optimize:route

# 5. å®‰è£…ç”Ÿäº§ç¯å¢ƒä¾èµ–
composer install --no-dev --optimize-autoloader

# 6. è®¾ç½®ç›®å½•æƒé™
chmod -R 755 .
chmod -R 777 runtime
chmod -R 777 public/uploads
```

#### 11.2.2 å‰ç«¯ä»£ç æ‰“åŒ…

**ç®¡ç†åå°æ‰“åŒ…ï¼š**

```bash
# è¿›å…¥ç®¡ç†åå°ç›®å½•
cd template/admin

# å®‰è£…ä¾èµ–
npm install

# ä¿®æ”¹ç”Ÿäº§ç¯å¢ƒé…ç½®
# ç¼–è¾‘ .env.production
VUE_APP_BASE_API = 'https://shop.qingrenfu.com'

# æ‰“åŒ…
npm run build

# æ‰“åŒ…åçš„æ–‡ä»¶åœ¨ dist ç›®å½•
```

**å°ç¨‹åºæ‰“åŒ…ï¼š**

```bash
# è¿›å…¥å°ç¨‹åºç›®å½•
cd template/uni-app

# å®‰è£…ä¾èµ–
npm install

# ä¿®æ”¹é…ç½®
# ç¼–è¾‘ common/config.js
export default {
  baseUrl: 'https://shop.qingrenfu.com',
  // ... å…¶ä»–é…ç½®
}

# ç¼–è¯‘å°ç¨‹åº
npm run build:mp-weixin

# ç¼–è¯‘åçš„æ–‡ä»¶åœ¨ dist/build/mp-weixin ç›®å½•
```

### 11.3 æœåŠ¡å™¨é…ç½®ä¼˜åŒ–

#### 11.3.1 Nginxé…ç½®ä¼˜åŒ–

```nginx
# ç¼–è¾‘ç½‘ç«™é…ç½®æ–‡ä»¶
# /www/server/panel/vhost/nginx/shop.qingrenfu.com.conf

server {
    listen 443 ssl http2;
    server_name shop.qingrenfu.com;
    
    # SSLé…ç½®
    ssl_certificate /www/server/panel/vhost/cert/shop.qingrenfu.com/fullchain.pem;
    ssl_certificate_key /www/server/panel/vhost/cert/shop.qingrenfu.com/privkey.pem;
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers ECDHE-RSA-AES128-GCM-SHA256:HIGH:!aNULL:!MD5:!RC4:!DHE;
    ssl_prefer_server_ciphers on;
    ssl_session_cache shared:SSL:10m;
    ssl_session_timeout 10m;
    
    # å®‰å…¨å¤´éƒ¨
    add_header X-Frame-Options "SAMEORIGIN";
    add_header X-Content-Type-Options "nosniff";
    add_header X-XSS-Protection "1; mode=block";
    
    # Gzipå‹ç¼©
    gzip on;
    gzip_vary on;
    gzip_comp_level 6;
    gzip_types text/plain text/css text/xml text/javascript application/json application/javascript application/xml+rss application/rss+xml application/atom+xml image/svg+xml;
    
    # æ ¹ç›®å½•
    root /www/wwwroot/qingrenfu/crmeb/public;
    index index.php;
    
    # é™æ€èµ„æºç¼“å­˜
    location ~* \.(jpg|jpeg|png|gif|ico|css|js|pdf|txt|woff|woff2|ttf)$ {
        expires 30d;
        add_header Cache-Control "public, immutable";
    }
    
    # ä¸Šä¼ æ–‡ä»¶å¤§å°é™åˆ¶
    client_max_body_size 50M;
    
    # PHPé…ç½®
    location ~ \.php$ {
        fastcgi_pass unix:/tmp/php-cgi-74.sock;
        fastcgi_index index.php;
        include fastcgi_params;
        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
        
        # PHPè¶…æ—¶è®¾ç½®
        fastcgi_connect_timeout 300;
        fastcgi_send_timeout 300;
        fastcgi_read_timeout 300;
    }
    
    # ä¼ªé™æ€è§„åˆ™
    location / {
        if (!-e $request_filename) {
            rewrite ^(.*)$ /index.php?s=/$1 last;
        }
    }
    
    # ç¦æ­¢è®¿é—®çš„æ–‡ä»¶
    location ~ ^/(\.user.ini|\.htaccess|\.git|\.svn|\.project|LICENSE|README.md) {
        return 404;
    }
    
    # ç®¡ç†åå°
    location /admin {
        alias /www/wwwroot/qingrenfu/template/admin/dist;
        try_files $uri $uri/ /admin/index.html;
    }
}

# HTTPè·³è½¬HTTPS
server {
    listen 80;
    server_name shop.qingrenfu.com;
    return 301 https://$server_name$request_uri;
}
```

#### 11.3.2 PHPé…ç½®ä¼˜åŒ–

åœ¨å®å¡”é¢æ¿ä¸­ï¼Œæ‰¾åˆ°PHPè®¾ç½®ï¼š

1. **é…ç½®ä¿®æ”¹**ï¼š
```ini
# å†…å­˜é™åˆ¶
memory_limit = 256M

# ä¸Šä¼ é™åˆ¶
upload_max_filesize = 50M
post_max_size = 50M

# æ‰§è¡Œæ—¶é—´
max_execution_time = 300
max_input_time = 300

# OPcacheä¼˜åŒ–
opcache.enable=1
opcache.memory_consumption=128
opcache.interned_strings_buffer=8
opcache.max_accelerated_files=10000
opcache.revalidate_freq=60
```

2. **å®‰è£…æ‰©å±•**ï¼š
- opcacheï¼ˆæ€§èƒ½ä¼˜åŒ–ï¼‰
- redisï¼ˆç¼“å­˜ï¼‰
- fileinfoï¼ˆæ–‡ä»¶å¤„ç†ï¼‰

### 11.4 æ•°æ®åº“ä¼˜åŒ–

#### 11.4.1 MySQLé…ç½®ä¼˜åŒ–

```ini
# ç¼–è¾‘ /etc/my.cnf
[mysqld]
# åŸºç¡€è®¾ç½®
max_connections = 500
max_connect_errors = 100

# ç¼“å­˜è®¾ç½®
key_buffer_size = 128M
query_cache_size = 64M
query_cache_type = 1
tmp_table_size = 64M
max_heap_table_size = 64M

# InnoDBè®¾ç½®
innodb_buffer_pool_size = 512M
innodb_log_file_size = 128M
innodb_flush_log_at_trx_commit = 2
innodb_flush_method = O_DIRECT

# æ…¢æŸ¥è¯¢æ—¥å¿—
slow_query_log = 1
slow_query_log_file = /www/server/data/mysql-slow.log
long_query_time = 2
```

#### 11.4.2 æ•°æ®åº“å¤‡ä»½ç­–ç•¥

```bash
# åˆ›å»ºå¤‡ä»½è„šæœ¬
vim /root/backup_mysql.sh

#!/bin/bash
# æ•°æ®åº“å¤‡ä»½è„šæœ¬

# é…ç½®
DB_NAME="qingrenfu"
DB_USER="root"
DB_PASS="your_password"
BACKUP_DIR="/www/backup/database"
DATE=$(date +%Y%m%d_%H%M%S)

# åˆ›å»ºå¤‡ä»½ç›®å½•
mkdir -p $BACKUP_DIR

# å¤‡ä»½æ•°æ®åº“
mysqldump -u$DB_USER -p$DB_PASS $DB_NAME > $BACKUP_DIR/${DB_NAME}_${DATE}.sql

# å‹ç¼©å¤‡ä»½æ–‡ä»¶
gzip $BACKUP_DIR/${DB_NAME}_${DATE}.sql

# åˆ é™¤7å¤©å‰çš„å¤‡ä»½
find $BACKUP_DIR -name "*.sql.gz" -mtime +7 -delete

# åŒæ­¥åˆ°è¿œç¨‹æœåŠ¡å™¨ï¼ˆå¯é€‰ï¼‰
# rsync -av $BACKUP_DIR/ user@backup-server:/path/to/backup/

echo "å¤‡ä»½å®Œæˆ: ${DB_NAME}_${DATE}.sql.gz"
```

è®¾ç½®å®šæ—¶ä»»åŠ¡ï¼š
```bash
# æ·»åŠ å®šæ—¶ä»»åŠ¡
crontab -e

# æ¯å¤©å‡Œæ™¨3ç‚¹å¤‡ä»½
0 3 * * * /root/backup_mysql.sh > /www/logs/backup.log 2>&1
```

### 11.5 CDNé…ç½®

#### 11.5.1 é™æ€èµ„æºCDN

1. **å¼€é€šCDNæœåŠ¡**ï¼ˆä»¥é˜¿é‡Œäº‘ä¸ºä¾‹ï¼‰ï¼š
   - ç™»å½•é˜¿é‡Œäº‘æ§åˆ¶å°
   - å¼€é€šCDNæœåŠ¡
   - æ·»åŠ åŠ é€ŸåŸŸåï¼šcdn.qingrenfu.com

2. **é…ç½®æºç«™**ï¼š
   - æºç«™ç±»å‹ï¼šæºç«™åŸŸå
   - æºç«™åœ°å€ï¼šshop.qingrenfu.com
   - å›æºç«¯å£ï¼š443

3. **ç¼“å­˜é…ç½®**ï¼š
```
# ç¼“å­˜è§„åˆ™
/static/*     ç¼“å­˜30å¤©
/uploads/*    ç¼“å­˜7å¤©
*.js          ç¼“å­˜30å¤©
*.css         ç¼“å­˜30å¤©
*.jpg,*.png   ç¼“å­˜30å¤©
```

4. **ä¿®æ”¹ä»£ç ä¸­çš„é™æ€èµ„æºåœ°å€**ï¼š
```php
// config/filesystem.php
'cdn_domain' => 'https://cdn.qingrenfu.com',
```

### 11.6 å°ç¨‹åºå‘å¸ƒ

#### 11.6.1 å°ç¨‹åºé…ç½®

1. **ä¿®æ”¹å°ç¨‹åºé…ç½®**ï¼š
```javascript
// manifest.json
{
  "mp-weixin": {
    "appid": "ä½ çš„å°ç¨‹åºAppID",
    "setting": {
      "urlCheck": true,
      "es6": true,
      "postcss": true,
      "minified": true
    },
    "permission": {
      "scope.userLocation": {
        "desc": "è·å–ä½ç½®ä¿¡æ¯"
      }
    }
  }
}
```

2. **é…ç½®æœåŠ¡å™¨åŸŸå**ï¼š
   - ç™»å½•å¾®ä¿¡å…¬ä¼—å¹³å°
   - å¼€å‘ â†’ å¼€å‘è®¾ç½® â†’ æœåŠ¡å™¨åŸŸå
   - æ·»åŠ åŸŸåï¼š
     - requeståˆæ³•åŸŸåï¼šhttps://shop.qingrenfu.com
     - uploadFileåˆæ³•åŸŸåï¼šhttps://shop.qingrenfu.com
     - downloadFileåˆæ³•åŸŸåï¼šhttps://shop.qingrenfu.com

#### 11.6.2 ä¸Šä¼ ä»£ç 

1. **ä½¿ç”¨å¾®ä¿¡å¼€å‘è€…å·¥å…·**ï¼š
   - å¯¼å…¥é¡¹ç›®ï¼šé€‰æ‹© dist/build/mp-weixin ç›®å½•
   - ç‚¹å‡»"ä¸Šä¼ "æŒ‰é’®
   - å¡«å†™ç‰ˆæœ¬å·å’Œé¡¹ç›®å¤‡æ³¨

2. **æäº¤å®¡æ ¸**ï¼š
   - ç™»å½•å°ç¨‹åºåå°
   - ç‰ˆæœ¬ç®¡ç† â†’ æäº¤å®¡æ ¸
   - å¡«å†™å®¡æ ¸ä¿¡æ¯

### 11.7 ç›‘æ§ä¸æ—¥å¿—

#### 11.7.1 é…ç½®æ—¥å¿—ç³»ç»Ÿ

```php
// config/log.php
return [
    'default' => 'file',
    'channels' => [
        'file' => [
            'type' => 'daily',
            'path' => runtime_path() . 'log/',
            'level' => 'error',
            'max_files' => 30,
        ],
        // é”™è¯¯æ—¥å¿—å•ç‹¬è®°å½•
        'error' => [
            'type' => 'daily',
            'path' => runtime_path() . 'error/',
            'level' => 'error',
            'max_files' => 30,
        ],
        // æ”¯ä»˜æ—¥å¿—
        'payment' => [
            'type' => 'daily',
            'path' => runtime_path() . 'payment/',
            'level' => 'info',
            'max_files' => 90,
        ],
    ],
];
```

#### 11.7.2 æ€§èƒ½ç›‘æ§è„šæœ¬

```php
// åˆ›å»ºæ–‡ä»¶ï¼šapp/command/Monitor.php
<?php
namespace app\command;

use think\console\Command;
use think\console\Input;
use think\console\Output;

class Monitor extends Command
{
    protected function configure()
    {
        $this->setName('monitor:check')
             ->setDescription('ç³»ç»Ÿç›‘æ§æ£€æŸ¥');
    }
    
    protected function execute(Input $input, Output $output)
    {
        // CPUä½¿ç”¨ç‡
        $cpu = sys_getloadavg()[0];
        
        // å†…å­˜ä½¿ç”¨
        $memory = memory_get_usage(true) / 1024 / 1024;
        
        // ç£ç›˜ç©ºé—´
        $disk = disk_free_space('/') / 1024 / 1024 / 1024;
        
        // æ•°æ®åº“è¿æ¥
        try {
            $db = \think\facade\Db::query("SELECT 1");
            $dbStatus = 'OK';
        } catch (\Exception $e) {
            $dbStatus = 'ERROR: ' . $e->getMessage();
        }
        
        // Redisè¿æ¥
        try {
            $redis = \think\facade\Cache::store('redis')->handler();
            $redis->ping();
            $redisStatus = 'OK';
        } catch (\Exception $e) {
            $redisStatus = 'ERROR: ' . $e->getMessage();
        }
        
        $output->writeln("=== ç³»ç»Ÿç›‘æ§æŠ¥å‘Š ===");
        $output->writeln("CPUè´Ÿè½½: {$cpu}");
        $output->writeln("å†…å­˜ä½¿ç”¨: {$memory}MB");
        $output->writeln("å‰©ä½™ç£ç›˜: {$disk}GB");
        $output->writeln("æ•°æ®åº“: {$dbStatus}");
        $output->writeln("Redis: {$redisStatus}");
        
        // å‘Šè­¦
        if ($cpu > 2) {
            $this->sendAlert("CPUè´Ÿè½½è¿‡é«˜: {$cpu}");
        }
        
        if ($disk < 10) {
            $this->sendAlert("ç£ç›˜ç©ºé—´ä¸è¶³: {$disk}GB");
        }
    }
    
    protected function sendAlert($message)
    {
        // å‘é€å‘Šè­¦ï¼ˆçŸ­ä¿¡ã€é‚®ä»¶ç­‰ï¼‰
        // ...
    }
}
```

### 11.8 å®‰å…¨åŠ å›º

#### 11.8.1 å®‰å…¨é…ç½®æ¸…å•

1. **å…³é—­ä¸å¿…è¦çš„æœåŠ¡**ï¼š
```bash
# æ£€æŸ¥å¼€æ”¾ç«¯å£
netstat -tlnp

# å…³é—­ä¸éœ€è¦çš„æœåŠ¡
systemctl stop service_name
systemctl disable service_name
```

2. **é…ç½®é˜²ç«å¢™**ï¼š
```bash
# å¼€å¯é˜²ç«å¢™
systemctl start firewalld
systemctl enable firewalld

# åªå¼€æ”¾å¿…è¦ç«¯å£
firewall-cmd --permanent --add-port=80/tcp
firewall-cmd --permanent --add-port=443/tcp
firewall-cmd --permanent --add-port=22/tcp
firewall-cmd --reload
```

3. **å®šæœŸæ›´æ–°**ï¼š
```bash
# ç³»ç»Ÿæ›´æ–°
yum update -y

# PHPæ›´æ–°ï¼ˆé€šè¿‡å®å¡”é¢æ¿ï¼‰
```

#### 11.8.2 ä»£ç å®‰å…¨æ£€æŸ¥

```php
// åˆ›å»ºå®‰å…¨ä¸­é—´ä»¶
// app/middleware/Security.php
<?php
namespace app\middleware;

class Security
{
    public function handle($request, \Closure $next)
    {
        // XSSé˜²æŠ¤
        $params = $request->param();
        array_walk_recursive($params, function(&$value) {
            $value = htmlspecialchars($value, ENT_QUOTES, 'UTF-8');
        });
        $request->withParam($params);
        
        // SQLæ³¨å…¥é˜²æŠ¤ï¼ˆæ¡†æ¶å·²å¤„ç†ï¼‰
        
        // CSRFé˜²æŠ¤
        if ($request->isPost()) {
            $token = $request->header('X-CSRF-TOKEN');
            if (!$this->validateCsrfToken($token)) {
                return json(['code' => 403, 'msg' => 'CSRFéªŒè¯å¤±è´¥']);
            }
        }
        
        return $next($request);
    }
    
    protected function validateCsrfToken($token)
    {
        // éªŒè¯é€»è¾‘
        return true;
    }
}
```

### 11.9 æœ¬ç« ç»ƒä¹ 

1. **éƒ¨ç½²å®è·µ**ï¼š
   - å®Œæˆç”Ÿäº§ç¯å¢ƒéƒ¨ç½²
   - é…ç½®SSLè¯ä¹¦
   - è®¾ç½®è‡ªåŠ¨å¤‡ä»½

2. **æ€§èƒ½ä¼˜åŒ–**ï¼š
   - å®æ–½CDNåŠ é€Ÿ
   - ä¼˜åŒ–æ•°æ®åº“æŸ¥è¯¢
   - é…ç½®Redisç¼“å­˜

3. **å®‰å…¨åŠ å›º**ï¼š
   - å®æ–½å®‰å…¨ç­–ç•¥
   - é…ç½®ç›‘æ§å‘Šè­¦
   - åˆ¶å®šåº”æ€¥é¢„æ¡ˆ

---

## ç¬¬åäºŒç« ï¼šè¿ç»´ä¸ä¼˜åŒ– - è®©å•†åŸç¨³å®šè¿è¡Œ

### 12.1 æ—¥å¸¸è¿ç»´å·¥ä½œ

è¿ç»´å°±åƒ**ç‰©ä¸šç®¡ç†**ï¼š
- ğŸ”§ **æ—¥å¸¸å·¡æ£€**ï¼šæ£€æŸ¥ç³»ç»ŸçŠ¶æ€
- ğŸš¨ **æ•…éšœå¤„ç†**ï¼šåŠæ—¶è§£å†³é—®é¢˜
- ğŸ“Š **æ€§èƒ½ä¼˜åŒ–**ï¼šæå‡ç”¨æˆ·ä½“éªŒ
- ğŸ“ˆ **æ•°æ®åˆ†æ**ï¼šæŒ‡å¯¼ä¸šåŠ¡å†³ç­–

### 12.2 ç›‘æ§ä½“ç³»å»ºè®¾

#### 12.2.1 æ­å»ºç›‘æ§ç³»ç»Ÿ

```bash
# å®‰è£…Prometheus + Grafana

# 1. å®‰è£…Prometheus
cd /opt
wget https://github.com/prometheus/prometheus/releases/download/v2.37.0/prometheus-2.37.0.linux-amd64.tar.gz
tar -xvf prometheus-2.37.0.linux-amd64.tar.gz
mv prometheus-2.37.0.linux-amd64 prometheus

# 2. é…ç½®Prometheus
cat > /opt/prometheus/prometheus.yml << EOF
global:
  scrape_interval: 15s

scrape_configs:
  - job_name: 'node'
    static_configs:
    - targets: ['localhost:9100']
    
  - job_name: 'mysql'
    static_configs:
    - targets: ['localhost:9104']
    
  - job_name: 'redis'
    static_configs:
    - targets: ['localhost:9121']
    
  - job_name: 'php-fpm'
    static_configs:
    - targets: ['localhost:9253']
EOF

# 3. åˆ›å»ºsystemdæœåŠ¡
cat > /etc/systemd/system/prometheus.service << EOF
[Unit]
Description=Prometheus
After=network.target

[Service]
Type=simple
ExecStart=/opt/prometheus/prometheus --config.file=/opt/prometheus/prometheus.yml
Restart=always

[Install]
WantedBy=multi-user.target
EOF

systemctl start prometheus
systemctl enable prometheus
```

#### 12.2.2 ä¸šåŠ¡ç›‘æ§æŒ‡æ ‡

```php
// åˆ›å»ºæ–‡ä»¶ï¼šapp/middleware/Metrics.php
<?php
namespace app\middleware;

use think\facade\Cache;

class Metrics
{
    public function handle($request, \Closure $next)
    {
        $startTime = microtime(true);
        
        // è¯·æ±‚è®¡æ•°
        Cache::inc('metrics:request:total');
        
        // æ‰§è¡Œè¯·æ±‚
        $response = $next($request);
        
        // å“åº”æ—¶é—´
        $duration = microtime(true) - $startTime;
        $this->recordResponseTime($request->pathinfo(), $duration);
        
        // çŠ¶æ€ç ç»Ÿè®¡
        $statusCode = $response->getCode();
        Cache::inc("metrics:response:status:{$statusCode}");
        
        return $response;
    }
    
    protected function recordResponseTime($path, $duration)
    {
        // æŒ‰è·¯å¾„åˆ†ç»„ç»Ÿè®¡
        $key = "metrics:response:time:" . date('YmdH');
        $data = Cache::get($key, []);
        
        if (!isset($data[$path])) {
            $data[$path] = [
                'count' => 0,
                'total' => 0,
                'max' => 0,
                'min' => PHP_FLOAT_MAX
            ];
        }
        
        $data[$path]['count']++;
        $data[$path]['total'] += $duration;
        $data[$path]['max'] = max($data[$path]['max'], $duration);
        $data[$path]['min'] = min($data[$path]['min'], $duration);
        
        Cache::set($key, $data, 3600);
    }
}
```

### 12.3 æ€§èƒ½ä¼˜åŒ–å®æˆ˜

#### 12.3.1 æ•°æ®åº“æŸ¥è¯¢ä¼˜åŒ–

```php
// ä¼˜åŒ–å‰ï¼šN+1æŸ¥è¯¢é—®é¢˜
$orders = Order::select();
foreach ($orders as $order) {
    $user = User::find($order->uid);  // æ¯æ¬¡å¾ªç¯éƒ½æŸ¥è¯¢æ•°æ®åº“
    $order->user_name = $user->nickname;
}

// ä¼˜åŒ–åï¼šä½¿ç”¨å…³è”é¢„åŠ è½½
$orders = Order::with(['user'])->select();
foreach ($orders as $order) {
    $order->user_name = $order->user->nickname;  // ä¸å†æŸ¥è¯¢æ•°æ®åº“
}

// ä¼˜åŒ–å¤æ‚ç»Ÿè®¡æŸ¥è¯¢
// åˆ›å»ºæ–‡ä»¶ï¼šapp/services/statistics/DashboardCache.php
<?php
namespace app\services\statistics;

use think\facade\Cache;
use think\facade\Db;

class DashboardCache
{
    /**
     * è·å–ä»ªè¡¨ç›˜æ•°æ®ï¼ˆå¸¦ç¼“å­˜ï¼‰
     */
    public function getDashboardData()
    {
        return Cache::remember('dashboard:stats', function() {
            return $this->calculateStats();
        }, 300);  // ç¼“å­˜5åˆ†é’Ÿ
    }
    
    /**
     * è®¡ç®—ç»Ÿè®¡æ•°æ®
     */
    protected function calculateStats()
    {
        $today = date('Y-m-d');
        $yesterday = date('Y-m-d', strtotime('-1 day'));
        
        // ä½¿ç”¨åŸç”ŸSQLä¼˜åŒ–å¤æ‚æŸ¥è¯¢
        $sql = "
            SELECT 
                COUNT(CASE WHEN DATE(FROM_UNIXTIME(add_time)) = ? THEN 1 END) as today_orders,
                COUNT(CASE WHEN DATE(FROM_UNIXTIME(add_time)) = ? THEN 1 END) as yesterday_orders,
                SUM(CASE WHEN DATE(FROM_UNIXTIME(add_time)) = ? THEN pay_price ELSE 0 END) as today_sales,
                SUM(CASE WHEN DATE(FROM_UNIXTIME(add_time)) = ? THEN pay_price ELSE 0 END) as yesterday_sales
            FROM eb_store_order
            WHERE paid = 1 
            AND is_del = 0
            AND DATE(FROM_UNIXTIME(add_time)) >= ?
        ";
        
        $result = Db::query($sql, [
            $today, $yesterday, $today, $yesterday, $yesterday
        ]);
        
        return $result[0];
    }
    
    /**
     * æ¸…é™¤ç¼“å­˜
     */
    public function clearCache()
    {
        Cache::delete('dashboard:stats');
    }
}
```

#### 12.3.2 æ¥å£å“åº”ä¼˜åŒ–

```php
// åˆ›å»ºæ–‡ä»¶ï¼šapp/services/optimize/ResponseOptimizer.php
<?php
namespace app\services\optimize;

class ResponseOptimizer
{
    /**
     * ä¼˜åŒ–å•†å“åˆ—è¡¨æ•°æ®
     */
    public function optimizeProductList($products)
    {
        // åªè¿”å›å¿…è¦å­—æ®µ
        $fields = ['id', 'store_name', 'image', 'price', 'sales', 'stock'];
        
        return $products->map(function($product) use ($fields) {
            $data = [];
            foreach ($fields as $field) {
                $data[$field] = $product[$field];
            }
            
            // å›¾ç‰‡ä½¿ç”¨CDN
            $data['image'] = $this->getCdnUrl($data['image']);
            
            return $data;
        });
    }
    
    /**
     * åˆ†é¡µæ•°æ®ä¼˜åŒ–
     */
    public function paginateOptimize($query, $page = 1, $limit = 10)
    {
        // ä¼˜åŒ–COUNTæŸ¥è¯¢
        $total = Cache::remember("pagination:total:{$query->buildSql()}", function() use ($query) {
            return $query->count();
        }, 60);
        
        // è·å–æ•°æ®
        $list = $query->page($page, $limit)->select();
        
        return [
            'list' => $list,
            'total' => $total,
            'page' => $page,
            'limit' => $limit,
            'pages' => ceil($total / $limit)
        ];
    }
    
    /**
     * CDNåœ°å€è½¬æ¢
     */
    protected function getCdnUrl($path)
    {
        if (empty($path)) {
            return '';
        }
        
        if (strpos($path, 'http') === 0) {
            return $path;
        }
        
        return config('filesystem.cdn_domain') . $path;
    }
}
```

### 12.4 æ•…éšœå¤„ç†æµç¨‹

#### 12.4.1 å»ºç«‹æ•…éšœå¤„ç†æœºåˆ¶

```php
// åˆ›å»ºæ–‡ä»¶ï¼šapp/services/alert/AlertService.php
<?php
namespace app\services\alert;

use think\facade\Log;

class AlertService
{
    protected $channels = [];
    
    public function __construct()
    {
        // åˆå§‹åŒ–å‘Šè­¦æ¸ é“
        $this->channels = [
            'sms' => new SmsAlertChannel(),
            'email' => new EmailAlertChannel(),
            'wechat' => new WechatAlertChannel(),
        ];
    }
    
    /**
     * å‘é€å‘Šè­¦
     */
    public function send($level, $message, $data = [])
    {
        // è®°å½•æ—¥å¿—
        Log::error("[ALERT] {$level}: {$message}", $data);
        
        // æ ¹æ®çº§åˆ«é€‰æ‹©é€šçŸ¥æ¸ é“
        $channels = $this->getChannelsByLevel($level);
        
        foreach ($channels as $channel) {
            try {
                $this->channels[$channel]->send($level, $message, $data);
            } catch (\Exception $e) {
                Log::error("å‘Šè­¦å‘é€å¤±è´¥: " . $e->getMessage());
            }
        }
    }
    
    /**
     * æ ¹æ®çº§åˆ«è·å–é€šçŸ¥æ¸ é“
     */
    protected function getChannelsByLevel($level)
    {
        $config = [
            'critical' => ['sms', 'email', 'wechat'],  // ä¸¥é‡ï¼šå…¨æ¸ é“é€šçŸ¥
            'error' => ['email', 'wechat'],            // é”™è¯¯ï¼šé‚®ä»¶å’Œå¾®ä¿¡
            'warning' => ['wechat'],                    // è­¦å‘Šï¼šä»…å¾®ä¿¡
            'info' => []                                // ä¿¡æ¯ï¼šä¸é€šçŸ¥
        ];
        
        return $config[$level] ?? [];
    }
}

// å‘Šè­¦ä½¿ç”¨ç¤ºä¾‹
class OrderService
{
    public function createOrder($data)
    {
        try {
            // åˆ›å»ºè®¢å•é€»è¾‘
            
        } catch (\Exception $e) {
            // å‘é€å‘Šè­¦
            app()->make(AlertService::class)->send('error', 'è®¢å•åˆ›å»ºå¤±è´¥', [
                'error' => $e->getMessage(),
                'user_id' => $data['user_id'] ?? 0,
                'data' => $data
            ]);
            
            throw $e;
        }
    }
}
```

#### 12.4.2 æ•…éšœè‡ªåŠ¨æ¢å¤

```php
// åˆ›å»ºæ–‡ä»¶ï¼šapp/command/HealthCheck.php
<?php
namespace app\command;

use think\console\Command;
use think\console\Input;
use think\console\Output;

class HealthCheck extends Command
{
    protected function configure()
    {
        $this->setName('health:check')
             ->setDescription('å¥åº·æ£€æŸ¥å’Œè‡ªåŠ¨æ¢å¤');
    }
    
    protected function execute(Input $input, Output $output)
    {
        $checks = [
            'database' => $this->checkDatabase(),
            'redis' => $this->checkRedis(),
            'queue' => $this->checkQueue(),
            'storage' => $this->checkStorage(),
        ];
        
        $hasError = false;
        foreach ($checks as $name => $result) {
            if (!$result['status']) {
                $hasError = true;
                $output->error("{$name}: {$result['message']}");
                
                // å°è¯•è‡ªåŠ¨æ¢å¤
                $this->tryRecover($name);
            } else {
                $output->info("{$name}: OK");
            }
        }
        
        return $hasError ? 1 : 0;
    }
    
    /**
     * æ£€æŸ¥æ•°æ®åº“
     */
    protected function checkDatabase()
    {
        try {
            \think\facade\Db::query("SELECT 1");
            return ['status' => true, 'message' => 'OK'];
        } catch (\Exception $e) {
            return ['status' => false, 'message' => $e->getMessage()];
        }
    }
    
    /**
     * æ£€æŸ¥Redis
     */
    protected function checkRedis()
    {
        try {
            $redis = \think\facade\Cache::store('redis')->handler();
            $redis->ping();
            return ['status' => true, 'message' => 'OK'];
        } catch (\Exception $e) {
            return ['status' => false, 'message' => $e->getMessage()];
        }
    }
    
    /**
     * å°è¯•æ¢å¤æœåŠ¡
     */
    protected function tryRecover($service)
    {
        switch ($service) {
            case 'redis':
                // é‡å¯Redis
                exec('systemctl restart redis', $output, $code);
                if ($code === 0) {
                    Log::info("RedisæœåŠ¡å·²è‡ªåŠ¨é‡å¯");
                }
                break;
                
            case 'queue':
                // é‡å¯é˜Ÿåˆ—
                exec('php think queue:restart', $output, $code);
                if ($code === 0) {
                    Log::info("é˜Ÿåˆ—æœåŠ¡å·²è‡ªåŠ¨é‡å¯");
                }
                break;
        }
    }
}
```

### 12.5 æ•°æ®åˆ†æä¸æŠ¥è¡¨

#### 12.5.1 ä¸šåŠ¡æ•°æ®åˆ†æ

```php
// åˆ›å»ºæ–‡ä»¶ï¼šapp/services/analysis/BusinessAnalysis.php
<?php
namespace app\services\analysis;

use think\facade\Db;

class BusinessAnalysis
{
    /**
     * ç”¨æˆ·è¡Œä¸ºåˆ†æ
     */
    public function userBehaviorAnalysis($startDate, $endDate)
    {
        // è®¿é—®è·¯å¾„åˆ†æ
        $pathAnalysis = Db::query("
            SELECT 
                path,
                COUNT(*) as pv,
                COUNT(DISTINCT user_id) as uv,
                AVG(duration) as avg_duration
            FROM eb_user_visit_log
            WHERE DATE(create_time) BETWEEN ? AND ?
            GROUP BY path
            ORDER BY pv DESC
            LIMIT 20
        ", [$startDate, $endDate]);
        
        // ç”¨æˆ·ç•™å­˜åˆ†æ
        $retentionAnalysis = $this->calculateRetention($startDate, $endDate);
        
        // è´­ä¹°è½¬åŒ–æ¼æ–—
        $conversionFunnel = $this->calculateConversionFunnel($startDate, $endDate);
        
        return compact('pathAnalysis', 'retentionAnalysis', 'conversionFunnel');
    }
    
    /**
     * è®¡ç®—ç”¨æˆ·ç•™å­˜
     */
    protected function calculateRetention($startDate, $endDate)
    {
        $sql = "
            SELECT 
                DATE(a.create_time) as cohort_date,
                COUNT(DISTINCT a.uid) as new_users,
                COUNT(DISTINCT b1.uid) as day_1,
                COUNT(DISTINCT b7.uid) as day_7,
                COUNT(DISTINCT b30.uid) as day_30
            FROM eb_user a
            LEFT JOIN eb_user_visit_log b1 ON a.uid = b1.user_id 
                AND DATE(b1.create_time) = DATE_ADD(DATE(a.create_time), INTERVAL 1 DAY)
            LEFT JOIN eb_user_visit_log b7 ON a.uid = b7.user_id 
                AND DATE(b7.create_time) = DATE_ADD(DATE(a.create_time), INTERVAL 7 DAY)
            LEFT JOIN eb_user_visit_log b30 ON a.uid = b30.user_id 
                AND DATE(b30.create_time) = DATE_ADD(DATE(a.create_time), INTERVAL 30 DAY)
            WHERE DATE(a.create_time) BETWEEN ? AND ?
            GROUP BY cohort_date
        ";
        
        $data = Db::query($sql, [$startDate, $endDate]);
        
        // è®¡ç®—ç•™å­˜ç‡
        foreach ($data as &$row) {
            $row['retention_1d'] = $row['new_users'] > 0 
                ? round($row['day_1'] / $row['new_users'] * 100, 2) : 0;
            $row['retention_7d'] = $row['new_users'] > 0 
                ? round($row['day_7'] / $row['new_users'] * 100, 2) : 0;
            $row['retention_30d'] = $row['new_users'] > 0 
                ? round($row['day_30'] / $row['new_users'] * 100, 2) : 0;
        }
        
        return $data;
    }
    
    /**
     * è®¡ç®—è½¬åŒ–æ¼æ–—
     */
    protected function calculateConversionFunnel($startDate, $endDate)
    {
        $timeRange = [
            strtotime($startDate),
            strtotime($endDate . ' 23:59:59')
        ];
        
        // å„é˜¶æ®µç”¨æˆ·æ•°
        $stages = [
            'visit' => Db::name('user_visit_log')
                ->whereTime('create_time', 'between', $timeRange)
                ->group('user_id')
                ->count(),
                
            'view_product' => Db::name('user_visit_log')
                ->whereTime('create_time', 'between', $timeRange)
                ->where('path', 'like', '%/goods/%')
                ->group('user_id')
                ->count(),
                
            'add_cart' => Db::name('store_cart')
                ->whereTime('add_time', 'between', $timeRange)
                ->group('uid')
                ->count(),
                
            'create_order' => Db::name('store_order')
                ->whereTime('add_time', 'between', $timeRange)
                ->group('uid')
                ->count(),
                
            'pay_order' => Db::name('store_order')
                ->whereTime('add_time', 'between', $timeRange)
                ->where('paid', 1)
                ->group('uid')
                ->count(),
        ];
        
        // è®¡ç®—è½¬åŒ–ç‡
        $funnel = [];
        $prevCount = 0;
        foreach ($stages as $stage => $count) {
            $funnel[] = [
                'stage' => $stage,
                'count' => $count,
                'rate' => $prevCount > 0 ? round($count / $prevCount * 100, 2) : 100
            ];
            $prevCount = $count;
        }
        # CRMEB 5.6.1 åº†äººåºœå•†åŸäºŒæ¬¡å¼€å‘å®Œå…¨æ•™ç¨‹

## ç›®å½•

- [å‰è¨€ï¼šå†™ç»™é›¶åŸºç¡€çš„ä½ ](#å‰è¨€å†™ç»™é›¶åŸºç¡€çš„ä½ )
- [ç¬¬ä¸€ç« ï¼šè®¤è¯†CRMEB - ä½ çš„å•†åŸå¼€å‘åˆ©å™¨](#ç¬¬ä¸€ç« è®¤è¯†crmeb---

## ç¬¬ä¹ç« ï¼šä¾›åº”å•†ç®¡ç†ç³»ç»Ÿå¼€å‘ - æ„å»ºä¾›åº”é“¾ç½‘ç»œ

### 9.1 ç†è§£ä¾›åº”å•†ç³»ç»Ÿ

ä¾›åº”å•†ç³»ç»Ÿå°±åƒä¸€ä¸ª**å•†åœºæ‹›å•†éƒ¨**ï¼š
- ğŸª **å…¥é©»ç®¡ç†**ï¼šå®¡æ ¸ä¾›åº”å•†èµ„è´¨ï¼Œåƒå®¡æ ¸å•†é“ºå…¥é©»
- ğŸ“¦ **å•†å“ç®¡ç†**ï¼šä¾›åº”å•†è‡ªä¸»ä¸Šæ¶å•†å“ï¼Œåƒå•†é“ºè¿›è´§
- ğŸ’° **ç»“ç®—ç®¡ç†**ï¼šè‡ªåŠ¨åˆ†è´¦ç»“ç®—ï¼Œåƒå•†åœºæ”¶ç§Ÿé‡‘

### 9.2 ä¾›åº”å•†å…¥é©»ç³»ç»Ÿ

#### 9.2.1 åˆ›å»ºä¾›åº”å•†æœåŠ¡

```php
// åˆ›å»ºæ–‡ä»¶ï¼šapp/services/supplier/SupplierServices.php
<?php
namespace app\services\supplier;

use app\services\BaseServices;
use app\dao\supplier\SupplierDao;
use think\facade\Db;

class SupplierServices extends BaseServices
{
    public function __construct(SupplierDao $dao)
    {
        $this->dao = $dao;
    }
    
    /**
     * ä¾›åº”å•†ç”³è¯·å…¥é©»
     * å°±åƒå•†æˆ·ç”³è¯·å…¥é©»å•†åœº
     */
    public function applySupplier($userId, $data)
    {
        // æ£€æŸ¥æ˜¯å¦å·²ç»æ˜¯ä¾›åº”å•†
        $exists = $this->dao->count(['user_id' => $userId]);
        if ($exists) {
            throw new \Exception('æ‚¨å·²ç»æ˜¯ä¾›åº”å•†äº†');
        }
        
        // éªŒè¯å¿…è¦ä¿¡æ¯
        if (empty($data['supplier_name']) || empty($data['contact_name']) || empty($data['contact_phone'])) {
            throw new \Exception('è¯·å¡«å†™å®Œæ•´ä¿¡æ¯');
        }
        
        // åˆ›å»ºä¾›åº”å•†ç”³è¯·
        $supplierData = [
            'user_id' => $userId,
            'supplier_name' => $data['supplier_name'],
            'contact_name' => $data['contact_name'],
            'contact_phone' => $data['contact_phone'],
            'business_license' => $data['business_license'] ?? '',
            'qualification_img' => $data['qualification_img'] ?? '',
            'bank_name' => $data['bank_name'] ?? '',
            'bank_account' => $data['bank_account'] ?? '',
            'bank_account_name' => $data['bank_account_name'] ?? '',
            'status' => 1,  // å¾…å®¡æ ¸
            'create_time' => time()
        ];
        
        $supplier = $this->dao->save($supplierData);
        
        // å‘é€é€šçŸ¥ç»™ç®¡ç†å‘˜
        $this->sendApplyNotice($supplier);
        
        return $supplier;
    }
    
    /**
     * å®¡æ ¸ä¾›åº”å•†
     * ç®¡ç†å‘˜å®¡æ ¸ä¾›åº”å•†å…¥é©»ç”³è¯·
     */
    public function auditSupplier($supplierId, $status, $reason = '')
    {
        $supplier = $this->dao->get($supplierId);
        if (!$supplier) {
            throw new \Exception('ä¾›åº”å•†ä¸å­˜åœ¨');
        }
        
        if ($supplier['status'] != 1) {
            throw new \Exception('è¯¥ç”³è¯·å·²å¤„ç†');
        }
        
        Db::startTrans();
        try {
            // æ›´æ–°çŠ¶æ€
            $updateData = [
                'status' => $status,  // 2:é€šè¿‡ 3:æ‹’ç»
                'audit_time' => time(),
                'audit_reason' => $reason
            ];
            
            if ($status == 2) {
                // é€šè¿‡å®¡æ ¸
                // 1. è®¾ç½®é»˜è®¤ä½£é‡‘æ¯”ä¾‹
                $updateData['commission_rate'] = 10;  // é»˜è®¤10%
                $updateData['settlement_cycle'] = 1;  // é»˜è®¤å‘¨ç»“
                
                // 2. åˆ›å»ºä¾›åº”å•†ä¸“å±è§’è‰²
                $this->createSupplierRole($supplier['user_id']);
                
                // 3. åˆå§‹åŒ–ä¾›åº”å•†é’±åŒ…
                $this->initSupplierWallet($supplierId);
            }
            
            $this->dao->update($supplierId, $updateData);
            
            // å‘é€å®¡æ ¸ç»“æœé€šçŸ¥
            $this->sendAuditNotice($supplier['user_id'], $status, $reason);
            
            Db::commit();
            
            return true;
        } catch (\Exception $e) {
            Db::rollback();
            throw $e;
        }
    }
    
    /**
     * åˆ›å»ºä¾›åº”å•†è§’è‰²
     * èµ‹äºˆä¾›åº”å•†åå°æƒé™
     */
    protected function createSupplierRole($userId)
    {
        // æ›´æ–°ç”¨æˆ·ç±»å‹
        app()->make(\app\services\user\UserServices::class)
            ->update(['uid' => $userId], ['user_type' => 'supplier']);
        
        // è¿™é‡Œå¯ä»¥é…ç½®ä¾›åº”å•†çš„èœå•æƒé™
        // å¦‚ï¼šå•†å“ç®¡ç†ã€è®¢å•ç®¡ç†ã€è´¢åŠ¡ç®¡ç†ç­‰
    }
    
    /**
     * åˆå§‹åŒ–ä¾›åº”å•†é’±åŒ…
     */
    protected function initSupplierWallet($supplierId)
    {
        app()->make(SupplierWalletServices::class)->initWallet($supplierId);
    }
    
    /**
     * è·å–ä¾›åº”å•†ä¿¡æ¯
     */
    public function getSupplierInfo($userId)
    {
        return $this->dao->getOne(['user_id' => $userId]);
    }
    
    /**
     * è·å–ä¾›åº”å•†åˆ—è¡¨
     */
    public function getSupplierList($where)
    {
        [$page, $limit] = $this->getPageValue();
        
        $query = $this->dao->getModel();
        
        // æœç´¢æ¡ä»¶
        if (!empty($where['keyword'])) {
            $query = $query->where('supplier_name|contact_name|contact_phone', 'like', "%{$where['keyword']}%");
        }
        
        if ($where['status'] !== '') {
            $query = $query->where('status', $where['status']);
        }
        
        $list = $query->page($page, $limit)->select();
        $count = $query->count();
        
        // ç»Ÿè®¡æ¯ä¸ªä¾›åº”å•†çš„æ•°æ®
        foreach ($list as &$item) {
            $item['product_count'] = app()->make(SupplierProductServices::class)
                ->dao->count(['supplier_id' => $item['id']]);
            
            $item['order_count'] = app()->make(\app\services\order\StoreOrderServices::class)
                ->dao->count(['supplier_id' => $item['id']]);
            
            // æ ¼å¼åŒ–æ—¶é—´
            $item['create_time_text'] = date('Y-m-d H:i', $item['create_time']);
        }
        
        return compact('list', 'count');
    }
}
```

#### 9.2.2 ä¾›åº”å•†å•†å“ç®¡ç†æœåŠ¡

```php
// åˆ›å»ºæ–‡ä»¶ï¼šapp/services/supplier/SupplierProductServices.php
<?php
namespace app\services\supplier;

use app\services\BaseServices;
use app\dao\supplier\SupplierProductDao;

class SupplierProductServices extends BaseServices
{
    public function __construct(SupplierProductDao $dao)
    {
        $this->dao = $dao;
    }
    
    /**
     * ä¾›åº”å•†æ·»åŠ å•†å“
     * å°±åƒå•†æˆ·åœ¨è‡ªå·±åº—é“ºä¸Šæ¶å•†å“
     */
    public function addProduct($supplierId, $data)
    {
        // æ£€æŸ¥å•†å“æ˜¯å¦å·²å­˜åœ¨
        $exists = $this->dao->count([
            'supplier_id' => $supplierId,
            'product_id' => $data['product_id']
        ]);
        
        if ($exists) {
            throw new \Exception('è¯¥å•†å“å·²æ·»åŠ ');
        }
        
        // è·å–å¹³å°å•†å“ä¿¡æ¯
        $productService = app()->make(\app\services\product\product\StoreProductServices::class);
        $product = $productService->get($data['product_id']);
        
        if (!$product || !$product['is_show']) {
            throw new \Exception('å•†å“ä¸å­˜åœ¨æˆ–å·²ä¸‹æ¶');
        }
        
        // éªŒè¯ä¾›è´§ä»·æ ¼
        if ($data['supplier_price'] >= $product['price']) {
            throw new \Exception('ä¾›è´§ä»·æ ¼ä¸èƒ½é«˜äºé”€å”®ä»·æ ¼');
        }
        
        // åˆ›å»ºä¾›åº”å•†å•†å“
        $supplierProduct = [
            'supplier_id' => $supplierId,
            'product_id' => $data['product_id'],
            'supplier_price' => $data['supplier_price'],
            'stock' => $data['stock'],
            'min_order' => $data['min_order'] ?? 1,
            'delivery_time' => $data['delivery_time'] ?? 3,  // é»˜è®¤3å¤©å‘è´§
            'status' => 1,  // å¾…å®¡æ ¸
            'create_time' => time()
        ];
        
        return $this->dao->save($supplierProduct);
    }
    
    /**
     * æ›´æ–°å•†å“åº“å­˜
     * ä¾›åº”å•†è¡¥è´§æˆ–è°ƒæ•´åº“å­˜
     */
    public function updateStock($supplierId, $productId, $stock, $type = 'set')
    {
        $supplierProduct = $this->dao->getOne([
            'supplier_id' => $supplierId,
            'product_id' => $productId
        ]);
        
        if (!$supplierProduct) {
            throw new \Exception('å•†å“ä¸å­˜åœ¨');
        }
        
        if ($type == 'set') {
            // è®¾ç½®åº“å­˜
            $newStock = $stock;
        } elseif ($type == 'inc') {
            // å¢åŠ åº“å­˜
            $newStock = $supplierProduct['stock'] + $stock;
        } else {
            // å‡å°‘åº“å­˜
            $newStock = max(0, $supplierProduct['stock'] - $stock);
        }
        
        $this->dao->update($supplierProduct['id'], [
            'stock' => $newStock,
            'update_time' => time()
        ]);
        
        // åŒæ­¥æ›´æ–°å¹³å°å•†å“åº“å­˜
        $this->syncPlatformStock($productId);
        
        return true;
    }
    
    /**
     * åŒæ­¥å¹³å°å•†å“åº“å­˜
     * æ‰€æœ‰ä¾›åº”å•†çš„åº“å­˜æ€»å’Œ
     */
    protected function syncPlatformStock($productId)
    {
        // è·å–æ‰€æœ‰ä¾›åº”å•†çš„è¯¥å•†å“åº“å­˜
        $totalStock = $this->dao->getModel()
            ->where('product_id', $productId)
            ->where('status', 2)  // å·²å®¡æ ¸
            ->sum('stock');
        
        // æ›´æ–°å¹³å°å•†å“åº“å­˜
        app()->make(\app\services\product\product\StoreProductServices::class)
            ->update($productId, ['stock' => $totalStock]);
    }
    
    /**
     * è®¢å•å•†å“åˆ†é…
     * å½“ç”¨æˆ·ä¸‹å•æ—¶ï¼Œåˆ†é…ç»™åˆé€‚çš„ä¾›åº”å•†
     */
    public function allocateOrderProduct($productId, $quantity)
    {
        // è·å–æœ‰åº“å­˜çš„ä¾›åº”å•†ï¼ŒæŒ‰ä»·æ ¼æ’åº
        $suppliers = $this->dao->getModel()
            ->where('product_id', $productId)
            ->where('status', 2)
            ->where('stock', '>=', $quantity)
            ->order('supplier_price asc')
            ->select();
        
        if ($suppliers->isEmpty()) {
            throw new \Exception('å•†å“åº“å­˜ä¸è¶³');
        }
        
        // é€‰æ‹©ä»·æ ¼æœ€ä½çš„ä¾›åº”å•†
        $supplier = $suppliers[0];
        
        // æ‰£å‡åº“å­˜
        $this->updateStock($supplier['supplier_id'], $productId, $quantity, 'dec');
        
        return [
            'supplier_id' => $supplier['supplier_id'],
            'supplier_price' => $supplier['supplier_price'],
            'supplier_product_id' => $supplier['id']
        ];
    }
}
```

### 9.3 ä¾›åº”å•†åå°å¼€å‘

#### 9.3.1 ä¾›åº”å•†æ§åˆ¶å™¨

```php
// åˆ›å»ºæ–‡ä»¶ï¼šapp/supplierapi/controller/v1/product/Product.php
<?php
namespace app\supplierapi\controller\v1\product;

use app\supplierapi\controller\AuthController;
use app\services\supplier\SupplierProductServices;

class Product extends AuthController
{
    /**
     * å•†å“åˆ—è¡¨
     */
    public function index()
    {
        $where = $this->request->getMore([
            ['keyword', ''],
            ['status', ''],
            ['page', 1],
            ['limit', 10]
        ]);
        
        $supplierInfo = $this->getSupplierInfo();
        $where['supplier_id'] = $supplierInfo['id'];
        
        $productService = app()->make(SupplierProductServices::class);
        $list = $productService->getList($where);
        
        return app('json')->success($list);
    }
    
    /**
     * æ·»åŠ å•†å“
     */
    public function save()
    {
        $data = $this->request->postMore([
            ['product_id', 0],
            ['supplier_price', 0],
            ['stock', 0],
            ['min_order', 1],
            ['delivery_time', 3]
        ]);
        
        $supplierInfo = $this->getSupplierInfo();
        
        $productService = app()->make(SupplierProductServices::class);
        $result = $productService->addProduct($supplierInfo['id'], $data);
        
        return app('json')->success('æ·»åŠ æˆåŠŸ');
    }
    
    /**
     * æ›´æ–°åº“å­˜
     */
    public function updateStock($id)
    {
        $stock = $this->request->post('stock', 0);
        $type = $this->request->post('type', 'set');
        
        $supplierInfo = $this->getSupplierInfo();
        
        $productService = app()->make(SupplierProductServices::class);
        
        // éªŒè¯å•†å“å½’å±
        $product = $productService->dao->get($id);
        if (!$product || $product['supplier_id'] != $supplierInfo['id']) {
            return app('json')->fail('å•†å“ä¸å­˜åœ¨');
        }
        
        $productService->updateStock($supplierInfo['id'], $product['product_id'], $stock, $type);
        
        return app('json')->success('æ›´æ–°æˆåŠŸ');
    }
    
    /**
     * è·å–å¯æ·»åŠ çš„å•†å“åˆ—è¡¨
     * å¹³å°å•†å“åº“ï¼Œä¾›åº”å•†é€‰æ‹©
     */
    public function platformProducts()
    {
        $keyword = $this->request->get('keyword', '');
        $supplierInfo = $this->getSupplierInfo();
        
        // è·å–å¹³å°å•†å“
        $productService = app()->make(\app\services\product\product\StoreProductServices::class);
        
        // è·å–å·²æ·»åŠ çš„å•†å“ID
        $addedProductIds = app()->make(SupplierProductServices::class)
            ->dao->getModel()
            ->where('supplier_id', $supplierInfo['id'])
            ->column('product_id');
        
        $where = [
            ['is_show', '=', 1],
            ['is_del', '=', 0]
        ];
        
        if ($keyword) {
            $where[] = ['store_name', 'like', "%{$keyword}%"];
        }
        
        if ($addedProductIds) {
            $where[] = ['id', 'not in', $addedProductIds];
        }
        
        $list = $productService->getList($where, ['id', 'store_name', 'image', 'price']);
        
        return app('json')->success($list);
    }
}
```

#### 9.3.2 ä¾›åº”å•†è®¢å•ç®¡ç†

```php
// åˆ›å»ºæ–‡ä»¶ï¼šapp/supplierapi/controller/v1/order/Order.php
<?php
namespace app\supplierapi\controller\v1\order;

use app\supplierapi\controller\AuthController;
use app\services\supplier\SupplierOrderServices;

class Order extends AuthController
{
    /**
     * è®¢å•åˆ—è¡¨
     */
    public function index()
    {
        $where = $this->request->getMore([
            ['order_id', ''],
            ['status', ''],
            ['date_range', []],
            ['page', 1],
            ['limit', 10]
        ]);
        
        $supplierInfo = $this->getSupplierInfo();
        $where['supplier_id'] = $supplierInfo['id'];
        
        $orderService = app()->make(SupplierOrderServices::class);
        $list = $orderService->getList($where);
        
        return app('json')->success($list);
    }
    
    /**
     * è®¢å•è¯¦æƒ…
     */
    public function detail($id)
    {
        $supplierInfo = $this->getSupplierInfo();
        
        $orderService = app()->make(SupplierOrderServices::class);
        $order = $orderService->getDetail($id, $supplierInfo['id']);
        
        if (!$order) {
            return app('json')->fail('è®¢å•ä¸å­˜åœ¨');
        }
        
        return app('json')->success($order);
    }
    
    /**
     * å‘è´§
     */
    public function ship($id)
    {
        $data = $this->request->postMore([
            ['express_company', ''],
            ['express_number', ''],
            ['remark', '']
        ]);
        
        if (empty($data['express_company']) || empty($data['express_number'])) {
            return app('json')->fail('è¯·å¡«å†™ç‰©æµä¿¡æ¯');
        }
        
        $supplierInfo = $this->getSupplierInfo();
        
        $orderService = app()->make(SupplierOrderServices::class);
        $result = $orderService->shipOrder($id, $supplierInfo['id'], $data);
        
        return app('json')->success('å‘è´§æˆåŠŸ');
    }
    
    /**
     * æ‰“å°è®¢å•
     */
    public function printOrder($id)
    {
        $supplierInfo = $this->getSupplierInfo();
        
        $orderService = app()->make(SupplierOrderServices::class);
        $order = $orderService->getDetail($id, $supplierInfo['id']);
        
        if (!$order) {
            return app('json')->fail('è®¢å•ä¸å­˜åœ¨');
        }
        
        // ç”Ÿæˆæ‰“å°æ•°æ®
        $printData = [
            'order_id' => $order['order_id'],
            'create_time' => date('Y-m-d H:i:s', $order['create_time']),
            'user_name' => $order['real_name'],
            'user_phone' => $order['user_phone'],
            'user_address' => $order['user_address'],
            'products' => $order['cart_info'],
            'total_num' => $order['total_num'],
            'pay_price' => $order['pay_price'],
            'mark' => $order['mark']
        ];
        
        return app('json')->success($printData);
    }
}
```

### 9.4 ä¾›åº”å•†è´¢åŠ¡ç®¡ç†

#### 9.4.1 ä¾›åº”å•†é’±åŒ…æœåŠ¡

```php
// åˆ›å»ºæ–‡ä»¶ï¼šapp/services/supplier/SupplierWalletServices.php
<?php
namespace app\services\supplier;

use app\services\BaseServices;
use app\dao\supplier\SupplierWalletDao;
use think\facade\Db;

class SupplierWalletServices extends BaseServices
{
    public function __construct(SupplierWalletDao $dao)
    {
        $this->dao = $dao;
    }
    
    /**
     * åˆå§‹åŒ–é’±åŒ…
     */
    public function initWallet($supplierId)
    {
        return $this->dao->save([
            'supplier_id' => $supplierId,
            'balance' => 0,
            'frozen_balance' => 0,
            'total_income' => 0,
            'total_withdraw' => 0,
            'create_time' => time()
        ]);
    }
    
    /**
     * è®¢å•ç»“ç®—
     * å½“è®¢å•å®Œæˆæ—¶ï¼Œç»™ä¾›åº”å•†ç»“ç®—è´§æ¬¾
     */
    public function orderSettlement($order, $supplierOrder)
    {
        Db::startTrans();
        try {
            // è®¡ç®—ç»“ç®—é‡‘é¢
            $settlementAmount = $this->calculateSettlement($order, $supplierOrder);
            
            // è·å–é’±åŒ…
            $wallet = $this->dao->getOne(['supplier_id' => $supplierOrder['supplier_id']]);
            
            // æ ¹æ®ç»“ç®—å‘¨æœŸå¤„ç†
            $supplier = app()->make(SupplierServices::class)->dao->get($supplierOrder['supplier_id']);
            
            if ($supplier['settlement_cycle'] == 1) {
                // å‘¨ç»“ï¼šå…ˆåˆ°å†»ç»“ä½™é¢
                $this->dao->inc($wallet['id'], 'frozen_balance', $settlementAmount);
            } else {
                // æœˆç»“ï¼šç›´æ¥åˆ°å¯ç”¨ä½™é¢
                $this->dao->inc($wallet['id'], 'balance', $settlementAmount);
                $this->dao->inc($wallet['id'], 'total_income', $settlementAmount);
            }
            
            // è®°å½•ç»“ç®—æ˜ç»†
            $this->recordSettlement([
                'supplier_id' => $supplierOrder['supplier_id'],
                'order_id' => $order['id'],
                'order_sn' => $order['order_id'],
                'product_amount' => $supplierOrder['supplier_price'] * $supplierOrder['quantity'],
                'commission_rate' => $supplier['commission_rate'],
                'commission_amount' => $settlementAmount * $supplier['commission_rate'] / 100,
                'settlement_amount' => $settlementAmount,
                'status' => $supplier['settlement_cycle'] == 1 ? 0 : 1,  // 0:å¾…ç»“ç®— 1:å·²ç»“ç®—
                'create_time' => time()
            ]);
            
            Db::commit();
            
            return true;
        } catch (\Exception $e) {
            Db::rollback();
            throw $e;
        }
    }
    
    /**
     * è®¡ç®—ç»“ç®—é‡‘é¢
     * ä¾›è´§ä»· - å¹³å°ä½£é‡‘
     */
    protected function calculateSettlement($order, $supplierOrder)
    {
        $supplier = app()->make(SupplierServices::class)->dao->get($supplierOrder['supplier_id']);
        
        // ä¾›è´§æ€»é¢
        $supplierAmount = $supplierOrder['supplier_price'] * $supplierOrder['quantity'];
        
        // æ‰£é™¤å¹³å°ä½£é‡‘
        $commissionAmount = $supplierAmount * $supplier['commission_rate'] / 100;
        
        return $supplierAmount - $commissionAmount;
    }
    
    /**
     * å‘¨ç»“ç®—
     * å®šæ—¶ä»»åŠ¡ï¼Œæ¯å‘¨ä¸€ç»“ç®—ä¸Šå‘¨çš„å†»ç»“é‡‘é¢
     */
    public function weeklySettlement()
    {
        // è·å–æ‰€æœ‰å‘¨ç»“çš„ä¾›åº”å•†
        $suppliers = app()->make(SupplierServices::class)->dao->getModel()
            ->where('settlement_cycle', 1)
            ->where('status', 2)
            ->select();
        
        foreach ($suppliers as $supplier) {
            $wallet = $this->dao->getOne(['supplier_id' => $supplier['id']]);
            
            if ($wallet['frozen_balance'] > 0) {
                // è½¬ç§»å†»ç»“ä½™é¢åˆ°å¯ç”¨ä½™é¢
                $this->dao->update($wallet['id'], [
                    'balance' => $wallet['balance'] + $wallet['frozen_balance'],
                    'total_income' => $wallet['total_income'] + $wallet['frozen_balance'],
                    'frozen_balance' => 0,
                    'update_time' => time()
                ]);
                
                // æ›´æ–°ç»“ç®—è®°å½•çŠ¶æ€
                app()->make(SupplierSettlementDao::class)->update(
                    [
                        'supplier_id' => $supplier['id'],
                        'status' => 0
                    ],
                    ['status' => 1, 'settlement_time' => time()]
                );
                
                // å‘é€ç»“ç®—é€šçŸ¥
                $this->sendSettlementNotice($supplier['id'], $wallet['frozen_balance']);
            }
        }
    }
    
    /**
     * æç°ç”³è¯·
     */
    public function withdraw($supplierId, $amount, $accountInfo)
    {
        $wallet = $this->dao->getOne(['supplier_id' => $supplierId]);
        
        if ($wallet['balance'] < $amount) {
            throw new \Exception('ä½™é¢ä¸è¶³');
        }
        
        if ($amount < 100) {
            throw new \Exception('æœ€ä½æç°é‡‘é¢ä¸º100å…ƒ');
        }
        
        Db::startTrans();
        try {
            // æ‰£å‡ä½™é¢
            $this->dao->dec($wallet['id'], 'balance', $amount);
            $this->dao->inc($wallet['id'], 'total_withdraw', $amount);
            
            // åˆ›å»ºæç°è®°å½•
            app()->make(SupplierWithdrawServices::class)->create([
                'supplier_id' => $supplierId,
                'amount' => $amount,
                'bank_name' => $accountInfo['bank_name'],
                'bank_account' => $accountInfo['bank_account'],
                'bank_account_name' => $accountInfo['bank_account_name'],
                'status' => 0,  // å¾…å®¡æ ¸
                'create_time' => time()
            ]);
            
            Db::commit();
            
            return true;
        } catch (\Exception $e) {
            Db::rollback();
            throw $e;
        }
    }
}
```

### 9.5 ä¾›åº”å•†ç«¯ç•Œé¢å¼€å‘

#### 9.5.1 ä¾›åº”å•†å…¥é©»ç”³è¯·é¡µé¢

```vue
<!-- åˆ›å»ºæ–‡ä»¶ï¼štemplate/uni-app/pages/supplier/apply.vue -->
<template>
  <view class="supplier-apply">
    <view class="apply-header">
      <image src="/static/images/supplier-banner.jpg" class="banner"></image>
      <view class="header-content">
        <view class="title">æˆä¸ºä¾›åº”å•†</view>
        <view class="desc">åŠ å…¥åº†äººåºœå•†åŸï¼Œå¼€å¯å†œäº§å“é”€å”®æ–°æ¸ é“</view>
      </view>
    </view>
    
    <!-- ç”³è¯·è¡¨å• -->
    <view class="apply-form">
      <view class="form-section">
        <view class="section-title">åŸºæœ¬ä¿¡æ¯</view>
        
        <view class="form-item">
          <view class="label required">ä¾›åº”å•†åç§°</view>
          <input v-model="form.supplier_name" 
                 placeholder="è¯·è¾“å…¥ä¾›åº”å•†åç§°"
                 maxlength="50" />
        </view>
        
        <view class="form-item">
          <view class="label required">è”ç³»äºº</view>
          <input v-model="form.contact_name" 
                 placeholder="è¯·è¾“å…¥è”ç³»äººå§“å"
                 maxlength="20" />
        </view>
        
        <view class="form-item">
          <view class="label required">è”ç³»ç”µè¯</view>
          <input v-model="form.contact_phone" 
                 placeholder="è¯·è¾“å…¥è”ç³»ç”µè¯"
                 type="number"
                 maxlength="11" />
        </view>
      </view>
      
      <view class="form-section">
        <view class="section-title">èµ„è´¨ä¿¡æ¯</view>
        
        <view class="form-item">
          <view class="label required">è¥ä¸šæ‰§ç…§</view>
          <view class="upload-area">
            <view class="upload-box" @click="uploadImage('business_license')">
              <image v-if="form.business_license" 
                     :src="form.business_license" 
                     mode="aspectFill"></image>
              <view v-else class="upload-placeholder">
                <text class="iconfont icon-camera"></text>
                <text>ä¸Šä¼ è¥ä¸šæ‰§ç…§</text>
              </view>
            </view>
          </view>
        </view>
        
        <view class="form-item">
          <view class="label">å…¶ä»–èµ„è´¨</view>
          <view class="upload-area">
            <view class="upload-list">
              <view class="upload-item" 
                    v-for="(img, index) in form.qualification_img" 
                    :key="index">
                <image :src="img" mode="aspectFill"></image>
                <view class="delete-btn" @click="deleteImage(index)">
                  <text class="iconfont icon-close"></text>
                </view>
              </view>
              <view class="upload-box" 
                    @click="uploadImage('qualification')"
                    v-if="form.qualification_img.length < 5">
                <view class="upload-placeholder">
                  <text class="iconfont icon-add"></text>
                  <text>æ·»åŠ èµ„è´¨</text>
                </view>
              </view>
            </view>
            <view class="upload-tips">æœ€å¤šä¸Šä¼ 5å¼ ï¼Œæ”¯æŒé£Ÿå“ç»è¥è®¸å¯è¯ç­‰</view>
          </view>
        </view>
      </view>
      
      <view class="form-section">
        <view class="section-title">ç»“ç®—ä¿¡æ¯</view>
        
        <view class="form-item">
          <view class="label required">å¼€æˆ·é“¶è¡Œ</view>
          <input v-model="form.bank_name" 
                 placeholder="è¯·è¾“å…¥å¼€æˆ·é“¶è¡Œ"
                 maxlength="50" />
        </view>
        
        <view class="form-item">
          <view class="label required">é“¶è¡Œè´¦å·</view>
          <input v-model="form.bank_account" 
                 placeholder="è¯·è¾“å…¥é“¶è¡Œè´¦å·"
                 type="number"
                 maxlength="30" />
        </view>
        
        <view class="form-item">
          <view class="label required">å¼€æˆ·å</view>
          <input v-model="form.bank_account_name" 
                 placeholder="è¯·è¾“å…¥å¼€æˆ·åï¼ˆéœ€ä¸è¥ä¸šæ‰§ç…§ä¸€è‡´ï¼‰"
                 maxlength="50" />
        </view>
      </view>
      
      <!-- åè®® -->
      <view class="agreement">
        <checkbox v-model="agreed" />
        <text>æˆ‘å·²é˜…è¯»å¹¶åŒæ„</text>
        <text class="link" @click="showAgreement">ã€Šä¾›åº”å•†å…¥é©»åè®®ã€‹</text>
      </view>
    </view>
    
    <!-- æäº¤æŒ‰é’® -->
    <view class="submit-section">
      <button class="submit-btn" @click="submitApply" :disabled="!canSubmit">
        æäº¤ç”³è¯·
      </button>
    </view>
  </view>
</template>

<script>
import { applySupplier } from '@/api/supplier.js'
import { uploadImage } from '@/api/common.js'

export default {
  data() {
    return {
      form: {
        supplier_name: '',
        contact_name: '',
        contact_phone: '',
        business_license: '',
        qualification_img: [],
        bank_name: '',
        bank_account: '',
        bank_account_name: ''
      },
      agreed: false
    }
  },
  
  computed: {
    canSubmit() {
      return this.form.supplier_name && 
             this.form.contact_name && 
             this.form.contact_phone &&
             this.form.business_license &&
             this.form.bank_name &&
             this.form.bank_account &&
             this.form.bank_account_name &&
             this.agreed
    }
  },
  
  methods: {
    // ä¸Šä¼ å›¾ç‰‡
    uploadImage(type) {
      uni.chooseImage({
        count: type === 'business_license' ? 1 : 5 - this.form.qualification_img.length,
        success: async (res) => {
          uni.showLoading({ title: 'ä¸Šä¼ ä¸­...' })
          
          try {
            for (let filePath of res.tempFilePaths) {
              const uploadRes = await uploadImage(filePath)
              
              if (type === 'business_license') {
                this.form.business_license = uploadRes.data.url
              } else {
                this.form.qualification_img.push(uploadRes.data.url)
              }
            }
            
            uni.hideLoading()
          } catch (error) {
            uni.hideLoading()
            uni.showToast({
              title: 'ä¸Šä¼ å¤±è´¥',
              icon: 'none'
            })
          }
        }
      })
    },
    
    // åˆ é™¤å›¾ç‰‡
    deleteImage(index) {
      this.form.qualification_img.splice(index, 1)
    },
    
    // æäº¤ç”³è¯·
    async submitApply() {
      if (!this.canSubmit) return
      
      // æ‰‹æœºå·éªŒè¯
      if (!/^1[3-9]\d{9}$/.test(this.form.contact_phone)) {
        uni.showToast({
          title: 'è¯·è¾“å…¥æ­£ç¡®çš„æ‰‹æœºå·',
          icon: 'none'
        })
        return
      }
      
      uni.showLoading({ title: 'æäº¤ä¸­...' })
      
      try {
        await applySupplier(this.form)
        
        uni.hideLoading()
        uni.showModal({
          title: 'ç”³è¯·æˆåŠŸ',
          content: 'æ‚¨çš„ç”³è¯·å·²æäº¤ï¼Œæˆ‘ä»¬ä¼šåœ¨1-3ä¸ªå·¥ä½œæ—¥å†…å®¡æ ¸',
          showCancel: false,
          success: () => {
            uni.navigateBack()
          }
        })
      } catch (error) {
        uni.hideLoading()
        uni.showToast({
          title: error.message || 'æäº¤å¤±è´¥',
          icon: 'none'
        })
      }
    },
    
    // æ˜¾ç¤ºåè®®
    showAgreement() {
      uni.navigateTo({
        url: '/pages/supplier/agreement'
      })
    }
  }
}
</script>

<style lang="scss">
.supplier-apply {
  background: #f5f5f5;
  min-height: 100vh;
  padding-bottom: 150rpx;
  
  .apply-header {
    position: relative;
    height: 400rpx;
    
    .banner {
      width: 100%;
      height: 100%;
    }
    
    .header-content {
      position: absolute;
      bottom: 40rpx;
      left: 40rpx;
      color: #fff;
      
      .title {
        font-size: 48rpx;
        font-weight: bold;
        margin-bottom: 10rpx;
      }
      
      .desc {
        font-size: 28rpx;
        opacity: 0.9;
      }
    }
  }
  
  .apply-form {
    padding: 0 30rpx;
    
    .form-section {
      background: #fff;
      border-radius: 20rpx;
      padding: 30rpx;
      margin-top: 20rpx;
      
      .section-title {
        font-size: 32rpx;
        font-weight: bold;
        margin-bottom: 30rpx;
        padding-left: 20rpx;
        border-left: 6rpx solid #ff6b6b;
      }
    }
    
    .form-item {
      margin-bottom: 30rpx;
      
      .label {
        font-size: 30rpx;
        margin-bottom: 20rpx;
        
        &.required::before {
          content: '*';
          color: #ff6b6b;
          margin-right: 8rpx;
        }
      }
      
      input {
        width: 100%;
        height: 88rpx;
        padding: 0 30rpx;
        border: 2rpx solid #e5e5e5;
        border-radius: 10rpx;
        font-size: 30rpx;
      }
    }
    
    .upload-area {
      .upload-box {
        width: 200rpx;
        height: 200rpx;
        border: 2rpx dashed #ddd;
        border-radius: 10rpx;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        
        image {
          width: 100%;
          height: 100%;
          border-radius: 10rpx;
        }
        
        .upload-placeholder {
          text-align: center;
          color: #999;
          
          .iconfont {
            font-size: 48rpx;
            display: block;
            margin-bottom: 10rpx;
          }
          
          text {
            font-size: 26rpx;
          }
        }
      }
      
      .upload-list {
        display: flex;
        flex-wrap: wrap;
        gap: 20rpx;
        
        .upload-item {
          position: relative;
          width: 200rpx;
          height: 200rpx;
          
          image {
            width: 100%;
            height: 100%;
            border-radius: 10rpx;
          }
          
          .delete-btn {
            position: absolute;
            top: -10rpx;
            right: -10rpx;
            width: 40rpx;
            height: 40rpx;
            background: #ff6b6b;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            
            .iconfont {
              color: #fff;
              font-size: 24rpx;
            }
          }
        }
      }
      
      .upload-tips {
        font-size: 24rpx;
        color: #999;
        margin-top: 20rpx;
      }
    }
    
    .agreement {
      display: flex;
      align-items: center;
      justify-content: center;
      margin-top: 40rpx;
      font-size: 28rpx;
      
      checkbox {
        margin-right: 10rpx;
      }
      
      .link {
        color: #576b95;
        text-decoration: underline;
      }
    }
  }
  
  .submit-section {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    padding: 30rpx;
    background: #fff;
    box-shadow: 0 -2rpx 10rpx rgba(0,0,0,0.05);
    
    .submit-btn {
      width: 100%;
      height: 88rpx;
      background: linear-gradient(45deg, #ff6b6b, #ff8e53);
      color: #fff;
      font-size: 32rpx;
      border-radius: 44rpx;
      
      &[disabled] {
        opacity: 0.5;
      }
    }
  }
}
</style>
```

### 9.6 æœ¬ç« ç»ƒä¹ 

1. **åŠŸèƒ½å®ç°**ï¼š
   - å®ç°ä¾›åº”å•†è¯„åˆ†ç³»ç»Ÿ
   - æ·»åŠ ä¾›åº”å•†å•†å“æ¨èåŠŸèƒ½
   - å®ç°å¤šä¾›åº”å•†æ¯”ä»·åŠŸèƒ½

2. **æ€è€ƒé¢˜**ï¼š
   - å¦‚ä½•å¹³è¡¡ä¾›åº”å•†ä¹‹é—´çš„è®¢å•åˆ†é…ï¼Ÿ
   - å¦‚ä½•å¤„ç†ä¾›åº”å•†å‘è´§å»¶è¿Ÿçš„é—®é¢˜ï¼Ÿ

3. **æ‰©å±•ä»»åŠ¡**ï¼š
   - å¼€å‘ä¾›åº”å•†æ•°æ®åˆ†ææŠ¥è¡¨
   - å®ç°æ™ºèƒ½è®¢å•åˆ†é…ç®—æ³•
   - æ·»åŠ ä¾›åº”å•†åŸ¹è®­ç®¡ç†ç³»ç»Ÿ

---ä½ çš„å•†åŸå¼€å‘åˆ©å™¨)
- [ç¬¬äºŒç« ï¼šæ­å»ºå¼€å‘ç¯å¢ƒ - æ‰“é€ ä½ çš„å·¥ä½œå°](#ç¬¬äºŒç« æ­å»ºå¼€å‘ç¯å¢ƒ---æ‰“é€ ä½ çš„å·¥ä½œå°)
- [ç¬¬ä¸‰ç« ï¼šCRMEBé¡¹ç›®ç»“æ„è¯¦è§£ - è®¤è¯†ä½ çš„æ–°å®¶](#ç¬¬ä¸‰ç« crmebé¡¹ç›®ç»“æ„è¯¦è§£---è®¤è¯†ä½ çš„æ–°å®¶)
- [ç¬¬å››ç« ï¼šæ•°æ®åº“è®¾è®¡ä¸æ‰©å±• - å•†åŸçš„è®°å¿†ä¸­å¿ƒ](#ç¬¬å››ç« æ•°æ®åº“è®¾è®¡ä¸æ‰©å±•---å•†åŸçš„è®°å¿†ä¸­å¿ƒ)
- [ç¬¬äº”ç« ï¼šåˆä¼™äººç®¡ç†ç³»ç»Ÿå¼€å‘ - æ‰“é€ ä½ çš„å•†ä¸šå¸å›½](#ç¬¬äº”ç« åˆä¼™äººç®¡ç†ç³»ç»Ÿå¼€å‘---æ‰“é€ ä½ çš„å•†ä¸šå¸å›½)
- [ç¬¬å…­ç« ï¼šç¤¼å“å¡ç³»ç»Ÿå¼€å‘ - åˆ›é€ è™šæ‹Ÿä»·å€¼](#ç¬¬å…­ç« ç¤¼å“å¡ç³»ç»Ÿå¼€å‘---åˆ›é€ è™šæ‹Ÿä»·å€¼)
- [ç¬¬ä¸ƒç« ï¼šå…ˆç”¨åä»˜ç³»ç»Ÿå¼€å‘ - å»ºç«‹ä¿¡ä»»ç»æµ](#ç¬¬ä¸ƒç« å…ˆç”¨åä»˜ç³»ç»Ÿå¼€å‘---å»ºç«‹ä¿¡ä»»ç»æµ)
- [ç¬¬å…«ç« ï¼šåˆ›æ–°åˆ†é”€ç³»ç»Ÿå¼€å‘ - è®©ç”¨æˆ·å¸®ä½ å–è´§](#ç¬¬å…«ç« åˆ›æ–°åˆ†é”€ç³»ç»Ÿå¼€å‘---è®©ç”¨æˆ·å¸®ä½ å–è´§)
- [ç¬¬ä¹ç« ï¼šä¾›åº”å•†ç®¡ç†ç³»ç»Ÿå¼€å‘ - æ„å»ºä¾›åº”é“¾ç½‘ç»œ](#ç¬¬ä¹ç« ä¾›åº”å•†ç®¡ç†ç³»ç»Ÿå¼€å‘---æ„å»ºä¾›åº”é“¾ç½‘ç»œ)
- [ç¬¬åç« ï¼šå‰ç«¯ç•Œé¢å¼€å‘ - è®©å•†åŸæ›´ç¾è§‚](#ç¬¬åç« å‰ç«¯ç•Œé¢å¼€å‘---è®©å•†åŸæ›´ç¾è§‚)
- [ç¬¬åä¸€ç« ï¼šç³»ç»Ÿéƒ¨ç½²ä¸ä¸Šçº¿ - è®©å•†åŸæ´»èµ·æ¥](#ç¬¬åä¸€ç« ç³»ç»Ÿéƒ¨ç½²ä¸ä¸Šçº¿---è®©å•†åŸæ´»èµ·æ¥)
- [ç¬¬åäºŒç« ï¼šè¿ç»´ä¸ä¼˜åŒ– - è®©å•†åŸç¨³å®šè¿è¡Œ](#ç¬¬åäºŒç« è¿ç»´ä¸ä¼˜åŒ–---è®©å•†åŸç¨³å®šè¿è¡Œ)

---

## å‰è¨€ï¼šå†™ç»™é›¶åŸºç¡€çš„ä½ 

### ä¸ºä»€ä¹ˆé€‰æ‹©è¿™æœ¬æ•™ç¨‹ï¼Ÿ

æƒ³è±¡ä¸€ä¸‹ï¼Œä½ æƒ³å¼€ä¸€å®¶ç½‘ä¸Šå•†åŸï¼Œå°±åƒåœ¨ç½‘ä¸Šå¼€äº†ä¸€å®¶24å°æ—¶è¥ä¸šçš„è¶…å¸‚ã€‚ä½†æ˜¯ä»é›¶å¼€å§‹å»ºè®¾è¿™æ ·ä¸€ä¸ªå•†åŸï¼Œå°±åƒè¦ä½ ä»é›¶å¼€å§‹ç›–ä¸€åº§å¤§æ¥¼ä¸€æ ·å›°éš¾ã€‚

CRMEBå°±åƒæ˜¯ä¸€åº§å·²ç»å»ºå¥½ä¸»ä½“ç»“æ„çš„å¤§æ¥¼ï¼Œæœ‰æˆ¿é—´ï¼ˆåŠŸèƒ½æ¨¡å—ï¼‰ã€æœ‰ç”µæ¢¯ï¼ˆæ•°æ®æµè½¬ï¼‰ã€æœ‰ç®¡é“ï¼ˆæ¥å£é€šé“ï¼‰ï¼Œä½ åªéœ€è¦æŒ‰ç…§è‡ªå·±çš„éœ€æ±‚è¿›è¡Œè£…ä¿®ï¼ˆäºŒæ¬¡å¼€å‘ï¼‰å°±å¯ä»¥äº†ã€‚

### ä½ å°†å­¦åˆ°ä»€ä¹ˆï¼Ÿ

é€šè¿‡è¿™æœ¬æ•™ç¨‹ï¼Œä½ å°†å­¦ä¼šï¼š
- ğŸ—ï¸ **ç†è§£å•†åŸçš„"å»ºç­‘ç»“æ„"**ï¼šçŸ¥é“æ¯ä¸ªæ–‡ä»¶å¤¹ã€æ¯ä¸ªæ–‡ä»¶çš„ä½œç”¨
- ğŸ”§ **æŒæ¡"è£…ä¿®æŠ€èƒ½"**ï¼šå­¦ä¼šä¿®æ”¹å’Œæ·»åŠ æ–°åŠŸèƒ½
- ğŸ’¡ **å®ç°åˆ›æ–°åŠŸèƒ½**ï¼šåˆä¼™äººåˆ¶åº¦ã€ç¤¼å“å¡ã€ä¿¡ç”¨æ”¯ä»˜ç­‰
- ğŸš€ **éƒ¨ç½²ä¸Šçº¿æŠ€èƒ½**ï¼šè®©ä½ çš„å•†åŸåœ¨äº’è”ç½‘ä¸Šè¿è¡Œ

### å­¦ä¹ å»ºè®®

1. **æŒ‰é¡ºåºå­¦ä¹ **ï¼šæ¯ç« éƒ½å»ºç«‹åœ¨å‰ä¸€ç« çš„åŸºç¡€ä¸Š
2. **åŠ¨æ‰‹å®è·µ**ï¼šçœ‹åˆ°ä»£ç å°±å»è¯•è¯•ï¼Œé”™äº†ä¹Ÿæ²¡å…³ç³»
3. **åšå¥½ç¬”è®°**ï¼šè®°å½•ä½ çš„ç†è§£å’Œé‡åˆ°çš„é—®é¢˜
4. **ä¿æŒè€å¿ƒ**ï¼šç½—é©¬ä¸æ˜¯ä¸€å¤©å»ºæˆçš„ï¼Œå•†åŸä¹Ÿæ˜¯

---

## ç¬¬ä¸€ç« ï¼šè®¤è¯†CRMEB - ä½ çš„å•†åŸå¼€å‘åˆ©å™¨

### 1.1 ä»€ä¹ˆæ˜¯CRMEBï¼Ÿ

æŠŠCRMEBæƒ³è±¡æˆä¸€ä¸ª**å•†åŸæ¨¡æ¿å·¥å…·åŒ…**ï¼Œå°±åƒï¼š
- **å®œå®¶çš„å®¶å…·**ï¼šåŸºç¡€æ¡†æ¶å·²ç»æœ‰äº†ï¼Œä½ æ¥ç»„è£…å’Œå®šåˆ¶
- **ä¹é«˜ç§¯æœ¨**ï¼šå„ç§åŠŸèƒ½æ¨¡å—å¯ä»¥è‡ªç”±ç»„åˆ
- **æ¯›å¯æˆ¿**ï¼šä¸»ä½“ç»“æ„å®Œæ•´ï¼Œç­‰ä½ æ¥è£…ä¿®

CRMEB = **C**ommerceï¼ˆå•†ä¸šï¼‰ + **RM**ï¼ˆå®¢æˆ·å…³ç³»ç®¡ç†ï¼‰ + **EB**ï¼ˆç”µå­å•†åŠ¡ï¼‰

### 1.2 CRMEBçš„æŠ€æœ¯æ ˆï¼ˆå·¥å…·ç®±ï¼‰

æƒ³è±¡ä½ è¦ä¿®ç†ä¸€è¾†æ±½è½¦ï¼Œéœ€è¦ä¸åŒçš„å·¥å…·ï¼š

| å·¥å…·ç±»æ¯” | æŠ€æœ¯åç§° | ä½œç”¨è¯´æ˜ |
|---------|---------|---------|
| ğŸ”¨ é”¤å­ | PHP | åç«¯ä¸»è¦ç¼–ç¨‹è¯­è¨€ï¼Œå¤„ç†ä¸šåŠ¡é€»è¾‘ |
| ğŸ”§ æ‰³æ‰‹ | ThinkPHP 6.0 | PHPæ¡†æ¶ï¼Œæä¾›å¿«é€Ÿå¼€å‘èƒ½åŠ› |
| ğŸ¨ ç”»ç¬” | Vue.js | å‰ç«¯æ¡†æ¶ï¼Œè®©ç•Œé¢åŠ¨èµ·æ¥ |
| ğŸ“± æ‰‹æœºå£³æ¨¡å…· | UniApp | å¼€å‘å°ç¨‹åºçš„æ¡†æ¶ |
| ğŸ’¾ ä»“åº“ | MySQL | å­˜å‚¨æ‰€æœ‰æ•°æ®çš„æ•°æ®åº“ |
| âš¡ åŠ é€Ÿå™¨ | Redis | ç¼“å­˜ç³»ç»Ÿï¼Œè®©ç½‘ç«™æ›´å¿« |

### 1.3 åº†äººåºœå•†åŸçš„ç‰¹è‰²åŠŸèƒ½

æˆ‘ä»¬è¦åœ¨CRMEBçš„åŸºç¡€ä¸Šæ·»åŠ ä»¥ä¸‹"ç‰¹è‰²è£…ä¿®"ï¼š

1. **ğŸ¤ åˆä¼™äººç³»ç»Ÿ**
   - åƒä¼šå‘˜å¡ä¸€æ ·ï¼Œä½†æ›´é«˜çº§
   - åˆ†ä¸ºæ¢¦æƒ³ã€æˆ˜ç•¥ã€åŸå¸‚ä¸‰ä¸ªç­‰çº§
   - æ¯ä¸ªç­‰çº§éƒ½æœ‰ä¸åŒçš„ä¼˜æƒ å’Œæƒç›Š

2. **ğŸ ç¤¼å“å¡ç³»ç»Ÿ**
   - åƒå•†åœºçš„è´­ç‰©å¡
   - å¯ä»¥é€äººï¼Œä¹Ÿå¯ä»¥è‡ªå·±ç”¨

3. **ğŸ’³ å…ˆç”¨åä»˜**
   - åƒä¿¡ç”¨å¡ä¸€æ ·ï¼Œå…ˆæ‹¿è´§åä»˜æ¬¾
   - åªæœ‰åˆä¼™äººæ‰èƒ½äº«å—

4. **ğŸ”„ åˆ›æ–°åˆ†é”€**
   - æ–°ç”¨æˆ·åˆ†äº«æˆåŠŸï¼Œè¿”è¿˜å…¨éƒ¨é‡‘é¢
   - è€ç”¨æˆ·åˆ†äº«æˆåŠŸï¼Œé€åŒæ ·å•†å“çš„ç¤¼å“å¡

5. **ğŸ­ ä¾›åº”å•†ç®¡ç†**
   - è®©å…¶ä»–å•†å®¶ä¹Ÿèƒ½åœ¨ä½ çš„å¹³å°å–è´§

### 1.4 æœ¬ç« ç»ƒä¹ 

1. **æ€è€ƒé¢˜**ï¼šå¦‚æœCRMEBæ˜¯ä¸€åº§æˆ¿å­ï¼Œé‚£ä¹ˆï¼š
   - PHPæ˜¯ä»€ä¹ˆï¼Ÿï¼ˆæç¤ºï¼šå»ºç­‘ææ–™ï¼‰
   - MySQLæ˜¯ä»€ä¹ˆï¼Ÿï¼ˆæç¤ºï¼šå‚¨ç‰©é—´ï¼‰
   - Vue.jsæ˜¯ä»€ä¹ˆï¼Ÿï¼ˆæç¤ºï¼šè£…é¥°ï¼‰

2. **å®è·µé¢˜**ï¼š
   - åœ¨çº¸ä¸Šç”»å‡ºä½ ç†è§£çš„å•†åŸç»“æ„å›¾
   - åˆ—å‡ºä½ æœ€æƒ³å®ç°çš„3ä¸ªåŠŸèƒ½

---

## ç¬¬äºŒç« ï¼šæ­å»ºå¼€å‘ç¯å¢ƒ - æ‰“é€ ä½ çš„å·¥ä½œå°

### 2.1 ç†è§£å¼€å‘ç¯å¢ƒ

å¼€å‘ç¯å¢ƒå°±åƒå¨æˆ¿ï¼Œä½ éœ€è¦å‡†å¤‡å¥½æ‰€æœ‰çš„"å¨å…·"æ‰èƒ½å¼€å§‹"çƒ¹é¥ª"ï¼ˆç¼–ç¨‹ï¼‰ã€‚

**éœ€è¦å‡†å¤‡çš„"å¨å…·"æ¸…å•**ï¼š
- ğŸ–¥ï¸ **ä»£ç ç¼–è¾‘å™¨**ï¼ˆèœåˆ€ï¼‰ï¼šç”¨æ¥å†™ä»£ç 
- ğŸŒ **WebæœåŠ¡å™¨**ï¼ˆç‚‰ç¶ï¼‰ï¼šè®©ç½‘ç«™è¿è¡Œèµ·æ¥
- ğŸ’¾ **æ•°æ®åº“**ï¼ˆå†°ç®±ï¼‰ï¼šå­˜å‚¨æ•°æ®
- ğŸ”§ **PHPç¯å¢ƒ**ï¼ˆè°ƒæ–™ï¼‰ï¼šè¿è¡ŒPHPä»£ç 

### 2.2 åœ¨é˜¿é‡Œäº‘æœåŠ¡å™¨ä¸Šæ­å»ºç¯å¢ƒ

æ—¢ç„¶ä½ å·²ç»æœ‰äº†é˜¿é‡Œäº‘CentOS 8æœåŠ¡å™¨ï¼Œæˆ‘ä»¬å°±åƒåœ¨ä¸€ä¸ªç©ºæˆ¿é—´é‡Œå¸ƒç½®å¨æˆ¿ã€‚

#### æ­¥éª¤1ï¼šè¿æ¥åˆ°æœåŠ¡å™¨

```bash
# åœ¨ä½ çš„ç”µè„‘ä¸Šæ‰“å¼€ç»ˆç«¯ï¼ˆWindowsç”¨æˆ·ä½¿ç”¨PowerShellï¼‰
# ç”¨ä½ çš„æœåŠ¡å™¨IPæ›¿æ¢ä¸‹é¢çš„ your-server-ip
ssh root@your-server-ip

# è¾“å…¥å¯†ç åï¼Œä½ å°±"èµ°è¿›"äº†æœåŠ¡å™¨è¿™ä¸ªæˆ¿é—´
```

ğŸ’¡ **å°è´´å£«**ï¼šSSHå°±åƒä¸€æŠŠé’¥åŒ™ï¼Œè®©ä½ èƒ½è¿œç¨‹è¿›å…¥æœåŠ¡å™¨ã€‚

#### æ­¥éª¤2ï¼šå®‰è£…å®å¡”é¢æ¿ï¼ˆä¸€é”®å®‰è£…æ‰€æœ‰å·¥å…·ï¼‰

å®å¡”é¢æ¿å°±åƒæ˜¯ä¸€ä¸ª**æ™ºèƒ½å¨æˆ¿ç®¡ç†ç³»ç»Ÿ**ï¼Œå¸®ä½ ä¸€é”®å®‰è£…å’Œç®¡ç†æ‰€æœ‰å·¥å…·ã€‚

```bash
# å®‰è£…å®å¡”é¢æ¿
yum install -y wget && wget -O install.sh http://download.bt.cn/install/install_6.0.sh && sh install.sh
```

å®‰è£…å®Œæˆåï¼Œä¼šæ˜¾ç¤ºï¼š
- é¢æ¿åœ°å€ï¼šhttp://ä½ çš„IP:8888
- ç”¨æˆ·åï¼šadmin
- å¯†ç ï¼šéšæœºç”Ÿæˆçš„

**è®°ä½è¿™äº›ä¿¡æ¯ï¼** å°±åƒè®°ä½ä½ å®¶çš„é’¥åŒ™å’Œå¯†ç ã€‚

#### æ­¥éª¤3ï¼šåœ¨å®å¡”é¢æ¿ä¸­å®‰è£…ç¯å¢ƒ

1. åœ¨æµè§ˆå™¨æ‰“å¼€å®å¡”é¢æ¿åœ°å€
2. ç™»å½•åï¼Œä¼šå¼¹å‡º"æ¨èå®‰è£…"çª—å£
3. é€‰æ‹©**LNMP**ç¯å¢ƒï¼š
   - **Nginx 1.20**ï¼ˆç½‘ç«™æœåŠ¡å™¨ï¼‰
   - **MySQL 5.7**ï¼ˆæ•°æ®åº“ï¼‰
   - **PHP 7.4**ï¼ˆPHPç¯å¢ƒï¼‰
   - **phpMyAdmin**ï¼ˆæ•°æ®åº“ç®¡ç†å·¥å…·ï¼‰

4. ç‚¹å‡»"ä¸€é”®å®‰è£…"ï¼Œç­‰å¾…çº¦10-20åˆ†é’Ÿ

### 2.3 é…ç½®PHPç¯å¢ƒ

å®‰è£…å®Œæˆåï¼Œéœ€è¦ç»™PHPå®‰è£…ä¸€äº›"æ’ä»¶"ï¼ˆæ‰©å±•ï¼‰ï¼š

1. åœ¨å®å¡”é¢æ¿ä¸­ï¼Œç‚¹å‡»"è½¯ä»¶å•†åº—"
2. æ‰¾åˆ°PHP 7.4ï¼Œç‚¹å‡»"è®¾ç½®"
3. ç‚¹å‡»"å®‰è£…æ‰©å±•"ï¼Œå®‰è£…ä»¥ä¸‹æ‰©å±•ï¼š
   - **fileinfo**ï¼ˆæ–‡ä»¶å¤„ç†ï¼‰
   - **redis**ï¼ˆç¼“å­˜æ”¯æŒï¼‰
   - **swoole**ï¼ˆæ€§èƒ½æå‡ï¼‰

### 2.4 ä¸Šä¼ CRMEBä»£ç 

#### æ–¹æ³•1ï¼šä½¿ç”¨å®å¡”é¢æ¿ä¸Šä¼ ï¼ˆæ¨èæ–°æ‰‹ï¼‰

1. åœ¨å®å¡”é¢æ¿ç‚¹å‡»"æ–‡ä»¶"
2. è¿›å…¥ `/www/wwwroot/` ç›®å½•
3. ç‚¹å‡»"ä¸Šä¼ "ï¼Œé€‰æ‹©ä½ çš„CRMEB-5.6.1.zipæ–‡ä»¶
4. ä¸Šä¼ å®Œæˆåï¼Œå³é”®è§£å‹

#### æ–¹æ³•2ï¼šä½¿ç”¨Gitï¼ˆæ¨èå­¦ä¹ ï¼‰

```bash
# è¿›å…¥ç½‘ç«™ç›®å½•
cd /www/wwwroot/

# å¦‚æœæ˜¯ä»GitHubå…‹éš†ï¼ˆå‡è®¾ä½ å·²ä¸Šä¼ åˆ°GitHubï¼‰
git clone https://github.com/ä½ çš„ç”¨æˆ·å/CRMEB-5.6.1.git qingrenfu

# æˆ–è€…ç›´æ¥ä¸Šä¼ åè§£å‹
unzip CRMEB-5.6.1.zip
mv CRMEB-5.6.1 qingrenfu
```

### 2.5 åˆ›å»ºç½‘ç«™å’Œæ•°æ®åº“

#### åˆ›å»ºç½‘ç«™

1. åœ¨å®å¡”é¢æ¿ç‚¹å‡»"ç½‘ç«™" â†’ "æ·»åŠ ç«™ç‚¹"
2. å¡«å†™ä¿¡æ¯ï¼š
   - åŸŸåï¼šä½ çš„åŸŸåï¼ˆå¦‚ï¼šshop.qingrenfu.comï¼‰
   - æ ¹ç›®å½•ï¼š/www/wwwroot/qingrenfu/crmeb/public
   - PHPç‰ˆæœ¬ï¼šPHP-74
   - åˆ›å»ºæ•°æ®åº“ï¼šå‹¾é€‰

#### é…ç½®ä¼ªé™æ€

1. ç‚¹å‡»ç½‘ç«™çš„"è®¾ç½®"
2. é€‰æ‹©"ä¼ªé™æ€"
3. é€‰æ‹©"thinkphp"è§„åˆ™
4. ä¿å­˜

### 2.6 å®‰è£…CRMEB

1. åœ¨æµè§ˆå™¨è®¿é—®ï¼šhttp://ä½ çš„åŸŸå/install
2. æŒ‰ç…§å®‰è£…å‘å¯¼æ“ä½œï¼š
   - æ£€æŸ¥ç¯å¢ƒï¼ˆå…¨éƒ¨é€šè¿‡æ‰èƒ½ç»§ç»­ï¼‰
   - å¡«å†™æ•°æ®åº“ä¿¡æ¯ï¼ˆå®å¡”åˆ›å»ºæ—¶çš„ä¿¡æ¯ï¼‰
   - è®¾ç½®ç®¡ç†å‘˜è´¦å·å¯†ç 
   - å®Œæˆå®‰è£…

### 2.7 é…ç½®SSLè¯ä¹¦ï¼ˆè®©ç½‘ç«™æ›´å®‰å…¨ï¼‰

1. åœ¨å®å¡”é¢æ¿ï¼Œç‚¹å‡»ç½‘ç«™"è®¾ç½®"
2. é€‰æ‹©"SSL" â†’ "Let's Encrypt"
3. å‹¾é€‰åŸŸåï¼Œç‚¹å‡»"ç”³è¯·"
4. ç”³è¯·æˆåŠŸåï¼Œå¼€å¯"å¼ºåˆ¶HTTPS"

### 2.8 æœ¬ç« ç»ƒä¹ 

1. **åŠ¨æ‰‹å®è·µ**ï¼š
   - æˆåŠŸå®‰è£…å®å¡”é¢æ¿
   - åˆ›å»ºä¸€ä¸ªæµ‹è¯•ç½‘ç«™
   - è®¿é—®CRMEBåå°ï¼ˆhttp://ä½ çš„åŸŸå/adminï¼‰

2. **æ€è€ƒé¢˜**ï¼š
   - ä¸ºä»€ä¹ˆéœ€è¦SSLè¯ä¹¦ï¼Ÿï¼ˆæç¤ºï¼šæƒ³æƒ³é“¶è¡Œç½‘ç«™ï¼‰
   - PHPæ‰©å±•åƒä»€ä¹ˆï¼Ÿï¼ˆæç¤ºï¼šæ‰‹æœºAPPï¼‰

---

## ç¬¬ä¸‰ç« ï¼šCRMEBé¡¹ç›®ç»“æ„è¯¦è§£ - è®¤è¯†ä½ çš„æ–°å®¶

### 3.1 æ•´ä½“ç»“æ„ - å•†åŸçš„"å»ºç­‘å›¾çº¸"

æƒ³è±¡CRMEBé¡¹ç›®å°±åƒä¸€åº§å¤§æ¥¼ï¼Œæ¯ä¸ªæ–‡ä»¶å¤¹éƒ½æ˜¯ä¸åŒçš„æ¥¼å±‚æˆ–æˆ¿é—´ï¼š

```
CRMEB-5.6.1/                    ğŸ¢ æ•´åº§å¤§æ¥¼
â”œâ”€â”€ crmeb/                      ğŸ—ï¸ ä¸»å»ºç­‘ï¼ˆæ ¸å¿ƒä»£ç ï¼‰
â”‚   â”œâ”€â”€ app/                    ğŸ¢ ä¸šåŠ¡åŠå…¬åŒº
â”‚   â”‚   â”œâ”€â”€ adminapi/          ğŸ‘” æ€»ç»ç†åŠå…¬å®¤ï¼ˆåå°ç®¡ç†APIï¼‰
â”‚   â”‚   â”œâ”€â”€ api/               ğŸ›ï¸ å®¢æˆ·æœåŠ¡å¤§å…ï¼ˆå‰ç«¯APIï¼‰
â”‚   â”‚   â”œâ”€â”€ dao/               ğŸ—„ï¸ æ¡£æ¡ˆå®¤ï¼ˆæ•°æ®è®¿é—®ï¼‰
â”‚   â”‚   â”œâ”€â”€ jobs/              â° ä»»åŠ¡è°ƒåº¦å®¤ï¼ˆå®šæ—¶ä»»åŠ¡ï¼‰
â”‚   â”‚   â”œâ”€â”€ listener/          ğŸ‘‚ ç›‘æ§å®¤ï¼ˆäº‹ä»¶ç›‘å¬ï¼‰
â”‚   â”‚   â”œâ”€â”€ model/             ğŸ“Š æ•°æ®æ¨¡å‹å®¤ï¼ˆæ•°æ®ç»“æ„ï¼‰
â”‚   â”‚   â””â”€â”€ services/          ğŸ”§ æœåŠ¡éƒ¨é—¨ï¼ˆä¸šåŠ¡é€»è¾‘ï¼‰
â”‚   â”œâ”€â”€ config/                ğŸ“‹ é…ç½®ä¸­å¿ƒï¼ˆå„ç§è®¾ç½®ï¼‰
â”‚   â”œâ”€â”€ public/                ğŸšª å¤§é—¨ï¼ˆå…¥å£æ–‡ä»¶ï¼‰
â”‚   â””â”€â”€ route/                 ğŸ—ºï¸ è·¯çº¿å›¾ï¼ˆè·¯ç”±é…ç½®ï¼‰
â”œâ”€â”€ template/                  ğŸ¨ è®¾è®¡éƒ¨
â”‚   â”œâ”€â”€ admin/                 ğŸ–¥ï¸ åå°ç•Œé¢è®¾è®¡
â”‚   â””â”€â”€ uni-app/               ğŸ“± æ‰‹æœºç«¯è®¾è®¡
â””â”€â”€ docker-compose/            ğŸ³ å¿«é€Ÿéƒ¨ç½²å·¥å…·
```

### 3.2 æ·±å…¥äº†è§£æ¯ä¸ªéƒ¨é—¨

#### 3.2.1 appç›®å½• - ä¸šåŠ¡æ ¸å¿ƒåŒº

è¿™æ˜¯æ•´ä¸ªå•†åŸçš„"å¤§è„‘"ï¼Œæ‰€æœ‰ä¸šåŠ¡é€»è¾‘éƒ½åœ¨è¿™é‡Œã€‚

**ğŸ“ adminapi/ - ç®¡ç†åå°æ¥å£**
```php
adminapi/
â”œâ”€â”€ controller/         # æ§åˆ¶å™¨ï¼ˆæ¥å¾…å‘˜ï¼‰
â”‚   â”œâ”€â”€ v1/            # ç‰ˆæœ¬1çš„æ¥å£
â”‚   â”‚   â”œâ”€â”€ user/      # ç”¨æˆ·ç®¡ç†ç›¸å…³
â”‚   â”‚   â”œâ”€â”€ product/   # å•†å“ç®¡ç†ç›¸å…³
â”‚   â”‚   â”œâ”€â”€ order/     # è®¢å•ç®¡ç†ç›¸å…³
â”‚   â”‚   â””â”€â”€ ...        # å…¶ä»–åŠŸèƒ½
â”œâ”€â”€ route/             # è·¯ç”±ï¼ˆåœ°å›¾ï¼‰
â””â”€â”€ validate/          # éªŒè¯å™¨ï¼ˆä¿å®‰ï¼‰
```

**ç†è§£æ§åˆ¶å™¨**ï¼šæ§åˆ¶å™¨å°±åƒæ¥å¾…å‘˜ï¼Œå½“æœ‰äººï¼ˆè¯·æ±‚ï¼‰æ¥è®¿æ—¶ï¼Œå†³å®šè¯¥åšä»€ä¹ˆã€‚

```php
// ä¾‹å­ï¼šadminapi/controller/v1/user/User.php
class User {
    // è·å–ç”¨æˆ·åˆ—è¡¨ - å°±åƒæŸ¥çœ‹å®¢æˆ·åå•
    public function index() {
        // 1. æ¥æ”¶å‚æ•°ï¼ˆå¬å®¢æˆ·éœ€æ±‚ï¼‰
        $where = $this->request->getMore([
            ['keyword', ''],
            ['status', ''],
        ]);
        
        // 2. è°ƒç”¨æœåŠ¡ï¼ˆæ‰¾ç›¸å…³éƒ¨é—¨å¤„ç†ï¼‰
        $list = $this->services->getUserList($where);
        
        // 3. è¿”å›ç»“æœï¼ˆç»™å®¢æˆ·ç­”å¤ï¼‰
        return app('json')->success($list);
    }
}
```

**ğŸ“ api/ - ç”¨æˆ·ç«¯æ¥å£**
```php
api/
â”œâ”€â”€ controller/
â”‚   â”œâ”€â”€ v1/
â”‚   â”‚   â”œâ”€â”€ LoginController.php    # ç™»å½•ç›¸å…³
â”‚   â”‚   â”œâ”€â”€ UserController.php     # ç”¨æˆ·ä¸­å¿ƒ
â”‚   â”‚   â”œâ”€â”€ ProductController.php  # å•†å“å±•ç¤º
â”‚   â”‚   â””â”€â”€ OrderController.php    # è®¢å•å¤„ç†
```

**ğŸ“ services/ - ä¸šåŠ¡æœåŠ¡å±‚**

æœåŠ¡å±‚å°±åƒå…¬å¸çš„å„ä¸ªéƒ¨é—¨ï¼Œä¸“é—¨å¤„ç†å…·ä½“ä¸šåŠ¡ï¼š

```php
// ä¾‹å­ï¼šapp/services/user/UserServices.php
class UserServices {
    // è·å–ç”¨æˆ·åˆ—è¡¨ - å…·ä½“çš„ä¸šåŠ¡å¤„ç†
    public function getUserList($where) {
        // å°±åƒä»æ¡£æ¡ˆæŸœï¼ˆæ•°æ®åº“ï¼‰æŸ¥æ‰¾èµ„æ–™
        return $this->dao->getList($where);
    }
    
    // åˆ›å»ºæ–°ç”¨æˆ· - å°±åƒåŠç†æ–°å®¢æˆ·å…¥æ¡£
    public function createUser($data) {
        // 1. éªŒè¯æ•°æ®
        // 2. å¤„ç†å¯†ç 
        // 3. ä¿å­˜åˆ°æ•°æ®åº“
        return $this->dao->save($data);
    }
}
```

**ğŸ“ dao/ - æ•°æ®è®¿é—®å±‚**

DAOï¼ˆData Access Objectï¼‰å°±åƒæ¡£æ¡ˆç®¡ç†å‘˜ï¼Œä¸“é—¨è´Ÿè´£å­˜å–æ•°æ®ï¼š

```php
// ä¾‹å­ï¼šapp/dao/user/UserDao.php
class UserDao {
    // è·å–ç”¨æˆ·æ•°æ® - ä»æ¡£æ¡ˆæŸœå–å‡ºèµ„æ–™
    public function getList($where) {
        return $this->search($where)
            ->order('id desc')
            ->paginate(10);
    }
}
```

### 3.3 æ¨¡å‹å±‚ - æ•°æ®çš„å½¢çŠ¶

æ¨¡å‹å®šä¹‰äº†æ•°æ®çš„"å½¢çŠ¶"ï¼Œå°±åƒè¡¨æ ¼çš„è¡¨å¤´ï¼š

```php
// app/model/user/User.php
class User extends BaseModel {
    // å®šä¹‰è¿™ä¸ª"æ¡£æ¡ˆæŸœ"é‡Œå­˜ä»€ä¹ˆ
    protected $name = 'user';  // è¡¨å
    
    // ç”¨æˆ·æœ‰å“ªäº›å±æ€§
    protected $schema = [
        'uid' => 'int',           // ç”¨æˆ·ID
        'nickname' => 'string',   // æ˜µç§°
        'phone' => 'string',      // æ‰‹æœºå·
        'add_time' => 'int',      // æ³¨å†Œæ—¶é—´
    ];
}
```

### 3.4 é…ç½®æ–‡ä»¶ - å•†åŸçš„è®¾ç½®ä¸­å¿ƒ

```php
config/
â”œâ”€â”€ app.php          # åº”ç”¨é…ç½®ï¼ˆå•†åŸåŸºæœ¬ä¿¡æ¯ï¼‰
â”œâ”€â”€ database.php     # æ•°æ®åº“é…ç½®ï¼ˆè¿æ¥ä¿¡æ¯ï¼‰
â”œâ”€â”€ cache.php        # ç¼“å­˜é…ç½®ï¼ˆRedisè®¾ç½®ï¼‰
â”œâ”€â”€ filesystem.php   # æ–‡ä»¶ç³»ç»Ÿé…ç½®ï¼ˆå›¾ç‰‡ä¸Šä¼ ï¼‰
â””â”€â”€ ...
```

**é‡è¦é…ç½®ç¤ºä¾‹**ï¼š

```php
// config/database.php
return [
    'default' => 'mysql',
    'connections' => [
        'mysql' => [
            'hostname' => '127.0.0.1',  // æ•°æ®åº“åœ°å€
            'database' => 'crmeb',      // æ•°æ®åº“å
            'username' => 'root',       // ç”¨æˆ·å
            'password' => '123456',     // å¯†ç 
            'hostport' => '3306',       // ç«¯å£
        ]
    ]
];
```

### 3.5 è·¯ç”±é…ç½® - è¯·æ±‚çš„åœ°å›¾

è·¯ç”±å‘Šè¯‰ç³»ç»Ÿï¼šå½“ç”¨æˆ·è®¿é—®æŸä¸ªç½‘å€æ—¶ï¼Œè¯¥è°ƒç”¨å“ªä¸ªæ§åˆ¶å™¨çš„å“ªä¸ªæ–¹æ³•ã€‚

```php
// route/api.php
Route::group('user', function () {
    // å½“è®¿é—® /api/user/info æ—¶ï¼Œè°ƒç”¨ UserController çš„ info æ–¹æ³•
    Route::get('info', 'v1.user.UserController/info');
    
    // å½“è®¿é—® /api/user/edit æ—¶ï¼Œè°ƒç”¨ UserController çš„ edit æ–¹æ³•
    Route::post('edit', 'v1.user.UserController/edit');
});
```

### 3.6 å‰ç«¯æ¨¡æ¿ - å•†åŸçš„è„¸é¢

```
template/
â”œâ”€â”€ admin/              # ç®¡ç†åå°ç•Œé¢
â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â”œâ”€â”€ views/     # é¡µé¢æ–‡ä»¶
â”‚   â”‚   â”œâ”€â”€ api/       # æ¥å£è°ƒç”¨
â”‚   â”‚   â””â”€â”€ router/    # è·¯ç”±é…ç½®
â””â”€â”€ uni-app/           # å°ç¨‹åº/H5ç•Œé¢
    â”œâ”€â”€ pages/         # é¡µé¢æ–‡ä»¶
    â”œâ”€â”€ api/           # æ¥å£è°ƒç”¨
    â””â”€â”€ store/         # çŠ¶æ€ç®¡ç†
```

### 3.7 æ–‡ä»¶ä¹‹é—´çš„åä½œå…³ç³»

æƒ³è±¡ä¸€ä¸ªç”¨æˆ·ä¸‹å•çš„è¿‡ç¨‹ï¼š

1. **ç”¨æˆ·åœ¨å°ç¨‹åºç‚¹å‡»"ç«‹å³è´­ä¹°"**
   - `template/uni-app/pages/goods/goods.vue` å¤„ç†ç‚¹å‡»äº‹ä»¶

2. **å‘é€è¯·æ±‚åˆ°åç«¯**
   - è¯·æ±‚åˆ°è¾¾ `public/index.php`ï¼ˆå…¥å£ï¼‰
   - è·¯ç”± `route/api.php` è¯†åˆ«è¿™æ˜¯åˆ›å»ºè®¢å•è¯·æ±‚
   - è½¬å‘ç»™ `api/controller/v1/order/StoreOrderController.php`

3. **æ§åˆ¶å™¨å¤„ç†è¯·æ±‚**
   ```php
   public function create() {
       // æ¥æ”¶æ•°æ®
       $data = $this->request->postMore(['addressId', 'cartIds']);
       
       // è°ƒç”¨æœåŠ¡å±‚
       $order = $this->services->createOrder($uid, $data);
       
       // è¿”å›ç»“æœ
       return app('json')->success('è®¢å•åˆ›å»ºæˆåŠŸ', $order);
   }
   ```

4. **æœåŠ¡å±‚å¤„ç†ä¸šåŠ¡**
   ```php
   // services/order/StoreOrderServices.php
   public function createOrder($uid, $data) {
       // 1. æ£€æŸ¥åº“å­˜
       // 2. è®¡ç®—ä»·æ ¼
       // 3. ç”Ÿæˆè®¢å•å·
       // 4. ä¿å­˜è®¢å•
       return $this->dao->save($orderData);
   }
   ```

5. **DAOå±‚ä¿å­˜æ•°æ®**
   ```php
   // dao/order/StoreOrderDao.php
   public function save($data) {
       return $this->getModel()->save($data);
   }
   ```

### 3.8 æœ¬ç« ç»ƒä¹ 

1. **æ¢ç´¢ä»»åŠ¡**ï¼š
   - æ‰¾åˆ°ç”¨æˆ·ç™»å½•çš„æ§åˆ¶å™¨æ–‡ä»¶
   - æ‰¾åˆ°å•†å“åˆ—è¡¨çš„æœåŠ¡å±‚æ–‡ä»¶
   - æ‰¾åˆ°è®¢å•çš„æ¨¡å‹æ–‡ä»¶

2. **æ€è€ƒé¢˜**ï¼š
   - ä¸ºä»€ä¹ˆè¦åˆ†æˆæ§åˆ¶å™¨ã€æœåŠ¡å±‚ã€DAOå±‚ï¼Ÿ
   - å¦‚æœæŠŠæ‰€æœ‰ä»£ç éƒ½å†™åœ¨æ§åˆ¶å™¨é‡Œä¼šæ€æ ·ï¼Ÿ

3. **å®è·µä»»åŠ¡**ï¼š
   - åœ¨ `api/controller/v1/` ä¸‹åˆ›å»ºä¸€ä¸ª `TestController.php`
   - æ·»åŠ ä¸€ä¸ª `hello` æ–¹æ³•ï¼Œè¿”å› "Hello, åº†äººåºœå•†åŸ!"
   - åœ¨è·¯ç”±ä¸­é…ç½®è¿™ä¸ªæ¥å£

---

## ç¬¬å››ç« ï¼šæ•°æ®åº“è®¾è®¡ä¸æ‰©å±• - å•†åŸçš„è®°å¿†ä¸­å¿ƒ

### 4.1 ç†è§£æ•°æ®åº“

æ•°æ®åº“å°±åƒå•†åŸçš„**æ¡£æ¡ˆå®¤**ï¼Œæ‰€æœ‰çš„ä¿¡æ¯éƒ½å­˜å‚¨åœ¨è¿™é‡Œï¼š
- ğŸ“ **è¡¨ï¼ˆTableï¼‰**ï¼šä¸åŒç±»å‹çš„æ¡£æ¡ˆæŸœ
- ğŸ“„ **è®°å½•ï¼ˆRecordï¼‰**ï¼šæ¯ä¸€ä»½æ¡£æ¡ˆ
- ğŸ“‹ **å­—æ®µï¼ˆFieldï¼‰**ï¼šæ¡£æ¡ˆä¸Šçš„æ¯ä¸€é¡¹ä¿¡æ¯

### 4.2 CRMEBåŸæœ‰çš„æ•°æ®è¡¨

å…ˆæ¥è®¤è¯†ä¸€ä¸‹CRMEBå·²ç»å‡†å¤‡å¥½çš„"æ¡£æ¡ˆæŸœ"ï¼š

```sql
-- ç”¨æˆ·ç›¸å…³
eb_user                 -- ç”¨æˆ·åŸºæœ¬ä¿¡æ¯è¡¨ï¼ˆå®¢æˆ·æ¡£æ¡ˆï¼‰
eb_user_address         -- ç”¨æˆ·åœ°å€è¡¨ï¼ˆæ”¶è´§åœ°å€ï¼‰
eb_user_bill            -- ç”¨æˆ·è´¦å•è¡¨ï¼ˆæ¶ˆè´¹è®°å½•ï¼‰

-- å•†å“ç›¸å…³
eb_store_product        -- å•†å“è¡¨ï¼ˆå•†å“æ¡£æ¡ˆï¼‰
eb_store_product_attr   -- å•†å“å±æ€§è¡¨ï¼ˆè§„æ ¼ä¿¡æ¯ï¼‰
eb_store_category       -- å•†å“åˆ†ç±»è¡¨ï¼ˆå•†å“ç›®å½•ï¼‰

-- è®¢å•ç›¸å…³
eb_store_order          -- è®¢å•è¡¨ï¼ˆè®¢å•æ¡£æ¡ˆï¼‰
eb_store_order_cart     -- è®¢å•å•†å“è¡¨ï¼ˆè®¢å•æ˜ç»†ï¼‰

-- è¥é”€ç›¸å…³
eb_store_coupon         -- ä¼˜æƒ åˆ¸è¡¨
eb_store_seckill        -- ç§’æ€æ´»åŠ¨è¡¨
eb_store_bargain        -- ç ä»·æ´»åŠ¨è¡¨
```

### 4.3 ä¸ºåº†äººåºœå•†åŸæ–°å¢æ•°æ®è¡¨

ç°åœ¨æˆ‘ä»¬è¦æ–°å¢ä¸€äº›"æ¡£æ¡ˆæŸœ"æ¥å­˜å‚¨æ–°åŠŸèƒ½çš„æ•°æ®ã€‚

#### 4.3.1 åˆ›å»ºåˆä¼™äººä¿¡æ¯è¡¨

```sql
-- è¿™å°±åƒä¸ºVIPå®¢æˆ·å»ºç«‹ç‰¹åˆ«æ¡£æ¡ˆ
CREATE TABLE `eb_partner_info` (
  `id` int(11) NOT NULL AUTO_INCREMENT COMMENT 'ç¼–å·',
  `user_id` int(11) NOT NULL COMMENT 'å¯¹åº”çš„ç”¨æˆ·ç¼–å·',
  `partner_level` tinyint(2) NOT NULL DEFAULT '1' COMMENT 'åˆä¼™äººç­‰çº§ï¼š1æ¢¦æƒ³ 2æˆ˜ç•¥ 3åŸå¸‚',
  `start_time` int(11) NOT NULL COMMENT 'æˆä¸ºåˆä¼™äººçš„æ—¶é—´',
  `expire_time` int(11) NOT NULL COMMENT 'æƒç›Šåˆ°æœŸæ—¶é—´',
  `credit_limit` decimal(10,2) DEFAULT '0.00' COMMENT 'ä¿¡ç”¨é¢åº¦ï¼ˆèƒ½æ¬ å¤šå°‘é’±ï¼‰',
  `total_commission` decimal(10,2) DEFAULT '0.00' COMMENT 'ç´¯è®¡è·å¾—çš„ä½£é‡‘',
  `status` tinyint(2) DEFAULT '1' COMMENT 'çŠ¶æ€ï¼š1æ­£å¸¸ 2å†»ç»“',
  `create_time` int(11) NOT NULL COMMENT 'åˆ›å»ºæ—¶é—´',
  PRIMARY KEY (`id`),
  UNIQUE KEY `user_id` (`user_id`) COMMENT 'ä¸€ä¸ªç”¨æˆ·åªèƒ½æœ‰ä¸€æ¡åˆä¼™äººè®°å½•'
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='åˆä¼™äººä¿¡æ¯è¡¨';
```

ğŸ’¡ **ç†è§£è¦ç‚¹**ï¼š
- `AUTO_INCREMENT`ï¼šè‡ªåŠ¨ç¼–å·ï¼Œå°±åƒæ¡£æ¡ˆè‡ªåŠ¨è´´ä¸Šç¼–å·
- `UNIQUE KEY`ï¼šå”¯ä¸€ç´¢å¼•ï¼Œç¡®ä¿ä¸é‡å¤
- `DECIMAL(10,2)`ï¼šæœ€å¤š10ä½æ•°ï¼Œå…¶ä¸­2ä½å°æ•°ï¼Œç”¨äºå­˜é’±
- `COMMENT`ï¼šæ³¨é‡Šï¼Œæ–¹ä¾¿ç†è§£æ¯ä¸ªå­—æ®µçš„ç”¨é€”

#### 4.3.2 åˆ›å»ºç¤¼å“å¡è¡¨

```sql
-- ç¤¼å“å¡å°±åƒå•†åœºçš„è´­ç‰©å¡
CREATE TABLE `eb_gift_card` (
  `id` int(11) NOT NULL AUTO_INCREMENT,
  `card_code` varchar(32) NOT NULL COMMENT 'å¡å·ï¼ˆåƒé“¶è¡Œå¡å·ï¼‰',
  `card_password` varchar(64) NOT NULL COMMENT 'å¯†ç ï¼ˆåˆ®å¼€æ¶‚å±‚æ‰èƒ½çœ‹åˆ°ï¼‰',
  `card_type` tinyint(2) NOT NULL DEFAULT '1' COMMENT 'ç±»å‹ï¼š1å•†å“å¡ 2åˆ†é”€å¥–åŠ±å¡',
  `product_id` int(11) NOT NULL COMMENT 'å¯å…‘æ¢çš„å•†å“ID',
  `product_name` varchar(255) NOT NULL COMMENT 'å•†å“åç§°',
  `user_id` int(11) DEFAULT NULL COMMENT 'æŒæœ‰äººIDï¼ˆè°çš„å¡ï¼‰',
  `status` tinyint(2) DEFAULT '1' COMMENT 'çŠ¶æ€ï¼š1æœªä½¿ç”¨ 2å·²ä½¿ç”¨ 3å·²è¿‡æœŸ',
  `expire_time` int(11) DEFAULT NULL COMMENT 'è¿‡æœŸæ—¶é—´',
  `create_time` int(11) NOT NULL,
  PRIMARY KEY (`id`),
  UNIQUE KEY `card_code` (`card_code`) COMMENT 'å¡å·ä¸èƒ½é‡å¤',
  KEY `user_id` (`user_id`) COMMENT 'æ–¹ä¾¿æŸ¥è¯¢æŸäººçš„å¡',
  KEY `status` (`status`) COMMENT 'æ–¹ä¾¿æŸ¥è¯¢å¯ç”¨çš„å¡'
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='ç¤¼å“å¡è¡¨';
```

### 4.4 ä½¿ç”¨å®å¡”é¢æ¿æ“ä½œæ•°æ®åº“

#### æ­¥éª¤1ï¼šè¿›å…¥æ•°æ®åº“ç®¡ç†

1. ç™»å½•å®å¡”é¢æ¿
2. ç‚¹å‡»"æ•°æ®åº“"
3. æ‰¾åˆ°ä½ çš„å•†åŸæ•°æ®åº“ï¼Œç‚¹å‡»"ç®¡ç†"
4. è¿™ä¼šæ‰“å¼€phpMyAdminï¼ˆæ•°æ®åº“ç®¡ç†å·¥å…·ï¼‰

#### æ­¥éª¤2ï¼šæ‰§è¡ŒSQLè¯­å¥

1. åœ¨phpMyAdminä¸­ï¼Œç‚¹å‡»"SQL"æ ‡ç­¾
2. å¤åˆ¶ä¸Šé¢çš„å»ºè¡¨è¯­å¥ï¼Œç²˜è´´è¿›å»
3. ç‚¹å‡»"æ‰§è¡Œ"
4. æˆåŠŸåä¼šçœ‹åˆ°æ–°è¡¨å‡ºç°åœ¨å·¦ä¾§åˆ—è¡¨

### 4.5 åœ¨ä»£ç ä¸­ä½¿ç”¨æ–°æ•°æ®è¡¨

#### 4.5.1 åˆ›å»ºæ¨¡å‹æ–‡ä»¶

æ¨¡å‹æ–‡ä»¶å‘Šè¯‰ç³»ç»Ÿè¿™ä¸ªè¡¨çš„ç»“æ„ï¼š

```php
// åˆ›å»ºæ–‡ä»¶ï¼šapp/model/partner/PartnerInfo.php
<?php
namespace app\model\partner;

use crmeb\basic\BaseModel;

class PartnerInfo extends BaseModel
{
    /**
     * æ•°æ®è¡¨å
     */
    protected $name = 'partner_info';
    
    /**
     * æ•°æ®è¡¨ä¸»é”®
     */
    protected $pk = 'id';
    
    /**
     * æ¨¡å‹å¯¹åº”æ•°æ®è¡¨å­—æ®µåŠç±»å‹
     * è¿™å°±åƒå‘Šè¯‰ç³»ç»Ÿï¼šè¿™ä¸ªæ¡£æ¡ˆæŸœé‡Œæœ‰å“ªäº›æ ¼å­
     */
    protected $schema = [
        'id'                => 'int',
        'user_id'           => 'int',
        'partner_level'     => 'int',
        'start_time'        => 'int',
        'expire_time'       => 'int',
        'credit_limit'      => 'float',
        'total_commission'  => 'float',
        'status'            => 'int',
        'create_time'       => 'int',
    ];
    
    /**
     * è·å–åˆä¼™äººç­‰çº§åç§°
     * å°±åƒæŠŠæ•°å­—1ã€2ã€3ç¿»è¯‘æˆ"æ¢¦æƒ³"ã€"æˆ˜ç•¥"ã€"åŸå¸‚"
     */
    public function getPartnerLevelAttr($value)
    {
        $levels = [
            1 => 'æ¢¦æƒ³åˆä¼™äºº',
            2 => 'æˆ˜ç•¥åˆä¼™äºº',
            3 => 'åŸå¸‚åˆä¼™äºº'
        ];
        return $levels[$value] ?? 'æœªçŸ¥';
    }
}
```

#### 4.5.2 åˆ›å»ºDAOæ–‡ä»¶

DAOè´Ÿè´£å…·ä½“çš„æ•°æ®æ“ä½œï¼š

```php
// åˆ›å»ºæ–‡ä»¶ï¼šapp/dao/partner/PartnerInfoDao.php
<?php
namespace app\dao\partner;

use app\dao\BaseDao;
use app\model\partner\PartnerInfo;

class PartnerInfoDao extends BaseDao
{
    /**
     * è®¾ç½®æ¨¡å‹
     */
    protected function setModel(): string
    {
        return PartnerInfo::class;
    }
    
    /**
     * æ ¹æ®ç”¨æˆ·IDè·å–åˆä¼™äººä¿¡æ¯
     * å°±åƒé€šè¿‡èº«ä»½è¯å·æŸ¥æ‰¾VIPæ¡£æ¡ˆ
     */
    public function getByUserId($userId)
    {
        return $this->getModel()->where('user_id', $userId)->find();
    }
    
    /**
     * åˆ›å»ºåˆä¼™äºº
     * å°±åƒä¸ºæ–°VIPå»ºç«‹æ¡£æ¡ˆ
     */
    public function createPartner($userId, $level)
    {
        $data = [
            'user_id' => $userId,
            'partner_level' => $level,
            'start_time' => time(),
            'expire_time' => time() + 365 * 86400, // ä¸€å¹´åè¿‡æœŸ
            'credit_limit' => $this->getCreditLimit($level),
            'status' => 1,
            'create_time' => time()
        ];
        
        return $this->save($data);
    }
    
    /**
     * æ ¹æ®ç­‰çº§è·å–ä¿¡ç”¨é¢åº¦
     */
    private function getCreditLimit($level)
    {
        $limits = [
            1 => 1000.00,  // æ¢¦æƒ³åˆä¼™äºº
            2 => 5000.00,  // æˆ˜ç•¥åˆä¼™äºº
            3 => 10000.00  // åŸå¸‚åˆä¼™äºº
        ];
        return $limits[$level] ?? 0;
    }
}
```

#### 4.5.3 åˆ›å»ºæœåŠ¡å±‚æ–‡ä»¶

æœåŠ¡å±‚å¤„ç†ä¸šåŠ¡é€»è¾‘ï¼š

```php
// åˆ›å»ºæ–‡ä»¶ï¼šapp/services/partner/PartnerServices.php
<?php
namespace app\services\partner;

use app\services\BaseServices;
use app\dao\partner\PartnerInfoDao;
use app\services\user\UserServices;

class PartnerServices extends BaseServices
{
    /**
     * æ„é€ æ–¹æ³•
     */
    public function __construct(PartnerInfoDao $dao)
    {
        $this->dao = $dao;
    }
    
    /**
     * å‡çº§ä¸ºåˆä¼™äºº
     * å°±åƒåŠç†VIPä¼šå‘˜å¡
     */
    public function upgradeToPartner($userId, $level, $orderId)
    {
        // 1. æ£€æŸ¥æ˜¯å¦å·²ç»æ˜¯åˆä¼™äºº
        $partnerInfo = $this->dao->getByUserId($userId);
        if ($partnerInfo) {
            throw new \Exception('æ‚¨å·²ç»æ˜¯åˆä¼™äººäº†');
        }
        
        // 2. åˆ›å»ºåˆä¼™äººè®°å½•
        $result = $this->dao->createPartner($userId, $level);
        
        // 3. è®°å½•å‡çº§æ—¥å¿—
        $this->recordUpgradeLog($userId, $level, $orderId);
        
        // 4. å‘é€é€šçŸ¥
        $this->sendUpgradeNotice($userId, $level);
        
        return $result;
    }
    
    /**
     * è·å–åˆä¼™äººä¿¡æ¯
     */
    public function getPartnerInfo($userId)
    {
        $info = $this->dao->getByUserId($userId);
        if (!$info) {
            return null;
        }
        
        // æ£€æŸ¥æ˜¯å¦è¿‡æœŸ
        if ($info['expire_time'] < time()) {
            $info['is_expired'] = true;
        } else {
            $info['is_expired'] = false;
            $info['days_left'] = ceil(($info['expire_time'] - time()) / 86400);
        }
        
        return $info;
    }
}
```

### 4.6 æ•°æ®åº“è®¾è®¡åŸåˆ™

è®¾è®¡æ•°æ®åº“å°±åƒæ•´ç†æ¡£æ¡ˆå®¤ï¼Œè¦éµå¾ªä¸€äº›åŸåˆ™ï¼š

1. **æ¯ä¸ªè¡¨éƒ½è¦æœ‰ä¸»é”®**
   - å°±åƒæ¯ä¸ªæ¡£æ¡ˆéƒ½è¦æœ‰å”¯ä¸€ç¼–å·

2. **å­—æ®µç±»å‹è¦åˆé€‚**
   - å­˜é’±ç”¨ `DECIMAL`
   - å­˜æ—¶é—´ç”¨ `INT`ï¼ˆæ—¶é—´æˆ³ï¼‰æˆ– `DATETIME`
   - å­˜çŸ­æ–‡æœ¬ç”¨ `VARCHAR`
   - å­˜é•¿æ–‡æœ¬ç”¨ `TEXT`

3. **å»ºç«‹åˆé€‚çš„ç´¢å¼•**
   - ç»å¸¸æŸ¥è¯¢çš„å­—æ®µè¦åŠ ç´¢å¼•
   - å°±åƒç»™å¸¸ç”¨æ¡£æ¡ˆè´´ä¸Šæ ‡ç­¾ï¼Œæ–¹ä¾¿æŸ¥æ‰¾

4. **æ³¨æ„æ•°æ®å…³è”**
   - ç”¨å¤–é”®å…³è”ä¸åŒçš„è¡¨
   - å°±åƒç”¨è®¢ä¹¦æœºæŠŠç›¸å…³æ¡£æ¡ˆè®¢åœ¨ä¸€èµ·

### 4.7 æœ¬ç« ç»ƒä¹ 

1. **åŠ¨æ‰‹å®è·µ**ï¼š
   - åˆ›å»ºæ‰€æœ‰æ–°åŠŸèƒ½éœ€è¦çš„æ•°æ®è¡¨
   - ä¸ºæ¯ä¸ªæ–°è¡¨åˆ›å»ºå¯¹åº”çš„æ¨¡å‹æ–‡ä»¶
   - æµ‹è¯•æ•°æ®çš„å¢åˆ æ”¹æŸ¥

2. **æ€è€ƒé¢˜**ï¼š
   - ä¸ºä»€ä¹ˆåˆä¼™äººè¡¨è¦å’Œç”¨æˆ·è¡¨å…³è”ï¼Ÿ
   - å¦‚æœè¦è®°å½•åˆä¼™äººçš„å‡çº§å†å²ï¼Œè¯¥å¦‚ä½•è®¾è®¡è¡¨ï¼Ÿ

3. **æ‰©å±•ä»»åŠ¡**ï¼š
   - è®¾è®¡ä¸€ä¸ªåˆä¼™äººå‡çº§è®°å½•è¡¨
   - è®¾è®¡ä¸€ä¸ªç¤¼å“å¡ä½¿ç”¨è®°å½•è¡¨

---

## ç¬¬äº”ç« ï¼šåˆä¼™äººç®¡ç†ç³»ç»Ÿå¼€å‘ - æ‰“é€ ä½ çš„å•†ä¸šå¸å›½

### 5.1 ç†è§£åˆä¼™äººç³»ç»Ÿ

åˆä¼™äººç³»ç»Ÿå°±åƒæ˜¯å•†åŸçš„**VIPä¼šå‘˜ä½“ç³»**ï¼Œä½†æ›´é«˜çº§ï¼š

- ğŸ¥‰ **æ¢¦æƒ³åˆä¼™äºº**ï¼šåƒé“œå¡ä¼šå‘˜
- ğŸ¥ˆ **æˆ˜ç•¥åˆä¼™äºº**ï¼šåƒé“¶å¡ä¼šå‘˜  
- ğŸ¥‡ **åŸå¸‚åˆä¼™äºº**ï¼šåƒé‡‘å¡ä¼šå‘˜

æ¯ä¸ªç­‰çº§éƒ½æœ‰ä¸åŒçš„æƒç›Šï¼Œå°±åƒä¸åŒç­‰çº§çš„ä¼šå‘˜å¡äº«å—ä¸åŒçš„ä¼˜æƒ ã€‚

### 5.2 åå°ç®¡ç†åŠŸèƒ½å¼€å‘

#### 5.2.1 åˆ›å»ºåˆä¼™äººç®¡ç†æ§åˆ¶å™¨

```php
// åˆ›å»ºæ–‡ä»¶ï¼šapp/adminapi/controller/v1/partner/Partner.php
<?php
namespace app\adminapi\controller\v1\partner;

use app\adminapi\controller\AuthController;
use app\services\partner\PartnerServices;
use think\facade\App;

/**
 * åˆä¼™äººç®¡ç†æ§åˆ¶å™¨
 * å°±åƒå…¬å¸çš„äººäº‹éƒ¨é—¨ï¼Œç®¡ç†æ‰€æœ‰åˆä¼™äºº
 */
class Partner extends AuthController
{
    protected $services;
    
    public function __construct(App $app, PartnerServices $services)
    {
        parent::__construct($app);
        $this->services = $services;
    }
    
    /**
     * åˆä¼™äººåˆ—è¡¨
     * å°±åƒæŸ¥çœ‹æ‰€æœ‰VIPä¼šå‘˜åå•
     */
    public function index()
    {
        // æ¥æ”¶æŸ¥è¯¢å‚æ•°
        $where = $this->request->getMore([
            ['keyword', ''],        // æœç´¢å…³é”®è¯
            ['level', ''],          // åˆä¼™äººç­‰çº§
            ['status', ''],         // çŠ¶æ€
            ['page', 1],            // é¡µç 
            ['limit', 10],          // æ¯é¡µæ˜¾ç¤ºæ•°é‡
        ]);
        
        // è·å–åˆ—è¡¨æ•°æ®
        $list = $this->services->getPartnerList($where);
        
        return app('json')->success($list);
    }
    
    /**
     * æ·»åŠ åˆä¼™äºº
     * å°±åƒç»™æŸäººåŠç†VIPå¡
     */
    public function save()
    {
        $data = $this->request->postMore([
            ['user_id', 0],                    // ç”¨æˆ·ID
            ['partner_level', 1],              // åˆä¼™äººç­‰çº§
            ['credit_limit', 0],               // ä¿¡ç”¨é¢åº¦
            ['expire_time', ''],               // åˆ°æœŸæ—¶é—´
        ]);
        
        // éªŒè¯æ•°æ®
        if (!$data['user_id']) {
            return app('json')->fail('è¯·é€‰æ‹©ç”¨æˆ·');
        }
        
        // åˆ›å»ºåˆä¼™äºº
        $result = $this->services->createPartner($data);
        
        return app('json')->success('æ·»åŠ æˆåŠŸ');
    }
    
    /**
     * ç¼–è¾‘åˆä¼™äººä¿¡æ¯
     * å°±åƒä¿®æ”¹VIPå¡ä¿¡æ¯
     */
    public function update($id)
    {
        $data = $this->request->postMore([
            ['credit_limit', 0],               // ä¿¡ç”¨é¢åº¦
            ['expire_time', ''],               // åˆ°æœŸæ—¶é—´
            ['status', 1],                     // çŠ¶æ€
        ]);
        
        $result = $this->services->updatePartner($id, $data);
        
        return app('json')->success('ä¿®æ”¹æˆåŠŸ');
    }
    
    /**
     * åˆä¼™äººé…ç½®
     * è®¾ç½®ä¸åŒç­‰çº§çš„æƒç›Š
     */
    public function config()
    {
        if ($this->request->isPost()) {
            // ä¿å­˜é…ç½®
            $data = $this->request->postMore([
                ['level_1_discount', 95],       // æ¢¦æƒ³åˆä¼™äººæŠ˜æ‰£
                ['level_1_commission', 5],      // æ¢¦æƒ³åˆä¼™äººåˆ†çº¢æ¯”ä¾‹
                ['level_2_discount', 90],       // æˆ˜ç•¥åˆä¼™äººæŠ˜æ‰£
                ['level_2_commission', 10],     // æˆ˜ç•¥åˆä¼™äººåˆ†çº¢æ¯”ä¾‹
                ['level_3_discount', 85],       // åŸå¸‚åˆä¼™äººæŠ˜æ‰£
                ['level_3_commission', 15],     // åŸå¸‚åˆä¼™äººåˆ†çº¢æ¯”ä¾‹
            ]);
            
            $this->services->saveConfig($data);
            return app('json')->success('ä¿å­˜æˆåŠŸ');
        } else {
            // è·å–é…ç½®
            $config = $this->services->getConfig();
            return app('json')->success($config);
        }
    }
}
```

#### 5.2.2 å®Œå–„æœåŠ¡å±‚

```php
// ä¿®æ”¹æ–‡ä»¶ï¼šapp/services/partner/PartnerServices.php
// æ·»åŠ ä»¥ä¸‹æ–¹æ³•

/**
 * è·å–åˆä¼™äººåˆ—è¡¨
 * æ”¯æŒæœç´¢ã€ç­›é€‰ã€åˆ†é¡µ
 */
public function getPartnerList($where)
{
    // æ„å»ºæŸ¥è¯¢æ¡ä»¶
    $query = $this->dao->getModel();
    
    // å…³è”ç”¨æˆ·è¡¨ï¼Œè·å–ç”¨æˆ·ä¿¡æ¯
    $query = $query->with(['user' => function($query) {
        $query->field('uid,nickname,phone,avatar');
    }]);
    
    // æœç´¢æ¡ä»¶
    if (!empty($where['keyword'])) {
        $query = $query->where(function($q) use ($where) {
            $q->whereHas('user', function($q) use ($where) {
                $q->where('nickname', 'like', "%{$where['keyword']}%")
                  ->whereOr('phone', 'like', "%{$where['keyword']}%");
            });
        });
    }
    
    // ç­‰çº§ç­›é€‰
    if ($where['level'] !== '') {
        $query = $query->where('partner_level', $where['level']);
    }
    
    // çŠ¶æ€ç­›é€‰
    if ($where['status'] !== '') {
        $query = $query->where('status', $where['status']);
    }
    
    // åˆ†é¡µè·å–æ•°æ®
    $list = $query->order('id desc')
                  ->page($where['page'], $where['limit'])
                  ->select();
    
    // ç»Ÿè®¡æ€»æ•°
    $count = $query->count();
    
    // å¤„ç†æ•°æ®
    foreach ($list as &$item) {
        // è®¡ç®—å‰©ä½™å¤©æ•°
        $item['days_left'] = max(0, ceil(($item['expire_time'] - time()) / 86400));
        // æ ¼å¼åŒ–æ—¶é—´
        $item['start_time_text'] = date('Y-m-d', $item['start_time']);
        $item['expire_time_text'] = date('Y-m-d', $item['expire_time']);
    }
    
    return compact('list', 'count');
}

/**
 * ä¿å­˜åˆä¼™äººé…ç½®
 */
public function saveConfig($data)
{
    // ä¿å­˜åˆ°ç³»ç»Ÿé…ç½®è¡¨
    foreach ($data as $key => $value) {
        // ä½¿ç”¨ç³»ç»Ÿé…ç½®æœåŠ¡ä¿å­˜
        app()->make(\app\services\system\config\SystemConfigServices::class)
              ->saveConfig($key, $value);
    }
    
    // æ¸…é™¤ç¼“å­˜
    $this->clearCache();
    
    return true;
}

/**
 * è·å–åˆä¼™äººé…ç½®
 */
public function getConfig()
{
    $configService = app()->make(\app\services\system\config\SystemConfigServices::class);
    
    return [
        'level_1_discount' => $configService->getConfig('level_1_discount') ?: 95,
        'level_1_commission' => $configService->getConfig('level_1_commission') ?: 5,
        'level_2_discount' => $configService->getConfig('level_2_discount') ?: 90,
        'level_2_commission' => $configService->getConfig('level_2_commission') ?: 10,
        'level_3_discount' => $configService->getConfig('level_3_discount') ?: 85,
        'level_3_commission' => $configService->getConfig('level_3_commission') ?: 15,
    ];
}
```

### 5.3 å‰ç«¯ç®¡ç†ç•Œé¢å¼€å‘

#### 5.3.1 åˆ›å»ºåˆä¼™äººåˆ—è¡¨é¡µé¢

```vue
<!-- åˆ›å»ºæ–‡ä»¶ï¼štemplate/admin/src/views/partner/index.vue -->
<template>
  <div class="partner-list">
    <!-- æœç´¢æ  -->
    <el-card class="search-card">
      <el-form :inline="true" :model="searchForm">
        <el-form-item label="å…³é”®è¯">
          <el-input v-model="searchForm.keyword" 
                    placeholder="ç”¨æˆ·æ˜µç§°/æ‰‹æœºå·" 
                    clearable />
        </el-form-item>
        
        <el-form-item label="åˆä¼™äººç­‰çº§">
          <el-select v-model="searchForm.level" placeholder="å…¨éƒ¨" clearable>
            <el-option label="æ¢¦æƒ³åˆä¼™äºº" :value="1" />
            <el-option label="æˆ˜ç•¥åˆä¼™äºº" :value="2" />
            <el-option label="åŸå¸‚åˆä¼™äºº" :value="3" />
          </el-select>
        </el-form-item>
        
        <el-form-item label="çŠ¶æ€">
          <el-select v-model="searchForm.status" placeholder="å…¨éƒ¨" clearable>
            <el-option label="æ­£å¸¸" :value="1" />
            <el-option label="å†»ç»“" :value="2" />
          </el-select>
        </el-form-item>
        
        <el-form-item>
          <el-button type="primary" @click="getList">æŸ¥è¯¢</el-button>
          <el-button @click="resetSearch">é‡ç½®</el-button>
          <el-button type="success" @click="openAddDialog">æ·»åŠ åˆä¼™äºº</el-button>
        </el-form-item>
      </el-form>
    </el-card>
    
    <!-- æ•°æ®è¡¨æ ¼ -->
    <el-card class="table-card">
      <el-table :data="tableData" border>
        <el-table-column prop="id" label="ID" width="80" />
        
        <el-table-column label="ç”¨æˆ·ä¿¡æ¯" width="200">
          <template slot-scope="scope">
            <div class="user-info">
              <el-avatar :src="scope.row.user.avatar" />
              <div>
                <div>{{ scope.row.user.nickname }}</div>
                <div class="text-muted">{{ scope.row.user.phone }}</div>
              </div>
            </div>
          </template>
        </el-table-column>
        
        <el-table-column label="åˆä¼™äººç­‰çº§">
          <template slot-scope="scope">
            <el-tag :type="getLevelType(scope.row.partner_level)">
              {{ getLevelName(scope.row.partner_level) }}
            </el-tag>
          </template>
        </el-table-column>
        
        <el-table-column prop="credit_limit" label="ä¿¡ç”¨é¢åº¦" />
        
        <el-table-column label="æœ‰æ•ˆæœŸ">
          <template slot-scope="scope">
            <div>{{ scope.row.start_time_text }} è‡³</div>
            <div>{{ scope.row.expire_time_text }}</div>
            <div class="text-warning">å‰©ä½™{{ scope.row.days_left }}å¤©</div>
          </template>
        </el-table-column>
        
        <el-table-column label="çŠ¶æ€">
          <template slot-scope="scope">
            <el-switch v-model="scope.row.status" 
                       :active-value="1" 
                       :inactive-value="2"
                       @change="changeStatus(scope.row)" />
          </template>
        </el-table-column>
        
        <el-table-column label="æ“ä½œ" width="150">
          <template slot-scope="scope">
            <el-button size="mini" @click="editPartner(scope.row)">ç¼–è¾‘</el-button>
            <el-button size="mini" type="danger" @click="deletePartner(scope.row)">åˆ é™¤</el-button>
          </template>
        </el-table-column>
      </el-table>
      
      <!-- åˆ†é¡µ -->
      <el-pagination
        @current-change="handlePageChange"
        :current-page="searchForm.page"
        :page-size="searchForm.limit"
        :total="total"
        layout="total, prev, pager, next" />
    </el-card>
  </div>
</template>

<script>
// å¯¼å…¥æ¥å£
import { getPartnerList, updatePartnerStatus } from '@/api/partner'

export default {
  name: 'PartnerList',
  data() {
    return {
      // æœç´¢è¡¨å•
      searchForm: {
        keyword: '',
        level: '',
        status: '',
        page: 1,
        limit: 10
      },
      // è¡¨æ ¼æ•°æ®
      tableData: [],
      total: 0
    }
  },
  
  created() {
    this.getList()
  },
  
  methods: {
    // è·å–åˆ—è¡¨
    async getList() {
      const res = await getPartnerList(this.searchForm)
      this.tableData = res.data.list
      this.total = res.data.count
    },
    
    // è·å–ç­‰çº§åç§°
    getLevelName(level) {
      const names = {
        1: 'æ¢¦æƒ³åˆä¼™äºº',
        2: 'æˆ˜ç•¥åˆä¼™äºº',
        3: 'åŸå¸‚åˆä¼™äºº'
      }
      return names[level] || 'æœªçŸ¥'
    },
    
    // è·å–ç­‰çº§æ ‡ç­¾ç±»å‹
    getLevelType(level) {
      const types = {
        1: 'info',
        2: 'warning',
        3: 'success'
      }
      return types[level] || 'info'
    },
    
    // æ”¹å˜çŠ¶æ€
    async changeStatus(row) {
      await updatePartnerStatus(row.id, { status: row.status })
      this.$message.success('çŠ¶æ€æ›´æ–°æˆåŠŸ')
    },
    
    // å…¶ä»–æ–¹æ³•...
  }
}
</script>

<style lang="scss" scoped>
.partner-list {
  .search-card {
    margin-bottom: 20px;
  }
  
  .user-info {
    display: flex;
    align-items: center;
    
    .el-avatar {
      margin-right: 10px;
    }
  }
  
  .text-muted {
    color: #999;
    font-size: 12px;
  }
  
  .text-warning {
    color: #e6a23c;
    font-size: 12px;
  }
}
</style>
```

### 5.4 å°ç¨‹åºç«¯åˆä¼™äººåŠŸèƒ½

#### 5.4.1 åˆ›å»ºåˆä¼™äººä¸­å¿ƒé¡µé¢

```vue
<!-- åˆ›å»ºæ–‡ä»¶ï¼štemplate/uni-app/pages/partner/index.vue -->
<template>
  <view class="partner-center">
    <!-- åˆä¼™äººä¿¡æ¯å¡ç‰‡ -->
    <view class="partner-card" v-if="partnerInfo">
      <view class="card-bg"></view>
      <view class="card-content">
        <view class="user-info">
          <image :src="userInfo.avatar" class="avatar"></image>
          <view class="info">
            <view class="nickname">{{ userInfo.nickname }}</view>
            <view class="level">{{ partnerInfo.partner_level_text }}</view>
          </view>
        </view>
        
        <view class="rights-info">
          <view class="item">
            <view class="label">è´­ç‰©æŠ˜æ‰£</view>
            <view class="value">{{ partnerInfo.discount }}æŠ˜</view>
          </view>
          <view class="item">
            <view class="label">åˆ†çº¢æ¯”ä¾‹</view>
            <view class="value">{{ partnerInfo.commission }}%</view>
          </view>
          <view class="item">
            <view class="label">ä¿¡ç”¨é¢åº¦</view>
            <view class="value">Â¥{{ partnerInfo.credit_limit }}</view>
          </view>
        </view>
        
        <view class="expire-info">
          <text>æœ‰æ•ˆæœŸè‡³ï¼š{{ partnerInfo.expire_time_text }}</text>
          <text class="days">ï¼ˆå‰©ä½™{{ partnerInfo.days_left }}å¤©ï¼‰</text>
        </view>
      </view>
    </view>
    
    <!-- æœªæˆä¸ºåˆä¼™äºº -->
    <view class="not-partner" v-else>
      <image src="/static/images/partner-banner.png" class="banner"></image>
      <view class="title">æˆä¸ºåˆä¼™äººï¼Œäº«å—ä¸“å±æƒç›Š</view>
      <view class="desc">è´­ç‰©äº«æŠ˜æ‰£ï¼Œåˆ†äº«å¾—åˆ†çº¢ï¼Œè¿˜èƒ½å…ˆç”¨åä»˜ï¼</view>
      <button class="upgrade-btn" @click="goUpgrade">ç«‹å³å‡çº§</button>
    </view>
    
    <!-- åŠŸèƒ½èœå• -->
    <view class="menu-list" v-if="partnerInfo">
      <view class="menu-item" @click="goPage('/pages/partner/team')">
        <view class="icon">
          <text class="iconfont icon-team"></text>
        </view>
        <view class="title">æˆ‘çš„å›¢é˜Ÿ</view>
        <view class="arrow">
          <text class="iconfont icon-arrow-right"></text>
        </view>
      </view>
      
      <view class="menu-item" @click="goPage('/pages/partner/commission')">
        <view class="icon">
          <text class="iconfont icon-money"></text>
        </view>
        <view class="title">ä½£é‡‘æ˜ç»†</view>
        <view class="value">Â¥{{ partnerInfo.current_commission }}</view>
        <view class="arrow">
          <text class="iconfont icon-arrow-right"></text>
        </view>
      </view>
      
      <view class="menu-item" @click="goPage('/pages/partner/credit')">
        <view class="icon">
          <text class="iconfont icon-credit"></text>
        </view>
        <view class="title">ä¿¡ç”¨ç®¡ç†</view>
        <view class="arrow">
          <text class="iconfont icon-arrow-right"></text>
        </view>
      </view>
    </view>
  </view>
</template>

<script>
import { getPartnerInfo } from '@/api/partner.js'

export default {
  data() {
    return {
      userInfo: {},
      partnerInfo: null
    }
  },
  
  onShow() {
    this.getUserInfo()
    this.getPartnerInfo()
  },
  
  methods: {
    // è·å–ç”¨æˆ·ä¿¡æ¯
    getUserInfo() {
      this.userInfo = uni.getStorageSync('userInfo')
    },
    
    // è·å–åˆä¼™äººä¿¡æ¯
    async getPartnerInfo() {
      const res = await getPartnerInfo()
      this.partnerInfo = res.data
    },
    
    // è·³è½¬é¡µé¢
    goPage(url) {
      uni.navigateTo({ url })
    },
    
    // å»å‡çº§
    goUpgrade() {
      uni.navigateTo({
        url: '/pages/partner/upgrade'
      })
    }
  }
}
</script>

<style lang="scss">
.partner-center {
  padding: 20rpx;
  
  .partner-card {
    position: relative;
    border-radius: 20rpx;
    overflow: hidden;
    box-shadow: 0 4rpx 20rpx rgba(0,0,0,0.1);
    
    .card-bg {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 200rpx;
      background: linear-gradient(45deg, #ff6b6b, #ff8e53);
    }
    
    .card-content {
      position: relative;
      padding: 30rpx;
      
      .user-info {
        display: flex;
        align-items: center;
        margin-bottom: 40rpx;
        
        .avatar {
          width: 120rpx;
          height: 120rpx;
          border-radius: 50%;
          border: 4rpx solid #fff;
        }
        
        .info {
          margin-left: 30rpx;
          color: #fff;
          
          .nickname {
            font-size: 36rpx;
            font-weight: bold;
          }
          
          .level {
            font-size: 28rpx;
            margin-top: 10rpx;
          }
        }
      }
      
      .rights-info {
        display: flex;
        justify-content: space-around;
        padding: 40rpx 0;
        background: #fff;
        border-radius: 20rpx;
        
        .item {
          text-align: center;
          
          .label {
            font-size: 26rpx;
            color: #999;
          }
          
          .value {
            font-size: 36rpx;
            font-weight: bold;
            color: #ff6b6b;
            margin-top: 10rpx;
          }
        }
      }
      
      .expire-info {
        text-align: center;
        margin-top: 30rpx;
        font-size: 26rpx;
        color: #666;
        
        .days {
          color: #ff6b6b;
        }
      }
    }
  }
  
  .not-partner {
    text-align: center;
    padding: 60rpx 0;
    
    .banner {
      width: 600rpx;
      height: 300rpx;
    }
    
    .title {
      font-size: 36rpx;
      font-weight: bold;
      margin-top: 40rpx;
    }
    
    .desc {
      font-size: 28rpx;
      color: #666;
      margin-top: 20rpx;
    }
    
    .upgrade-btn {
      width: 400rpx;
      height: 88rpx;
      background: linear-gradient(45deg, #ff6b6b, #ff8e53);
      color: #fff;
      font-size: 32rpx;
      border-radius: 44rpx;
      margin-top: 60rpx;
    }
  }
  
  .menu-list {
    margin-top: 30rpx;
    background: #fff;
    border-radius: 20rpx;
    
    .menu-item {
      display: flex;
      align-items: center;
      padding: 30rpx;
      border-bottom: 1rpx solid #f5f5f5;
      
      &:last-child {
        border-bottom: none;
      }
      
      .icon {
        width: 60rpx;
        height: 60rpx;
        background: #fff5f5;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        
        .iconfont {
          font-size: 32rpx;
          color: #ff6b6b;
        }
      }
      
      .title {
        flex: 1;
        margin-left: 30rpx;
        font-size: 30rpx;
      }
      
      .value {
        font-size: 30rpx;
        color: #ff6b6b;
        font-weight: bold;
      }
      
      .arrow {
        margin-left: 20rpx;
        
        .iconfont {
          font-size: 28rpx;
          color: #999;
        }
      }
    }
  }
}
</style>
```

### 5.5 åˆä¼™äººæƒç›Šå®ç°

#### 5.5.1 è´­ç‰©æŠ˜æ‰£å®ç°

åœ¨è®¢å•æœåŠ¡ä¸­æ·»åŠ æŠ˜æ‰£è®¡ç®—ï¼š

```php
// ä¿®æ”¹æ–‡ä»¶ï¼šapp/services/order/StoreOrderServices.php
// åœ¨è®¡ç®—è®¢å•ä»·æ ¼çš„æ–¹æ³•ä¸­æ·»åŠ 

/**
 * è®¡ç®—åˆä¼™äººæŠ˜æ‰£
 */
protected function calculatePartnerDiscount($uid, $totalPrice)
{
    // è·å–åˆä¼™äººä¿¡æ¯
    $partnerService = app()->make(PartnerServices::class);
    $partnerInfo = $partnerService->getPartnerInfo($uid);
    
    if (!$partnerInfo || $partnerInfo['is_expired']) {
        return [
            'discount' => 100,  // æ— æŠ˜æ‰£
            'discount_price' => 0
        ];
    }
    
    // è·å–æŠ˜æ‰£é…ç½®
    $config = $partnerService->getConfig();
    $discountKey = 'level_' . $partnerInfo['partner_level'] . '_discount';
    $discount = $config[$discountKey] ?? 100;
    
    // è®¡ç®—æŠ˜æ‰£é‡‘é¢
    $discountPrice = $totalPrice * (100 - $discount) / 100;
    
    return [
        'discount' => $discount,
        'discount_price' => round($discountPrice, 2)
    ];
}
```

#### 5.5.2 åˆ†çº¢è®¡ç®—å®ç°

åˆ›å»ºåˆ†çº¢æœåŠ¡ï¼š

```php
// åˆ›å»ºæ–‡ä»¶ï¼šapp/services/partner/PartnerCommissionServices.php
<?php
namespace app\services\partner;

use app\services\BaseServices;

class PartnerCommissionServices extends BaseServices
{
    /**
     * è®¡ç®—åˆ†çº¢
     * å½“è®¢å•å®Œæˆæ—¶è°ƒç”¨
     */
    public function calculateCommission($order)
    {
        // è·å–è´­ä¹°ç”¨æˆ·çš„æ¨èäºº
        $userService = app()->make(\app\services\user\UserServices::class);
        $spreadUid = $userService->value(['uid' => $order['uid']], 'spread_uid');
        
        if (!$spreadUid) {
            return;
        }
        
        // æ£€æŸ¥æ¨èäººæ˜¯å¦æ˜¯åˆä¼™äºº
        $partnerService = app()->make(PartnerServices::class);
        $partnerInfo = $partnerService->getPartnerInfo($spreadUid);
        
        if (!$partnerInfo || $partnerInfo['is_expired']) {
            return;
        }
        
        // è·å–åˆ†çº¢æ¯”ä¾‹
        $config = $partnerService->getConfig();
        $commissionKey = 'level_' . $partnerInfo['partner_level'] . '_commission';
        $commissionRate = $config[$commissionKey] ?? 0;
        
        // è®¡ç®—åˆ†çº¢é‡‘é¢
        $commissionAmount = $order['pay_price'] * $commissionRate / 100;
        
        // è®°å½•åˆ†çº¢
        $this->recordCommission([
            'partner_id' => $partnerInfo['id'],
            'user_id' => $spreadUid,
            'order_id' => $order['id'],
            'order_sn' => $order['order_id'],
            'commission_rate' => $commissionRate,
            'order_amount' => $order['pay_price'],
            'commission_amount' => round($commissionAmount, 2),
            'status' => 0,  // å¾…ç»“ç®—
            'create_time' => time()
        ]);
        
        // æ›´æ–°åˆä¼™äººç´¯è®¡ä½£é‡‘
        $partnerService->dao->inc($partnerInfo['id'], 'total_commission', $commissionAmount);
    }
    
    /**
     * è®°å½•åˆ†çº¢æ˜ç»†
     */
    protected function recordCommission($data)
    {
        // è¿™é‡Œéœ€è¦åˆ›å»ºä¸€ä¸ªåˆ†çº¢è®°å½•è¡¨
        // eb_partner_commission
        return app()->make(\app\dao\partner\PartnerCommissionDao::class)->save($data);
    }
}
```

### 5.6 å®šæ—¶ä»»åŠ¡å¤„ç†

åˆ›å»ºå®šæ—¶ä»»åŠ¡å¤„ç†åˆä¼™äººæƒç›Šåˆ°æœŸï¼š

```php
// åˆ›å»ºæ–‡ä»¶ï¼šapp/jobs/partner/PartnerExpireJob.php
<?php
namespace app\jobs\partner;

use crmeb\basic\BaseJobs;
use app\services\partner\PartnerServices;

/**
 * åˆä¼™äººåˆ°æœŸå¤„ç†ä»»åŠ¡
 * å°±åƒæ¯å¤©æ£€æŸ¥ä¼šå‘˜å¡æ˜¯å¦è¿‡æœŸ
 */
class PartnerExpireJob extends BaseJobs
{
    /**
     * æ‰§è¡Œä»»åŠ¡
     */
    public function doJob()
    {
        $partnerService = app()->make(PartnerServices::class);
        
        // æŸ¥æ‰¾å³å°†åˆ°æœŸçš„åˆä¼™äººï¼ˆ3å¤©å†…ï¼‰
        $expiringSoon = $partnerService->dao->getModel()
            ->where('status', 1)
            ->where('expire_time', '<=', time() + 3 * 86400)
            ->where('expire_time', '>', time())
            ->select();
        
        // å‘é€åˆ°æœŸæé†’
        foreach ($expiringSoon as $partner) {
            $this->sendExpireReminder($partner);
        }
        
        // å¤„ç†å·²åˆ°æœŸçš„åˆä¼™äºº
        $expired = $partnerService->dao->getModel()
            ->where('status', 1)
            ->where('expire_time', '<=', time())
            ->select();
        
        foreach ($expired as $partner) {
            // æ›´æ–°çŠ¶æ€ä¸ºè¿‡æœŸ
            $partnerService->dao->update($partner['id'], ['status' => 3]);
            
            // å‘é€è¿‡æœŸé€šçŸ¥
            $this->sendExpiredNotice($partner);
        }
        
        return true;
    }
    
    /**
     * å‘é€å³å°†åˆ°æœŸæé†’
     */
    protected function sendExpireReminder($partner)
    {
        // è°ƒç”¨æ¶ˆæ¯æœåŠ¡å‘é€æé†’
        // å¯ä»¥æ˜¯çŸ­ä¿¡ã€å¾®ä¿¡æ¨¡æ¿æ¶ˆæ¯ç­‰
    }
    
    /**
     * å‘é€è¿‡æœŸé€šçŸ¥
     */
    protected function sendExpiredNotice($partner)
    {
        // å‘é€è¿‡æœŸé€šçŸ¥
    }
}
```

### 5.7 æœ¬ç« ç»ƒä¹ 

1. **åŠŸèƒ½å®ç°**ï¼š
   - å®Œæˆåˆä¼™äººå‡çº§å•†å“çš„é…ç½®åŠŸèƒ½
   - å®ç°åˆä¼™äººåˆ°æœŸè‡ªåŠ¨ç»­è´¹åŠŸèƒ½
   - æ·»åŠ åˆä¼™äººç­‰çº§å˜æ›´è®°å½•

2. **æ€è€ƒé¢˜**ï¼š
   - å¦‚ä½•é˜²æ­¢ç”¨æˆ·é‡å¤å‡çº§åˆä¼™äººï¼Ÿ
   - å¦‚ä½•å¤„ç†åˆä¼™äººé™çº§çš„æƒ…å†µï¼Ÿ

3. **æ‰©å±•ä»»åŠ¡**ï¼š
   - å®ç°åˆä¼™äººä¸“å±å•†å“åŠŸèƒ½
   - æ·»åŠ åˆä¼™äººä¸šç»©æ’è¡Œæ¦œ
   - å®ç°å›¢é˜Ÿç®¡ç†åŠŸèƒ½

---

## ç¬¬å…­ç« ï¼šç¤¼å“å¡ç³»ç»Ÿå¼€å‘ - åˆ›é€ è™šæ‹Ÿä»·å€¼

### 6.1 ç†è§£ç¤¼å“å¡ç³»ç»Ÿ

ç¤¼å“å¡å°±åƒå•†åœºçš„**è´­ç‰©å¡**ï¼Œä½†æˆ‘ä»¬çš„æ›´ç‰¹åˆ«ï¼š
- ğŸ **å•†å“ç¤¼å“å¡**ï¼šåªèƒ½å…‘æ¢ç‰¹å®šå•†å“ï¼Œåƒä¸“æŸœè´­ç‰©åˆ¸
- ğŸ¯ **åˆ†é”€ç¤¼å“å¡**ï¼šåˆ†é”€å¥–åŠ±å‘æ”¾ï¼Œå¥–åŠ±çš„æ˜¯å•†å“è€Œä¸æ˜¯ç°é‡‘

### 6.2 ç¤¼å“å¡ç”Ÿæˆç³»ç»Ÿ

#### 6.2.1 åˆ›å»ºç¤¼å“å¡ç”ŸæˆæœåŠ¡

```php
// åˆ›å»ºæ–‡ä»¶ï¼šapp/services/giftcard/GiftCardServices.php
<?php
namespace app\services\giftcard;

use app\services\BaseServices;
use app\dao\giftcard\GiftCardDao;

class GiftCardServices extends BaseServices
{
    public function __construct(GiftCardDao $dao)
    {
        $this->dao = $dao;
    }
    
    /**
     * æ‰¹é‡ç”Ÿæˆç¤¼å“å¡
     * å°±åƒå°åˆ·ä¸€æ‰¹è´­ç‰©åˆ¸
     */
    public function batchGenerate($data)
    {
        // æå–å‚æ•°
        $productId = $data['product_id'];      // å•†å“ID
        $quantity = $data['quantity'];         // ç”Ÿæˆæ•°é‡
        $expireDays = $data['expire_days'];   // æœ‰æ•ˆå¤©æ•°
        $batchId = $this->generateBatchId();   // æ‰¹æ¬¡å·
        
        // è·å–å•†å“ä¿¡æ¯
        $productService = app()->make(\app\services\product\product\StoreProductServices::class);
        $product = $productService->get($productId);
        
        if (!$product) {
            throw new \Exception('å•†å“ä¸å­˜åœ¨');
        }
        
        $cards = [];
        $successCount = 0;
        
        // å¾ªç¯ç”Ÿæˆå¡ç‰‡
        for ($i = 0; $i < $quantity; $i++) {
            // ç”Ÿæˆå”¯ä¸€çš„å¡å·å’Œå¯†ç 
            $cardCode = $this->generateCardCode();
            $cardPassword = $this->generateCardPassword();
            
            // ç¡®ä¿å¡å·å”¯ä¸€
            while ($this->dao->count(['card_code' => $cardCode]) > 0) {
                $cardCode = $this->generateCardCode();
            }
            
            $cardData = [
                'card_code' => $cardCode,
                'card_password' => $cardPassword,
                'card_type' => 1,  // å•†å“å¡
                'product_id' => $productId,
                'product_name' => $product['store_name'],
                'product_image' => $product['image'],
                'batch_id' => $batchId,
                'source_type' => 1,  // ç®¡ç†å‘˜å‘æ”¾
                'status' => 1,  // æœªä½¿ç”¨
                'expire_time' => time() + $expireDays * 86400,
                'create_time' => time()
            ];
            
            if ($this->dao->save($cardData)) {
                $successCount++;
                $cards[] = [
                    'card_code' => $cardCode,
                    'card_password' => $cardPassword
                ];
            }
        }
        
        return [
            'batch_id' => $batchId,
            'total' => $quantity,
            'success' => $successCount,
            'cards' => $cards
        ];
    }
    
    /**
     * ç”Ÿæˆæ‰¹æ¬¡å·
     * æ ¼å¼ï¼šGC + å¹´æœˆæ—¥ + 4ä½éšæœºæ•°
     */
    protected function generateBatchId()
    {
        return 'GC' . date('Ymd') . rand(1000, 9999);
    }
    
    /**
     * ç”Ÿæˆå¡å·
     * 16ä½æ•°å­—ï¼Œåƒé“¶è¡Œå¡å·
     */
    protected function generateCardCode()
    {
        // å‰ç¼€ï¼ˆ4ä½ï¼‰ + æ—¶é—´æˆ³å8ä½ + éšæœº4ä½
        $prefix = '8888';  // å‰åˆ©æ•°å­—
        $timestamp = substr(time(), -8);
        $random = rand(1000, 9999);
        
        return $prefix . $timestamp . $random;
    }
    
    /**
     * ç”Ÿæˆå¡å¯†
     * 12ä½å­—æ¯æ•°å­—ç»„åˆ
     */
    protected function generateCardPassword()
    {
        $chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
        $password = '';
        
        for ($i = 0; i < 12; $i++) {
            if ($i > 0 && $i % 4 == 0) {
                $password .= '-';  // æ¯4ä½åŠ ä¸ªæ¨ªçº¿ï¼Œæ–¹ä¾¿è¾“å…¥
            }
            $password .= $chars[rand(0, strlen($chars) - 1)];
        }
        
        return $password;
    }
    
    /**
     * ä½¿ç”¨ç¤¼å“å¡
     * å°±åƒåˆ·è´­ç‰©å¡ç»“è´¦
     */
    public function useCard($userId, $cardCode, $cardPassword)
    {
        // æŸ¥æ‰¾ç¤¼å“å¡
        $card = $this->dao->getOne([
            'card_code' => $cardCode,
            'card_password' => $cardPassword
        ]);
        
        if (!$card) {
            throw new \Exception('ç¤¼å“å¡å·æˆ–å¯†ç é”™è¯¯');
        }
        
        // æ£€æŸ¥çŠ¶æ€
        if ($card['status'] != 1) {
            $statusText = ['', 'æœªä½¿ç”¨', 'å·²ä½¿ç”¨', 'å·²è¿‡æœŸ'];
            throw new \Exception('è¯¥ç¤¼å“å¡' . $statusText[$card['status']]);
        }
        
        // æ£€æŸ¥æ˜¯å¦è¿‡æœŸ
        if ($card['expire_time'] < time()) {
            $this->dao->update($card['id'], ['status' => 3]);
            throw new \Exception('ç¤¼å“å¡å·²è¿‡æœŸ');
        }
        
        // ç»‘å®šç”¨æˆ·
        if (!$card['user_id']) {
            $this->dao->update($card['id'], ['user_id' => $userId]);
        } elseif ($card['user_id'] != $userId) {
            throw new \Exception('è¯¥ç¤¼å“å¡å·²è¢«å…¶ä»–ç”¨æˆ·ç»‘å®š');
        }
        
        return $card;
    }
    
    /**
     * åˆ›å»ºåˆ†é”€å¥–åŠ±ç¤¼å“å¡
     * è€ç”¨æˆ·åˆ†é”€æˆåŠŸåè°ƒç”¨
     */
    public function createDistributionCard($userId, $productId)
    {
        // è·å–å•†å“ä¿¡æ¯
        $productService = app()->make(\app\services\product\product\StoreProductServices::class);
        $product = $productService->get($productId);
        
        // ç”Ÿæˆç¤¼å“å¡
        $cardData = [
            'card_code' => $this->generateCardCode(),
            'card_password' => $this->generateCardPassword(),
            'card_type' => 2,  // åˆ†é”€å¡
            'product_id' => $productId,
            'product_name' => $product['store_name'],
            'product_image' => $product['image'],
            'user_id' => $userId,  // ç›´æ¥ç»‘å®šç”¨æˆ·
            'source_type' => 2,  // åˆ†é”€å¥–åŠ±
            'status' => 1,
            'expire_time' => time() + 365 * 86400,  // ä¸€å¹´æœ‰æ•ˆæœŸ
            'create_time' => time()
        ];
        
        $this->dao->save($cardData);
        
        // å‘é€é€šçŸ¥
        $this->sendGiftCardNotice($userId, $cardData);
        
        return $cardData;
    }
}
```

#### 6.2.2 åˆ›å»ºç¤¼å“å¡ç®¡ç†æ§åˆ¶å™¨

```php
// åˆ›å»ºæ–‡ä»¶ï¼šapp/adminapi/controller/v1/giftcard/GiftCard.php
<?php
namespace app\adminapi\controller\v1\giftcard;

use app\adminapi\controller\AuthController;
use app\services\giftcard\GiftCardServices;

class GiftCard extends AuthController
{
    protected $services;
    
    public function __construct(App $app, GiftCardServices $services)
    {
        parent::__construct($app);
        $this->services = $services;
    }
    
    /**
     * ç¤¼å“å¡åˆ—è¡¨
     */
    public function index()
    {
        $where = $this->request->getMore([
            ['card_code', ''],
            ['batch_id', ''],
            ['status', ''],
            ['card_type', ''],
            ['page', 1],
            ['limit', 10]
        ]);
        
        $list = $this->services->getList($where);
        
        return app('json')->success($list);
    }
    
    /**
     * æ‰¹é‡ç”Ÿæˆç¤¼å“å¡
     */
    public function batchGenerate()
    {
        $data = $this->request->postMore([
            ['product_id', 0],
            ['quantity', 10],
            ['expire_days', 365]
        ]);
        
        // éªŒè¯
        if (!$data['product_id']) {
            return app('json')->fail('è¯·é€‰æ‹©å•†å“');
        }
        
        if ($data['quantity'] < 1 || $data['quantity'] > 1000) {
            return app('json')->fail('ç”Ÿæˆæ•°é‡å¿…é¡»åœ¨1-1000ä¹‹é—´');
        }
        
        $result = $this->services->batchGenerate($data);
        
        return app('json')->success('ç”ŸæˆæˆåŠŸ', $result);
    }
    
    /**
     * å¯¼å‡ºç¤¼å“å¡
     * å¯¼å‡ºä¸ºExcelï¼Œæ–¹ä¾¿æ‰“å°æˆ–åˆ†å‘
     */
    public function export()
    {
        $batchId = $this->request->get('batch_id');
        
        if (!$batchId) {
            return app('json')->fail('è¯·é€‰æ‹©æ‰¹æ¬¡');
        }
        
        // è·å–è¯¥æ‰¹æ¬¡çš„ç¤¼å“å¡
        $cards = $this->services->dao->getList(['batch_id' => $batchId]);
        
        // ç”ŸæˆExcel
        $excel = new \PhpOffice\PhpSpreadsheet\Spreadsheet();
        $sheet = $excel->getActiveSheet();
        
        // è®¾ç½®è¡¨å¤´
        $sheet->setCellValue('A1', 'å¡å·');
        $sheet->setCellValue('B1', 'å¯†ç ');
        $sheet->setCellValue('C1', 'å•†å“åç§°');
        $sheet->setCellValue('D1', 'æœ‰æ•ˆæœŸ');
        $sheet->setCellValue('E1', 'çŠ¶æ€');
        
        // å¡«å……æ•°æ®
        $row = 2;
        foreach ($cards as $card) {
            $sheet->setCellValue('A' . $row, $card['card_code']);
            $sheet->setCellValue('B' . $row, $card['card_password']);
            $sheet->setCellValue('C' . $row, $card['product_name']);
            $sheet->setCellValue('D' . $row, date('Y-m-d', $card['expire_time']));
            $sheet->setCellValue('E' . $row, $card['status'] == 1 ? 'æœªä½¿ç”¨' : 'å·²ä½¿ç”¨');
            $row++;
        }
        
        // è¾“å‡ºä¸‹è½½
        $filename = 'ç¤¼å“å¡_' . $batchId . '.xlsx';
        header('Content-Type: application/vnd.openxmlformats-officedocument.spreadsheetml.sheet');
        header('Content-Disposition: attachment;filename="' . $filename . '"');
        
        $writer = new \PhpOffice\PhpSpreadsheet\Writer\Xlsx($excel);
        $writer->save('php://output');
    }
}
```

### 6.3 ç¤¼å“å¡ä½¿ç”¨æµç¨‹

#### 6.3.1 å°ç¨‹åºç«¯ç¤¼å“å¡ä¸­å¿ƒ

```vue
<!-- åˆ›å»ºæ–‡ä»¶ï¼štemplate/uni-app/pages/giftcard/index.vue -->
<template>
  <view class="giftcard-page">
    <!-- é¡¶éƒ¨æ ‡ç­¾ -->
    <view class="tabs">
      <view class="tab" 
            :class="{active: currentTab === 'unused'}"
            @click="switchTab('unused')">
        æœªä½¿ç”¨({{ unusedCount }})
      </view>
      <view class="tab" 
            :class="{active: currentTab === 'used'}"
            @click="switchTab('used')">
        å·²ä½¿ç”¨({{ usedCount }})
      </view>
      <view class="tab" 
            :class="{active: currentTab === 'expired'}"
            @click="switchTab('expired')">
        å·²è¿‡æœŸ({{ expiredCount }})
      </view>
    </view>
    
    <!-- æ·»åŠ ç¤¼å“å¡æŒ‰é’® -->
    <view class="add-card" @click="showAddDialog = true">
      <text class="iconfont icon-add"></text>
      <text>æ·»åŠ ç¤¼å“å¡</text>
    </view>
    
    <!-- ç¤¼å“å¡åˆ—è¡¨ -->
    <view class="card-list">
      <view class="card-item" 
            v-for="card in cardList" 
            :key="card.id"
            :class="{disabled: card.status !== 1}">
        
        <!-- å¡ç‰‡ä¸»ä½“ -->
        <view class="card-body">
          <image :src="card.product_image" class="product-img"></image>
          <view class="card-info">
            <view class="product-name">{{ card.product_name }}</view>
            <view class="card-code">å¡å·ï¼š{{ formatCardCode(card.card_code) }}</view>
            <view class="expire-time">
              æœ‰æ•ˆæœŸè‡³ï¼š{{ card.expire_time_text }}
            </view>
          </view>
          <view class="card-status">
            <text v-if="card.status === 1" class="status-unused">æœªä½¿ç”¨</text>
            <text v-if="card.status === 2" class="status-used">å·²ä½¿ç”¨</text>
            <text v-if="card.status === 3" class="status-expired">å·²è¿‡æœŸ</text>
          </view>
        </view>
        
        <!-- ä½¿ç”¨æŒ‰é’® -->
        <view class="card-action" v-if="card.status === 1">
          <button class="use-btn" @click="useCard(card)">ç«‹å³ä½¿ç”¨</button>
        </view>
      </view>
    </view>
    
    <!-- æ·»åŠ ç¤¼å“å¡å¼¹çª— -->
    <uni-popup ref="addDialog" type="bottom">
      <view class="add-dialog">
        <view class="dialog-title">æ·»åŠ ç¤¼å“å¡</view>
        <view class="input-group">
          <input v-model="cardForm.card_code" 
                 placeholder="è¯·è¾“å…¥16ä½å¡å·"
                 maxlength="16"
                 type="number" />
        </view>
        <view class="input-group">
          <input v-model="cardForm.card_password" 
                 placeholder="è¯·è¾“å…¥å¡å¯†ï¼ˆå«æ¨ªçº¿ï¼‰"
                 maxlength="15" />
        </view>
        <view class="dialog-tips">
          æç¤ºï¼šå¡å¯†æ ¼å¼ä¸º XXXX-XXXX-XXXX
        </view>
        <view class="dialog-btns">
          <button class="btn-cancel" @click="$refs.addDialog.close()">å–æ¶ˆ</button>
          <button class="btn-confirm" @click="addCard">ç¡®å®š</button>
        </view>
      </view>
    </uni-popup>
  </view>
</template>

<script>
import { getMyGiftCards, bindGiftCard } from '@/api/giftcard.js'

export default {
  data() {
    return {
      currentTab: 'unused',
      cardList: [],
      unusedCount: 0,
      usedCount: 0,
      expiredCount: 0,
      showAddDialog: false,
      cardForm: {
        card_code: '',
        card_password: ''
      }
    }
  },
  
  onLoad() {
    this.loadCards()
  },
  
  methods: {
    // åŠ è½½ç¤¼å“å¡åˆ—è¡¨
    async loadCards() {
      const res = await getMyGiftCards({
        status: this.getStatusByTab()
      })
      
      this.cardList = res.data.list
      this.unusedCount = res.data.unused_count
      this.usedCount = res.data.used_count
      this.expiredCount = res.data.expired_count
    },
    
    // æ ¼å¼åŒ–å¡å·æ˜¾ç¤º
    formatCardCode(code) {
      // 1234 5678 9012 3456
      return code.replace(/(\d{4})(?=\d)/g, '$1 ')
    },
    
    // ä½¿ç”¨ç¤¼å“å¡
    useCard(card) {
      uni.navigateTo({
        url: `/pages/goods/goods?id=${card.product_id}&gift_card_id=${card.id}`
      })
    },
    
    // æ·»åŠ ç¤¼å“å¡
    async addCard() {
      if (!this.cardForm.card_code || !this.cardForm.card_password) {
        uni.showToast({
          title: 'è¯·è¾“å…¥å®Œæ•´ä¿¡æ¯',
          icon: 'none'
        })
        return
      }
      
      try {
        await bindGiftCard(this.cardForm)
        uni.showToast({
          title: 'æ·»åŠ æˆåŠŸ',
          icon: 'success'
        })
        this.$refs.addDialog.close()
        this.cardForm = {
          card_code: '',
          card_password: ''
        }
        this.loadCards()
      } catch (error) {
        uni.showToast({
          title: error.message || 'æ·»åŠ å¤±è´¥',
          icon: 'none'
        })
      }
    }
  }
}
</script>

<style lang="scss">
.giftcard-page {
  background: #f5f5f5;
  min-height: 100vh;
  
  .tabs {
    display: flex;
    background: #fff;
    
    .tab {
      flex: 1;
      text-align: center;
      padding: 30rpx 0;
      font-size: 30rpx;
      color: #666;
      position: relative;
      
      &.active {
        color: #ff6b6b;
        
        &::after {
          content: '';
          position: absolute;
          bottom: 0;
          left: 50%;
          transform: translateX(-50%);
          width: 60rpx;
          height: 4rpx;
          background: #ff6b6b;
        }
      }
    }
  }
  
  .add-card {
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 20rpx;
    padding: 20rpx;
    background: #fff;
    border-radius: 10rpx;
    color: #ff6b6b;
    font-size: 30rpx;
    
    .iconfont {
      margin-right: 10rpx;
    }
  }
  
  .card-list {
    padding: 0 20rpx;
    
    .card-item {
      background: #fff;
      border-radius: 20rpx;
      margin-bottom: 20rpx;
      overflow: hidden;
      
      &.disabled {
        opacity: 0.6;
      }
      
      .card-body {
        display: flex;
        padding: 30rpx;
        
        .product-img {
          width: 160rpx;
          height: 160rpx;
          border-radius: 10rpx;
        }
        
        .card-info {
          flex: 1;
          margin-left: 30rpx;
          
          .product-name {
            font-size: 32rpx;
            font-weight: bold;
            margin-bottom: 20rpx;
          }
          
          .card-code {
            font-size: 26rpx;
            color: #666;
            margin-bottom: 10rpx;
          }
          
          .expire-time {
            font-size: 24rpx;
            color: #999;
          }
        }
        
        .card-status {
          .status-unused {
            color: #07c160;
          }
          
          .status-used {
            color: #999;
          }
          
          .status-expired {
            color: #ff6b6b;
          }
        }
      }
      
      .card-action {
        padding: 20rpx 30rpx;
        border-top: 1rpx solid #f5f5f5;
        
        .use-btn {
          width: 100%;
          height: 70rpx;
          background: linear-gradient(45deg, #ff6b6b, #ff8e53);
          color: #fff;
          font-size: 30rpx;
          border-radius: 35rpx;
        }
      }
    }
  }
  
  .add-dialog {
    background: #fff;
    padding: 40rpx;
    border-radius: 20rpx 20rpx 0 0;
    
    .dialog-title {
      font-size: 36rpx;
      font-weight: bold;
      text-align: center;
      margin-bottom: 40rpx;
    }
    
    .input-group {
      margin-bottom: 30rpx;
      
      input {
        width: 100%;
        height: 88rpx;
        padding: 0 30rpx;
        border: 2rpx solid #e5e5e5;
        border-radius: 10rpx;
        font-size: 30rpx;
      }
    }
    
    .dialog-tips {
      font-size: 24rpx;
      color: #999;
      margin-bottom: 40rpx;
    }
    
    .dialog-btns {
      display: flex;
      
      button {
        flex: 1;
        height: 88rpx;
        font-size: 32rpx;
        border-radius: 44rpx;
        
        &.btn-cancel {
          background: #f5f5f5;
          color: #666;
          margin-right: 20rpx;
        }
        
        &.btn-confirm {
          background: linear-gradient(45deg, #ff6b6b, #ff8e53);
          color: #fff;
        }
      }
    }
  }
}
</style>
```

### 6.4 ç¤¼å“å¡å…‘æ¢æµç¨‹

#### 6.4.1 åˆ›å»ºç¤¼å“å¡å…‘æ¢æœåŠ¡

```php
// ä¿®æ”¹æ–‡ä»¶ï¼šapp/services/order/StoreOrderServices.php
// æ·»åŠ ç¤¼å“å¡å…‘æ¢è®¢å•æ–¹æ³•

/**
 * ä½¿ç”¨ç¤¼å“å¡åˆ›å»ºè®¢å•
 * å°±åƒç”¨è´­ç‰©åˆ¸ç›´æ¥æ¢å•†å“
 */
public function createGiftCardOrder($uid, $giftCardId, $addressId)
{
    // è·å–ç¤¼å“å¡ä¿¡æ¯
    $giftCardService = app()->make(\app\services\giftcard\GiftCardServices::class);
    $giftCard = $giftCardService->dao->get($giftCardId);
    
    if (!$giftCard) {
        throw new \Exception('ç¤¼å“å¡ä¸å­˜åœ¨');
    }
    
    if ($giftCard['user_id'] != $uid) {
        throw new \Exception('è¿™ä¸æ˜¯æ‚¨çš„ç¤¼å“å¡');
    }
    
    if ($giftCard['status'] != 1) {
        throw new \Exception('ç¤¼å“å¡å·²ä½¿ç”¨æˆ–å·²è¿‡æœŸ');
    }
    
    // è·å–å•†å“ä¿¡æ¯
    $productService = app()->make(\app\services\product\product\StoreProductServices::class);
    $product = $productService->get($giftCard['product_id']);
    
    if (!$product || !$product['is_show'] || !$product['is_del']) {
        throw new \Exception('å•†å“å·²ä¸‹æ¶');
    }
    
    // åˆ›å»ºè®¢å•æ•°æ®
    $orderInfo = [
        'uid' => $uid,
        'order_id' => $this->getNewOrderId(),  // ç”Ÿæˆè®¢å•å·
        'real_name' => '',  // ä»åœ°å€è·å–
        'user_phone' => '',
        'user_address' => '',
        'cart_id' => [],
        'total_num' => 1,
        'total_price' => $product['price'],
        'pay_price' => 0,  // ç¤¼å“å¡å…‘æ¢ï¼Œæ”¯ä»˜é‡‘é¢ä¸º0
        'paid' => 1,  // å·²æ”¯ä»˜
        'pay_type' => 'giftcard',  // æ”¯ä»˜æ–¹å¼ï¼šç¤¼å“å¡
        'pay_time' => time(),
        'deduction_price' => $product['price'],  // æŠµæ‰£é‡‘é¢
        'coupon_price' => 0,
        'is_gift_card' => 1,  // æ ‡è®°ä¸ºç¤¼å“å¡è®¢å•
        'gift_card_id' => $giftCardId,
        'mark' => 'ç¤¼å“å¡å…‘æ¢è®¢å•',
        'add_time' => time()
    ];
    
    // å¼€å¯äº‹åŠ¡
    $this->transaction(function () use ($orderInfo, $giftCard, $product) {
        // 1. åˆ›å»ºè®¢å•
        $order = $this->dao->save($orderInfo);
        
        // 2. åˆ›å»ºè®¢å•å•†å“
        $this->dao->saveOrderCart($order['id'], [
            [
                'product_id' => $product['id'],
                'cart_info' => $product->toArray(),
                'cart_num' => 1,
                'unique' => $product['unique'] ?? ''
            ]
        ]);
        
        // 3. æ›´æ–°ç¤¼å“å¡çŠ¶æ€
        $giftCardService->dao->update($giftCard['id'], [
            'status' => 2,  // å·²ä½¿ç”¨
            'use_time' => time(),
            'use_order_id' => $orderInfo['order_id']
        ]);
        
        // 4. å‡å°‘å•†å“åº“å­˜
        $productService->decStock([$product['id'] => 1]);
        
        // 5. è®°å½•ä½¿ç”¨æ—¥å¿—
        $this->recordGiftCardUseLog($uid, $giftCard, $order);
    });
    
    return $orderInfo;
}
```

### 6.5 ç¤¼å“å¡ç»Ÿè®¡ä¸æŠ¥è¡¨

#### 6.5.1 åˆ›å»ºç»Ÿè®¡æœåŠ¡

```php
// åˆ›å»ºæ–‡ä»¶ï¼šapp/services/giftcard/GiftCardStatisticsServices.php
<?php
namespace app\services\giftcard;

use app\services\BaseServices;

class GiftCardStatisticsServices extends BaseServices
{
    /**
     * è·å–ç¤¼å“å¡ç»Ÿè®¡æ•°æ®
     * å°±åƒæŸ¥çœ‹è´­ç‰©åˆ¸çš„ä½¿ç”¨æŠ¥è¡¨
     */
    public function getStatistics($where = [])
    {
        $giftCardDao = app()->make(\app\dao\giftcard\GiftCardDao::class);
        
        // æ€»ä½“ç»Ÿè®¡
        $total = [
            'total_count' => $giftCardDao->count(),  // æ€»æ•°é‡
            'unused_count' => $giftCardDao->count(['status' => 1]),  // æœªä½¿ç”¨
            'used_count' => $giftCardDao->count(['status' => 2]),  // å·²ä½¿ç”¨
            'expired_count' => $giftCardDao->count(['status' => 3]),  // å·²è¿‡æœŸ
        ];
        
        // è®¡ç®—ä½¿ç”¨ç‡
        $total['use_rate'] = $total['total_count'] > 0 
            ? round($total['used_count'] / $total['total_count'] * 100, 2) 
            : 0;
        
        // æŒ‰å•†å“ç»Ÿè®¡
        $productStats = $giftCardDao->getModel()
            ->field('product_id, product_name, COUNT(*) as total, 
                    SUM(status = 1) as unused, 
                    SUM(status = 2) as used')
            ->group('product_id')
            ->select();
        
        // æŒ‰æ‰¹æ¬¡ç»Ÿè®¡
        $batchStats = $giftCardDao->getModel()
            ->field('batch_id, COUNT(*) as total, 
                    SUM(status = 1) as unused, 
                    SUM(status = 2) as used,
                    MIN(create_time) as create_time')
            ->where('batch_id', '<>', '')
            ->group('batch_id')
            ->order('create_time desc')
            ->select();
        
        // ä½¿ç”¨è¶‹åŠ¿ï¼ˆæœ€è¿‘30å¤©ï¼‰
        $trends = [];
        for ($i = 29; $i >= 0; $i--) {
            $date = date('Y-m-d', strtotime("-{$i} days"));
            $startTime = strtotime($date);
            $endTime = $startTime + 86400;
            
            $dayCount = $giftCardDao->count([
                ['use_time', '>=', $startTime],
                ['use_time', '<', $endTime],
                ['status', '=', 2]
            ]);
            
            $trends[] = [
                'date' => $date,
                'count' => $dayCount
            ];
        }
        
        return compact('total', 'productStats', 'batchStats', 'trends');
    }
    
    /**
     * å¯¼å‡ºä½¿ç”¨æŠ¥è¡¨
     */
    public function exportUsageReport($where)
    {
        // è·å–ä½¿ç”¨è®°å½•
        $list = app()->make(\app\dao\giftcard\GiftCardLogDao::class)
            ->getModel()
            ->with(['user', 'giftCard'])
            ->where($where)
            ->select();
        
        // ç”ŸæˆæŠ¥è¡¨æ•°æ®
        $reportData = [];
        foreach ($list as $item) {
            $reportData[] = [
                'ä½¿ç”¨æ—¶é—´' => date('Y-m-d H:i:s', $item['create_time']),
                'ç”¨æˆ·æ˜µç§°' => $item['user']['nickname'],
                'ç”¨æˆ·æ‰‹æœº' => $item['user']['phone'],
                'å¡å·' => $item['giftCard']['card_code'],
                'å•†å“åç§°' => $item['giftCard']['product_name'],
                'è®¢å•å·' => $item['order_id']
            ];
        }
        
        return $reportData;
    }
}
```

### 6.6 æœ¬ç« ç»ƒä¹ 

1. **åŠŸèƒ½å®ç°**ï¼š
   - å®ç°ç¤¼å“å¡æ‰¹é‡å‘æ”¾åŠŸèƒ½
   - æ·»åŠ ç¤¼å“å¡è½¬èµ åŠŸèƒ½
   - å®ç°ç¤¼å“å¡ä½™é¢åŠŸèƒ½ï¼ˆä¸€å¼ å¡å¤šæ¬¡ä½¿ç”¨ï¼‰

2. **æ€è€ƒé¢˜**ï¼š
   - å¦‚ä½•é˜²æ­¢ç¤¼å“å¡è¢«ç›—ç”¨ï¼Ÿ
   - å¦‚ä½•å¤„ç†ç¤¼å“å¡é€€æ¬¾é—®é¢˜ï¼Ÿ

3. **æ‰©å±•ä»»åŠ¡**ï¼š
   - è®¾è®¡ç”µå­ç¤¼å“å¡æ ·å¼
   - å®ç°ç¤¼å“å¡å……å€¼åŠŸèƒ½
   - æ·»åŠ ç¤¼å“å¡ä½¿ç”¨é™åˆ¶ï¼ˆå¦‚æŒ‡å®šæ—¶é—´ã€æŒ‡å®šç”¨æˆ·ç­‰ï¼‰

---

## ç¬¬ä¸ƒç« ï¼šå…ˆç”¨åä»˜ç³»ç»Ÿå¼€å‘ - å»ºç«‹ä¿¡ä»»ç»æµ

### 7.1 ç†è§£å…ˆç”¨åä»˜

å…ˆç”¨åä»˜å°±åƒ**ä¿¡ç”¨å¡è´­ç‰©**ï¼š
- ğŸ¦ **ä¿¡ç”¨é¢åº¦**ï¼šæ¯ä¸ªåˆä¼™äººéƒ½æœ‰ä¸€å®šçš„ä¿¡ç”¨é¢åº¦
- ğŸ“… **è´¦æœŸç®¡ç†**ï¼šå›ºå®šçš„è¿˜æ¬¾å‘¨æœŸï¼ˆå¦‚30å¤©ï¼‰
- âš ï¸ **é£é™©æ§åˆ¶**ï¼šé€¾æœŸç®¡ç†å’Œä¿¡ç”¨è¯„ä¼°

### 7.2 ä¿¡ç”¨ç³»ç»Ÿæ¶æ„è®¾è®¡

#### 7.2.1 åˆ›å»ºä¿¡ç”¨ç®¡ç†æœåŠ¡

```php
// åˆ›å»ºæ–‡ä»¶ï¼šapp/services/credit/UserCreditServices.php
<?php
namespace app\services\credit;

use app\services\BaseServices;
use app\dao\credit\UserCreditDao;

class UserCreditServices extends BaseServices
{
    public function __construct(UserCreditDao $dao)
    {
        $this->dao = $dao;
    }
    
    /**
     * åˆå§‹åŒ–ç”¨æˆ·ä¿¡ç”¨
     * å½“ç”¨æˆ·æˆä¸ºåˆä¼™äººæ—¶è°ƒç”¨
     */
    public function initUserCredit($userId, $partnerLevel)
    {
        // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨
        $credit = $this->dao->getOne(['user_id' => $userId]);
        if ($credit) {
            return $credit;
        }
        
        // æ ¹æ®åˆä¼™äººç­‰çº§è®¾ç½®ä¿¡ç”¨é¢åº¦
        $creditLimits = [
            1 => 1000.00,   // æ¢¦æƒ³åˆä¼™äºº
            2 => 5000.00,   // æˆ˜ç•¥åˆä¼™äºº
            3 => 10000.00   // åŸå¸‚åˆä¼™äºº
        ];
        
        $creditLimit = $creditLimits[$partnerLevel] ?? 0;
        
        // åˆ›å»ºä¿¡ç”¨è®°å½•
        $data = [
            'user_id' => $userId,
            'credit_limit' => $creditLimit,
            'used_credit' => 0,
            'available_credit' => $creditLimit,
            'credit_score' => 100,  // åˆå§‹ä¿¡ç”¨åˆ†
            'is_enabled' => 1,
            'status' => 1,
            'create_time' => time()
        ];
        
        return $this->dao->save($data);
    }
    
    /**
     * æ£€æŸ¥ä¿¡ç”¨é¢åº¦
     * ä¸‹å•æ—¶è°ƒç”¨ï¼Œæ£€æŸ¥æ˜¯å¦å¯ä»¥ä½¿ç”¨ä¿¡ç”¨æ”¯ä»˜
     */
    public function checkCreditLimit($userId, $amount)
    {
        $credit = $this->dao->getOne(['user_id' => $userId]);
        
        if (!$credit) {
            throw new \Exception('æ‚¨è¿˜æœªå¼€é€šä¿¡ç”¨æ”¯ä»˜');
        }
        
        if (!$credit['is_enabled']) {
            throw new \Exception('æ‚¨çš„ä¿¡ç”¨æ”¯ä»˜åŠŸèƒ½å·²è¢«ç¦ç”¨');
        }
        
        if ($credit['status'] != 1) {
            throw new \Exception('æ‚¨çš„ä¿¡ç”¨è´¦æˆ·çŠ¶æ€å¼‚å¸¸');
        }
        
        if ($credit['available_credit'] < $amount) {
            throw new \Exception('ä¿¡ç”¨é¢åº¦ä¸è¶³ï¼Œå¯ç”¨é¢åº¦ï¼šÂ¥' . $credit['available_credit']);
        }
        
        // æ£€æŸ¥æ˜¯å¦æœ‰é€¾æœŸæœªè¿˜
        $overdueCount = app()->make(CreditOrderServices::class)
            ->dao->count([
                'user_id' => $userId,
                'status' => 3  // é€¾æœŸçŠ¶æ€
            ]);
        
        if ($overdueCount > 0) {
            throw new \Exception('æ‚¨æœ‰é€¾æœŸæœªè¿˜æ¬¾é¡¹ï¼Œè¯·å…ˆè¿˜æ¬¾');
        }
        
        return true;
    }
    
    /**
     * ä½¿ç”¨ä¿¡ç”¨é¢åº¦
     * åˆ›å»ºä¿¡ç”¨è®¢å•æ—¶è°ƒç”¨
     */
    public function useCredit($userId, $amount, $orderId)
    {
        $credit = $this->dao->getOne(['user_id' => $userId]);
        
        // å†æ¬¡æ£€æŸ¥é¢åº¦
        if ($credit['available_credit'] < $amount) {
            throw new \Exception('ä¿¡ç”¨é¢åº¦ä¸è¶³');
        }
        
        // æ›´æ–°ä¿¡ç”¨é¢åº¦
        $this->dao->update($credit['id'], [
            'used_credit' => $credit['used_credit'] + $amount,
            'available_credit' => $credit['available_credit'] - $amount,
            'update_time' => time()
        ]);
        
        // è®°å½•ä¿¡ç”¨ä½¿ç”¨æ—¥å¿—
        $this->recordCreditLog($userId, 'use', $amount, $orderId);
        
        return true;
    }
    
    /**
     * è¿˜æ¬¾
     * ç”¨æˆ·è¿˜æ¬¾æ—¶è°ƒç”¨
     */
    public function repayment($userId, $amount, $creditOrderId)
    {
        $credit = $this->dao->getOne(['user_id' => $userId]);
        
        // æ›´æ–°ä¿¡ç”¨é¢åº¦
        $this->dao->update($credit['id'], [
            'used_credit' => max(0, $credit['used_credit'] - $amount),
            'available_credit' => min($credit['credit_limit'], $credit['available_credit'] + $amount),
            'update_time' => time()
        ]);
        
        // æ›´æ–°ä¿¡ç”¨åˆ†ï¼ˆæŒ‰æ—¶è¿˜æ¬¾åŠ åˆ†ï¼‰
        $this->updateCreditScore($userId, 5);
        
        // è®°å½•è¿˜æ¬¾æ—¥å¿—
        $this->recordCreditLog($userId, 'repay', $amount, $creditOrderId);
        
        return true;
    }
    
    /**
     * æ›´æ–°ä¿¡ç”¨åˆ†
     * æ­£åˆ†è¡¨ç¤ºåŠ åˆ†ï¼Œè´Ÿåˆ†è¡¨ç¤ºæ‰£åˆ†
     */
    public function updateCreditScore($userId, $score)
    {
        $credit = $this->dao->getOne(['user_id' => $userId]);
        
        $newScore = max(0, min(150, $credit['credit_score'] + $score));
        
        $this->dao->update($credit['id'], [
            'credit_score' => $newScore,
            'update_time' => time()
        ]);
        
        // æ ¹æ®ä¿¡ç”¨åˆ†è°ƒæ•´é¢åº¦
        $this->adjustCreditLimit($userId, $newScore);
    }
    
    /**
     * æ ¹æ®ä¿¡ç”¨åˆ†è°ƒæ•´é¢åº¦
     * ä¿¡ç”¨åˆ†é«˜çš„ç”¨æˆ·å¯ä»¥è·å¾—æ›´é«˜é¢åº¦
     */
    protected function adjustCreditLimit($userId, $creditScore)
    {
        $credit = $this->dao->getOne(['user_id' => $userId]);
        
        // è·å–åŸºç¡€é¢åº¦
        $partnerInfo = app()->make(\app\services\partner\PartnerServices::class)
            ->getPartnerInfo($userId);
        
        $baseLimits = [
            1 => 1000.00,
            2 => 5000.00,
            3 => 10000.00
        ];
        
        $baseLimit = $baseLimits[$partnerInfo['partner_level']] ?? 1000;
        
        // æ ¹æ®ä¿¡ç”¨åˆ†è®¡ç®—é¢åº¦å€æ•°
        $multiplier = 1.0;
        if ($creditScore >= 120) {
            $multiplier = 1.5;  // 150%
        } elseif ($creditScore >= 100) {
            $multiplier = 1.2;  // 120%
        } elseif ($creditScore < 80) {
            $multiplier = 0.5;  // 50%
        }
        
        $newLimit = round($baseLimit * $multiplier, 2);
        
        // æ›´æ–°é¢åº¦
        if ($newLimit != $credit['credit_limit']) {
            $availableChange = $newLimit - $credit['credit_limit'];
            
            $this->dao->update($credit['id'], [
                'credit_limit' => $newLimit,
                'available_credit' => max(0, $credit['available_credit'] + $availableChange)
            ]);
        }
    }
}
```

#### 7.2.2 åˆ›å»ºä¿¡ç”¨è®¢å•æœåŠ¡

```php
// åˆ›å»ºæ–‡ä»¶ï¼šapp/services/credit/CreditOrderServices.php
<?php
namespace app\services\credit;

use app\services\BaseServices;
use app\dao\credit\CreditOrderDao;

class CreditOrderServices extends BaseServices
{
    public function __construct(CreditOrderDao $dao)
    {
        $this->dao = $dao;
    }
    
    /**
     * åˆ›å»ºä¿¡ç”¨è®¢å•
     * å½“ç”¨æˆ·é€‰æ‹©å…ˆç”¨åä»˜æ—¶è°ƒç”¨
     */
    public function createCreditOrder($orderInfo)
    {
        // è®¡ç®—è¿˜æ¬¾æ—¶é—´ï¼ˆ30å¤©åï¼‰
        $repaymentTime = time() + 30 * 86400;
        
        $data = [
            'order_id' => $orderInfo['order_id'],
            'user_id' => $orderInfo['uid'],
            'credit_amount' => $orderInfo['pay_price'],
            'repayment_amount' => 0,
            'repayment_time' => $repaymentTime,
            'status' => 1,  // æœªè¿˜æ¬¾
            'create_time' => time()
        ];
        
        return $this->dao->save($data);
    }
    
    /**
     * å¤„ç†è¿˜æ¬¾
     * æ”¯æŒéƒ¨åˆ†è¿˜æ¬¾
     */
    public function processRepayment($creditOrderId, $amount)
    {
        $creditOrder = $this->dao->get($creditOrderId);
        
        if (!$creditOrder) {
            throw new \Exception('ä¿¡ç”¨è®¢å•ä¸å­˜åœ¨');
        }
        
        if ($creditOrder['status'] == 2) {
            throw new \Exception('è¯¥è®¢å•å·²è¿˜æ¸…');
        }
        
        // è®¡ç®—å‰©ä½™åº”è¿˜é‡‘é¢
        $remainAmount = $creditOrder['credit_amount'] - $creditOrder['repayment_amount'];
        $actualRepayAmount = min($amount, $remainAmount);
        
        // æ›´æ–°è¿˜æ¬¾é‡‘é¢
        $newRepaymentAmount = $creditOrder['repayment_amount'] + $actualRepayAmount;
        
        $updateData = [
            'repayment_amount' => $newRepaymentAmount,
            'update_time' => time()
        ];
        
        // å¦‚æœè¿˜æ¸…äº†
        if ($newRepaymentAmount >= $creditOrder['credit_amount']) {
            $updateData['status'] = 2;  // å·²è¿˜æ¬¾
            $updateData['actual_repayment_time'] = time();
        }
        
        $this->dao->update($creditOrderId, $updateData);
        
        // æ¢å¤ä¿¡ç”¨é¢åº¦
        $creditService = app()->make(UserCreditServices::class);
        $creditService->repayment($creditOrder['user_id'], $actualRepayAmount, $creditOrderId);
        
        return $actualRepayAmount;
    }
    
    /**
     * æ£€æŸ¥é€¾æœŸè®¢å•
     * å®šæ—¶ä»»åŠ¡è°ƒç”¨
     */
    public function checkOverdueOrders()
    {
        // æŸ¥æ‰¾æ‰€æœ‰æœªè¿˜æ¬¾ä¸”å·²è¿‡è¿˜æ¬¾æ—¶é—´çš„è®¢å•
        $overdueOrders = $this->dao->getModel()
            ->where('status', 1)
            ->where('repayment_time', '<', time())
            ->select();
        
        foreach ($overdueOrders as $order) {
            // è®¡ç®—é€¾æœŸå¤©æ•°
            $overdueDays = ceil((time() - $order['repayment_time']) / 86400);
            
            // æ›´æ–°è®¢å•çŠ¶æ€
            $this->dao->update($order['id'], [
                'status' => 3,  // é€¾æœŸ
                'overdue_days' => $overdueDays,
                'update_time' => time()
            ]);
            
            // æ‰£é™¤ä¿¡ç”¨åˆ†
            $creditService = app()->make(UserCreditServices::class);
            $creditService->updateCreditScore($order['user_id'], -10);
            
            // å‘é€é€¾æœŸæé†’
            $this->sendOverdueReminder($order);
        }
    }
    
    /**
     * å‘é€è¿˜æ¬¾æé†’
     * æå‰3å¤©æé†’
     */
    public function sendRepaymentReminder()
    {
        // æŸ¥æ‰¾3å¤©ååˆ°æœŸçš„è®¢å•
        $startTime = time() + 2 * 86400;  // 2å¤©å
        $endTime = time() + 4 * 86400;    // 4å¤©å
        
        $orders = $this->dao->getModel()
            ->where('status', 1)
            ->where('repayment_time', '>=', $startTime)
            ->where('repayment_time', '<', $endTime)
            ->where('remind_count', '<', 3)  // æœ€å¤šæé†’3æ¬¡
            ->select();
        
        foreach ($orders as $order) {
            // å‘é€æé†’
            $this->sendReminder($order, 'repayment');
            
            // æ›´æ–°æé†’æ¬¡æ•°
            $this->dao->inc($order['id'], 'remind_count');
            $this->dao->update($order['id'], [
                'last_remind_time' => time()
            ]);
        }
    }
    
    /**
     * å‘é€æé†’
     * ä½¿ç”¨çŸ­ä¿¡æˆ–å¾®ä¿¡æ¨¡æ¿æ¶ˆæ¯
     */
    protected function sendReminder($order, $type)
    {
        $userService = app()->make(\app\services\user\UserServices::class);
        $user = $userService->get($order['user_id']);
        
        if ($type == 'repayment') {
            // è¿˜æ¬¾æé†’
            $daysLeft = ceil(($order['repayment_time'] - time()) / 86400);
            $message = "ã€åº†äººåºœå•†åŸã€‘æ‚¨æœ‰ä¸€ç¬”ï¿¥{$order['credit_amount']}çš„ä¿¡ç”¨è®¢å•å°†åœ¨{$daysLeft}å¤©ååˆ°æœŸï¼Œè¯·åŠæ—¶è¿˜æ¬¾ã€‚";
        } else {
            // é€¾æœŸæé†’
            $message = "ã€åº†äººåºœå•†åŸã€‘æ‚¨æœ‰ä¸€ç¬”ï¿¥{$order['credit_amount']}çš„ä¿¡ç”¨è®¢å•å·²é€¾æœŸ{$order['overdue_days']}å¤©ï¼Œè¯·å°½å¿«è¿˜æ¬¾ä»¥å…å½±å“ä¿¡ç”¨ã€‚";
        }
        
        // å‘é€çŸ­ä¿¡
        if ($user['phone']) {
            app()->make(\app\services\message\SmsServices::class)
                ->send($user['phone'], $message);
        }
        
        // å‘é€å¾®ä¿¡æ¨¡æ¿æ¶ˆæ¯
        if ($user['openid']) {
            // è°ƒç”¨å¾®ä¿¡æ¨¡æ¿æ¶ˆæ¯æœåŠ¡
        }
    }
}
```

### 7.3 å‰ç«¯ä¿¡ç”¨æ”¯ä»˜ç•Œé¢

#### 7.3.1 è®¢å•ç¡®è®¤é¡µé¢æ·»åŠ ä¿¡ç”¨æ”¯ä»˜

```vue
<!-- ä¿®æ”¹æ–‡ä»¶ï¼štemplate/uni-app/pages/order/order-confirm.vue -->
<!-- åœ¨æ”¯ä»˜æ–¹å¼é€‰æ‹©éƒ¨åˆ†æ·»åŠ  -->

<template>
  <view class="order-confirm">
    <!-- å…¶ä»–å†…å®¹... -->
    
    <!-- æ”¯ä»˜æ–¹å¼é€‰æ‹© -->
    <view class="payment-section">
      <view class="section-title">æ”¯ä»˜æ–¹å¼</view>
      <view class="payment-list">
        <!-- å¾®ä¿¡æ”¯ä»˜ -->
        <view class="payment-item" @click="selectPayment('weixin')">
          <image src="/static/images/wechat-pay.png" class="pay-icon"></image>
          <text class="pay-name">å¾®ä¿¡æ”¯ä»˜</text>
          <view class="radio" :class="{active: payType === 'weixin'}"></view>
        </view>
        
        <!-- ä½™é¢æ”¯ä»˜ -->
        <view class="payment-item" @click="selectPayment('balance')">
          <image src="/static/images/balance-pay.png" class="pay-icon"></image>
          <text class="pay-name">ä½™é¢æ”¯ä»˜</text>
          <text class="balance">Â¥{{ userInfo.balance }}</text>
          <view class="radio" :class="{active: payType === 'balance'}"></view>
        </view>
        
        <!-- ä¿¡ç”¨æ”¯ä»˜ï¼ˆä»…åˆä¼™äººå¯è§ï¼‰ -->
        <view class="payment-item" 
              v-if="creditInfo && creditInfo.is_enabled"
              @click="selectPayment('credit')">
          <image src="/static/images/credit-pay.png" class="pay-icon"></image>
          <view class="pay-info">
            <text class="pay-name">å…ˆç”¨åä»˜</text>
            <text class="pay-desc">30å¤©å…æ¯ï¼Œå¯ç”¨é¢åº¦Â¥{{ creditInfo.available_credit }}</text>
          </view>
          <view class="radio" :class="{active: payType === 'credit'}"></view>
        </view>
      </view>
      
      <!-- ä¿¡ç”¨æ”¯ä»˜æç¤º -->
      <view class="credit-tips" v-if="payType === 'credit'">
        <view class="tips-title">
          <text class="iconfont icon-info"></text>
          <text>å…ˆç”¨åä»˜è¯´æ˜</text>
        </view>
        <view class="tips-content">
          <view>1. è®¢å•ç¡®è®¤æ”¶è´§å30å¤©å†…è¿˜æ¬¾ï¼Œæ— éœ€æ”¯ä»˜åˆ©æ¯</view>
          <view>2. åˆ°æœŸå‰3å¤©ä¼šå‘é€è¿˜æ¬¾æé†’</view>
          <view>3. é€¾æœŸå°†å½±å“æ‚¨çš„ä¿¡ç”¨é¢åº¦</view>
        </view>
      </view>
    </view>
    
    <!-- æäº¤è®¢å•æŒ‰é’® -->
    <view class="bottom-bar">
      <view class="total-info">
        <text class="label">éœ€æ”¯ä»˜ï¼š</text>
        <text class="price">Â¥{{ totalPrice }}</text>
      </view>
      <button class="submit-btn" @click="submitOrder">
        {{ payType === 'credit' ? 'ç¡®è®¤ä½¿ç”¨ä¿¡ç”¨æ”¯ä»˜' : 'æäº¤è®¢å•' }}
      </button>
    </view>
  </view>
</template>

<script>
import { getCreditInfo } from '@/api/credit.js'

export default {
  data() {
    return {
      payType: 'weixin',
      creditInfo: null,
      // ... å…¶ä»–æ•°æ®
    }
  },
  
  onLoad() {
    this.loadCreditInfo()
  },
  
  methods: {
    // åŠ è½½ä¿¡ç”¨ä¿¡æ¯
    async loadCreditInfo() {
      try {
        const res = await getCreditInfo()
        this.creditInfo = res.data
      } catch (error) {
        // éåˆä¼™äººä¸æ˜¾ç¤ºä¿¡ç”¨æ”¯ä»˜
      }
    },
    
    // é€‰æ‹©æ”¯ä»˜æ–¹å¼
    selectPayment(type) {
      if (type === 'credit' && this.totalPrice > this.creditInfo.available_credit) {
        uni.showToast({
          title: 'ä¿¡ç”¨é¢åº¦ä¸è¶³',
          icon: 'none'
        })
        return
      }
      this.payType = type
    },
    
    // æäº¤è®¢å•
    async submitOrder() {
      if (this.payType === 'credit') {
        // ä¿¡ç”¨æ”¯ä»˜ç¡®è®¤
        uni.showModal({
          title: 'ç¡®è®¤ä½¿ç”¨ä¿¡ç”¨æ”¯ä»˜',
          content: `æœ¬æ¬¡æ¶ˆè´¹Â¥${this.totalPrice}ï¼Œå°†ä»æ‚¨çš„ä¿¡ç”¨é¢åº¦ä¸­æ‰£é™¤ï¼Œè¯·åœ¨30å¤©å†…è¿˜æ¬¾ã€‚`,
          success: (res) => {
            if (res.confirm) {
              this.createOrder()
            }
          }
        })
      } else {
        this.createOrder()
      }
    }
  }
}
</script>

<style lang="scss">
.payment-section {
  background: #fff;
  margin: 20rpx 0;
  padding: 30rpx;
  
  .payment-item {
    display: flex;
    align-items: center;
    padding: 30rpx 0;
    border-bottom: 1rpx solid #f5f5f5;
    
    .pay-icon {
      width: 60rpx;
      height: 60rpx;
      margin-right: 20rpx;
    }
    
    .pay-info {
      flex: 1;
      
      .pay-name {
        font-size: 32rpx;
        display: block;
      }
      
      .pay-desc {
        font-size: 24rpx;
        color: #999;
        margin-top: 8rpx;
      }
    }
    
    .balance {
      color: #ff6b6b;
      margin-right: 20rpx;
    }
    
    .radio {
      width: 40rpx;
      height: 40rpx;
      border: 2rpx solid #ddd;
      border-radius: 50%;
      
      &.active {
        border-color: #ff6b6b;
        position: relative;
        
        &::after {
          content: '';
          position: absolute;
          top: 50%;
          left: 50%;
          transform: translate(-50%, -50%);
          width: 20rpx;
          height: 20rpx;
          background: #ff6b6b;
          border-radius: 50%;
        }
      }
    }
  }
  
  .credit-tips {
    margin-top: 30rpx;
    padding: 20rpx;
    background: #fff5f5;
    border-radius: 10rpx;
    
    .tips-title {
      display: flex;
      align-items: center;
      font-size: 28rpx;
      color: #ff6b6b;
      margin-bottom: 20rpx;
      
      .iconfont {
        margin-right: 10rpx;
      }
    }
    
    .tips-content {
      font-size: 24rpx;
      color: #666;
      
      view {
        margin-bottom: 10rpx;
      }
    }
  }
}
</style>
```

#### 7.3.2 ä¿¡ç”¨ç®¡ç†ä¸­å¿ƒ

```vue
<!-- åˆ›å»ºæ–‡ä»¶ï¼štemplate/uni-app/pages/credit/index.vue -->
<template>
  <view class="credit-center">
    <!-- ä¿¡ç”¨é¢åº¦å¡ç‰‡ -->
    <view class="credit-card">
      <view class="card-bg"></view>
      <view class="card-content">
        <view class="card-title">æˆ‘çš„ä¿¡ç”¨é¢åº¦</view>
        <view class="credit-info">
          <view class="amount-item">
            <view class="label">æ€»é¢åº¦</view>
            <view class="amount">Â¥{{ creditInfo.credit_limit }}</view>
          </view>
          <view class="amount-item">
            <view class="label">å·²ä½¿ç”¨</view>
            <view class="amount used">Â¥{{ creditInfo.used_credit }}</view>
          </view>
          <view class="amount-item">
            <view class="label">å¯ä½¿ç”¨</view>
            <view class="amount available">Â¥{{ creditInfo.available_credit }}</view>
          </view>
        </view>
        <view class="credit-score">
          <text>ä¿¡ç”¨åˆ†ï¼š</text>
          <text class="score">{{ creditInfo.credit_score }}</text>
          <text class="score-desc">{{ getCreditLevel(creditInfo.credit_score) }}</text>
        </view>
      </view>
    </view>
    
    <!-- å¾…è¿˜æ¬¾è®¢å• -->
    <view class="pending-section" v-if="pendingOrders.length > 0">
      <view class="section-header">
        <text class="title">å¾…è¿˜æ¬¾</text>
        <text class="count">{{ pendingOrders.length }}ç¬”</text>
      </view>
      
      <view class="order-list">
        <view class="order-item" 
              v-for="order in pendingOrders" 
              :key="order.id">
          <view class="order-info">
            <view class="order-no">è®¢å•å·ï¼š{{ order.order_id }}</view>
            <view class="order-time">{{ order.create_time_text }}</view>
          </view>
          <view class="order-amount">
            <view class="amount">Â¥{{ order.credit_amount }}</view>
            <view class="due-date" :class="{overdue: order.is_overdue}">
              {{ order.is_overdue ? 'å·²é€¾æœŸ' + order.overdue_days + 'å¤©' : order.days_left + 'å¤©ååˆ°æœŸ' }}
            </view>
          </view>
          <button class="repay-btn" @click="goRepay(order)">ç«‹å³è¿˜æ¬¾</button>
        </view>
      </view>
    </view>
    
    <!-- è¿˜æ¬¾è®°å½• -->
    <view class="record-section">
      <view class="section-header">
        <text class="title">è¿˜æ¬¾è®°å½•</text>
        <text class="more" @click="goRecords">æŸ¥çœ‹å…¨éƒ¨</text>
      </view>
      
      <view class="record-list">
        <view class="record-item" 
              v-for="record in recentRecords" 
              :key="record.id">
          <view class="record-info">
            <view class="record-title">è¿˜æ¬¾æˆåŠŸ</view>
            <view class="record-time">{{ record.create_time_text }}</view>
          </view>
          <view class="record-amount">-Â¥{{ record.amount }}</view>
        </view>
      </view>
    </view>
  </view>
</template>

<script>
import { getCreditInfo, getPendingOrders, getRepayRecords } from '@/api/credit.js'

export default {
  data() {
    return {
      creditInfo: {
        credit_limit: 0,
        used_credit: 0,
        available_credit: 0,
        credit_score: 100
      },
      pendingOrders: [],
      recentRecords: []
    }
  },
  
  onShow() {
    this.loadData()
  },
  
  methods: {
    async loadData() {
      // åŠ è½½ä¿¡ç”¨ä¿¡æ¯
      const creditRes = await getCreditInfo()
      this.creditInfo = creditRes.data
      
      // åŠ è½½å¾…è¿˜æ¬¾è®¢å•
      const ordersRes = await getPendingOrders()
      this.pendingOrders = ordersRes.data.list
      
      // åŠ è½½è¿˜æ¬¾è®°å½•
      const recordsRes = await getRepayRecords({ limit: 5 })
      this.recentRecords = recordsRes.data.list
    },
    
    // è·å–ä¿¡ç”¨ç­‰çº§æè¿°
    getCreditLevel(score) {
      if (score >= 120) return 'ä¿¡ç”¨æå¥½'
      if (score >= 100) return 'ä¿¡ç”¨è‰¯å¥½'
      if (score >= 80) return 'ä¿¡ç”¨ä¸€èˆ¬'
      return 'ä¿¡ç”¨è¾ƒå·®'
    },
    
    // å»è¿˜æ¬¾
    goRepay(order) {
      uni.navigateTo({
        url: `/pages/credit/repay?id=${order.id}`
      })
    },
    
    // æŸ¥çœ‹å…¨éƒ¨è®°å½•
    goRecords() {
      uni.navigateTo({
        url: '/pages/credit/records'
      })
    }
  }
}
</script>

<style lang="scss">
.credit-center {
  background: #f5f5f5;
  min-height: 100vh;
  padding-bottom: 20rpx;
  
  .credit-card {
    position: relative;
    margin: 20rpx;
    border-radius: 20rpx;
    overflow: hidden;
    box-shadow: 0 4rpx 20rpx rgba(0,0,0,0.1);
    
    .card-bg {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }
    
    .card-content {
      position: relative;
      padding: 40rpx;
      color: #fff;
      
      .card-title {
        font-size: 32rpx;
        margin-bottom: 40rpx;
      }
      
      .credit-info {
        display: flex;
        justify-content: space-between;
        margin-bottom: 40rpx;
        
        .amount-item {
          text-align: center;
          
          .label {
            font-size: 26rpx;
            opacity: 0.8;
            margin-bottom: 10rpx;
          }
          
          .amount {
            font-size: 36rpx;
            font-weight: bold;
            
            &.used {
              color: #ffd700;
            }
            
            &.available {
              color: #90ee90;
            }
          }
        }
      }
      
      .credit-score {
        text-align: center;
        font-size: 28rpx;
        
        .score {
          font-size: 48rpx;
          font-weight: bold;
          margin: 0 10rpx;
        }
        
        .score-desc {
          opacity: 0.8;
        }
      }
    }
  }
  
  .pending-section, .record-section {
    margin: 20rpx;
    background: #fff;
    border-radius: 20rpx;
    padding: 30rpx;
    
    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 30rpx;
      
      .title {
        font-size: 32rpx;
        font-weight: bold;
      }
      
      .count {
        color: #ff6b6b;
        font-size: 28rpx;
      }
      
      .more {
        color: #666;
        font-size: 28rpx;
      }
    }
    
    .order-item {
      display: flex;
      align-items: center;
      padding: 30rpx 0;
      border-bottom: 1rpx solid #f5f5f5;
      
      &:last-child {
        border-bottom: none;
      }
      
      .order-info {
        flex: 1;
        
        .order-no {
          font-size: 30rpx;
          margin-bottom: 10rpx;
        }
        
        .order-time {
          font-size: 26rpx;
          color: #999;
        }
      }
      
      .order-amount {
        text-align: right;
        margin-right: 30rpx;
        
        .amount {
          font-size: 36rpx;
          font-weight: bold;
          color: #333;
        }
        
        .due-date {
          font-size: 24rpx;
          color: #666;
          margin-top: 8rpx;
          
          &.overdue {
            color: #ff6b6b;
          }
        }
      }
      
      .repay-btn {
        width: 140rpx;
        height: 60rpx;
        background: linear-gradient(45deg, #667eea, #764ba2);
        color: #fff;
        font-size: 26rpx;
        border-radius: 30rpx;
      }
    }
    
    .record-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 20rpx 0;
      
      .record-info {
        .record-title {
          font-size: 30rpx;
          margin-bottom: 8rpx;
        }
        
        .record-time {
          font-size: 26rpx;
          color: #999;
        }
      }
      
      .record-amount {
        font-size: 32rpx;
        color: #ff6b6b;
        font-weight: bold;
      }
    }
  }
}
</style>
```

### 7.4 å®šæ—¶ä»»åŠ¡ç®¡ç†

#### 7.4.1 åˆ›å»ºä¿¡ç”¨ç®¡ç†å®šæ—¶ä»»åŠ¡

```php
// åˆ›å»ºæ–‡ä»¶ï¼šapp/jobs/credit/CreditManageJob.php
<?php
namespace app\jobs\credit;

use crmeb\basic\BaseJobs;
use think\facade\Log;

/**
 * ä¿¡ç”¨ç®¡ç†å®šæ—¶ä»»åŠ¡
 * æ¯å¤©å‡Œæ™¨æ‰§è¡Œä¸€æ¬¡
 */
class CreditManageJob extends BaseJobs
{
    /**
     * æ‰§è¡Œä»»åŠ¡
     */
    public function doJob()
    {
        try {
            Log::info('å¼€å§‹æ‰§è¡Œä¿¡ç”¨ç®¡ç†å®šæ—¶ä»»åŠ¡');
            
            // 1. æ£€æŸ¥é€¾æœŸè®¢å•
            $this->checkOverdueOrders();
            
            // 2. å‘é€è¿˜æ¬¾æé†’
            $this->sendRepaymentReminders();
            
            // 3. æ›´æ–°ä¿¡ç”¨åˆ†
            $this->updateCreditScores();
            
            // 4. æ¸…ç†è¿‡æœŸæ•°æ®
            $this->cleanExpiredData();
            
            Log::info('ä¿¡ç”¨ç®¡ç†å®šæ—¶ä»»åŠ¡æ‰§è¡Œå®Œæˆ');
            
            return true;
        } catch (\Exception $e) {
            Log::error('ä¿¡ç”¨ç®¡ç†å®šæ—¶ä»»åŠ¡æ‰§è¡Œå¤±è´¥ï¼š' . $e->getMessage());
            return false;
        }
    }
    
    /**
     * æ£€æŸ¥é€¾æœŸè®¢å•
     */
    protected function checkOverdueOrders()
    {
        $creditOrderService = app()->make(\app\services\credit\CreditOrderServices::class);
        $creditOrderService->checkOverdueOrders();
    }
    
    /**
     * å‘é€è¿˜æ¬¾æé†’
     */
    protected function sendRepaymentReminders()
    {
        $creditOrderService = app()->make(\app\services\credit\CreditOrderServices::class);
        $creditOrderService->sendRepaymentReminder();
    }
    
    /**
     * æ›´æ–°ä¿¡ç”¨åˆ†
     * æ ¹æ®ç”¨æˆ·çš„è¿˜æ¬¾è¡Œä¸ºæ›´æ–°ä¿¡ç”¨åˆ†
     */
    protected function updateCreditScores()
    {
        $creditService = app()->make(\app\services\credit\UserCreditServices::class);
        
        // è·å–æ‰€æœ‰æœ‰ä¿¡ç”¨è®°å½•çš„ç”¨æˆ·
        $users = $creditService->dao->getModel()->select();
        
        foreach ($users as $user) {
            // è®¡ç®—ä¿¡ç”¨åˆ†å˜åŒ–
            $scoreChange = $this->calculateScoreChange($user['user_id']);
            
            if ($scoreChange != 0) {
                $creditService->updateCreditScore($user['user_id'], $scoreChange);
            }
        }
    }
    
    /**
     * è®¡ç®—ä¿¡ç”¨åˆ†å˜åŒ–
     */
    protected function calculateScoreChange($userId)
    {
        $creditOrderDao = app()->make(\app\dao\credit\CreditOrderDao::class);
        
        // ç»Ÿè®¡æœ€è¿‘30å¤©çš„è¿˜æ¬¾æƒ…å†µ
        $startTime = time() - 30 * 86400;
        
        // æŒ‰æ—¶è¿˜æ¬¾æ¬¡æ•°
        $onTimeCount = $creditOrderDao->count([
            'user_id' => $userId,
            'status' => 2,
            ['actual_repayment_time', '<=', 'repayment_time'],
            ['create_time', '>=', $startTime]
        ]);
        
        // é€¾æœŸæ¬¡æ•°
        $overdueCount = $creditOrderDao->count([
            'user_id' => $userId,
            'status' => 3,
            ['create_time', '>=', $startTime]
        ]);
        
        // è®¡ç®—åˆ†æ•°å˜åŒ–
        $score = $onTimeCount * 2 - $overdueCount * 5;
        
        return $score;
    }
    
    /**
     * æ¸…ç†è¿‡æœŸæ•°æ®
     */
    protected function cleanExpiredData()
    {
        // æ¸…ç†è¶…è¿‡1å¹´çš„è¿˜æ¬¾è®°å½•
        $expireTime = time() - 365 * 86400;
        
        app()->make(\app\dao\credit\CreditOrderDao::class)
            ->getModel()
            ->where('status', 2)
            ->where('create_time', '<', $expireTime)
            ->delete();
    }
}
```

#### 7.4.2 é…ç½®å®šæ—¶ä»»åŠ¡

```php
// åœ¨ config/crontab.php ä¸­æ·»åŠ 
return [
    // ... å…¶ä»–ä»»åŠ¡
    
    // ä¿¡ç”¨ç®¡ç†ä»»åŠ¡ - æ¯å¤©å‡Œæ™¨2ç‚¹æ‰§è¡Œ
    [
        'title' => 'ä¿¡ç”¨ç®¡ç†ä»»åŠ¡',
        'task' => \app\jobs\credit\CreditManageJob::class,
        'cron' => '0 2 * * *'
    ],
];
```

### 7.5 æœ¬ç« ç»ƒä¹ 

1. **åŠŸèƒ½å®ç°**ï¼š
   - å®ç°è‡ªåŠ¨è¿˜æ¬¾åŠŸèƒ½ï¼ˆä»ä½™é¢æ‰£é™¤ï¼‰
   - æ·»åŠ è¿˜æ¬¾è®¡åˆ’åŠŸèƒ½
   - å®ç°ä¿¡ç”¨é¢åº¦ç”³è¯·æå‡åŠŸèƒ½

2. **æ€è€ƒé¢˜**ï¼š
   - å¦‚ä½•é˜²æ­¢ç”¨æˆ·æ¶æ„é€æ”¯ï¼Ÿ
   - å¦‚ä½•è®¾è®¡æ›´åˆç†çš„ä¿¡ç”¨è¯„åˆ†ä½“ç³»ï¼Ÿ

3. **æ‰©å±•ä»»åŠ¡**ï¼š
   - å®ç°åˆ†æœŸè¿˜æ¬¾åŠŸèƒ½
   - æ·»åŠ é€¾æœŸè´¹ç”¨è®¡ç®—
   - å¼€å‘ä¿¡ç”¨æŠ¥å‘ŠåŠŸèƒ½

---

## ç¬¬å…«ç« ï¼šåˆ›æ–°åˆ†é”€ç³»ç»Ÿå¼€å‘ - è®©ç”¨æˆ·å¸®ä½ å–è´§

### 8.1 ç†è§£åˆ›æ–°åˆ†é”€ç³»ç»Ÿ

æˆ‘ä»¬çš„åˆ†é”€ç³»ç»Ÿä¸ä¼—ä¸åŒï¼š
- ğŸ†• **æ–°ç”¨æˆ·åˆ†é”€**ï¼šé¦–å•åˆ†äº«æˆåŠŸï¼Œè¿”è¿˜å…¨éƒ¨è´­ä¹°é‡‘é¢
- ğŸ‘¥ **è€ç”¨æˆ·åˆ†é”€**ï¼šåˆ†äº«æˆåŠŸï¼Œè·å¾—ç›¸åŒå•†å“çš„ç¤¼å“åˆ¸
- ğŸ“Š **åˆ†äº«æ¡ä»¶**ï¼šè‡³å°‘2äººè´­ä¹°ï¼Œä¸”ä»·æ ¼ä¸ä½äºåˆ†äº«è€…çš„è´­ä¹°ä»·æ ¼

### 8.2 åˆ†é”€æ ¸å¿ƒé€»è¾‘å®ç°

#### 8.2.1 åˆ›å»ºåˆ†é”€æœåŠ¡

```php
// åˆ›å»ºæ–‡ä»¶ï¼šapp/services/distribution/DistributionServices.php
<?php
namespace app\services\distribution;

use app\services\BaseServices;
use app\dao\distribution\DistributionRelationDao;
use think\facade\Log;

class DistributionServices extends BaseServices
{
    public function __construct(DistributionRelationDao $dao)
    {
        $this->dao = $dao;
    }
    
    /**
     * è®°å½•åˆ†äº«å…³ç³»
     * å½“ç”¨æˆ·é€šè¿‡åˆ†äº«é“¾æ¥è¿›å…¥å¹¶ä¸‹å•æ—¶è°ƒç”¨
     */
    public function recordShareRelation($shareUserId, $shareOrderId, $buyerUserId, $buyerOrderInfo)
    {
        // æ£€æŸ¥æ˜¯å¦å·²è®°å½•
        $exists = $this->dao->count([
            'share_user_id' => $shareUserId,
            'share_order_id' => $shareOrderId,
            'buyer_user_id' => $buyerUserId,
            'buyer_order_id' => $buyerOrderInfo['order_id']
        ]);
        
        if ($exists) {
            return true;
        }
        
        // è®°å½•åˆ†äº«å…³ç³»
        $data = [
            'share_user_id' => $shareUserId,
            'share_order_id' => $shareOrderId,
            'buyer_user_id' => $buyerUserId,
            'buyer_order_id' => $buyerOrderInfo['order_id'],
            'buyer_order_amount' => $buyerOrderInfo['pay_price'],
            'share_time' => time(),
            'buy_time' => time(),
            'create_time' => time()
        ];
        
        $this->dao->save($data);
        
        // æ£€æŸ¥æ˜¯å¦æ»¡è¶³åˆ†é”€æ¡ä»¶
        $this->checkDistributionCondition($shareUserId, $shareOrderId);
        
        return true;
    }
    
    /**
     * æ£€æŸ¥åˆ†é”€æ¡ä»¶
     * è§„åˆ™ï¼šè‡³å°‘2äººè´­ä¹°ï¼Œä¸”æœ€ä½ä»·æ ¼>=åˆ†äº«è€…è´­ä¹°ä»·æ ¼
     */
    public function checkDistributionCondition($shareUserId, $shareOrderId)
    {
        // è·å–åˆ†äº«è€…çš„è®¢å•ä¿¡æ¯
        $orderService = app()->make(\app\services\order\StoreOrderServices::class);
        $shareOrder = $orderService->dao->get($shareOrderId);
        
        if (!$shareOrder) {
            Log::error("åˆ†é”€æ£€æŸ¥å¤±è´¥ï¼šè®¢å•ä¸å­˜åœ¨ {$shareOrderId}");
            return false;
        }
        
        // ç»Ÿè®¡é€šè¿‡åˆ†äº«è´­ä¹°çš„æƒ…å†µ
        $relations = $this->dao->getModel()
            ->where('share_user_id', $shareUserId)
            ->where('share_order_id', $shareOrderId)
            ->select();
        
        // è´­ä¹°äººæ•°
        $buyerCount = count($relations);
        
        // æœ€ä½è´­ä¹°ä»·æ ¼
        $minPrice = $relations->min('buyer_order_amount');
        
        Log::info("åˆ†é”€æ¡ä»¶æ£€æŸ¥ï¼šåˆ†äº«è€…{$shareUserId}ï¼Œè®¢å•{$shareOrderId}ï¼Œè´­ä¹°äººæ•°{$buyerCount}ï¼Œæœ€ä½ä»·æ ¼{$minPrice}ï¼Œåˆ†äº«è®¢å•ä»·æ ¼{$shareOrder['pay_price']}");
        
        // æ£€æŸ¥æ˜¯å¦æ»¡è¶³æ¡ä»¶ï¼šäººæ•°>=2 ä¸” æœ€ä½ä»·æ ¼>=åˆ†äº«è®¢å•ä»·æ ¼
        if ($buyerCount >= 2 && $minPrice >= $shareOrder['pay_price']) {
            // æ£€æŸ¥æ˜¯å¦å·²å‘æ”¾å¥–åŠ±
            $rewardService = app()->make(DistributionRewardServices::class);
            $hasReward = $rewardService->dao->count([
                'user_id' => $shareUserId,
                'share_order_id' => $shareOrderId,
                'status' => 2  // å·²å‘æ”¾
            ]);
            
            if (!$hasReward) {
                // è§¦å‘åˆ†é”€å¥–åŠ±
                $this->triggerDistributionReward($shareUserId, $shareOrder);
            }
            
            return true;
        }
        
        return false;
    }
    
    /**
     * è§¦å‘åˆ†é”€å¥–åŠ±
     */
    protected function triggerDistributionReward($shareUserId, $shareOrder)
    {
        Log::info("è§¦å‘åˆ†é”€å¥–åŠ±ï¼šç”¨æˆ·{$shareUserId}ï¼Œè®¢å•{$shareOrder['order_id']}");
        
        // åˆ¤æ–­æ˜¯å¦ä¸ºæ–°ç”¨æˆ·
        $isNewUser = $this->checkIsNewUser($shareUserId, $shareOrder['id']);
        
        // è·å–åˆ†äº«ç»Ÿè®¡
        $shareStats = $this->getShareStats($shareUserId, $shareOrder['order_id']);
        
        // åˆ›å»ºå¥–åŠ±è®°å½•
        $rewardService = app()->make(DistributionRewardServices::class);
        
        if ($isNewUser) {
            // æ–°ç”¨æˆ·ï¼šå…¨é¢è¿”è¿˜
            $rewardData = [
                'user_id' => $shareUserId,
                'share_order_id' => $shareOrder['order_id'],
                'reward_type' => 1,  // ç°é‡‘è¿”è¿˜
                'reward_amount' => $shareOrder['pay_price'],
                'buyer_count' => $shareStats['buyer_count'],
                'min_buy_amount' => $shareStats['min_price'],
                'status' => 1,  // å¾…å‘æ”¾
                'create_time' => time()
            ];
            
            $reward = $rewardService->dao->save($rewardData);
            
            // å‘æ”¾ç°é‡‘å¥–åŠ±
            $this->processNewUserReward($shareUserId, $shareOrder, $reward);
            
        } else {
            // è€ç”¨æˆ·ï¼šå‘æ”¾å•†å“ç¤¼å“åˆ¸
            $rewardData = [
                'user_id' => $shareUserId,
                'share_order_id' => $shareOrder['order_id'],
                'reward_type' => 2,  // å•†å“ç¤¼å“åˆ¸
                'reward_amount' => 0,
                'buyer_count' => $shareStats['buyer_count'],
                'min_buy_amount' => $shareStats['min_price'],
                'status' => 1,  // å¾…å‘æ”¾
                'create_time' => time()
            ];
            
            $reward = $rewardService->dao->save($rewardData);
            
            // å‘æ”¾ç¤¼å“åˆ¸å¥–åŠ±
            $this->processOldUserReward($shareUserId, $shareOrder, $reward);
        }
    }
    
    /**
     * æ£€æŸ¥æ˜¯å¦ä¸ºæ–°ç”¨æˆ·
     * æ–°ç”¨æˆ·å®šä¹‰ï¼šåˆ†äº«çš„æ˜¯é¦–å•
     */
    protected function checkIsNewUser($userId, $orderId)
    {
        // æŸ¥è¯¢ç”¨æˆ·é¦–å•è®°å½•
        $firstOrderDao = app()->make(\app\dao\user\UserFirstOrderDao::class);
        $firstOrder = $firstOrderDao->getOne(['user_id' => $userId]);
        
        if (!$firstOrder) {
            // å¦‚æœæ²¡æœ‰é¦–å•è®°å½•ï¼ŒæŸ¥è¯¢ç”¨æˆ·ç¬¬ä¸€ä¸ªè®¢å•
            $orderService = app()->make(\app\services\order\StoreOrderServices::class);
            $firstRealOrder = $orderService->dao->getModel()
                ->where('uid', $userId)
                ->where('paid', 1)
                ->order('id asc')
                ->find();
            
            if ($firstRealOrder && $firstRealOrder['id'] == $orderId) {
                // åˆ›å»ºé¦–å•è®°å½•
                $firstOrderDao->save([
                    'user_id' => $userId,
                    'first_order_id' => $firstRealOrder['order_id'],
                    'first_order_amount' => $firstRealOrder['pay_price'],
                    'first_order_time' => $firstRealOrder['pay_time'],
                    'create_time' => time()
                ]);
                
                return true;
            }
        }
        
        // æ£€æŸ¥åˆ†äº«çš„æ˜¯å¦æ˜¯é¦–å•
        return $firstOrder && $firstOrder['first_order_id'] == $orderId;
    }
    
    /**
     * å¤„ç†æ–°ç”¨æˆ·å¥–åŠ± - å…¨é¢è¿”è¿˜
     */
    protected function processNewUserReward($userId, $shareOrder, $rewardRecord)
    {
        try {
            // è¿”è¿˜åˆ°ç”¨æˆ·ä½™é¢
            $userService = app()->make(\app\services\user\UserServices::class);
            $userService->incMoney($userId, $shareOrder['pay_price']);
            
            // è®°å½•ä½™é¢å˜åŠ¨
            $userBillService = app()->make(\app\services\user\UserBillServices::class);
            $userBillService->income('distribution_new', $userId, $shareOrder['pay_price'], 0, $shareOrder['id']);
            
            // æ›´æ–°å¥–åŠ±çŠ¶æ€
            $rewardService = app()->make(DistributionRewardServices::class);
            $rewardService->dao->update($rewardRecord['id'], [
                'status' => 2,  // å·²å‘æ”¾
                'reward_time' => time()
            ]);
            
            // æ›´æ–°é¦–å•åˆ†äº«çŠ¶æ€
            $firstOrderDao = app()->make(\app\dao\user\UserFirstOrderDao::class);
            $firstOrderDao->update(['user_id' => $userId], [
                'is_shared' => 1,
                'share_reward_status' => 2
            ]);
            
            // å‘é€é€šçŸ¥
            $this->sendRewardNotice($userId, 'new_user', $shareOrder['pay_price']);
            
            Log::info("æ–°ç”¨æˆ·åˆ†é”€å¥–åŠ±å‘æ”¾æˆåŠŸï¼šç”¨æˆ·{$userId}ï¼Œé‡‘é¢{$shareOrder['pay_price']}");
            
        } catch (\Exception $e) {
            Log::error("æ–°ç”¨æˆ·åˆ†é”€å¥–åŠ±å‘æ”¾å¤±è´¥ï¼š" . $e->getMessage());
            throw $e;
        }
    }
    
    /**
     * å¤„ç†è€ç”¨æˆ·å¥–åŠ± - å‘æ”¾å•†å“ç¤¼å“åˆ¸
     */
    protected function processOldUserReward($userId, $shareOrder, $rewardRecord)
    {
        try {
            // è·å–è®¢å•å•†å“
            $orderCartInfo = app()->make(\app\dao\order\StoreOrderCartInfoDao::class)
                ->getModel()
                ->where('oid', $shareOrder['id'])
                ->select();
            
            $giftCardService = app()->make(\app\services\giftcard\GiftCardServices::class);
            $giftCardIds = [];
            
            // ä¸ºæ¯ä¸ªå•†å“ç”Ÿæˆç¤¼å“åˆ¸
            foreach ($orderCartInfo as $cartItem) {
                $productInfo = json_decode($cartItem['cart_info'], true);
                
                // æ ¹æ®è´­ä¹°æ•°é‡ç”Ÿæˆå¯¹åº”æ•°é‡çš„ç¤¼å“åˆ¸
                for ($i = 0; $i < $cartItem['cart_num']; $i++) {
                    $giftCard = $giftCardService->createDistributionCard($userId, $productInfo['product_id']);
                    $giftCardIds[] = $giftCard['id'];
                }
            }
            
            // æ›´æ–°å¥–åŠ±è®°å½•
            $rewardService = app()->make(DistributionRewardServices::class);
            $rewardService->dao->update($rewardRecord['id'], [
                'gift_card_ids' => implode(',', $giftCardIds),
                'status' => 2,  // å·²å‘æ”¾
                'reward_time' => time()
            ]);
            
            // å‘é€é€šçŸ¥
            $this->sendRewardNotice($userId, 'old_user', count($giftCardIds));
            
            Log::info("è€ç”¨æˆ·åˆ†é”€å¥–åŠ±å‘æ”¾æˆåŠŸï¼šç”¨æˆ·{$userId}ï¼Œç¤¼å“åˆ¸æ•°é‡" . count($giftCardIds));
            
        } catch (\Exception $e) {
            Log::error("è€ç”¨æˆ·åˆ†é”€å¥–åŠ±å‘æ”¾å¤±è´¥ï¼š" . $e->getMessage());
            throw $e;
        }
    }
    
    /**
     * è·å–åˆ†äº«ç»Ÿè®¡
     */
    public function getShareStats($shareUserId, $shareOrderId)
    {
        $relations = $this->dao->getModel()
            ->where('share_user_id', $shareUserId)
            ->where('share_order_id', $shareOrderId)
            ->select();
        
        return [
            'buyer_count' => count($relations),
            'total_amount' => $relations->sum('buyer_order_amount'),
            'min_price' => $relations->min('buyer_order_amount'),
            'buyers' => $relations->toArray()
        ];
    }
    
    /**
     * å‘é€å¥–åŠ±é€šçŸ¥
     */
    protected function sendRewardNotice($userId, $type, $value)
    {
        $userService = app()->make(\app\services\user\UserServices::class);
        $user = $userService->get($userId);
        
        if ($type == 'new_user') {
            $message = "æ­å–œæ‚¨ï¼æ‚¨çš„é¦–å•åˆ†äº«å·²æˆåŠŸï¼Œï¿¥{$value}å·²è¿”è¿˜åˆ°æ‚¨çš„è´¦æˆ·ä½™é¢ã€‚";
        } else {
            $message = "æ­å–œæ‚¨ï¼æ‚¨çš„åˆ†äº«å·²æˆåŠŸï¼Œ{$value}å¼ å•†å“ç¤¼å“åˆ¸å·²å‘æ”¾åˆ°æ‚¨çš„è´¦æˆ·ã€‚";
        }
        
        // å‘é€ç«™å†…ä¿¡
        app()->make(\app\services\message\SystemMessageServices::class)->save([
            'uid' => $userId,
            'type' => 'distribution_reward',
            'title' => 'åˆ†é”€å¥–åŠ±åˆ°è´¦',
            'content' => $message,
            'add_time' => time()
        ]);
        
        // å‘é€å¾®ä¿¡æ¨¡æ¿æ¶ˆæ¯
        if ($user['openid']) {
            // è°ƒç”¨å¾®ä¿¡æ¨¡æ¿æ¶ˆæ¯æœåŠ¡
        }
    }
}
```

#### 8.2.2 åˆ›å»ºåˆ†é”€å¥–åŠ±æœåŠ¡

```php
// åˆ›å»ºæ–‡ä»¶ï¼šapp/services/distribution/DistributionRewardServices.php
<?php
namespace app\services\distribution;

use app\services\BaseServices;
use app\dao\distribution\DistributionRewardDao;

class DistributionRewardServices extends BaseServices
{
    public function __construct(DistributionRewardDao $dao)
    {
        $this->dao = $dao;
    }
    
    /**
     * è·å–ç”¨æˆ·åˆ†é”€å¥–åŠ±åˆ—è¡¨
     */
    public function getUserRewardList($userId, $where = [])
    {
        $where['user_id'] = $userId;
        
        $list = $this->dao->getList($where, ['*'], 0, 0, 'create_time desc');
        
        foreach ($list as &$item) {
            // æ ¼å¼åŒ–æ—¶é—´
            $item['create_time_text'] = date('Y-m-d H:i', $item['create_time']);
            $item['reward_time_text'] = $item['reward_time'] ? date('Y-m-d H:i', $item['reward_time']) : '';
            
            // å¥–åŠ±ç±»å‹æ–‡å­—
            $item['reward_type_text'] = $item['reward_type'] == 1 ? 'ç°é‡‘è¿”è¿˜' : 'å•†å“ç¤¼å“åˆ¸';
            
            // çŠ¶æ€æ–‡å­—
            $statusText = ['', 'å¾…å‘æ”¾', 'å·²å‘æ”¾', 'å·²å–æ¶ˆ'];
            $item['status_text'] = $statusText[$item['status']] ?? '';
            
            // å¦‚æœæ˜¯ç¤¼å“åˆ¸ï¼Œè·å–ç¤¼å“åˆ¸ä¿¡æ¯
            if ($item['reward_type'] == 2 && $item['gift_card_ids']) {
                $giftCardIds = explode(',', $item['gift_card_ids']);
                $item['gift_card_count'] = count($giftCardIds);
            }
        }
        
        return $list;
    }
    
    /**
     * è·å–åˆ†é”€ç»Ÿè®¡
     */
    public function getDistributionStats($userId)
    {
        // æ€»å¥–åŠ±æ¬¡æ•°
        $totalCount = $this->dao->count(['user_id' => $userId, 'status' => 2]);
        
        // ç°é‡‘å¥–åŠ±ç»Ÿè®¡
        $cashReward = $this->dao->getModel()
            ->where('user_id', $userId)
            ->where('reward_type', 1)
            ->where('status', 2)
            ->sum('reward_amount');
        
        // ç¤¼å“åˆ¸å¥–åŠ±ç»Ÿè®¡
        $giftCardCount = 0;
        $giftCardRewards = $this->dao->getModel()
            ->where('user_id', $userId)
            ->where('reward_type', 2)
            ->where('status', 2)
            ->select();
        
        foreach ($giftCardRewards as $reward) {
            if ($reward['gift_card_ids']) {
                $giftCardCount += count(explode(',', $reward['gift_card_ids']));
            }
        }
        
        // åˆ†äº«æˆåŠŸçš„è®¢å•æ•°
        $shareOrderCount = $this->dao->getModel()
            ->where('user_id', $userId)
            ->where('status', 2)
            ->group('share_order_id')
            ->count();
        
        // å¸¦æ¥çš„ç”¨æˆ·æ•°
        $distributionService = app()->make(DistributionServices::class);
        $buyerCount = $distributionService->dao->getModel()
            ->where('share_user_id', $userId)
            ->group('buyer_user_id')
            ->count();
        
        return [
            'total_count' => $totalCount,
            'cash_reward' => $cashReward,
            'gift_card_count' => $giftCardCount,
            'share_order_count' => $shareOrderCount,
            'buyer_count' => $buyerCount
        ];
    }
    
    /**
     * æ£€æŸ¥è®¢å•æ˜¯å¦å¯åˆ†äº«
     */
    public function checkOrderCanShare($userId, $orderId)
    {
        // æ£€æŸ¥æ˜¯å¦å·²ç»åˆ†äº«æˆåŠŸ
        $hasReward = $this->dao->count([
            'user_id' => $userId,
            'share_order_id' => $orderId,
            'status' => 2
        ]);
        
        if ($hasReward) {
            return [
                'can_share' => false,
                'reason' => 'è¯¥è®¢å•å·²è·å¾—åˆ†é”€å¥–åŠ±'
            ];
        }
        
        // æ£€æŸ¥æ˜¯å¦æ˜¯æ–°ç”¨æˆ·çš„é¦–å•
        $firstOrderDao = app()->make(\app\dao\user\UserFirstOrderDao::class);
        $firstOrder = $firstOrderDao->getOne(['user_id' => $userId]);
        
        if ($firstOrder && $firstOrder['first_order_id'] == $orderId && $firstOrder['share_reward_status'] == 2) {
            return [
                'can_share' => false,
                'reason' => 'é¦–å•å·²è·å¾—åˆ†é”€å¥–åŠ±'
            ];
        }
        
        // è·å–åˆ†äº«ç»Ÿè®¡
        $distributionService = app()->make(DistributionServices::class);
        $shareStats = $distributionService->getShareStats($userId, $orderId);
        
        return [
            'can_share' => true,
            'is_new_user' => $firstOrder && $firstOrder['first_order_id'] == $orderId,
            'current_buyers' => $shareStats['buyer_count'],
            'need_buyers' => max(0, 2 - $shareStats['buyer_count']),
            'share_stats' => $shareStats
        ];
    }
}
```

### 8.3 å‰ç«¯åˆ†é”€åŠŸèƒ½å®ç°

#### 8.3.1 è®¢å•åˆ†äº«é¡µé¢

```vue
<!-- åˆ›å»ºæ–‡ä»¶ï¼štemplate/uni-app/pages/distribution/share.vue -->
<template>
  <view class="share-page">
    <!-- åˆ†äº«æµ·æŠ¥ -->
    <view class="poster-section">
      <canvas canvas-id="posterCanvas" 
              :style="{width: canvasWidth + 'px', height: canvasHeight + 'px'}"
              class="poster-canvas"></canvas>
      <image :src="posterImage" 
             mode="aspectFit" 
             class="poster-image" 
             v-if="posterImage"></image>
    </view>
    
    <!-- åˆ†äº«è¯´æ˜ -->
    <view class="share-info">
      <view class="info-card">
        <view class="card-title">
          <text class="iconfont icon-gift"></text>
          <text>{{ isNewUser ? 'æ–°ç”¨æˆ·ä¸“å±ç¦åˆ©' : 'åˆ†äº«èµ¢å¥½ç¤¼' }}</text>
        </view>
        
        <view class="reward-desc" v-if="isNewUser">
          <view class="reward-amount">Â¥{{ orderInfo.pay_price }}</view>
          <view class="reward-text">åˆ†äº«æˆåŠŸå¯è·å¾—å…¨é¢è¿”ç°</view>
        </view>
        
        <view class="reward-desc" v-else>
          <view class="reward-products">
            <view class="product-item" 
                  v-for="(product, index) in orderProducts" 
                  :key="index">
              <image :src="product.image" class="product-img"></image>
              <text class="product-name">{{ product.name }}</text>
              <text class="product-num">Ã—{{ product.num }}</text>
            </view>
          </view>
          <view class="reward-text">åˆ†äº«æˆåŠŸå¯è·å¾—ç›¸åŒå•†å“ç¤¼å“åˆ¸</view>
        </view>
        
        <view class="share-rules">
          <view class="rule-title">åˆ†äº«è§„åˆ™ï¼š</view>
          <view class="rule-item">1. éœ€è¦è‡³å°‘2ä½å¥½å‹é€šè¿‡æ‚¨çš„åˆ†äº«è´­ä¹°</view>
          <view class="rule-item">2. å¥½å‹è´­ä¹°ä»·æ ¼éœ€â‰¥Â¥{{ orderInfo.pay_price }}</view>
          <view class="rule-item">3. æ»¡è¶³æ¡ä»¶åè‡ªåŠ¨å‘æ”¾å¥–åŠ±</view>
        </view>
      </view>
      
      <!-- åˆ†äº«è¿›åº¦ -->
      <view class="progress-card" v-if="shareStats">
        <view class="progress-title">å½“å‰è¿›åº¦</view>
        <view class="progress-bar">
          <view class="progress-fill" 
                :style="{width: progressPercent + '%'}"></view>
        </view>
        <view class="progress-text">
          å·²æœ‰{{ shareStats.buyer_count }}äººè´­ä¹°ï¼Œ
          {{ shareStats.buyer_count >= 2 ? 'å·²æ»¡è¶³äººæ•°æ¡ä»¶' : 'è¿˜éœ€' + (2 - shareStats.buyer_count) + 'äºº' }}
        </view>
        
        <view class="buyer-list" v-if="shareStats.buyers.length > 0">
          <view class="buyer-item" 
                v-for="buyer in shareStats.buyers" 
                :key="buyer.id">
            <view class="buyer-info">
              <text class="buyer-name">{{ buyer.nickname }}</text>
              <text class="buy-time">{{ formatTime(buyer.buy_time) }}</text>
            </view>
            <view class="buy-amount">Â¥{{ buyer.buyer_order_amount }}</view>
          </view>
        </view>
      </view>
    </view>
    
    <!-- åˆ†äº«æŒ‰é’® -->
    <view class="share-actions">
      <button class="share-btn wechat" @click="shareToWechat">
        <text class="iconfont icon-wechat"></text>
        <text>åˆ†äº«ç»™å¥½å‹</text>
      </button>
      <button class="share-btn moments" @click="shareToMoments">
        <text class="iconfont icon-moments"></text>
        <text>åˆ†äº«åˆ°æœ‹å‹åœˆ</text>
      </button>
      <button class="share-btn save" @click="savePoster">
        <text class="iconfont icon-download"></text>
        <text>ä¿å­˜æµ·æŠ¥</text>
      </button>
    </view>
  </view>
</template>

<script>
import { getOrderDetail } from '@/api/order.js'
import { checkOrderShare, getShareStats } from '@/api/distribution.js'

export default {
  data() {
    return {
      orderId: '',
      orderInfo: {},
      orderProducts: [],
      isNewUser: false,
      shareStats: null,
      canvasWidth: 375,
      canvasHeight: 667,
      posterImage: '',
      shareUrl: ''
    }
  },
  
  computed: {
    progressPercent() {
      if (!this.shareStats) return 0
      const percent = (this.shareStats.buyer_count / 2) * 100
      return Math.min(percent, 100)
    }
  },
  
  onLoad(options) {
    this.orderId = options.id
    this.loadData()
  },
  
  methods: {
    async loadData() {
      // è·å–è®¢å•ä¿¡æ¯
      const orderRes = await getOrderDetail(this.orderId)
      this.orderInfo = orderRes.data
      this.orderProducts = this.orderInfo.cart_info
      
      // æ£€æŸ¥åˆ†äº«çŠ¶æ€
      const shareRes = await checkOrderShare(this.orderId)
      this.isNewUser = shareRes.data.is_new_user
      this.shareStats = shareRes.data.share_stats
      
      // ç”Ÿæˆåˆ†äº«é“¾æ¥
      const userInfo = uni.getStorageSync('userInfo')
      this.shareUrl = `${process.env.VUE_APP_BASE_URL}/pages/goods/goods?share_uid=${userInfo.uid}&share_order=${this.orderId}`
      
      // ç”Ÿæˆæµ·æŠ¥
      this.generatePoster()
    },
    
    // ç”Ÿæˆåˆ†äº«æµ·æŠ¥
    generatePoster() {
      const ctx = uni.createCanvasContext('posterCanvas', this)
      
      // èƒŒæ™¯
      ctx.setFillStyle('#ffffff')
      ctx.fillRect(0, 0, this.canvasWidth, this.canvasHeight)
      
      // æ ‡é¢˜
      ctx.setFillStyle('#333333')
      ctx.setFontSize(20)
      ctx.setTextAlign('center')
      ctx.fillText('åº†äººåºœå•†åŸ', this.canvasWidth / 2, 40)
      
      // å•†å“å›¾ç‰‡
      const mainProduct = this.orderProducts[0]
      if (mainProduct) {
        ctx.drawImage(mainProduct.image, 50, 70, 275, 275)
      }
      
      // å•†å“åç§°
      ctx.setFillStyle('#333333')
      ctx.setFontSize(16)
      ctx.setTextAlign('left')
      this.drawText(ctx, mainProduct.name, 50, 370, 275, 20)
      
      // ä»·æ ¼
      ctx.setFillStyle('#ff6b6b')
      ctx.setFontSize(24)
      ctx.fillText('Â¥' + this.orderInfo.pay_price, 50, 420)
      
      // åˆ†é”€è¯´æ˜
      ctx.setFillStyle('#666666')
      ctx.setFontSize(14)
      if (this.isNewUser) {
        ctx.fillText('åˆ†äº«æˆåŠŸè¿”ç° Â¥' + this.orderInfo.pay_price, 50, 460)
      } else {
        ctx.fillText('åˆ†äº«æˆåŠŸé€åŒæ¬¾å•†å“', 50, 460)
      }
      
      // äºŒç»´ç ï¼ˆè¿™é‡Œéœ€è¦åç«¯ç”Ÿæˆï¼‰
      ctx.drawImage('/static/images/qrcode-placeholder.png', 225, 480, 100, 100)
      
      // æç¤ºæ–‡å­—
      ctx.setFillStyle('#999999')
      ctx.setFontSize(12)
      ctx.setTextAlign('center')
      ctx.fillText('é•¿æŒ‰è¯†åˆ«äºŒç»´ç ', this.canvasWidth / 2, 610)
      ctx.fillText('å¥½å‹è´­ä¹°ä½ å°±èµš', this.canvasWidth / 2, 630)
      
      // ç»˜åˆ¶åˆ°canvas
      ctx.draw(false, () => {
        setTimeout(() => {
          uni.canvasToTempFilePath({
            canvasId: 'posterCanvas',
            success: (res) => {
              this.posterImage = res.tempFilePath
            }
          }, this)
        }, 500)
      })
    },
    
    // æ–‡å­—æ¢è¡Œ
    drawText(ctx, text, x, y, maxWidth, lineHeight) {
      const words = text.split('')
      let line = ''
      let lineNum = 0
      
      for (let n = 0; n < words.length; n++) {
        const testLine = line + words[n]
        const metrics = ctx.measureText(testLine)
        const testWidth = metrics.width
        
        if (testWidth > maxWidth && n > 0) {
          ctx.fillText(line, x, y + lineNum * lineHeight)
          line = words[n]
          lineNum++
          if (lineNum >= 2) {
            ctx.fillText(line + '...', x, y + lineNum * lineHeight)
            break
          }
        } else {
          line = testLine
        }
      }
      
      if (lineNum < 2) {
        ctx.fillText(line, x, y + lineNum * lineHeight)
      }
    },
    
    // åˆ†äº«ç»™å¥½å‹
    shareToWechat() {
      // #ifdef MP-WEIXIN
      uni.share({
        provider: 'weixin',
        scene: 'WXSceneSession',
        type: 0,
        href: this.shareUrl,
        title: this.isNewUser ? `æˆ‘åœ¨åº†äººåºœå•†åŸè´­ç‰©ï¼Œåˆ†äº«æˆåŠŸè¿”ç°Â¥${this.orderInfo.pay_price}` : 'æˆ‘åœ¨åº†äººåºœå•†åŸå‘ç°å¥½ç‰©ï¼Œå¿«æ¥çœ‹çœ‹',
        summary: 'ä¼˜è´¨å†œäº§å“ï¼Œäº§åœ°ç›´ä¾›',
        imageUrl: this.posterImage,
        success: () => {
          uni.showToast({
            title: 'åˆ†äº«æˆåŠŸ',
            icon: 'success'
          })
        }
      })
      // #endif
      
      // #ifdef H5
      this.showShareGuide()
      // #endif
    },
    
    // ä¿å­˜æµ·æŠ¥
    savePoster() {
      uni.saveImageToPhotosAlbum({
        filePath: this.posterImage,
        success: () => {
          uni.showToast({
            title: 'ä¿å­˜æˆåŠŸ',
            icon: 'success'
          })
        },
        fail: () => {
          uni.showToast({
            title: 'ä¿å­˜å¤±è´¥',
            icon: 'none'
          })
        }
      })
    },
    
    // æ ¼å¼åŒ–æ—¶é—´
    formatTime(timestamp) {
      const date = new Date(timestamp * 1000)
      return `${date.getMonth() + 1}æœˆ${date.getDate()}æ—¥ ${date.getHours()}:${date.getMinutes()}`
    }
  }
}
</script>

<style lang="scss">
.share-page {
  background: #f5f5f5;
  min-height: 100vh;
  padding-bottom: 200rpx;
  
  .poster-section {
    background: #fff;
    padding: 30rpx;
    text-align: center;
    
    .poster-canvas {
      position: absolute;
      left: -9999px;
    }
    
    .poster-image {
      width: 600rpx;
      height: 1067rpx;
      box-shadow: 0 4rpx 20rpx rgba(0,0,0,0.1);
    }
  }
  
  .share-info {
    padding: 0 30rpx;
    
    .info-card, .progress-card {
      background: #fff;
      border-radius: 20rpx;
      padding: 30rpx;
      margin-top: 20rpx;
    }
    
    .card-title {
      display: flex;
      align-items: center;
      font-size: 32rpx;
      font-weight: bold;
      margin-bottom: 30rpx;
      
      .iconfont {
        font-size: 36rpx;
        color: #ff6b6b;
        margin-right: 10rpx;
      }
    }
    
    .reward-desc {
      text-align: center;
      padding: 40rpx 0;
      
      .reward-amount {
        font-size: 60rpx;
        color: #ff6b6b;
        font-weight: bold;
        margin-bottom: 20rpx;
      }
      
      .reward-products {
        display: flex;
        flex-wrap: wrap;
        justify-content: center;
        margin-bottom: 20rpx;
        
        .product-item {
          display: flex;
          align-items: center;
          margin: 10rpx;
          padding: 10rpx;
          background: #f5f5f5;
          border-radius: 10rpx;
          
          .product-img {
            width: 60rpx;
            height: 60rpx;
            border-radius: 8rpx;
            margin-right: 10rpx;
          }
          
          .product-name {
            font-size: 26rpx;
            max-width: 200rpx;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
          }
          
          .product-num {
            font-size: 24rpx;
            color: #999;
            margin-left: 10rpx;
          }
        }
      }
      
      .reward-text {
        font-size: 30rpx;
        color: #666;
      }
    }
    
    .share-rules {
      background: #fff5f5;
      padding: 20rpx;
      border-radius: 10rpx;
      
      .rule-title {
        font-size: 28rpx;
        font-weight: bold;
        margin-bottom: 20rpx;
      }
      
      .rule-item {
        font-size: 26rpx;
        color: #666;
        margin-bottom: 10rpx;
        padding-left: 20rpx;
      }
    }
    
    .progress-title {
      font-size: 30rpx;
      font-weight: bold;
      margin-bottom: 20rpx;
    }
    
    .progress-bar {
      height: 20rpx;
      background: #f5f5f5;
      border-radius: 10rpx;
      overflow: hidden;
      margin-bottom: 20rpx;
      
      .progress-fill {
        height: 100%;
        background: linear-gradient(45deg, #ff6b6b, #ff8e53);
        transition: width 0.3s;
      }
    }
    
    .progress-text {
      font-size: 26rpx;
      color: #666;
      margin-bottom: 30rpx;
    }
    
    .buyer-list {
      border-top: 1rpx solid #f5f5f5;
      padding-top: 20rpx;
      
      .buyer-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 20rpx 0;
        
        .buyer-info {
          .buyer-name {
            font-size: 28rpx;
            margin-right: 20rpx;
          }
          
          .buy-time {
            font-size: 24rpx;
            color: #999;
          }
        }
        
        .buy-amount {
          font-size: 30rpx;
          color: #ff6b6b;
          font-weight: bold;
        }
      }
    }
  }
  
  .share-actions {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    background: #fff;
    padding: 30rpx;
    display: flex;
    justify-content: space-around;
    box-shadow: 0 -2rpx 10rpx rgba(0,0,0,0.05);
    
    .share-btn {
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 20rpx;
      border: none;
      background: none;
      
      .iconfont {
        font-size: 48rpx;
        margin-bottom: 10rpx;
      }
      
      text {
        font-size: 26rpx;
      }
      
      &.wechat {
        .iconfont {
          color: #07c160;
        }
      }
      
      &.moments {
        .iconfont {
          color: #ff6b6b;
        }
      }
      
      &.save {
        .iconfont {
          color: #576b95;
        }
      }
    }
  }
}
</style>
```

### 8.4 åå°åˆ†é”€ç®¡ç†

#### 8.4.1 åˆ†é”€ç®¡ç†æ§åˆ¶å™¨

```php
// åˆ›å»ºæ–‡ä»¶ï¼šapp/adminapi/controller/v1/distribution/Distribution.php
<?php
namespace app\adminapi\controller\v1\distribution;

use app\adminapi\controller\AuthController;
use app\services\distribution\DistributionServices;
use app\services\distribution\DistributionRewardServices;

class Distribution extends AuthController
{
    /**
     * åˆ†é”€è®°å½•åˆ—è¡¨
     */
    public function relationList()
    {
        $where = $this->request->getMore([
            ['share_user', ''],      // åˆ†äº«è€…
            ['buyer_user', ''],      // è´­ä¹°è€…
            ['date_range', []],      // æ—¶é—´èŒƒå›´
            ['page', 1],
            ['limit', 10]
        ]);
        
        $distributionService = app()->make(DistributionServices::class);
        $list = $distributionService->getRelationList($where);
        
        return app('json')->success($list);
    }
    
    /**
     * åˆ†é”€å¥–åŠ±åˆ—è¡¨
     */
    public function rewardList()
    {
        $where = $this->request->getMore([
            ['user_id', 0],
            ['reward_type', ''],
            ['status', ''],
            ['date_range', []],
            ['page', 1],
            ['limit', 10]
        ]);
        
        $rewardService = app()->make(DistributionRewardServices::class);
        $list = $rewardService->getList($where);
        
        return app('json')->success($list);
    }
    
    /**
     * åˆ†é”€ç»Ÿè®¡
     */
    public function statistics()
    {
        $dateRange = $this->request->get('date_range', []);
        
        $distributionService = app()->make(DistributionServices::class);
        $rewardService = app()->make(DistributionRewardServices::class);
        
        // ç»Ÿè®¡æ•°æ®
        $stats = [
            // æ€»ä½“ç»Ÿè®¡
            'total' => [
                'share_users' => $distributionService->dao->group('share_user_id')->count(),
                'buyer_users' => $distributionService->dao->group('buyer_user_id')->count(),
                'share_orders' => $distributionService->dao->group('share_order_id')->count(),
                'total_amount' => $distributionService->dao->sum('buyer_order_amount')
            ],
            
            // å¥–åŠ±ç»Ÿè®¡
            'reward' => [
                'total_count' => $rewardService->dao->where('status', 2)->count(),
                'cash_amount' => $rewardService->dao->where('reward_type', 1)->where('status', 2)->sum('reward_amount'),
                'gift_card_count' => $this->countGiftCards(),
                'pending_count' => $rewardService->dao->where('status', 1)->count()
            ],
            
            // è¶‹åŠ¿æ•°æ®
            'trends' => $this->getTrendData($dateRange)
        ];
        
        return app('json')->success($stats);
    }
    
    /**
     * å®¡æ ¸åˆ†é”€å¥–åŠ±
     */
    public function auditReward($id)
    {
        $status = $this->request->post('status', 2);  // 2:é€šè¿‡ 3:æ‹’ç»
        $reason = $this->request->post('reason', '');
        
        $rewardService = app()->make(DistributionRewardServices::class);
        $reward = $rewardService->dao->get($id);
        
        if (!$reward) {
            return app('json')->fail('å¥–åŠ±è®°å½•ä¸å­˜åœ¨');
        }
        
        if ($reward['status'] != 1) {
            return app('json')->fail('è¯¥å¥–åŠ±å·²å¤„ç†');
        }
        
        if ($status == 2) {
            // é€šè¿‡å®¡æ ¸ï¼Œå‘æ”¾å¥–åŠ±
            $distributionService = app()->make(DistributionServices::class);
            
            if ($reward['reward_type'] == 1) {
                // æ–°ç”¨æˆ·ç°é‡‘å¥–åŠ±
                $distributionService->processNewUserReward(
                    $reward['user_id'], 
                    ['pay_price' => $reward['reward_amount']], 
                    $reward
                );
            } else {
                // è€ç”¨æˆ·ç¤¼å“åˆ¸å¥–åŠ±
                // éœ€è¦é‡æ–°ç”Ÿæˆç¤¼å“åˆ¸
            }
        } else {
            // æ‹’ç»
            $rewardService->dao->update($id, [
                'status' => 3,
                'remark' => $reason,
                'update_time' => time()
            ]);
        }
        
        return app('json')->success('å¤„ç†æˆåŠŸ');
    }
    
    /**
     * ç»Ÿè®¡ç¤¼å“åˆ¸æ•°é‡
     */
    protected function countGiftCards()
    {
        $rewards = app()->make(DistributionRewardServices::class)->dao->getModel()
            ->where('reward_type', 2)
            ->where('status', 2)
            ->select();
        
        $count = 0;
        foreach ($rewards as $reward) {
            if ($reward['gift_card_ids']) {
                $count += count(explode(',', $reward['gift_card_ids']));
            }
        }
        
        return $count;
    }
    
    /**
     * è·å–è¶‹åŠ¿æ•°æ®
     */
    protected function getTrendData($dateRange)
    {
        // é»˜è®¤æœ€è¿‘30å¤©
        $endTime = time();
        $startTime = $endTime - 30 * 86400;
        
        if ($dateRange && count($dateRange) == 2) {
            $startTime = strtotime($dateRange[0]);
            $endTime = strtotime($dateRange[1]);
        }
        
        $trends = [];
        $currentTime = $startTime;
        
        while ($currentTime <= $endTime) {
            $dayStart = strtotime(date('Y-m-d', $currentTime));
            $dayEnd = $dayStart + 86400;
            
            $trends[] = [
                'date' => date('Y-m-d', $currentTime),
                'share_count' => app()->make(DistributionServices::class)->dao->whereTime('create_time', 'between', [$dayStart, $dayEnd])->count(),
                'reward_count' => app()->make(DistributionRewardServices::class)->dao->whereTime('create_time', 'between', [$dayStart, $dayEnd])->where('status', 2)->count(),
                'reward_amount' => app()->make(DistributionRewardServices::class)->dao->whereTime('create_time', 'between', [$dayStart, $dayEnd])->where('status', 2)->where('reward_type', 1)->sum('reward_amount')
            ];
            
            $currentTime += 86400;
        }
        
        return $trends;
    }
}
```

### 8.5 æœ¬ç« ç»ƒä¹ 

1. **åŠŸèƒ½å®ç°**ï¼š
   - å®ç°åˆ†äº«æ’è¡Œæ¦œåŠŸèƒ½
   - æ·»åŠ åˆ†é”€æµ·æŠ¥æ¨¡æ¿ç®¡ç†
   - å®ç°å›¢é˜Ÿåˆ†é”€åŠŸèƒ½ï¼ˆå¤šçº§åˆ†é”€ï¼‰

2. **æ€è€ƒé¢˜**ï¼š
   - å¦‚ä½•é˜²æ­¢ç”¨æˆ·åˆ·å•è·å–åˆ†é”€å¥–åŠ±ï¼Ÿ
   - å¦‚ä½•ä¼˜åŒ–åˆ†é”€é“¾è·¯è¿½è¸ªï¼Ÿ

3. **æ‰©å±•ä»»åŠ¡**ï¼š
   - å®ç°åˆ†é”€ç­‰çº§ç³»ç»Ÿ
   - æ·»åŠ åˆ†é”€ä»»åŠ¡ç³»ç»Ÿ
   - å¼€å‘åˆ†é”€æ•°æ®å¤§å±å±•ç¤º

---